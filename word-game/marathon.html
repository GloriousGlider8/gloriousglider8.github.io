<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
	<title>word game</title>
	<link rel="stylesheet" href="/assets/styles/common.css">
	<link rel="stylesheet" href="/assets/styles/word-game.css">
	<script src="https://kit.fontawesome.com/1a33e75b22.js" crossorigin="anonymous"></script>
</head>
<body id="body" class="background-default" style="overflow-y: auto;">
	<div class="center-cont" style="padding-top: 0%; padding-bottom: 0%;" id="center-cont">
	<form class="form-in-flex" action="javascript:doShit()">
	<h1 class="text-center">Word Marathon</h1>
	<button type="button" class="collapsible">Stats<i class="fa-solid fa-caret-right caret-right"></i></button>
		<div class="collapsed-content">
			<p id="stat-text"></p>
		</div>
	<input type="text" id="word" placeholder="your guess" pattern="[a-zA-Z]*" title="Only letters allowed" required>
	<div class="button-container">
	<button type="button" class="button yellow contained-button" onclick="javascript:hint()">Hint</button>
	<button type="submit" class="button green contained-button">Guess</button>
	</div>
	<div id="game-cont">
	</div>
	</form>
	</div>
</body>
<script>
	var coll = document.getElementsByClassName("collapsible");
	var i;

		for (i = 0; i < coll.length; i++) {
		coll[i].addEventListener("click", function() {
		let content = this.nextElementSibling;
		if (content.style.height && content.style.height !== "0px") {
			content.style.border = "0px solid var(--background-200)";
			content.style.height = "0px";
		} else {
			content.style.border = "1px solid var(--background-200)";
			content.style.height = content.scrollHeight + "px";
		}
		this.classList.toggle("collapsible-active");
	});
	}
</script>
<script>
	async function getWords(len, count) {
		try {
			const response = await fetch(`https://random-word-api.herokuapp.com/word?length=${len}&number=${count}`);
			if (!response.ok) {alert("error fetching random word"); return null;}
			const data = await response.json();
			return data;
		} catch (err) {
			alert("error fetching random word");
			return null;
		}
	}

	function shuffleA(a) {
		for (let i = a.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[a[i], a[j]] = [a[j], a[i]];
		}
	}

	const params = new URLSearchParams(window.location.search)

	if (!params.has("w")) {window.location.replace("/word-game/marathoncfg.html")}

	const wdLetters = params.get("w")
	const number = params.get("n")

	let guessedUsed = 0

	let word = ""
	let points = 0

	let wordStore = []

	async function newWord() {
		if (wordStore.length == 0) {
			wordStore = await getWords(wdLetters, 50)
		}
		word = wordStore.pop().toLowerCase()
		hintAvailable = []
		for (let i = 0; i < wdLetters; i++) {
			hintAvailable.push(i)
		}
	}

	function updateStatText() {
		document.getElementById("stat-text").innerHTML = `${wdLetters} Letters<br/>${guessedUsed}/${number} Slots Filled<br/>${points} Point(s)`
	}

	updateStatText()
	newWord()

	document.getElementById("word").setAttribute("minlength", wdLetters)
	document.getElementById("word").setAttribute("maxlength", wdLetters)

	if (number > 10) {
		document.getElementById("center-cont").style.paddingTop = `${number / 1.05}%`
		document.getElementById("center-cont").style.paddingBottom = `${number / 1.05}%`
	}

	for (let i = 0; i < number; i++) {
		document.getElementById("game-cont").innerHTML = document.getElementById("game-cont").innerHTML.concat(`<div class="word-row" id="row${i}" style="grid-template-columns: repeat(${wdLetters}, 1fr);"></div>`)
		for (let i1 = 0; i1 < wdLetters; i1++) {
			document.getElementById(`row${i}`).innerHTML = document.getElementById(`row${i}`).innerHTML.concat(`<div class="word-panel" id="row${i}-letter${i1}"><p id="row${i}-text${i1}" style="color: transparent;">A</p></div>`)
		}
	}

	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	let guessAllowed = true
	
	async function doShit() {
		if (!guessAllowed) {return}
		const guess = document.getElementById("word").value.toLowerCase()
		document.getElementById("word").value = ""

		for (let i = 0; i < wdLetters; i++) {
			document.getElementById(`row${guessedUsed}-text${i}`).innerHTML = guess.charAt(i).toUpperCase()
			document.getElementById(`row${guessedUsed}-text${i}`).style.color = "var(--text-700)"
			if (word.charAt(i) == guess.charAt(i)) {
				document.getElementById(`row${guessedUsed}-letter${i}`).classList.add("green")
			} else if (word.includes(guess.charAt(i))) {
				document.getElementById(`row${guessedUsed}-letter${i}`).classList.add("yellow")
			} else {
				document.getElementById(`row${guessedUsed}-letter${i}`).classList.add("red")
			}
		}

		guessedUsed++
		
		if (word == guess) {
			guessAllowed = false
			for (let row = 0; row < guessedUsed - 1; row++) {
			for (let i = 0; i < wdLetters; i++) {
				document.getElementById(`row${row}-letter${i}`).classList.add("clear")
			}}
			for (let i = 0; i < wdLetters; i++) {
				document.getElementById(`row${guessedUsed - 1}-letter${i}`).classList.add("clear-correct")
			}
			points++
			await sleep(1000)
			for (let row = 0; row < guessedUsed; row++) {
			for (let i = 0; i < wdLetters; i++) {
				document.getElementById(`row${row}-letter${i}`).classList.remove("green")
				document.getElementById(`row${row}-letter${i}`).classList.remove("yellow")
				document.getElementById(`row${row}-letter${i}`).classList.remove("red")
				document.getElementById(`row${row}-letter${i}`).classList.remove("clear")
				document.getElementById(`row${row}-text${i}`).innerHTML = "A"
				document.getElementById(`row${row}-text${i}`).style.color = "transparent"
			}}
			for (let i = 0; i < wdLetters; i++) {
				document.getElementById(`row${guessedUsed - 1}-letter${i}`).classList.remove("clear-correct")
				document.getElementById(`row${guessedUsed - 1}-letter${i}`).classList.remove("green")
				document.getElementById(`row${guessedUsed - 1}-text${i}`).innerHTML = "A"
				document.getElementById(`row${guessedUsed - 1}-text${i}`).style.color = "transparent"
			}
			guessedUsed = 0
			newWord()
			guessAllowed = true
		}

		updateStatText()

		if (guessedUsed == number) {
			window.location.href = `/word-game/marathon-finish.html?n=${number}&p=${points}&w=${window.btoa(word)}`
		}
	}

	let hintAvailable = []

	shuffleA(hintAvailable)

	function hint() {
		if (hintAvailable.length == 0) {
			return
		}
		const i = hintAvailable[0]
		hintAvailable.splice(0, 1)

		document.getElementById(`row${guessedUsed}-text${i}`).innerHTML = word.charAt(i).toUpperCase()
		document.getElementById(`row${guessedUsed}-text${i}`).style.color = "var(--text-400)"
	}
</script>
</html>