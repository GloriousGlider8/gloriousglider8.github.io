export const RegexOptions={NONE:0,IGNORE_CASE:1,MULTILINE:2,SINGLELINE:16};export class FuParserHost{program;getResources(){return this.program.resources}reportStatementError(e,t){let i=this.program.getLine(e.loc),r=e.loc-this.program.lineLocs[i],s=this.program.getSourceFile(i);this.reportError(s.filename,i-s.line,r,r+e.getLocLength(),t)}}export const FuToken={END_OF_FILE:0,ID:1,LITERAL_LONG:2,LITERAL_DOUBLE:3,LITERAL_CHAR:4,LITERAL_STRING:5,INTERPOLATED_STRING:6,SEMICOLON:7,DOT:8,COMMA:9,LEFT_PARENTHESIS:10,RIGHT_PARENTHESIS:11,LEFT_BRACKET:12,RIGHT_BRACKET:13,LEFT_BRACE:14,RIGHT_BRACE:15,PLUS:16,MINUS:17,ASTERISK:18,SLASH:19,MOD:20,AND:21,OR:22,XOR:23,TILDE:24,SHIFT_LEFT:25,SHIFT_RIGHT:26,EQUAL:27,NOT_EQUAL:28,LESS:29,LESS_OR_EQUAL:30,GREATER:31,GREATER_OR_EQUAL:32,RIGHT_ANGLE:33,COND_AND:34,COND_OR:35,EXCLAMATION_MARK:36,HASH:37,ASSIGN:38,ADD_ASSIGN:39,SUB_ASSIGN:40,MUL_ASSIGN:41,DIV_ASSIGN:42,MOD_ASSIGN:43,AND_ASSIGN:44,OR_ASSIGN:45,XOR_ASSIGN:46,SHIFT_LEFT_ASSIGN:47,SHIFT_RIGHT_ASSIGN:48,INCREMENT:49,DECREMENT:50,QUESTION_MARK:51,COLON:52,FAT_ARROW:53,RANGE:54,DOC_REGULAR:55,DOC_BULLET:56,DOC_BLANK:57,ABSTRACT:58,ASSERT:59,BREAK:60,CASE:61,CLASS:62,CONST:63,CONTINUE:64,DEFAULT:65,DO:66,ELSE:67,ENUM:68,FALSE:69,FOR:70,FOREACH:71,IF:72,IN:73,INTERNAL:74,IS:75,LOCK_:76,NATIVE:77,NEW:78,NULL:79,OVERRIDE:80,PROTECTED:81,PUBLIC:82,RESOURCE:83,RETURN:84,SEALED:85,STATIC:86,SWITCH:87,THROW:88,THROWS:89,TRUE:90,VIRTUAL:91,VOID:92,WHEN:93,WHILE:94,END_OF_LINE:95,PRE_UNKNOWN:96,PRE_IF:97,PRE_EL_IF:98,PRE_ELSE:99,PRE_END_IF:100};const FuPreState={NOT_YET:0,ALREADY:1,ALREADY_ELSE:2};export class FuLexer{input;#e;#t;charOffset;#i;host;loc=0;tokenLoc;lexemeOffset;currentToken;longValue;stringValue;#r=new Set;#s=!0;#a=!1;#n=!1;parsingTypeArg=!1;#h=[];setHost(e){this.host=e}addPreSymbol(e){this.#r.add(e)}open(e,t,i){this.input=t,this.#e=i,this.#t=0,this.host.program.sourceFiles.push(new FuSourceFile),this.host.program.sourceFiles.at(-1).filename=e,this.host.program.sourceFiles.at(-1).line=this.host.program.lineLocs.length,this.host.program.lineLocs.push(this.loc),this.#o(),65279==this.#i&&this.#o(),this.nextToken()}reportError(e){let t=this.host.program.sourceFiles.at(-1),i=this.host.program.lineLocs.length-t.line-1,r=this.host.program.lineLocs.at(-1);this.host.reportError(t.filename,i,this.tokenLoc-r,this.loc-r,e)}#u(){return this.#t>=this.#e?-1:this.input[this.#t++]}#c(e){let t=this.#u();if(65533!=e){if(t>=128&&t<=191)return(e<<6)+t-128;this.reportError("Invalid UTF-8")}return 65533}#o(){this.charOffset=this.#t;let e=this.#u();e>=128&&(e<194||e>244?(this.reportError("Invalid UTF-8"),e=65533):e<224?e=this.#c(e-192):e<240?(e=this.#c(e-224),e=this.#c(e)):(e=this.#c(e-240),e=this.#c(e),e=this.#c(e))),this.#i=e}peekChar(){return this.#i}static isLetterOrDigit(e){return e>=97&&e<=122||(e>=65&&e<=90||(e>=48&&e<=57||95==e))}readChar(){let e=this.#i;switch(e){case 9:case 32:this.loc++;break;case 10:this.host.program.lineLocs.push(this.loc),this.#s=!0;break;default:this.loc+=e<65536?1:2,this.#s=!1}return this.#o(),e}#l(e){return this.peekChar()==e&&(this.readChar(),!0)}#w(){for(;9==this.peekChar()||32==this.peekChar()||13==this.peekChar();)this.readChar()}#T(e){let t=!1,i=!1,r=!0;for(let s=0n;;this.readChar()){let a=this.peekChar();if(a>=48&&a<=57)a-=48;else if(a>=65&&a<=90)a-=55;else{if(!(a>=97&&a<=122)){if(95==a){r=!0;continue}return this.longValue=s,t||r?this.reportError("Invalid integer"):i&&this.reportError("Integer too big"),FuToken.LITERAL_LONG}a-=87}a>=1<<e?t=!0:s>>BigInt(64-e)!=0?i=!0:s=(s<<BigInt(e))+BigInt(a),r=!1}}#d(e){let t=!1,i=!1;for(;;){let r=this.peekChar();switch(r){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:this.readChar(),e=!1;break;case 69:case 101:if(i)return this.reportError("Invalid floating-point number"),FuToken.LITERAL_DOUBLE;e&&(t=!0),this.readChar(),r=this.peekChar(),43!=r&&45!=r||this.readChar(),i=!0,e=!0;break;case 95:this.readChar(),e=!0;break;default:return(t||e||r>=65&&r<=90||r>=97&&r<=122)&&this.reportError("Invalid floating-point number"),FuToken.LITERAL_DOUBLE}}}#p(e){let t=!1,i=!1;for(let r=!1;;this.readChar()){let s=this.peekChar();switch(s){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:s-=48;break;case 46:return this.readChar(),this.#d(!0);case 101:case 69:return this.#d(r);case 95:r=!0;continue;default:return this.longValue=e,t&&this.reportError("Leading zeros are not permitted, octal numbers must begin with 0o"),r||s>=65&&s<=90||s>=97&&s<=122?this.reportError("Invalid integer"):i&&this.reportError("Integer too big"),FuToken.LITERAL_LONG}0==e&&(t=!0),e>(s<8?922337203685477580n:922337203685477579n)?i=!0:e=10n*e+BigInt(s),r=!1}}static getEscapedChar(e){switch(e){case 34:return 34;case 39:return 39;case 92:return 92;case 110:return 10;case 114:return 13;case 116:return 9;default:return-1}}#F(){let e=this.readChar();return e<32?(this.reportError("Invalid character in literal"),65533):92!=e?e:(e=FuLexer.getEscapedChar(this.readChar()),e<0?(this.reportError("Unknown escape sequence"),65533):e)}readString(e){for(let t=this.charOffset;;)switch(this.peekChar()){case-1:return this.reportError("Unterminated string literal"),FuToken.END_OF_FILE;case 10:return this.reportError("Unterminated string literal"),this.stringValue="",FuToken.LITERAL_STRING;case 34:{let i=this.charOffset;this.readChar(),this.stringValue=(new TextDecoder).decode(this.input.subarray(t,t+i-t)),e&&(this.stringValue=this.stringValue.replaceAll("{{","{"))}return FuToken.LITERAL_STRING;case 123:if(e){let e=this.charOffset;if(this.readChar(),this.#l(123))break;if(!this.#n)return this.stringValue=(new TextDecoder).decode(this.input.subarray(t,t+e-t)).replaceAll("{{","{"),FuToken.INTERPOLATED_STRING;for(;;){let e=this.#E();if(e==FuToken.RIGHT_BRACE)break;if(e==FuToken.END_OF_FILE)return this.reportError("Unterminated string literal"),FuToken.END_OF_FILE}}else this.readChar();break;default:this.#F()}}#y(e){return this.#l(e)&&!FuLexer.isLetterOrDigit(this.peekChar())}getLexeme(){return(new TextDecoder).decode(this.input.subarray(this.lexemeOffset,this.lexemeOffset+this.charOffset-this.lexemeOffset))}#E(){for(;;){let e=this.#s;this.tokenLoc=this.loc,this.lexemeOffset=this.charOffset;let t=this.readChar();switch(t){case-1:return FuToken.END_OF_FILE;case 9:case 13:case 32:break;case 10:if(this.#a)return FuToken.END_OF_LINE;break;case 35:if(!e)return FuToken.HASH;switch(this.peekChar()){case 105:return this.readChar(),this.#y(102)?FuToken.PRE_IF:FuToken.PRE_UNKNOWN;case 101:switch(this.readChar(),this.peekChar()){case 108:switch(this.readChar(),this.peekChar()){case 105:return this.readChar(),this.#y(102)?FuToken.PRE_EL_IF:FuToken.PRE_UNKNOWN;case 115:return this.readChar(),this.#y(101)?FuToken.PRE_ELSE:FuToken.PRE_UNKNOWN;default:return FuToken.PRE_UNKNOWN}case 110:return this.readChar(),this.#l(100)&&this.#l(105)&&this.#y(102)?FuToken.PRE_END_IF:FuToken.PRE_UNKNOWN;default:return FuToken.PRE_UNKNOWN}default:return FuToken.PRE_UNKNOWN}case 59:return FuToken.SEMICOLON;case 46:return this.#l(46)?FuToken.RANGE:FuToken.DOT;case 44:return FuToken.COMMA;case 40:return FuToken.LEFT_PARENTHESIS;case 41:return FuToken.RIGHT_PARENTHESIS;case 91:return FuToken.LEFT_BRACKET;case 93:return FuToken.RIGHT_BRACKET;case 123:return FuToken.LEFT_BRACE;case 125:return FuToken.RIGHT_BRACE;case 126:return FuToken.TILDE;case 63:return FuToken.QUESTION_MARK;case 58:return FuToken.COLON;case 43:return this.#l(43)?FuToken.INCREMENT:this.#l(61)?FuToken.ADD_ASSIGN:FuToken.PLUS;case 45:return this.#l(45)?FuToken.DECREMENT:this.#l(61)?FuToken.SUB_ASSIGN:FuToken.MINUS;case 42:return this.#l(61)?FuToken.MUL_ASSIGN:FuToken.ASTERISK;case 47:if(this.#l(47)){if(t=this.readChar(),47==t&&!this.#n)switch(this.#w(),this.peekChar()){case 10:return FuToken.DOC_BLANK;case 42:return this.readChar(),this.#w(),FuToken.DOC_BULLET;default:return FuToken.DOC_REGULAR}for(;10!=t&&t>=0;)t=this.readChar();if(10==t&&this.#a)return FuToken.END_OF_LINE;break}if(this.#l(42)){let e=this.host.program.lineLocs.length;do{if(t=this.readChar(),t<0)return this.reportError(`Unterminated multi-line comment, started in line ${e}`),FuToken.END_OF_FILE}while(42!=t||47!=this.peekChar());this.readChar();break}return this.#l(61)?FuToken.DIV_ASSIGN:FuToken.SLASH;case 37:return this.#l(61)?FuToken.MOD_ASSIGN:FuToken.MOD;case 38:return this.#l(38)?FuToken.COND_AND:this.#l(61)?FuToken.AND_ASSIGN:FuToken.AND;case 124:return this.#l(124)?FuToken.COND_OR:this.#l(61)?FuToken.OR_ASSIGN:FuToken.OR;case 94:return this.#l(61)?FuToken.XOR_ASSIGN:FuToken.XOR;case 61:return this.#l(61)?FuToken.EQUAL:this.#l(62)?FuToken.FAT_ARROW:FuToken.ASSIGN;case 33:return this.#l(61)?FuToken.NOT_EQUAL:FuToken.EXCLAMATION_MARK;case 60:return this.#l(60)?this.#l(61)?FuToken.SHIFT_LEFT_ASSIGN:FuToken.SHIFT_LEFT:this.#l(61)?FuToken.LESS_OR_EQUAL:FuToken.LESS;case 62:return this.parsingTypeArg?FuToken.RIGHT_ANGLE:this.#l(62)?this.#l(61)?FuToken.SHIFT_RIGHT_ASSIGN:FuToken.SHIFT_RIGHT:this.#l(61)?FuToken.GREATER_OR_EQUAL:FuToken.GREATER;case 39:return 39==this.peekChar()?(this.reportError("Empty character literal"),this.longValue=0n):this.longValue=BigInt(this.#F()),this.#l(39)||this.reportError("Unterminated character literal"),FuToken.LITERAL_CHAR;case 34:return this.readString(!1);case 36:if(this.#l(34))return this.readString(!0);this.reportError("Expected interpolated string");break;case 48:switch(this.peekChar()){case 66:case 98:return this.readChar(),this.#T(1);case 79:case 111:return this.readChar(),this.#T(3);case 88:case 120:return this.readChar(),this.#T(4);default:return this.#p(0n)}case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.#p(BigInt(t-48));default:if(!FuLexer.isLetterOrDigit(t)){this.reportError("Invalid character");continue}for(;FuLexer.isLetterOrDigit(this.peekChar());)this.readChar();switch(this.stringValue=this.getLexeme(),this.stringValue){case"abstract":return FuToken.ABSTRACT;case"assert":return FuToken.ASSERT;case"break":return FuToken.BREAK;case"case":return FuToken.CASE;case"class":return FuToken.CLASS;case"const":return FuToken.CONST;case"continue":return FuToken.CONTINUE;case"default":return FuToken.DEFAULT;case"do":return FuToken.DO;case"else":return FuToken.ELSE;case"enum":return FuToken.ENUM;case"false":return FuToken.FALSE;case"for":return FuToken.FOR;case"foreach":return FuToken.FOREACH;case"if":return FuToken.IF;case"in":return FuToken.IN;case"internal":return FuToken.INTERNAL;case"is":return FuToken.IS;case"lock":return FuToken.LOCK_;case"native":return FuToken.NATIVE;case"new":return FuToken.NEW;case"null":return FuToken.NULL;case"override":return FuToken.OVERRIDE;case"protected":return FuToken.PROTECTED;case"public":return FuToken.PUBLIC;case"resource":return FuToken.RESOURCE;case"return":return FuToken.RETURN;case"sealed":return FuToken.SEALED;case"static":return FuToken.STATIC;case"switch":return FuToken.SWITCH;case"throw":return FuToken.THROW;case"throws":return FuToken.THROWS;case"true":return FuToken.TRUE;case"virtual":return FuToken.VIRTUAL;case"void":return FuToken.VOID;case"when":return FuToken.WHEN;case"while":return FuToken.WHILE;default:return FuToken.ID}}}}#I(){this.currentToken=this.#E()}see(e){return this.currentToken==e}static tokenToString(e){switch(e){case FuToken.END_OF_FILE:return"end-of-file";case FuToken.ID:return"identifier";case FuToken.LITERAL_LONG:return"integer constant";case FuToken.LITERAL_DOUBLE:return"floating-point constant";case FuToken.LITERAL_CHAR:return"character constant";case FuToken.LITERAL_STRING:return"string constant";case FuToken.INTERPOLATED_STRING:return"interpolated string";case FuToken.SEMICOLON:return"';'";case FuToken.DOT:return"'.'";case FuToken.COMMA:return"','";case FuToken.LEFT_PARENTHESIS:return"'('";case FuToken.RIGHT_PARENTHESIS:return"')'";case FuToken.LEFT_BRACKET:return"'['";case FuToken.RIGHT_BRACKET:return"']'";case FuToken.LEFT_BRACE:return"'{'";case FuToken.RIGHT_BRACE:return"'}'";case FuToken.PLUS:return"'+'";case FuToken.MINUS:return"'-'";case FuToken.ASTERISK:return"'*'";case FuToken.SLASH:return"'/'";case FuToken.MOD:return"'%'";case FuToken.AND:return"'&'";case FuToken.OR:return"'|'";case FuToken.XOR:return"'^'";case FuToken.TILDE:return"'~'";case FuToken.SHIFT_LEFT:return"'<<'";case FuToken.SHIFT_RIGHT:return"'>>'";case FuToken.EQUAL:return"'=='";case FuToken.NOT_EQUAL:return"'!='";case FuToken.LESS:return"'<'";case FuToken.LESS_OR_EQUAL:return"'<='";case FuToken.GREATER:return"'>'";case FuToken.GREATER_OR_EQUAL:return"'>='";case FuToken.RIGHT_ANGLE:return"'>'";case FuToken.COND_AND:return"'&&'";case FuToken.COND_OR:return"'||'";case FuToken.EXCLAMATION_MARK:return"'!'";case FuToken.HASH:return"'#'";case FuToken.ASSIGN:return"'='";case FuToken.ADD_ASSIGN:return"'+='";case FuToken.SUB_ASSIGN:return"'-='";case FuToken.MUL_ASSIGN:return"'*='";case FuToken.DIV_ASSIGN:return"'/='";case FuToken.MOD_ASSIGN:return"'%='";case FuToken.AND_ASSIGN:return"'&='";case FuToken.OR_ASSIGN:return"'|='";case FuToken.XOR_ASSIGN:return"'^='";case FuToken.SHIFT_LEFT_ASSIGN:return"'<<='";case FuToken.SHIFT_RIGHT_ASSIGN:return"'>>='";case FuToken.INCREMENT:return"'++'";case FuToken.DECREMENT:return"'--'";case FuToken.QUESTION_MARK:return"'?'";case FuToken.COLON:return"':'";case FuToken.FAT_ARROW:return"'=>'";case FuToken.RANGE:return"'..'";case FuToken.DOC_REGULAR:case FuToken.DOC_BULLET:case FuToken.DOC_BLANK:return"'///'";case FuToken.ABSTRACT:return"'abstract'";case FuToken.ASSERT:return"'assert'";case FuToken.BREAK:return"'break'";case FuToken.CASE:return"'case'";case FuToken.CLASS:return"'class'";case FuToken.CONST:return"'const'";case FuToken.CONTINUE:return"'continue'";case FuToken.DEFAULT:return"'default'";case FuToken.DO:return"'do'";case FuToken.ELSE:return"'else'";case FuToken.ENUM:return"'enum'";case FuToken.FALSE:return"'false'";case FuToken.FOR:return"'for'";case FuToken.FOREACH:return"'foreach'";case FuToken.IF:return"'if'";case FuToken.IN:return"'in'";case FuToken.INTERNAL:return"'internal'";case FuToken.IS:return"'is'";case FuToken.LOCK_:return"'lock'";case FuToken.NATIVE:return"'native'";case FuToken.NEW:return"'new'";case FuToken.NULL:return"'null'";case FuToken.OVERRIDE:return"'override'";case FuToken.PROTECTED:return"'protected'";case FuToken.PUBLIC:return"'public'";case FuToken.RESOURCE:return"'resource'";case FuToken.RETURN:return"'return'";case FuToken.SEALED:return"'sealed'";case FuToken.STATIC:return"'static'";case FuToken.SWITCH:return"'switch'";case FuToken.THROW:return"'throw'";case FuToken.THROWS:return"'throws'";case FuToken.TRUE:return"'true'";case FuToken.VIRTUAL:return"'virtual'";case FuToken.VOID:return"'void'";case FuToken.WHEN:return"'when'";case FuToken.WHILE:return"'while'";case FuToken.END_OF_LINE:return"end-of-line";case FuToken.PRE_UNKNOWN:return"unknown preprocessor directive";case FuToken.PRE_IF:return"'#if'";case FuToken.PRE_EL_IF:return"'#elif'";case FuToken.PRE_ELSE:return"'#else'";case FuToken.PRE_END_IF:return"'#endif'";default:throw new Error}}check(e){return!!this.see(e)||(this.reportError(`Expected ${FuLexer.tokenToString(e)}, got ${FuLexer.tokenToString(this.currentToken)}`),!1)}#S(e){return!!this.see(e)&&(this.#I(),!0)}#C(){if(this.#S(FuToken.EXCLAMATION_MARK))return!this.#C();if(this.#S(FuToken.LEFT_PARENTHESIS)){let e=this.#A();return this.check(FuToken.RIGHT_PARENTHESIS),this.#I(),e}if(this.see(FuToken.ID)){let e=this.#r.has(this.stringValue);return this.#I(),e}return!this.#S(FuToken.FALSE)&&(!!this.#S(FuToken.TRUE)||(this.reportError("Invalid preprocessor expression"),!1))}#_(){let e=this.#C();for(;;)if(this.#S(FuToken.EQUAL))e=e==this.#C();else{if(!this.#S(FuToken.NOT_EQUAL))return e;e=e!=this.#C()}}#f(){let e=this.#_();for(;this.#S(FuToken.COND_AND);)this.#_()||(e=!1);return e}#A(){let e=this.#f();for(;this.#S(FuToken.COND_OR);)this.#f()&&(e=!0);return e}#R(){this.#a=!0,this.#I();let e=this.#A();return this.check(FuToken.END_OF_LINE),this.#a=!1,e}#L(e){this.#a=!0;let t=this.#E();t!=FuToken.END_OF_LINE&&t!=FuToken.END_OF_FILE&&this.reportError(`Unexpected characters after '${e}'`),this.#a=!1}#N(e){return 0==this.#h.length?(this.reportError(`'${e}' with no matching '#if'`),!1):(this.#h.pop()&&"#endif"!=e&&this.reportError(`'${e}' after '#else'`),!0)}#g(e){for(this.#n=!0;;)switch(this.#E()){case FuToken.END_OF_FILE:return void this.reportError("Expected '#endif', got end-of-file");case FuToken.PRE_IF:this.#R(),this.#g(FuPreState.ALREADY);break;case FuToken.PRE_EL_IF:if(e==FuPreState.ALREADY_ELSE&&this.reportError("'#elif' after '#else'"),this.#R()&&e==FuPreState.NOT_YET)return void this.#h.push(!1);break;case FuToken.PRE_ELSE:if(e==FuPreState.ALREADY_ELSE&&this.reportError("'#else' after '#else'"),this.#L("#else"),e==FuPreState.NOT_YET)return void this.#h.push(!0);e=FuPreState.ALREADY_ELSE;break;case FuToken.PRE_END_IF:return void this.#L("#endif")}}#m(){for(;;){this.#n=!1;let e,t=this.#E();switch(t){case FuToken.END_OF_FILE:return 0!=this.#h.length&&this.reportError("Expected '#endif', got end-of-file"),FuToken.END_OF_FILE;case FuToken.PRE_IF:this.#R()?this.#h.push(!1):this.#g(FuPreState.NOT_YET);break;case FuToken.PRE_EL_IF:e=this.#N("#elif"),this.#R(),e&&this.#g(FuPreState.ALREADY);break;case FuToken.PRE_ELSE:e=this.#N("#else"),this.#L("#else"),e&&this.#g(FuPreState.ALREADY_ELSE);break;case FuToken.PRE_END_IF:this.#N("#endif"),this.#L("#endif");break;default:return t}}}nextToken(){let e=this.currentToken;return this.currentToken=this.#m(),e}eat(e){return!!this.see(e)&&(this.nextToken(),!0)}expect(e){let t=this.check(e);return this.nextToken(),t}expectOrSkip(e){if(this.check(e))this.nextToken();else do{this.nextToken()}while(!this.see(FuToken.END_OF_FILE)&&!this.eat(e))}}export const FuVisibility={PRIVATE:0,INTERNAL:1,PROTECTED:2,PUBLIC:3,NUMERIC_ELEMENT_TYPE:4,FINAL_VALUE_TYPE:5};export const FuCallType={STATIC:0,NORMAL:1,ABSTRACT:2,VIRTUAL:3,OVERRIDE:4,SEALED:5};export const FuPriority={STATEMENT:0,ARGUMENT:1,ASSIGN:2,SELECT:3,SELECT_COND:4,COND_OR:5,COND_AND:6,OR:7,XOR:8,AND:9,EQUALITY:10,REL:11,SHIFT:12,ADD:13,MUL:14,PRIMARY:15};export const FuId={NONE:0,VOID_TYPE:1,NULL_TYPE:2,BASE_PTR:3,TYPE_PARAM0:4,TYPE_PARAM0_NOT_FINAL:5,TYPE_PARAM0_PREDICATE:6,TYPE_PARAM1:7,S_BYTE_RANGE:8,BYTE_RANGE:9,SHORT_RANGE:10,U_SHORT_RANGE:11,INT_TYPE:12,N_INT_TYPE:13,LONG_TYPE:14,FLOAT_TYPE:15,DOUBLE_TYPE:16,FLOAT_INT_TYPE:17,FLOATING_TYPE:18,NUMERIC_TYPE:19,BOOL_TYPE:20,STRING_CLASS:21,STRING_PTR_TYPE:22,STRING_STORAGE_TYPE:23,MAIN_ARGS_TYPE:24,ARRAY_PTR_CLASS:25,ARRAY_STORAGE_CLASS:26,EXCEPTION_CLASS:27,LIST_CLASS:28,QUEUE_CLASS:29,STACK_CLASS:30,PRIORITY_QUEUE_CLASS:31,HASH_SET_CLASS:32,SORTED_SET_CLASS:33,DICTIONARY_CLASS:34,SORTED_DICTIONARY_CLASS:35,ORDERED_DICTIONARY_CLASS:36,TEXT_WRITER_CLASS:37,STRING_WRITER_CLASS:38,REGEX_OPTIONS_ENUM:39,REGEX_CLASS:40,MATCH_CLASS:41,JSON_ELEMENT_CLASS:42,LOCK_CLASS:43,STRING_LENGTH:44,ARRAY_LENGTH:45,CONSOLE_ERROR:46,MAIN:47,CLASS_TO_STRING:48,MATCH_START:49,MATCH_END:50,MATCH_LENGTH:51,MATCH_VALUE:52,MATH_NA_N:53,MATH_NEGATIVE_INFINITY:54,MATH_POSITIVE_INFINITY:55,ENUM_FROM_INT:56,ENUM_HAS_FLAG:57,ENUM_TO_INT:58,INT_TRY_PARSE:59,N_INT_TRY_PARSE:60,LONG_TRY_PARSE:61,DOUBLE_TRY_PARSE:62,STRING_CONTAINS:63,STRING_ENDS_WITH:64,STRING_INDEX_OF:65,STRING_LAST_INDEX_OF:66,STRING_REPLACE:67,STRING_STARTS_WITH:68,STRING_SUBSTRING:69,STRING_TO_LOWER:70,STRING_TO_UPPER:71,ARRAY_BINARY_SEARCH_ALL:72,ARRAY_BINARY_SEARCH_PART:73,ARRAY_CONTAINS:74,ARRAY_COPY_TO:75,ARRAY_FILL_ALL:76,ARRAY_FILL_PART:77,ARRAY_SORT_ALL:78,ARRAY_SORT_PART:79,LIST_ADD:80,LIST_ADD_RANGE:81,LIST_ALL:82,LIST_ANY:83,LIST_CLEAR:84,LIST_CONTAINS:85,LIST_COPY_TO:86,LIST_COUNT:87,LIST_INDEX_OF:88,LIST_INSERT:89,LIST_LAST:90,LIST_REMOVE_AT:91,LIST_REMOVE_RANGE:92,LIST_SORT_ALL:93,LIST_SORT_PART:94,QUEUE_CLEAR:95,QUEUE_COUNT:96,QUEUE_DEQUEUE:97,QUEUE_ENQUEUE:98,QUEUE_PEEK:99,STACK_CLEAR:100,STACK_COUNT:101,STACK_PEEK:102,STACK_PUSH:103,STACK_POP:104,PRIORITY_QUEUE_CLEAR:105,PRIORITY_QUEUE_COUNT:106,PRIORITY_QUEUE_DEQUEUE:107,PRIORITY_QUEUE_ENQUEUE:108,PRIORITY_QUEUE_PEEK:109,HASH_SET_ADD:110,HASH_SET_CLEAR:111,HASH_SET_CONTAINS:112,HASH_SET_COUNT:113,HASH_SET_REMOVE:114,SORTED_SET_ADD:115,SORTED_SET_CLEAR:116,SORTED_SET_CONTAINS:117,SORTED_SET_COUNT:118,SORTED_SET_REMOVE:119,DICTIONARY_ADD:120,DICTIONARY_CLEAR:121,DICTIONARY_CONTAINS_KEY:122,DICTIONARY_COUNT:123,DICTIONARY_REMOVE:124,SORTED_DICTIONARY_CLEAR:125,SORTED_DICTIONARY_CONTAINS_KEY:126,SORTED_DICTIONARY_COUNT:127,SORTED_DICTIONARY_REMOVE:128,ORDERED_DICTIONARY_CLEAR:129,ORDERED_DICTIONARY_CONTAINS_KEY:130,ORDERED_DICTIONARY_COUNT:131,ORDERED_DICTIONARY_REMOVE:132,TEXT_WRITER_WRITE:133,TEXT_WRITER_WRITE_CHAR:134,TEXT_WRITER_WRITE_CODE_POINT:135,TEXT_WRITER_WRITE_LINE:136,CONSOLE_WRITE:137,CONSOLE_WRITE_LINE:138,STRING_WRITER_CLEAR:139,STRING_WRITER_TO_STRING:140,CONVERT_TO_BASE64_STRING:141,U_T_F8_GET_BYTE_COUNT:142,U_T_F8_GET_BYTES:143,U_T_F8_GET_STRING:144,ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:145,REGEX_COMPILE:146,REGEX_ESCAPE:147,REGEX_IS_MATCH_STR:148,REGEX_IS_MATCH_REGEX:149,MATCH_FIND_STR:150,MATCH_FIND_REGEX:151,MATCH_GET_CAPTURE:152,JSON_ELEMENT_PARSE:153,JSON_ELEMENT_IS_OBJECT:154,JSON_ELEMENT_IS_ARRAY:155,JSON_ELEMENT_IS_STRING:156,JSON_ELEMENT_IS_NUMBER:157,JSON_ELEMENT_IS_BOOLEAN:158,JSON_ELEMENT_IS_NULL:159,JSON_ELEMENT_GET_OBJECT:160,JSON_ELEMENT_GET_ARRAY:161,JSON_ELEMENT_GET_STRING:162,JSON_ELEMENT_GET_DOUBLE:163,JSON_ELEMENT_GET_BOOLEAN:164,MATH_METHOD:165,MATH_ABS:166,MATH_CEILING:167,MATH_CLAMP:168,MATH_FUSED_MULTIPLY_ADD:169,MATH_IS_FINITE:170,MATH_IS_INFINITY:171,MATH_IS_NA_N:172,MATH_LOG2:173,MATH_MAX:174,MATH_MIN:175,MATH_ROUND:176,MATH_TRUNCATE:177};export class FuDocInline{}export class FuDocText extends FuDocInline{text}export class FuDocCode extends FuDocInline{text}export class FuDocLine extends FuDocInline{}export class FuDocBlock{}export class FuDocPara extends FuDocBlock{children=[]}export class FuDocList extends FuDocBlock{items=[]}export class FuCodeDoc{summary=new FuDocPara;details=[]}export class FuVisitor{visitOptionalStatement(e){null!=e&&e.acceptStatement(this)}}export class FuStatement{loc=0;getLocLength(){return 0}}export class FuExpr extends FuStatement{type;completesNormally(){return!0}toString(){throw new Error}isIndexing(){return!1}isLiteralZero(){return!1}isConstEnum(){return!1}intValue(){throw new Error}accept(e,t){throw new Error}acceptStatement(e){e.visitExpr(this)}isReferenceTo(e){return!1}isNewString(e){return!1}isUnique(){return!1}setShared(){}}export class FuName extends FuExpr{name="";getLocLength(){return this.name.length}}export class FuSymbol extends FuName{id=FuId.NONE;next;parent;documentation=null;getSymbol(){return this}toString(){return this.name}}export class FuScope extends FuSymbol{dict={};first=null;last=null;count(){return Object.keys(this.dict).length}contains(e){return this.dict.hasOwnProperty(e.name)}tryLookup(e,t){for(let i=this;null!=i&&(t||!(i instanceof FuProgram||i instanceof FuSystem));i=i.parent)if(i.dict.hasOwnProperty(e))return i.dict[e];return null}addToList(e){e.next=null,e.parent=this,null==this.first?this.first=e:this.last.next=e,this.last=e}add(e){this.dict[e.name]=e,this.addToList(e)}encloses(e){for(let t=e.parent;null!=t;t=t.parent)if(t==this)return!0;return!1}}export class FuAggregateInitializer extends FuExpr{items=[];accept(e,t){e.visitAggregateInitializer(this)}}export class FuLiteral extends FuExpr{getLiteralString(){throw new Error}}class FuLiteralNull extends FuLiteral{getLocLength(){return 4}isDefaultValue(){return!0}accept(e,t){e.visitLiteralNull()}isUnique(){return!0}toString(){return"null"}}class FuLiteralFalse extends FuLiteral{getLocLength(){return 5}isDefaultValue(){return!0}accept(e,t){e.visitLiteralFalse()}toString(){return"false"}}class FuLiteralTrue extends FuLiteral{getLocLength(){return 4}isDefaultValue(){return!1}accept(e,t){e.visitLiteralTrue()}toString(){return"true"}}class FuLiteralLong extends FuLiteral{value;isLiteralZero(){return 0==this.value}intValue(){return Number(this.value)}isDefaultValue(){return 0==this.value}accept(e,t){e.visitLiteralLong(this.value)}getLiteralString(){return`${this.value}`}toString(){return`${this.value}`}}class FuLiteralChar extends FuLiteralLong{static new(e,t){return Object.assign(new FuLiteralChar,{loc:t,type:FuRangeType.new(e,e),value:BigInt(e)})}getLocLength(){return this.value>=65536||10==this.value||13==this.value||9==this.value||92==this.value||39==this.value?4:3}accept(e,t){e.visitLiteralChar(Number(this.value))}}class FuLiteralDouble extends FuLiteral{value;isDefaultValue(){return 0==this.value&&1/this.value>0}accept(e,t){e.visitLiteralDouble(this.value)}getLiteralString(){return`${this.value}`}toString(){return`${this.value}`}}class FuLiteralString extends FuLiteral{value;isDefaultValue(){return!1}getLocLength(){return this.value.length+2}accept(e,t){e.visitLiteralString(this.value)}getLiteralString(){return this.value}toString(){return`"${this.value}"`}getAsciiLength(){let e=0,t=!1;for(const i of this.value){if(i.codePointAt(0)<0||i.codePointAt(0)>127)return-1;t||92!=i.codePointAt(0)?(e++,t=!1):t=!0}return e}getAsciiAt(e){let t=!1;for(const i of this.value){if(i.codePointAt(0)<0||i.codePointAt(0)>127)return-1;if(t||92!=i.codePointAt(0)){if(0==e)return t?FuLexer.getEscapedChar(i.codePointAt(0)):i.codePointAt(0);e--,t=!1}else t=!0}return-1}getOneAscii(){switch(this.value.length){case 1:let e=this.value.charCodeAt(0);return e>=0&&e<=127?e:-1;case 2:return 92==this.value.charCodeAt(0)?FuLexer.getEscapedChar(this.value.charCodeAt(1)):-1;default:return-1}}}export class FuInterpolatedPart{prefix;argument;widthExpr;width;format;precision}export class FuInterpolatedString extends FuExpr{parts=[];suffix;addPart(e,t,i=null,r=32,s=-1){this.parts.push(new FuInterpolatedPart);let a=this.parts.at(-1);a.prefix=e,a.argument=t,a.widthExpr=i,a.format=r,a.precision=s}getLocLength(){return 2}accept(e,t){e.visitInterpolatedString(this,t)}isNewString(e){return!0}}class FuImplicitEnumValue extends FuExpr{value;intValue(){return this.value}}export class FuSymbolReference extends FuName{left=null;symbol;isConstEnum(){return this.symbol.parent instanceof FuEnum}intValue(){return this.symbol.value.intValue()}accept(e,t){e.visitSymbolReference(this,t)}isReferenceTo(e){return this.symbol==e}isNewString(e){return this.symbol.id==FuId.MATCH_VALUE}setShared(){let e,t;(e=this.symbol)instanceof FuNamedValue&&(t=e.type)instanceof FuDynamicPtrType&&(t.unique=!1)}getSymbol(){return this.symbol}toString(){return null!=this.left?`${this.left}.${this.name}`:this.name}}export class FuUnaryExpr extends FuExpr{op;inner;getLocLength(){switch(this.op){case FuToken.INCREMENT:case FuToken.DECREMENT:return 2;case FuToken.MINUS:case FuToken.TILDE:case FuToken.EXCLAMATION_MARK:case FuToken.HASH:case FuToken.QUESTION_MARK:return 1;case FuToken.NEW:return 3;case FuToken.RESOURCE:return 8;default:throw new Error}}}export class FuPrefixExpr extends FuUnaryExpr{isConstEnum(){return this.type instanceof FuEnumFlags&&this.inner.isConstEnum()}intValue(){return console.assert(this.op==FuToken.TILDE),~this.inner.intValue()}accept(e,t){e.visitPrefixExpr(this,t)}isUnique(){return this.op==FuToken.NEW&&!(this.inner instanceof FuAggregateInitializer)}}export class FuPostfixExpr extends FuUnaryExpr{accept(e,t){e.visitPostfixExpr(this,t)}}export class FuBinaryExpr extends FuExpr{left;op;right;getLocLength(){switch(this.op){case FuToken.PLUS:case FuToken.MINUS:case FuToken.ASTERISK:case FuToken.SLASH:case FuToken.MOD:case FuToken.LESS:case FuToken.GREATER:case FuToken.AND:case FuToken.OR:case FuToken.XOR:case FuToken.ASSIGN:case FuToken.LEFT_BRACKET:case FuToken.LEFT_BRACE:return 1;case FuToken.SHIFT_LEFT:case FuToken.SHIFT_RIGHT:case FuToken.LESS_OR_EQUAL:case FuToken.GREATER_OR_EQUAL:case FuToken.EQUAL:case FuToken.NOT_EQUAL:case FuToken.COND_AND:case FuToken.COND_OR:case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:case FuToken.RANGE:case FuToken.IS:return 2;case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:return 3;case FuToken.WHEN:return 0;default:throw new Error}}isIndexing(){return this.op==FuToken.LEFT_BRACKET}isConstEnum(){switch(this.op){case FuToken.AND:case FuToken.OR:case FuToken.XOR:return this.type instanceof FuEnumFlags&&this.left.isConstEnum()&&this.right.isConstEnum();default:return!1}}intValue(){switch(this.op){case FuToken.AND:return this.left.intValue()&this.right.intValue();case FuToken.OR:return this.left.intValue()|this.right.intValue();case FuToken.XOR:return this.left.intValue()^this.right.intValue();default:throw new Error}}accept(e,t){e.visitBinaryExpr(this,t)}isNewString(e){return this.op==FuToken.PLUS&&this.type.id==FuId.STRING_STORAGE_TYPE}isRel(){switch(this.op){case FuToken.EQUAL:case FuToken.NOT_EQUAL:case FuToken.LESS:case FuToken.LESS_OR_EQUAL:case FuToken.GREATER:case FuToken.GREATER_OR_EQUAL:return!0;default:return!1}}isAssign(){switch(this.op){case FuToken.ASSIGN:case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:return!0;default:return!1}}getOpString(){switch(this.op){case FuToken.PLUS:return"+";case FuToken.MINUS:return"-";case FuToken.ASTERISK:return"*";case FuToken.SLASH:return"/";case FuToken.MOD:return"%";case FuToken.SHIFT_LEFT:return"<<";case FuToken.SHIFT_RIGHT:return">>";case FuToken.LESS:return"<";case FuToken.LESS_OR_EQUAL:return"<=";case FuToken.GREATER:return">";case FuToken.GREATER_OR_EQUAL:return">=";case FuToken.EQUAL:return"==";case FuToken.NOT_EQUAL:return"!=";case FuToken.AND:return"&";case FuToken.OR:return"|";case FuToken.XOR:return"^";case FuToken.COND_AND:return"&&";case FuToken.COND_OR:return"||";case FuToken.ASSIGN:return"=";case FuToken.ADD_ASSIGN:return"+=";case FuToken.SUB_ASSIGN:return"-=";case FuToken.MUL_ASSIGN:return"*=";case FuToken.DIV_ASSIGN:return"/=";case FuToken.MOD_ASSIGN:return"%=";case FuToken.SHIFT_LEFT_ASSIGN:return"<<=";case FuToken.SHIFT_RIGHT_ASSIGN:return">>=";case FuToken.AND_ASSIGN:return"&=";case FuToken.OR_ASSIGN:return"|=";case FuToken.XOR_ASSIGN:return"^=";default:throw new Error}}toString(){return this.op==FuToken.LEFT_BRACKET?`${this.left}[${this.right}]`:`(${this.left} ${this.getOpString()} ${this.right})`}}export class FuSelectExpr extends FuExpr{cond;onTrue;onFalse;getLocLength(){return 1}accept(e,t){e.visitSelectExpr(this,t)}isUnique(){return this.onTrue.isUnique()&&this.onFalse.isUnique()}setShared(){this.onTrue.setShared(),this.onFalse.setShared()}toString(){return`(${this.cond} ? ${this.onTrue} : ${this.onFalse})`}}export class FuCallExpr extends FuExpr{method;arguments_=[];accept(e,t){e.visitCallExpr(this,t)}isNewString(e){return this.type.id==FuId.STRING_STORAGE_TYPE&&this.method.symbol.id!=FuId.LIST_LAST&&this.method.symbol.id!=FuId.QUEUE_PEEK&&this.method.symbol.id!=FuId.STACK_PEEK&&(e||this.method.symbol.id!=FuId.STRING_SUBSTRING||1!=this.arguments_.length)}toString(){return this.method.name}}class FuLambdaExpr extends FuScope{body;accept(e,t){e.visitLambdaExpr(this)}}export class FuCondCompletionStatement extends FuScope{#P;completesNormally(){return this.#P}setCompletesNormally(e){this.#P=e}}export class FuBlock extends FuCondCompletionStatement{statements=[];acceptStatement(e){e.visitBlock(this)}}export class FuAssert extends FuStatement{cond;message=null;getLocLength(){return 6}completesNormally(){return!(this.cond instanceof FuLiteralFalse)}acceptStatement(e){e.visitAssert(this)}}export class FuLoop extends FuCondCompletionStatement{cond;body;hasBreak=!1}class FuBreak extends FuStatement{loopOrSwitch;getLocLength(){return 5}completesNormally(){return!1}acceptStatement(e){e.visitBreak(this)}}class FuContinue extends FuStatement{loop;getLocLength(){return 8}completesNormally(){return!1}acceptStatement(e){e.visitContinue(this)}}class FuDoWhile extends FuLoop{getLocLength(){return 2}acceptStatement(e){e.visitDoWhile(this)}}class FuFor extends FuLoop{init;advance;isRange=!1;isIndVarUsed;rangeStep;getLocLength(){return 3}acceptStatement(e){e.visitFor(this)}}class FuForeach extends FuLoop{collection;getLocLength(){return 7}acceptStatement(e){e.visitForeach(this)}getVar(){return this.first}getValueVar(){return this.getVar().nextVar()}}class FuIf extends FuCondCompletionStatement{cond;onTrue;onFalse;getLocLength(){return 2}acceptStatement(e){e.visitIf(this)}}class FuLock extends FuStatement{lock;body;getLocLength(){return 4}completesNormally(){return this.body.completesNormally()}acceptStatement(e){e.visitLock(this)}}export class FuNative extends FuSymbol{content;getLocLength(){return 6}completesNormally(){return!0}acceptStatement(e){e.visitNative(this)}getFollowingMember(){for(let e=this.next;null!=e;e=e.next){let t;if((t=e)instanceof FuMember)return t}return null}}class FuReturn extends FuScope{value;getLocLength(){return 6}completesNormally(){return!1}acceptStatement(e){e.visitReturn(this)}}export class FuCase{values=[];body=[]}export class FuSwitch extends FuCondCompletionStatement{value;cases=[];defaultBody=[];getLocLength(){return 6}acceptStatement(e){e.visitSwitch(this)}isTypeMatching(){let e;return(e=this.value.type)instanceof FuClassType&&e.class.id!=FuId.STRING_CLASS}hasWhen(){return this.cases.some((e=>e.values.some((e=>{let t;return(t=e)instanceof FuBinaryExpr&&t.op==FuToken.WHEN}))))}static lengthWithoutTrailingBreak(e){let t=e.length;return t>0&&e[t-1]instanceof FuBreak&&t--,t}hasDefault(){return FuSwitch.lengthWithoutTrailingBreak(this.defaultBody)>0}static#k(e){if(e instanceof FuBreak)return!0;if(e instanceof FuIf){const t=e;return FuSwitch.#k(t.onTrue)||null!=t.onFalse&&FuSwitch.#k(t.onFalse)}if(e instanceof FuBlock){return e.statements.some((e=>FuSwitch.#k(e)))}return!1}static hasEarlyBreak(e){let t=FuSwitch.lengthWithoutTrailingBreak(e);for(let i=0;i<t;i++)if(FuSwitch.#k(e[i]))return!0;return!1}static#b(e){return e.some((e=>FuSwitch.#O(e)))}static#O(e){if(e instanceof FuContinue)return!0;if(e instanceof FuIf){const t=e;return FuSwitch.#O(t.onTrue)||null!=t.onFalse&&FuSwitch.#O(t.onFalse)}if(e instanceof FuSwitch){const t=e;return t.cases.some((e=>FuSwitch.#b(e.body)))||FuSwitch.#b(t.defaultBody)}if(e instanceof FuBlock){const t=e;return FuSwitch.#b(t.statements)}return!1}static hasEarlyBreakAndContinue(e){return FuSwitch.hasEarlyBreak(e)&&FuSwitch.#b(e)}}export class FuThrow extends FuStatement{class;message;getLocLength(){return 5}completesNormally(){return!1}acceptStatement(e){e.visitThrow(this)}}class FuWhile extends FuLoop{getLocLength(){return 5}acceptStatement(e){e.visitWhile(this)}}export class FuParameters extends FuScope{}export class FuType extends FuScope{nullable=!1;getArraySuffix(){return""}isAssignableFrom(e){return this==e}equalsType(e){return this==e}isArray(){return!1}isFinal(){return!1}getBaseType(){return this}getStorageType(){return this}asClassType(){return this}}class FuNumericType extends FuType{}class FuIntegerType extends FuNumericType{isAssignableFrom(e){return e instanceof FuIntegerType||e.id==FuId.FLOAT_INT_TYPE}}class FuRangeType extends FuIntegerType{min;max;static#M(e,t,i){let r=e.min==e.max?e:Object.assign(new FuRangeType,{min:i,max:i});e.add(Object.assign(new FuConst,{visibility:FuVisibility.PUBLIC,name:t,value:Object.assign(new FuLiteralLong,{type:r,value:BigInt(i)}),visitStatus:FuVisitStatus.DONE}))}static new(e,t){console.assert(e<=t);let i=Object.assign(new FuRangeType,{id:e>=0&&t<=255?FuId.BYTE_RANGE:e>=-128&&t<=127?FuId.S_BYTE_RANGE:e>=-32768&&t<=32767?FuId.SHORT_RANGE:e>=0&&t<=65535?FuId.U_SHORT_RANGE:FuId.INT_TYPE,min:e,max:t});return FuRangeType.#M(i,"MinValue",e),FuRangeType.#M(i,"MaxValue",t),i}toString(){return this.min==this.max?`${this.min}`:`(${this.min} .. ${this.max})`}isAssignableFrom(e){if(e instanceof FuRangeType){const t=e;return this.min<=t.max&&this.max>=t.min}return e instanceof FuIntegerType||e.id==FuId.FLOAT_INT_TYPE}equalsType(e){let t;return(t=e)instanceof FuRangeType&&this.min==t.min&&this.max==t.max}static getMask(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16}getVariableBits(){return FuRangeType.getMask(this.min^this.max)}}class FuFloatingType extends FuNumericType{isAssignableFrom(e){return e instanceof FuNumericType}}export class FuNamedValue extends FuSymbol{typeExpr;value;isAssignableStorage(){return!(!(this.type instanceof FuStorageType)||this.type instanceof FuArrayStorageType||null==this.value||this.value instanceof FuSymbolReference||this.value instanceof FuAggregateInitializer)}}export class FuMember extends FuNamedValue{constructor(){super()}visibility;startLine;startColumn;endLine;endColumn}export class FuVar extends FuNamedValue{isAssigned=!1;static new(e,t,i=null){return Object.assign(new FuVar,{type:e,name:t,value:i})}accept(e,t){e.visitVar(this)}nextVar(){return this.next}}const FuVisitStatus={NOT_YET:0,IN_PROGRESS:1,DONE:2};export class FuConst extends FuMember{inMethod;inMethodIndex=0;visitStatus;acceptStatement(e){e.visitConst(this)}isStatic(){return!0}}export class FuField extends FuMember{isStatic(){return!1}}class FuProperty extends FuMember{isStatic(){return!1}static new(e,t,i){return Object.assign(new FuProperty,{visibility:FuVisibility.PUBLIC,type:e,id:t,name:i})}}class FuStaticProperty extends FuMember{isStatic(){return!0}static new(e,t,i){return Object.assign(new FuStaticProperty,{visibility:FuVisibility.PUBLIC,type:e,id:t,name:i})}}export class FuThrowsDeclaration extends FuSymbolReference{documentation}export class FuMethodBase extends FuMember{parameters=new FuParameters;throws=[];body;isLive=!1;calls=new Set;isStatic(){return!1}addThis(e,t){let i=t?new FuReadWriteClassType:new FuClassType;i.class=e,this.parameters.add(FuVar.new(i,"this"))}isMutator(){return this.parameters.first.type instanceof FuReadWriteClassType}}export class FuMethod extends FuMethodBase{callType;static new(e,t,i,r,s,a,n,h=null,o=null,u=null,c=null){let l=Object.assign(new FuMethod,{visibility:t,callType:i,type:r,id:s,name:a});return i!=FuCallType.STATIC&&l.addThis(e,n),null!=h&&(l.parameters.add(h),null!=o&&(l.parameters.add(o),null!=u&&(l.parameters.add(u),null!=c&&l.parameters.add(c)))),l}isStatic(){return this.callType==FuCallType.STATIC}isAbstractOrVirtual(){return this.callType==FuCallType.ABSTRACT||this.callType==FuCallType.VIRTUAL}isAbstractVirtualOrOverride(){return this.callType==FuCallType.ABSTRACT||this.callType==FuCallType.VIRTUAL||this.callType==FuCallType.OVERRIDE}static callTypeToString(e){switch(e){case FuCallType.STATIC:return"static";case FuCallType.ABSTRACT:return"abstract";case FuCallType.VIRTUAL:return"virtual";case FuCallType.OVERRIDE:return"override";case FuCallType.SEALED:return"sealed";default:throw new Error}}firstParameter(){let e=this.parameters.first;return this.isStatic()?e:e.nextVar()}getParametersCount(){let e=this.parameters.count();return this.isStatic()?e:e-1}getDeclaringMethod(){let e=this;for(;e.callType==FuCallType.OVERRIDE;){let t=e.parent.parent.tryLookup(e.name,!1);e=t}return e}}class FuMethodGroup extends FuMember{constructor(){super()}methods=new Array(2);isStatic(){throw new Error}static new(e,t){let i=Object.assign(new FuMethodGroup,{visibility:e.visibility,name:e.name});return i.methods[0]=e,i.methods[1]=t,i}}export class FuContainerType extends FuType{isPublic;startLine;startColumn;endLine;endColumn}export class FuEnum extends FuContainerType{hasExplicitValue=!1;getFirstValue(){let e=this.first;for(;!(e instanceof FuConst);)e=e.next;return e}acceptValues(e){let t=null;for(let i=this.first;null!=i;i=i.next){let r;(r=i)instanceof FuConst&&(e.visitEnumValue(r,t),t=r)}}}class FuEnumFlags extends FuEnum{}export class FuClass extends FuContainerType{callType;typeParameterCount=0;hasSubclasses=!1;baseClass=new FuSymbolReference;constructor_;constArrays=[];cppFriends=new Set;#D=[];hasBaseClass(){return this.baseClass.name.length>0}addsVirtualMethods(){for(let e=this.first;null!=e;e=e.next){let t;if((t=e)instanceof FuMethod&&t.isAbstractOrVirtual())return!0}return!1}static new(e,t,i,r=0){return Object.assign(new FuClass,{callType:e,id:t,name:i,typeParameterCount:r})}addMethod(e,t,i,r,s=null,a=null,n=null,h=null){this.add(FuMethod.new(this,FuVisibility.PUBLIC,FuCallType.NORMAL,e,t,i,r,s,a,n,h))}addStaticMethod(e,t,i,r,s=null,a=null){this.add(FuMethod.new(this,FuVisibility.PUBLIC,FuCallType.STATIC,e,t,i,!1,r,s,a))}addNative(e){this.addToList(e),this.#D.push(e)}isSameOrBaseOf(e){for(;e!=this;){let t;if(!((t=e.parent)instanceof FuClass))return!1;e=t}return!0}hasToString(){let e;return(e=this.tryLookup("ToString",!1))instanceof FuMethod&&e.id==FuId.CLASS_TO_STRING}addsToString(){let e;return this.dict.hasOwnProperty("ToString")&&(e=this.dict.ToString)instanceof FuMethod&&e.id==FuId.CLASS_TO_STRING&&e.callType!=FuCallType.OVERRIDE&&e.callType!=FuCallType.SEALED}}export class FuClassType extends FuType{class;typeArg0;typeArg1;getElementType(){return this.typeArg0}getKeyType(){return this.typeArg0}getValueType(){return this.typeArg1}isArray(){return this.class.id==FuId.ARRAY_PTR_CLASS||this.class.id==FuId.ARRAY_STORAGE_CLASS}getBaseType(){return this.isArray()?this.getElementType().getBaseType():this}equalTypeArguments(e){switch(this.class.typeParameterCount){case 0:return!0;case 1:return this.typeArg0.equalsType(e.typeArg0);case 2:return this.typeArg0.equalsType(e.typeArg0)&&this.typeArg1.equalsType(e.typeArg1);default:throw new Error}}isAssignableFromClass(e){return this.class.isSameOrBaseOf(e.class)&&this.equalTypeArguments(e)}isAssignableFrom(e){let t;return this.nullable&&e.id==FuId.NULL_TYPE||(t=e)instanceof FuClassType&&this.isAssignableFromClass(t)}equalsTypeInternal(e){return this.nullable==e.nullable&&this.class==e.class&&this.equalTypeArguments(e)}equalsType(e){let t;return(t=e)instanceof FuClassType&&!(e instanceof FuReadWriteClassType)&&this.equalsTypeInternal(t)}getArraySuffix(){return this.isArray()?"[]":""}getClassSuffix(){return""}#x(){return this.nullable?"?":""}toString(){if(this.isArray())return`${this.getElementType().getBaseType()}${this.getArraySuffix()}${this.#x()}${this.getElementType().getArraySuffix()}`;switch(this.class.typeParameterCount){case 0:return`${this.class.name}${this.getClassSuffix()}${this.#x()}`;case 1:return`${this.class.name}<${this.typeArg0}>${this.getClassSuffix()}${this.#x()}`;case 2:return`${this.class.name}<${this.typeArg0}, ${this.typeArg1}>${this.getClassSuffix()}${this.#x()}`;default:throw new Error}}}export class FuReadWriteClassType extends FuClassType{isAssignableFrom(e){let t;return this.nullable&&e.id==FuId.NULL_TYPE||(t=e)instanceof FuReadWriteClassType&&this.isAssignableFromClass(t)}equalsType(e){let t;return(t=e)instanceof FuReadWriteClassType&&!(e instanceof FuOwningType)&&this.equalsTypeInternal(t)}getArraySuffix(){return this.isArray()?"[]!":""}getClassSuffix(){return"!"}}export class FuOwningType extends FuReadWriteClassType{}export class FuStorageType extends FuOwningType{isFinal(){return this.class.id!=FuId.MATCH_CLASS}isAssignableFrom(e){let t;return(t=e)instanceof FuStorageType&&this.class==t.class&&this.equalTypeArguments(t)}equalsType(e){let t;return(t=e)instanceof FuStorageType&&this.equalsTypeInternal(t)}getClassSuffix(){return"()"}}class FuDynamicPtrType extends FuOwningType{unique=!1;isAssignableFrom(e){let t;return this.nullable&&e.id==FuId.NULL_TYPE||(t=e)instanceof FuDynamicPtrType&&this.isAssignableFromClass(t)}equalsType(e){let t;return(t=e)instanceof FuDynamicPtrType&&this.equalsTypeInternal(t)}getArraySuffix(){return this.isArray()?"[]#":""}getClassSuffix(){return"#"}}export class FuArrayStorageType extends FuStorageType{lengthExpr;length;ptrTaken=!1;getBaseType(){return this.getElementType().getBaseType()}isArray(){return!0}getArraySuffix(){return`[${this.length}]`}equalsType(e){let t;return(t=e)instanceof FuArrayStorageType&&this.getElementType().equalsType(t.getElementType())&&this.length==t.length}getStorageType(){return this.getElementType().getStorageType()}}class FuStringType extends FuClassType{}class FuStringStorageType extends FuStringType{isAssignableFrom(e){return e instanceof FuStringType}getClassSuffix(){return"()"}}class FuPrintableType extends FuType{isAssignableFrom(e){if(e instanceof FuNumericType||e instanceof FuStringType)return!0;if(e instanceof FuClassType){return e.class.hasToString()}return!1}}export class FuSystem extends FuScope{constructor(){super(),this.parent=null;let e=FuVar.new(null,"base");e.id=FuId.BASE_PTR,this.add(e),this.#M(this.intType,-2147483648n,2147483647n),this.intType.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.INT_TRY_PARSE,"TryParse",!0,FuVar.new(this.stringPtrType,"value"),FuVar.new(this.intType,"radix",this.newLiteralLong(0n)))),this.add(this.intType),this.#G.name="uint",this.add(this.#G),this.nIntType.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.N_INT_TRY_PARSE,"TryParse",!0,FuVar.new(this.stringPtrType,"value"),FuVar.new(this.intType,"radix",this.newLiteralLong(0n)))),this.add(this.nIntType),this.#M(this.longType,-9223372036854775808n,9223372036854775807n),this.longType.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.LONG_TRY_PARSE,"TryParse",!0,FuVar.new(this.stringPtrType,"value"),FuVar.new(this.intType,"radix",this.newLiteralLong(0n)))),this.add(this.longType),this.byteType.name="byte",this.add(this.byteType);let t=FuRangeType.new(-32768,32767);t.name="short",this.add(t);let i=FuRangeType.new(0,65535);i.name="ushort",this.add(i),this.add(this.floatType),this.doubleType.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.DOUBLE_TRY_PARSE,"TryParse",!0,FuVar.new(this.stringPtrType,"value"))),this.add(this.doubleType),this.add(this.boolType),this.#U.addMethod(this.boolType,FuId.STRING_CONTAINS,"Contains",!1,FuVar.new(this.stringPtrType,"value")),this.#U.addMethod(this.boolType,FuId.STRING_ENDS_WITH,"EndsWith",!1,FuVar.new(this.stringPtrType,"value")),this.#U.addMethod(this.nIntType,FuId.STRING_INDEX_OF,"IndexOf",!1,FuVar.new(this.stringPtrType,"value")),this.#U.addMethod(this.nIntType,FuId.STRING_LAST_INDEX_OF,"LastIndexOf",!1,FuVar.new(this.stringPtrType,"value")),this.#U.add(FuProperty.new(this.nIntType,FuId.STRING_LENGTH,"Length")),this.#U.addMethod(this.stringStorageType,FuId.STRING_REPLACE,"Replace",!1,FuVar.new(this.stringPtrType,"oldValue"),FuVar.new(this.stringPtrType,"newValue")),this.#U.addMethod(this.boolType,FuId.STRING_STARTS_WITH,"StartsWith",!1,FuVar.new(this.stringPtrType,"value")),this.#U.addMethod(this.stringStorageType,FuId.STRING_SUBSTRING,"Substring",!1,FuVar.new(this.nIntType,"offset"),FuVar.new(this.nIntType,"length",this.newLiteralLong(-1n))),this.#U.addMethod(this.stringStorageType,FuId.STRING_TO_LOWER,"ToLower",!1),this.#U.addMethod(this.stringStorageType,FuId.STRING_TO_UPPER,"ToUpper",!1),this.stringPtrType.class=this.#U,this.add(this.stringPtrType),this.stringNullablePtrType.class=this.#U,this.stringStorageType.class=this.#U;let r=FuMethod.new(null,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.nIntType,FuId.ARRAY_BINARY_SEARCH_PART,"BinarySearch",!1,FuVar.new(this.#v,"value"),FuVar.new(this.nIntType,"startIndex"),FuVar.new(this.nIntType,"count"));this.arrayPtrClass.add(r),this.arrayPtrClass.addMethod(this.voidType,FuId.ARRAY_COPY_TO,"CopyTo",!1,FuVar.new(this.nIntType,"sourceIndex"),FuVar.new(Object.assign(new FuReadWriteClassType,{class:this.arrayPtrClass,typeArg0:this.#v}),"destinationArray"),FuVar.new(this.nIntType,"destinationIndex"),FuVar.new(this.nIntType,"count"));let s=FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.voidType,FuId.ARRAY_FILL_PART,"Fill",!0,FuVar.new(this.#v,"value"),FuVar.new(this.nIntType,"startIndex"),FuVar.new(this.nIntType,"count"));this.arrayPtrClass.add(s);let a=FuMethod.new(null,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.voidType,FuId.ARRAY_SORT_PART,"Sort",!0,FuVar.new(this.nIntType,"startIndex"),FuVar.new(this.nIntType,"count"));this.arrayPtrClass.add(a),this.arrayStorageClass.parent=this.arrayPtrClass,this.arrayStorageClass.add(FuMethodGroup.new(FuMethod.new(this.arrayStorageClass,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.nIntType,FuId.ARRAY_BINARY_SEARCH_ALL,"BinarySearch",!1,FuVar.new(this.#v,"value")),r)),this.arrayStorageClass.addMethod(this.boolType,FuId.ARRAY_CONTAINS,"Contains",!1,FuVar.new(this.#v,"value")),this.arrayStorageClass.add(FuMethodGroup.new(FuMethod.new(this.arrayStorageClass,FuVisibility.PUBLIC,FuCallType.NORMAL,this.voidType,FuId.ARRAY_FILL_ALL,"Fill",!0,FuVar.new(this.#v,"value")),s)),this.arrayStorageClass.add(FuProperty.new(this.nIntType,FuId.ARRAY_LENGTH,"Length")),this.arrayStorageClass.add(FuMethodGroup.new(FuMethod.new(this.arrayStorageClass,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.voidType,FuId.ARRAY_SORT_ALL,"Sort",!0),a));let n=FuClass.new(FuCallType.NORMAL,FuId.EXCEPTION_CLASS,"Exception");n.isPublic=!0,this.add(n);let h=Object.assign(new FuType,{id:FuId.TYPE_PARAM0_NOT_FINAL,name:"T"}),o=Object.assign(new FuType,{id:FuId.TYPE_PARAM0_PREDICATE,name:"Predicate<T>"}),u=this.#B(FuId.LIST_CLASS,"List",1,FuId.LIST_CLEAR,FuId.LIST_COUNT);u.addMethod(this.voidType,FuId.LIST_ADD,"Add",!0,FuVar.new(h,"value")),u.addMethod(this.voidType,FuId.LIST_ADD_RANGE,"AddRange",!0,FuVar.new(Object.assign(new FuClassType,{class:u,typeArg0:this.#v}),"source")),u.addMethod(this.boolType,FuId.LIST_ALL,"All",!1,FuVar.new(o,"predicate")),u.addMethod(this.boolType,FuId.LIST_ANY,"Any",!1,FuVar.new(o,"predicate")),u.addMethod(this.boolType,FuId.LIST_CONTAINS,"Contains",!1,FuVar.new(this.#v,"value")),u.addMethod(this.voidType,FuId.LIST_COPY_TO,"CopyTo",!1,FuVar.new(this.nIntType,"sourceIndex"),FuVar.new(Object.assign(new FuReadWriteClassType,{class:this.arrayPtrClass,typeArg0:this.#v}),"destinationArray"),FuVar.new(this.nIntType,"destinationIndex"),FuVar.new(this.nIntType,"count")),u.addMethod(this.nIntType,FuId.LIST_INDEX_OF,"IndexOf",!1,FuVar.new(this.#v,"value")),u.addMethod(this.voidType,FuId.LIST_INSERT,"Insert",!0,FuVar.new(this.nIntType,"index"),FuVar.new(h,"value")),u.addMethod(this.#v,FuId.LIST_LAST,"Last",!1),u.addMethod(this.voidType,FuId.LIST_REMOVE_AT,"RemoveAt",!0,FuVar.new(this.nIntType,"index")),u.addMethod(this.voidType,FuId.LIST_REMOVE_RANGE,"RemoveRange",!0,FuVar.new(this.nIntType,"index"),FuVar.new(this.nIntType,"count")),u.add(FuMethodGroup.new(FuMethod.new(u,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.voidType,FuId.LIST_SORT_ALL,"Sort",!0),FuMethod.new(u,FuVisibility.NUMERIC_ELEMENT_TYPE,FuCallType.NORMAL,this.voidType,FuId.LIST_SORT_PART,"Sort",!0,FuVar.new(this.nIntType,"startIndex"),FuVar.new(this.nIntType,"count"))));let c=this.#B(FuId.QUEUE_CLASS,"Queue",1,FuId.QUEUE_CLEAR,FuId.QUEUE_COUNT);c.addMethod(this.#v,FuId.QUEUE_DEQUEUE,"Dequeue",!0),c.addMethod(this.voidType,FuId.QUEUE_ENQUEUE,"Enqueue",!0,FuVar.new(this.#v,"value")),c.addMethod(this.#v,FuId.QUEUE_PEEK,"Peek",!1);let l=this.#B(FuId.STACK_CLASS,"Stack",1,FuId.STACK_CLEAR,FuId.STACK_COUNT);l.addMethod(this.#v,FuId.STACK_PEEK,"Peek",!1),l.addMethod(this.voidType,FuId.STACK_PUSH,"Push",!0,FuVar.new(this.#v,"value")),l.addMethod(this.#v,FuId.STACK_POP,"Pop",!0);let w=this.#B(FuId.PRIORITY_QUEUE_CLASS,"PriorityQueue",2,FuId.PRIORITY_QUEUE_CLEAR,FuId.PRIORITY_QUEUE_COUNT);w.addMethod(this.#v,FuId.PRIORITY_QUEUE_DEQUEUE,"Dequeue",!0),w.addMethod(this.voidType,FuId.PRIORITY_QUEUE_ENQUEUE,"Enqueue",!0,FuVar.new(this.#v,"element"),FuVar.new(this.#Y,"priority")),w.addMethod(this.#v,FuId.PRIORITY_QUEUE_PEEK,"Peek",!1),this.#V(FuId.HASH_SET_CLASS,"HashSet",FuId.HASH_SET_ADD,FuId.HASH_SET_CLEAR,FuId.HASH_SET_CONTAINS,FuId.HASH_SET_COUNT,FuId.HASH_SET_REMOVE),this.#V(FuId.SORTED_SET_CLASS,"SortedSet",FuId.SORTED_SET_ADD,FuId.SORTED_SET_CLEAR,FuId.SORTED_SET_CONTAINS,FuId.SORTED_SET_COUNT,FuId.SORTED_SET_REMOVE);let T=this.#H(FuId.DICTIONARY_CLASS,"Dictionary",FuId.DICTIONARY_CLEAR,FuId.DICTIONARY_CONTAINS_KEY,FuId.DICTIONARY_COUNT,FuId.DICTIONARY_REMOVE);this.#H(FuId.SORTED_DICTIONARY_CLASS,"SortedDictionary",FuId.SORTED_DICTIONARY_CLEAR,FuId.SORTED_DICTIONARY_CONTAINS_KEY,FuId.SORTED_DICTIONARY_COUNT,FuId.SORTED_DICTIONARY_REMOVE),this.#H(FuId.ORDERED_DICTIONARY_CLASS,"OrderedDictionary",FuId.ORDERED_DICTIONARY_CLEAR,FuId.ORDERED_DICTIONARY_CONTAINS_KEY,FuId.ORDERED_DICTIONARY_COUNT,FuId.ORDERED_DICTIONARY_REMOVE);let d=FuClass.new(FuCallType.NORMAL,FuId.TEXT_WRITER_CLASS,"TextWriter");d.addMethod(this.voidType,FuId.TEXT_WRITER_WRITE,"Write",!0,FuVar.new(this.printableType,"value")),d.addMethod(this.voidType,FuId.TEXT_WRITER_WRITE_CHAR,"WriteChar",!0,FuVar.new(this.intType,"c")),d.addMethod(this.voidType,FuId.TEXT_WRITER_WRITE_CODE_POINT,"WriteCodePoint",!0,FuVar.new(this.intType,"c")),d.addMethod(this.voidType,FuId.TEXT_WRITER_WRITE_LINE,"WriteLine",!0,FuVar.new(this.printableType,"value",this.newLiteralString(""))),this.add(d);let p=FuClass.new(FuCallType.STATIC,FuId.NONE,"Console");p.addStaticMethod(this.voidType,FuId.CONSOLE_WRITE,"Write",FuVar.new(this.printableType,"value")),p.addStaticMethod(this.voidType,FuId.CONSOLE_WRITE_LINE,"WriteLine",FuVar.new(this.printableType,"value",this.newLiteralString(""))),p.add(FuStaticProperty.new(Object.assign(new FuStorageType,{class:d}),FuId.CONSOLE_ERROR,"Error")),this.add(p);let F=FuClass.new(FuCallType.SEALED,FuId.STRING_WRITER_CLASS,"StringWriter");F.addMethod(this.voidType,FuId.STRING_WRITER_CLEAR,"Clear",!0),F.addMethod(this.stringPtrType,FuId.STRING_WRITER_TO_STRING,"ToString",!1),this.add(F),F.parent=d;let E=FuClass.new(FuCallType.STATIC,FuId.NONE,"Convert");E.addStaticMethod(this.stringStorageType,FuId.CONVERT_TO_BASE64_STRING,"ToBase64String",FuVar.new(Object.assign(new FuClassType,{class:this.arrayPtrClass,typeArg0:this.byteType}),"bytes"),FuVar.new(this.nIntType,"offset"),FuVar.new(this.nIntType,"length")),this.add(E);let y=FuClass.new(FuCallType.SEALED,FuId.NONE,"UTF8Encoding");y.addMethod(this.nIntType,FuId.U_T_F8_GET_BYTE_COUNT,"GetByteCount",!1,FuVar.new(this.stringPtrType,"str")),y.addMethod(this.voidType,FuId.U_T_F8_GET_BYTES,"GetBytes",!1,FuVar.new(this.stringPtrType,"str"),FuVar.new(Object.assign(new FuReadWriteClassType,{class:this.arrayPtrClass,typeArg0:this.byteType}),"bytes"),FuVar.new(this.nIntType,"byteIndex")),y.addMethod(this.stringStorageType,FuId.U_T_F8_GET_STRING,"GetString",!1,FuVar.new(Object.assign(new FuClassType,{class:this.arrayPtrClass,typeArg0:this.byteType}),"bytes"),FuVar.new(this.nIntType,"offset"),FuVar.new(this.nIntType,"length"));let I=FuClass.new(FuCallType.STATIC,FuId.NONE,"Encoding");I.add(FuStaticProperty.new(y,FuId.NONE,"UTF8")),this.add(I);let S=FuClass.new(FuCallType.STATIC,FuId.NONE,"Environment");S.addStaticMethod(this.stringNullablePtrType,FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE,"GetEnvironmentVariable",FuVar.new(this.stringPtrType,"name")),this.add(S),this.regexOptionsEnum=this.newEnum(!0),this.regexOptionsEnum.isPublic=!0,this.regexOptionsEnum.id=FuId.REGEX_OPTIONS_ENUM,this.regexOptionsEnum.name="RegexOptions";let C=this.#W("None",0n);FuSystem.#Q(this.regexOptionsEnum,C),FuSystem.#Q(this.regexOptionsEnum,this.#W("IgnoreCase",1n)),FuSystem.#Q(this.regexOptionsEnum,this.#W("Multiline",2n)),FuSystem.#Q(this.regexOptionsEnum,this.#W("Singleline",16n)),this.add(this.regexOptionsEnum);let A=FuClass.new(FuCallType.SEALED,FuId.REGEX_CLASS,"Regex");A.addStaticMethod(this.stringStorageType,FuId.REGEX_ESCAPE,"Escape",FuVar.new(this.stringPtrType,"str")),A.add(FuMethodGroup.new(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.STATIC,this.boolType,FuId.REGEX_IS_MATCH_STR,"IsMatch",!1,FuVar.new(this.stringPtrType,"input"),FuVar.new(this.stringPtrType,"pattern"),FuVar.new(this.regexOptionsEnum,"options",C)),FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.REGEX_IS_MATCH_REGEX,"IsMatch",!1,FuVar.new(this.stringPtrType,"input")))),A.addStaticMethod(Object.assign(new FuDynamicPtrType,{class:A}),FuId.REGEX_COMPILE,"Compile",FuVar.new(this.stringPtrType,"pattern"),FuVar.new(this.regexOptionsEnum,"options",C)),this.add(A);let _=FuClass.new(FuCallType.SEALED,FuId.MATCH_CLASS,"Match");_.add(FuMethodGroup.new(FuMethod.new(_,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.MATCH_FIND_STR,"Find",!0,FuVar.new(this.stringPtrType,"input"),FuVar.new(this.stringPtrType,"pattern"),FuVar.new(this.regexOptionsEnum,"options",C)),FuMethod.new(_,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.MATCH_FIND_REGEX,"Find",!0,FuVar.new(this.stringPtrType,"input"),FuVar.new(Object.assign(new FuClassType,{class:A}),"pattern")))),_.add(FuProperty.new(this.nIntType,FuId.MATCH_START,"Start")),_.add(FuProperty.new(this.nIntType,FuId.MATCH_END,"End")),_.addMethod(this.stringStorageType,FuId.MATCH_GET_CAPTURE,"GetCapture",!1,FuVar.new(this.#G,"group")),_.add(FuProperty.new(this.nIntType,FuId.MATCH_LENGTH,"Length")),_.add(FuProperty.new(this.stringStorageType,FuId.MATCH_VALUE,"Value")),this.add(_);let f=FuClass.new(FuCallType.SEALED,FuId.JSON_ELEMENT_CLASS,"JsonElement"),R=Object.assign(new FuDynamicPtrType,{class:f});f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.STATIC,R,FuId.JSON_ELEMENT_PARSE,"Parse",!1,FuVar.new(this.stringPtrType,"value"))),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_OBJECT,"IsObject",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_ARRAY,"IsArray",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_STRING,"IsString",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_NUMBER,"IsNumber",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_BOOLEAN,"IsBoolean",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_IS_NULL,"IsNull",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,Object.assign(new FuClassType,{class:T,typeArg0:this.stringStorageType,typeArg1:R}),FuId.JSON_ELEMENT_GET_OBJECT,"GetObject",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,Object.assign(new FuClassType,{class:u,typeArg0:R}),FuId.JSON_ELEMENT_GET_ARRAY,"GetArray",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.stringPtrType,FuId.JSON_ELEMENT_GET_STRING,"GetString",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.doubleType,FuId.JSON_ELEMENT_GET_DOUBLE,"GetDouble",!1)),f.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.JSON_ELEMENT_GET_BOOLEAN,"GetBoolean",!1)),this.add(f);let L=Object.assign(new FuNumericType,{id:FuId.NUMERIC_TYPE,name:"numeric"}),N=Object.assign(new FuFloatingType,{id:FuId.FLOATING_TYPE,name:"float"}),g=Object.assign(new FuFloatingType,{id:FuId.FLOAT_INT_TYPE,name:"float"}),m=FuClass.new(FuCallType.STATIC,FuId.NONE,"Math");m.addStaticMethod(L,FuId.MATH_ABS,"Abs",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Acos",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Asin",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Atan",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Atan2",FuVar.new(this.doubleType,"y"),FuVar.new(this.doubleType,"x")),m.addStaticMethod(N,FuId.MATH_METHOD,"Cbrt",FuVar.new(this.doubleType,"a")),m.addStaticMethod(g,FuId.MATH_CEILING,"Ceiling",FuVar.new(this.doubleType,"a")),m.addStaticMethod(L,FuId.MATH_CLAMP,"Clamp",FuVar.new(this.doubleType,"value"),FuVar.new(this.doubleType,"min"),FuVar.new(this.doubleType,"max")),m.addStaticMethod(N,FuId.MATH_METHOD,"Cos",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Cosh",FuVar.new(this.doubleType,"a")),m.add(this.#X("E",2.718281828459045)),m.addStaticMethod(N,FuId.MATH_METHOD,"Exp",FuVar.new(this.doubleType,"a")),m.addStaticMethod(g,FuId.MATH_METHOD,"Floor",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_FUSED_MULTIPLY_ADD,"FusedMultiplyAdd",FuVar.new(this.doubleType,"x"),FuVar.new(this.doubleType,"y"),FuVar.new(this.doubleType,"z")),m.addStaticMethod(this.boolType,FuId.MATH_IS_FINITE,"IsFinite",FuVar.new(this.doubleType,"a")),m.addStaticMethod(this.boolType,FuId.MATH_IS_INFINITY,"IsInfinity",FuVar.new(this.doubleType,"a")),m.addStaticMethod(this.boolType,FuId.MATH_IS_NA_N,"IsNaN",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Log",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_LOG2,"Log2",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Log10",FuVar.new(this.doubleType,"a")),m.addStaticMethod(L,FuId.MATH_MAX,"Max",FuVar.new(this.doubleType,"a"),FuVar.new(this.doubleType,"b")),m.addStaticMethod(L,FuId.MATH_MIN,"Min",FuVar.new(this.doubleType,"a"),FuVar.new(this.doubleType,"b")),m.add(FuStaticProperty.new(this.floatType,FuId.MATH_NA_N,"NaN")),m.add(FuStaticProperty.new(this.floatType,FuId.MATH_NEGATIVE_INFINITY,"NegativeInfinity")),m.add(this.#X("PI",3.141592653589793)),m.add(FuStaticProperty.new(this.floatType,FuId.MATH_POSITIVE_INFINITY,"PositiveInfinity")),m.addStaticMethod(N,FuId.MATH_METHOD,"Pow",FuVar.new(this.doubleType,"x"),FuVar.new(this.doubleType,"y")),m.addStaticMethod(g,FuId.MATH_ROUND,"Round",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Sin",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Sinh",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Sqrt",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Tan",FuVar.new(this.doubleType,"a")),m.addStaticMethod(N,FuId.MATH_METHOD,"Tanh",FuVar.new(this.doubleType,"a")),m.addStaticMethod(g,FuId.MATH_TRUNCATE,"Truncate",FuVar.new(this.doubleType,"a")),this.add(m);let P=FuClass.new(FuCallType.SEALED,FuId.LOCK_CLASS,"Lock");this.add(P),this.lockPtrType.class=P}voidType=Object.assign(new FuType,{id:FuId.VOID_TYPE,name:"void"});nullType=Object.assign(new FuType,{id:FuId.NULL_TYPE,name:"null",nullable:!0});#v=Object.assign(new FuType,{id:FuId.TYPE_PARAM0,name:"T"});#Y=Object.assign(new FuType,{id:FuId.TYPE_PARAM1,name:"T"});intType=Object.assign(new FuIntegerType,{id:FuId.INT_TYPE,name:"int"});#G=FuRangeType.new(0,2147483647);nIntType=Object.assign(new FuIntegerType,{id:FuId.N_INT_TYPE,name:"nint"});longType=Object.assign(new FuIntegerType,{id:FuId.LONG_TYPE,name:"long"});byteType=FuRangeType.new(0,255);floatType=Object.assign(new FuFloatingType,{id:FuId.FLOAT_TYPE,name:"float"});doubleType=Object.assign(new FuFloatingType,{id:FuId.DOUBLE_TYPE,name:"double"});charType=FuRangeType.new(-128,65535);boolType=Object.assign(new FuEnum,{id:FuId.BOOL_TYPE,name:"bool"});#U=FuClass.new(FuCallType.NORMAL,FuId.STRING_CLASS,"string");stringPtrType=Object.assign(new FuStringType,{id:FuId.STRING_PTR_TYPE,name:"string"});stringNullablePtrType=Object.assign(new FuStringType,{id:FuId.STRING_PTR_TYPE,name:"string",nullable:!0});stringStorageType=Object.assign(new FuStringStorageType,{id:FuId.STRING_STORAGE_TYPE});printableType=Object.assign(new FuPrintableType,{name:"printable"});arrayPtrClass=FuClass.new(FuCallType.NORMAL,FuId.ARRAY_PTR_CLASS,"ArrayPtr",1);arrayStorageClass=FuClass.new(FuCallType.NORMAL,FuId.ARRAY_STORAGE_CLASS,"ArrayStorage",1);regexOptionsEnum;lockPtrType=new FuReadWriteClassType;newLiteralLong(e,t=0){let i=e>=-2147483648&&e<=2147483647?FuRangeType.new(Number(e),Number(e)):this.longType;return Object.assign(new FuLiteralLong,{loc:t,type:i,value:e})}newLiteralString(e,t=0){return Object.assign(new FuLiteralString,{loc:t,type:this.stringPtrType,value:e})}promoteIntegerTypes(e,t){return e==this.longType||t==this.longType?this.longType:e==this.nIntType||t==this.nIntType?this.nIntType:this.intType}promoteFloatingTypes(e,t){return e.id==FuId.DOUBLE_TYPE||t.id==FuId.DOUBLE_TYPE?this.doubleType:e.id==FuId.FLOAT_TYPE||t.id==FuId.FLOAT_TYPE||e.id==FuId.FLOAT_INT_TYPE||t.id==FuId.FLOAT_INT_TYPE?this.floatType:null}promoteNumericTypes(e,t){let i=this.promoteFloatingTypes(e,t);return null!=i?i:this.promoteIntegerTypes(e,t)}newEnum(e){let t=e?new FuEnumFlags:new FuEnum;return t.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.STATIC,t,FuId.ENUM_FROM_INT,"FromInt",!1,FuVar.new(this.intType,"value"))),t.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.intType,FuId.ENUM_TO_INT,"ToInt",!1)),e&&t.add(FuMethod.new(null,FuVisibility.PUBLIC,FuCallType.NORMAL,this.boolType,FuId.ENUM_HAS_FLAG,"HasFlag",!1,FuVar.new(t,"flag"))),t}#B(e,t,i,r,s){let a=FuClass.new(FuCallType.NORMAL,e,t,i);return a.addMethod(this.voidType,r,"Clear",!0),a.add(FuProperty.new(this.nIntType,s,"Count")),this.add(a),a}#V(e,t,i,r,s,a,n){let h=this.#B(e,t,1,r,a);h.addMethod(this.voidType,i,"Add",!0,FuVar.new(this.#v,"value")),h.addMethod(this.boolType,s,"Contains",!1,FuVar.new(this.#v,"value")),h.addMethod(this.voidType,n,"Remove",!0,FuVar.new(this.#v,"value"))}#H(e,t,i,r,s,a){let n=this.#B(e,t,2,i,s);return n.add(FuMethod.new(n,FuVisibility.FINAL_VALUE_TYPE,FuCallType.NORMAL,this.voidType,FuId.DICTIONARY_ADD,"Add",!0,FuVar.new(this.#v,"key"))),n.addMethod(this.boolType,r,"ContainsKey",!1,FuVar.new(this.#v,"key")),n.addMethod(this.voidType,a,"Remove",!0,FuVar.new(this.#v,"key")),n}static#Q(e,t){t.type=e,e.add(t)}#W(e,t){let i=Object.assign(new FuConst,{visibility:FuVisibility.PUBLIC,name:e,value:this.newLiteralLong(t),visitStatus:FuVisitStatus.DONE});return i.type=i.value.type,i}#X(e,t){return Object.assign(new FuConst,{visibility:FuVisibility.PUBLIC,name:e,value:Object.assign(new FuLiteralDouble,{value:t,type:this.doubleType}),type:this.doubleType,visitStatus:FuVisitStatus.DONE})}#M(e,t,i){e.add(this.#W("MinValue",t)),e.add(this.#W("MaxValue",i))}static new(){return new FuSystem}}class FuSourceFile{filename;line}export class FuProgram extends FuScope{system;topLevelNatives=[];classes=[];main=null;resources={};regexOptionsEnum=!1;lineLocs=[];sourceFiles=[];init(e,t,i){this.parent=e,this.system=t,i.program=this}getLine(e){let t=0,i=this.lineLocs.length-1;for(;t<i;){let r=t+i+1>>1;e<this.lineLocs[r]?i=r-1:t=r}return t}getSourceFile(e){let t=0,i=this.sourceFiles.length-1;for(;t<i;){let r=t+i+1>>1;e<this.sourceFiles[r].line?i=r-1:t=r}return this.sourceFiles[t]}}export class FuParser extends FuLexer{#K=null;#j=null;#J=null;#q;#z=-1;#$;#Z=null;findName(e,t,i){this.#q=e,this.#z=t,this.#$=i,this.#Z=null}getFoundDefinition(){return null==this.#Z?null:this.#Z.getSymbol()}#ee(e){e.children.length>0&&e.children.push(new FuDocLine),this.lexemeOffset=this.charOffset;for(let t=0;;)switch(this.peekChar()){case-1:case 10:case 13:return e.children.push(Object.assign(new FuDocText,{text:this.getLexeme()})),46==t;case 9:case 32:this.readChar();break;case 96:for(this.charOffset>this.lexemeOffset&&e.children.push(Object.assign(new FuDocText,{text:this.getLexeme()})),this.readChar(),this.lexemeOffset=this.charOffset;;){let t=this.peekChar();if(96==t){e.children.push(Object.assign(new FuDocCode,{text:this.getLexeme()})),this.readChar();break}if(t<0||10==t){this.reportError("Unterminated code in documentation comment");break}this.readChar()}this.lexemeOffset=this.charOffset,t=96;break;default:t=this.readChar()}}#te(e){do{this.#ee(e),this.nextToken()}while(this.see(FuToken.DOC_REGULAR))}#ie(){if(!this.see(FuToken.DOC_REGULAR))return null;let e,t=new FuCodeDoc;do{e=this.#ee(t.summary),this.nextToken()}while(!e&&this.see(FuToken.DOC_REGULAR));for(;;)switch(this.currentToken){case FuToken.DOC_REGULAR:let e=new FuDocPara;this.#te(e),t.details.push(e);break;case FuToken.DOC_BULLET:let i=new FuDocList;do{i.items.push(new FuDocPara),this.#te(i.items.at(-1))}while(this.see(FuToken.DOC_BULLET));t.details.push(i);break;case FuToken.DOC_BLANK:this.nextToken();break;default:return t}}#re(){if(null!=this.#K){let e=this.see(FuToken.INCREMENT)?"++":"--";this.reportError(`${e} not allowed on the right side of ${this.#K}`)}}#se(){let e;isNaN(e=parseFloat(this.getLexeme().replaceAll("_","")))&&this.reportError("Invalid floating-point number");let t=Object.assign(new FuLiteralDouble,{loc:this.tokenLoc,type:this.host.program.system.doubleType,value:e});return this.nextToken(),t}#ae(){let e=this.peekChar();return e>=48&&e<=57}#ne(){let e=Object.assign(new FuInterpolatedString,{loc:this.tokenLoc});do{let t=this.stringValue;this.nextToken();let i=this.#he(),r=this.eat(FuToken.COMMA)?this.#he():null,s=32,a=-1;this.see(FuToken.COLON)&&(s=this.readChar(),this.#ae()&&(a=this.readChar()-48,this.#ae()&&(a=10*a+this.readChar()-48)),this.nextToken()),e.addPart(t,i,r,s,a),this.check(FuToken.RIGHT_BRACE)}while(this.readString(!0)==FuToken.INTERPOLATED_STRING);return e.suffix=this.stringValue,this.nextToken(),e}#oe(){this.expect(FuToken.LEFT_PARENTHESIS);let e=this.#he();return this.expect(FuToken.RIGHT_PARENTHESIS),e}#ue(){let e=this.host.program.sourceFiles.at(-1);if(this.host.program.lineLocs.length-e.line-1==this.#z&&e.filename==this.#q){let e=this.host.program.lineLocs.at(-1)+this.#$;return e>=this.tokenLoc&&e<=this.loc}return!1}#ce(e){return this.#ue()&&(this.#Z=e),e.loc=this.tokenLoc,e.name=this.stringValue,this.expect(FuToken.ID)}#le(e,t){if(!this.see(t))do{e.push(this.#he())}while(this.eat(FuToken.COMMA));this.expectOrSkip(t)}#we(e){let t;switch(this.currentToken){case FuToken.INCREMENT:case FuToken.DECREMENT:return this.#re(),Object.assign(new FuPrefixExpr,{loc:this.tokenLoc,op:this.nextToken(),inner:this.#we(!1)});case FuToken.MINUS:case FuToken.TILDE:case FuToken.EXCLAMATION_MARK:return Object.assign(new FuPrefixExpr,{loc:this.tokenLoc,op:this.nextToken(),inner:this.#we(!1)});case FuToken.NEW:let i=Object.assign(new FuPrefixExpr,{loc:this.tokenLoc,op:this.nextToken()});return t=this.#Te(),this.eat(FuToken.LEFT_BRACE)&&(t=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:t,op:FuToken.LEFT_BRACE,right:this.#de()})),i.inner=t,i;case FuToken.LITERAL_LONG:t=this.host.program.system.newLiteralLong(this.longValue,this.tokenLoc),this.nextToken();break;case FuToken.LITERAL_DOUBLE:t=this.#se();break;case FuToken.LITERAL_CHAR:t=FuLiteralChar.new(Number(this.longValue),this.tokenLoc),this.nextToken();break;case FuToken.LITERAL_STRING:t=this.host.program.system.newLiteralString(this.stringValue,this.tokenLoc),this.nextToken();break;case FuToken.FALSE:t=Object.assign(new FuLiteralFalse,{loc:this.tokenLoc,type:this.host.program.system.boolType}),this.nextToken();break;case FuToken.TRUE:t=Object.assign(new FuLiteralTrue,{loc:this.tokenLoc,type:this.host.program.system.boolType}),this.nextToken();break;case FuToken.NULL:t=Object.assign(new FuLiteralNull,{loc:this.tokenLoc,type:this.host.program.system.nullType}),this.nextToken();break;case FuToken.INTERPOLATED_STRING:t=this.#ne();break;case FuToken.LEFT_PARENTHESIS:t=this.#oe();break;case FuToken.ID:let r=new FuSymbolReference;if(this.#ce(r),this.eat(FuToken.FAT_ARROW)){let e=Object.assign(new FuLambdaExpr,{loc:r.loc});return e.add(FuVar.new(null,r.name)),e.body=this.#he(),e}if(e&&this.eat(FuToken.LESS)){let e=Object.assign(new FuAggregateInitializer,{loc:this.tokenLoc}),t=this.parsingTypeArg;this.parsingTypeArg=!0;do{e.items.push(this.#Te())}while(this.eat(FuToken.COMMA));this.expect(FuToken.RIGHT_ANGLE),this.parsingTypeArg=t,r.left=e}t=r;break;case FuToken.RESOURCE:let s=this.tokenLoc;this.nextToken(),this.eat(FuToken.LESS)&&"byte"==this.stringValue&&this.eat(FuToken.ID)&&this.eat(FuToken.LEFT_BRACKET)&&this.eat(FuToken.RIGHT_BRACKET)&&this.eat(FuToken.GREATER)?t=Object.assign(new FuPrefixExpr,{loc:s,op:FuToken.RESOURCE,inner:this.#oe()}):(this.reportError("Expected 'resource<byte[]>'"),t=null);break;default:this.reportError("Invalid expression"),t=null}for(;;)switch(this.currentToken){case FuToken.DOT:this.nextToken();let i=Object.assign(new FuSymbolReference,{left:t});this.#ce(i),t=i;break;case FuToken.LEFT_PARENTHESIS:let r;if(this.nextToken(),(r=t)instanceof FuSymbolReference){let e=Object.assign(new FuCallExpr,{loc:this.tokenLoc,method:r});this.#le(e.arguments_,FuToken.RIGHT_PARENTHESIS),t=e}else this.reportError("Expected a method");break;case FuToken.LEFT_BRACKET:t=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:t,op:this.nextToken(),right:this.see(FuToken.RIGHT_BRACKET)?null:this.#he()}),this.expect(FuToken.RIGHT_BRACKET);break;case FuToken.INCREMENT:case FuToken.DECREMENT:this.#re(),t=Object.assign(new FuPostfixExpr,{loc:this.tokenLoc,inner:t,op:this.nextToken()});break;case FuToken.EXCLAMATION_MARK:case FuToken.HASH:t=Object.assign(new FuPostfixExpr,{loc:this.tokenLoc,inner:t,op:this.nextToken()});break;case FuToken.QUESTION_MARK:if(!e)return t;t=Object.assign(new FuPostfixExpr,{loc:this.tokenLoc,inner:t,op:this.nextToken()});break;default:return t}}#pe(){let e=this.#we(!1);for(;;)switch(this.currentToken){case FuToken.ASTERISK:case FuToken.SLASH:case FuToken.MOD:e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#we(!1)});break;default:return e}}#Fe(){let e=this.#pe();for(;this.see(FuToken.PLUS)||this.see(FuToken.MINUS);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#pe()});return e}#Ee(){let e=this.#Fe();for(;this.see(FuToken.SHIFT_LEFT)||this.see(FuToken.SHIFT_RIGHT);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#Fe()});return e}#ye(){let e=this.#Ee();for(;;)switch(this.currentToken){case FuToken.LESS:case FuToken.LESS_OR_EQUAL:case FuToken.GREATER:case FuToken.GREATER_OR_EQUAL:e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#Ee()});break;case FuToken.IS:let t=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#we(!1)});if(this.see(FuToken.ID)){let e=this.#Ie(t.right,!1);e.isAssigned=!0,t.right=e}return t;default:return e}}#Se(){let e=this.#ye();for(;this.see(FuToken.EQUAL)||this.see(FuToken.NOT_EQUAL);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#ye()});return e}#Ce(){let e=this.#Se();for(;this.see(FuToken.AND);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#Se()});return e}#Ae(){let e=this.#Ce();for(;this.see(FuToken.XOR);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#Ce()});return e}#_e(){let e=this.#Ae();for(;this.see(FuToken.OR);)e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#Ae()});return e}#fe(){let e=this.#_e();for(;this.see(FuToken.COND_AND);){let t=this.#K;this.#K="&&",e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#_e()}),this.#K=t}return e}#Re(){let e=this.#fe();for(;this.see(FuToken.COND_OR);){let t=this.#K;this.#K="||",e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:this.nextToken(),right:this.#fe()}),this.#K=t}return e}#he(){let e=this.#Re();if(this.see(FuToken.QUESTION_MARK)){let t=Object.assign(new FuSelectExpr,{loc:this.tokenLoc,cond:e});this.nextToken();let i=this.#K;return this.#K="?",t.onTrue=this.#he(),this.expect(FuToken.COLON),t.onFalse=this.#he(),this.#K=i,t}return e}#Te(){let e=this.#we(!0);return this.eat(FuToken.RANGE)?Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:FuToken.RANGE,right:this.#we(!0)}):e}#Le(){if(this.eat(FuToken.LEFT_BRACE)){let e=Object.assign(new FuAggregateInitializer,{loc:this.tokenLoc});return this.#le(e.items,FuToken.RIGHT_BRACE),e}return this.#he()}#de(){let e=Object.assign(new FuAggregateInitializer,{loc:this.tokenLoc});do{let t=this.tokenLoc,i=new FuSymbolReference;this.#ce(i),this.expect(FuToken.ASSIGN),e.items.push(Object.assign(new FuBinaryExpr,{loc:t,left:i,op:FuToken.ASSIGN,right:this.#he()}))}while(this.eat(FuToken.COMMA));return this.expect(FuToken.RIGHT_BRACE),e}#Ne(){return this.eat(FuToken.ASSIGN)?this.eat(FuToken.LEFT_BRACE)?this.#de():this.#he():null}#ge(e,t){e.contains(t)?this.host.reportStatementError(t,"Duplicate symbol"):e.add(t)}#Ie(e,t){let i=Object.assign(new FuVar,{typeExpr:e});return this.#ce(i),i.value=t?this.#Ne():null,i}#me(e){this.expect(FuToken.CONST);let t=Object.assign(new FuConst,{visibility:e,typeExpr:this.#Te(),visitStatus:FuVisitStatus.NOT_YET});return this.#ce(t),this.expect(FuToken.ASSIGN),t.value=this.#Le(),this.#Pe(FuToken.SEMICOLON,t),t}#ke(e){let t=e?this.#Te():this.#he();switch(this.currentToken){case FuToken.ASSIGN:case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:return Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:t,op:this.nextToken(),right:this.#ke(!1)});case FuToken.ID:return e?this.#Ie(t,!0):t;default:return t}}#be(e){let t=Object.assign(new FuBlock,{loc:this.tokenLoc});for(this.expect(FuToken.LEFT_BRACE);!this.see(FuToken.RIGHT_BRACE)&&!this.see(FuToken.END_OF_FILE);)t.statements.push(this.#Oe());return this.#Pe(FuToken.RIGHT_BRACE,e),t}#Me(){let e=Object.assign(new FuAssert,{loc:this.tokenLoc});return this.expect(FuToken.ASSERT),e.cond=this.#he(),this.eat(FuToken.COMMA)&&(e.message=this.#he()),this.expect(FuToken.SEMICOLON),e}#De(){null==this.#J&&this.reportError("'break' outside loop or 'switch'");let e,t=Object.assign(new FuBreak,{loc:this.tokenLoc,loopOrSwitch:this.#J});return this.expect(FuToken.BREAK),this.expect(FuToken.SEMICOLON),(e=this.#J)instanceof FuLoop&&(e.hasBreak=!0),t}#xe(){null==this.#j&&this.reportError("'continue' outside loop");let e=Object.assign(new FuContinue,{loc:this.tokenLoc,loop:this.#j});return this.expect(FuToken.CONTINUE),this.expect(FuToken.SEMICOLON),e}#Ge(e){let t=this.#j,i=this.#J;this.#j=e,this.#J=e,e.body=this.#Oe(),this.#J=i,this.#j=t}#Ue(){let e=Object.assign(new FuDoWhile,{loc:this.tokenLoc});return this.expect(FuToken.DO),this.#Ge(e),this.expect(FuToken.WHILE),e.cond=this.#oe(),this.expect(FuToken.SEMICOLON),e}#ve(){let e=Object.assign(new FuFor,{loc:this.tokenLoc});return this.expect(FuToken.FOR),this.expect(FuToken.LEFT_PARENTHESIS),this.see(FuToken.SEMICOLON)||(e.init=this.#ke(!0)),this.expect(FuToken.SEMICOLON),this.see(FuToken.SEMICOLON)||(e.cond=this.#he()),this.expect(FuToken.SEMICOLON),this.see(FuToken.RIGHT_PARENTHESIS)||(e.advance=this.#ke(!1)),this.expect(FuToken.RIGHT_PARENTHESIS),this.#Ge(e),e}#Be(e){this.#ge(e,this.#Ie(this.#Te(),!1))}#Ye(){let e=Object.assign(new FuForeach,{loc:this.tokenLoc});return this.expect(FuToken.FOREACH),this.expect(FuToken.LEFT_PARENTHESIS),this.eat(FuToken.LEFT_PARENTHESIS)?(this.#Be(e),this.expect(FuToken.COMMA),this.#Be(e),this.expect(FuToken.RIGHT_PARENTHESIS)):this.#Be(e),this.expect(FuToken.IN),e.collection=this.#he(),this.expect(FuToken.RIGHT_PARENTHESIS),this.#Ge(e),e}#Ve(){let e=Object.assign(new FuIf,{loc:this.tokenLoc});return this.expect(FuToken.IF),e.cond=this.#oe(),e.onTrue=this.#Oe(),this.eat(FuToken.ELSE)&&(e.onFalse=this.#Oe()),e}#He(){let e=Object.assign(new FuLock,{loc:this.tokenLoc});return this.expect(FuToken.LOCK_),e.lock=this.#oe(),e.body=this.#Oe(),e}#We(){let e=Object.assign(new FuNative,{loc:this.tokenLoc});if(this.expect(FuToken.NATIVE),this.see(FuToken.LITERAL_STRING))e.content=this.stringValue;else{let t=this.charOffset;this.expect(FuToken.LEFT_BRACE);let i=1;for(;;){if(this.see(FuToken.END_OF_FILE))return this.expect(FuToken.RIGHT_BRACE),e;if(this.see(FuToken.LEFT_BRACE))i++;else if(this.see(FuToken.RIGHT_BRACE)&&0==--i)break;this.nextToken()}console.assert(125==this.input[this.charOffset-1]),e.content=(new TextDecoder).decode(this.input.subarray(t,t+this.charOffset-1-t))}return this.nextToken(),e}#Qe(){return this.host.program.lineLocs.length-this.host.program.sourceFiles.at(-1).line-1}#Xe(){return this.tokenLoc-this.host.program.lineLocs.at(-1)}#Ke(e){e.endLine=this.#Qe(),e.endColumn=this.loc-this.host.program.lineLocs.at(-1)}#Pe(e,t){null!=t&&this.#Ke(t),this.expect(e)}#je(e){e.endLine=this.#Qe(),e.endColumn=this.loc-this.host.program.lineLocs.at(-1),this.expect(FuToken.RIGHT_BRACE)}#Je(e){let t=Object.assign(new FuReturn,{loc:this.tokenLoc});return this.nextToken(),this.see(FuToken.SEMICOLON)||(t.value=this.#he()),this.#Pe(FuToken.SEMICOLON,e),t}#qe(){let e=Object.assign(new FuSwitch,{loc:this.tokenLoc});this.expect(FuToken.SWITCH),e.value=this.#oe(),this.expect(FuToken.LEFT_BRACE);let t=this.#J;for(this.#J=e;this.eat(FuToken.CASE);){e.cases.push(new FuCase);let t=e.cases.at(-1);do{let e=this.#he();this.see(FuToken.ID)&&(e=this.#Ie(e,!1)),this.eat(FuToken.WHEN)&&(e=Object.assign(new FuBinaryExpr,{loc:this.tokenLoc,left:e,op:FuToken.WHEN,right:this.#he()})),t.values.push(e),this.expect(FuToken.COLON)}while(this.eat(FuToken.CASE));if(this.see(FuToken.DEFAULT)){this.reportError("Please remove 'case' before 'default'");break}for(;!this.see(FuToken.END_OF_FILE);){switch(t.body.push(this.#Oe()),this.currentToken){case FuToken.CASE:case FuToken.DEFAULT:case FuToken.RIGHT_BRACE:break;default:continue}break}}if(0==e.cases.length&&this.reportError("Switch with no cases"),this.eat(FuToken.DEFAULT)){this.expect(FuToken.COLON);do{if(this.see(FuToken.END_OF_FILE))break;e.defaultBody.push(this.#Oe())}while(!this.see(FuToken.RIGHT_BRACE))}return this.expect(FuToken.RIGHT_BRACE),this.#J=t,e}#ze(){let e=Object.assign(new FuThrow,{loc:this.tokenLoc});return this.expect(FuToken.THROW),e.class=new FuSymbolReference,this.#ce(e.class),this.expectOrSkip(FuToken.LEFT_PARENTHESIS),e.message=this.see(FuToken.RIGHT_PARENTHESIS)?null:this.#he(),this.expect(FuToken.RIGHT_PARENTHESIS),this.expect(FuToken.SEMICOLON),e}#$e(){let e=Object.assign(new FuWhile,{loc:this.tokenLoc});return this.expect(FuToken.WHILE),e.cond=this.#oe(),this.#Ge(e),e}#Oe(){switch(this.currentToken){case FuToken.LEFT_BRACE:return this.#be(null);case FuToken.ASSERT:return this.#Me();case FuToken.BREAK:return this.#De();case FuToken.CONST:return this.#me(FuVisibility.PRIVATE);case FuToken.CONTINUE:return this.#xe();case FuToken.DO:return this.#Ue();case FuToken.FOR:return this.#ve();case FuToken.FOREACH:return this.#Ye();case FuToken.IF:return this.#Ve();case FuToken.LOCK_:return this.#He();case FuToken.NATIVE:return this.#We();case FuToken.RETURN:return this.#Je(null);case FuToken.SWITCH:return this.#qe();case FuToken.THROW:return this.#ze();case FuToken.WHILE:return this.#$e();default:let e=this.#ke(!0);return this.expect(FuToken.SEMICOLON),e}}#Ze(){switch(this.currentToken){case FuToken.STATIC:return this.nextToken(),FuCallType.STATIC;case FuToken.ABSTRACT:return this.nextToken(),FuCallType.ABSTRACT;case FuToken.VIRTUAL:return this.nextToken(),FuCallType.VIRTUAL;case FuToken.OVERRIDE:return this.nextToken(),FuCallType.OVERRIDE;case FuToken.SEALED:return this.nextToken(),FuCallType.SEALED;default:return FuCallType.NORMAL}}#et(e,t){if(this.#ge(e,t),t.parameters.parent=e,t.callType!=FuCallType.STATIC&&t.addThis(e,this.eat(FuToken.EXCLAMATION_MARK)),this.expectOrSkip(FuToken.LEFT_PARENTHESIS),!this.see(FuToken.RIGHT_PARENTHESIS))do{let e=this.#ie(),i=this.#Ie(this.#Te(),!0);i.documentation=e,this.#ge(t.parameters,i)}while(this.eat(FuToken.COMMA));this.expect(FuToken.RIGHT_PARENTHESIS);let i=this.#ie();if(this.eat(FuToken.THROWS))do{let e=new FuThrowsDeclaration;null==i?e.documentation=this.#ie():t.throws.length>0?(this.reportError("Exception documentation must follow the 'throws' keyword"),e.documentation=null):e.documentation=i,this.#ce(e),t.throws.push(e)}while(this.eat(FuToken.COMMA));t.callType==FuCallType.ABSTRACT?this.#Pe(FuToken.SEMICOLON,t):this.see(FuToken.FAT_ARROW)?t.body=this.#Je(t):this.check(FuToken.LEFT_BRACE)&&(t.body=this.#be(t))}#tt(e,t,i,r){this.host.reportError(this.host.program.sourceFiles.at(-1).filename,e,t,t+i,r)}#it(e,t,i,r){let s=FuMethod.callTypeToString(r);this.#tt(e,t,s.length,`${i} cannot be ${s}`)}#rt(e,t,i,r,s){this.expect(FuToken.CLASS);let a=Object.assign(new FuClass,{documentation:e,startLine:t,startColumn:i,isPublic:r,callType:s});for(this.#ce(a)&&this.#ge(this.host.program,a),this.eat(FuToken.COLON)&&this.#ce(a.baseClass),this.expect(FuToken.LEFT_BRACE);!this.see(FuToken.RIGHT_BRACE)&&!this.see(FuToken.END_OF_FILE);){let r;switch(e=this.#ie(),t=this.#Qe(),i=this.#Xe(),this.currentToken){case FuToken.INTERNAL:r=FuVisibility.INTERNAL,this.nextToken();break;case FuToken.PROTECTED:r=FuVisibility.PROTECTED,this.nextToken();break;case FuToken.PUBLIC:r=FuVisibility.PUBLIC,this.nextToken();break;case FuToken.NATIVE:a.addNative(this.#We());continue;default:r=FuVisibility.PRIVATE}if(this.see(FuToken.CONST)){let s=this.#me(r);s.startLine=t,s.startColumn=i,s.documentation=e,this.#ge(a,s);continue}let n=this.#Qe(),h=this.#Xe();s=this.#Ze();let o,u=this.eat(FuToken.VOID)?this.host.program.system.voidType:this.#Te();if(this.see(FuToken.LEFT_BRACE)&&(o=u)instanceof FuCallExpr){o.method.name!=a.name?this.reportError("Method with no return type"):(a.callType==FuCallType.STATIC&&this.reportError("Constructor in a static class"),s!=FuCallType.NORMAL&&this.#it(n,h,"Constructor",s),0!=o.arguments_.length&&this.reportError("Constructor parameters not supported"),null!=a.constructor_&&this.reportError(`Duplicate constructor, already defined in line ${this.host.program.getLine(a.constructor_.loc)+1}`)),r==FuVisibility.PRIVATE&&(r=FuVisibility.INTERNAL),a.constructor_=Object.assign(new FuMethodBase,{startLine:t,startColumn:i,loc:o.loc,documentation:e,visibility:r,parent:a,type:this.host.program.system.voidType,name:a.name}),a.constructor_.parameters.parent=a,a.constructor_.addThis(a,!0),a.constructor_.body=this.#be(a.constructor_);continue}let c=this.#ue(),l=this.tokenLoc,w=this.stringValue;if(!this.expect(FuToken.ID))continue;if(this.see(FuToken.LEFT_PARENTHESIS)||this.see(FuToken.EXCLAMATION_MARK)){s==FuCallType.STATIC||a.callType==FuCallType.ABSTRACT||(a.callType==FuCallType.STATIC?this.reportError("Only static methods allowed in a static class"):s==FuCallType.ABSTRACT?this.#tt(n,h,8,"Abstract methods allowed only in an abstract class"):a.callType==FuCallType.SEALED&&s==FuCallType.VIRTUAL&&this.#tt(n,h,7,"Virtual methods disallowed in a sealed class")),r==FuVisibility.PRIVATE&&s!=FuCallType.STATIC&&s!=FuCallType.NORMAL&&this.#it(n,h,"Private method",s);let o=Object.assign(new FuMethod,{startLine:t,startColumn:i,loc:l,documentation:e,visibility:r,callType:s,typeExpr:u,name:w});this.#et(a,o),c&&(this.#Z=o);continue}s!=FuCallType.NORMAL&&this.#it(n,h,"Field",s),u==this.host.program.system.voidType&&this.reportError("Field cannot be void");let T=Object.assign(new FuField,{startLine:t,startColumn:i,loc:l,documentation:e,visibility:r,typeExpr:u,name:w,value:this.#Ne()});this.#ge(a,T),this.#Pe(FuToken.SEMICOLON,T),c&&(this.#Z=T)}this.#je(a)}#st(e,t,i,r){this.expect(FuToken.ENUM);let s=this.eat(FuToken.ASTERISK),a=this.host.program.system.newEnum(s);a.documentation=e,a.startLine=t,a.startColumn=i,a.isPublic=r,this.#ce(a)&&this.#ge(this.host.program,a),this.expect(FuToken.LEFT_BRACE);do{let e=Object.assign(new FuConst,{visibility:FuVisibility.PUBLIC,documentation:this.#ie(),type:a,visitStatus:FuVisitStatus.NOT_YET});e.startLine=this.#Qe(),e.startColumn=this.#Xe(),this.#ce(e),this.eat(FuToken.ASSIGN)?e.value=this.#he():s&&this.reportError("enum* symbol must be assigned a value"),this.#ge(a,e),this.#Ke(e)}while(this.eat(FuToken.COMMA));this.#je(a)}parse(e,t,i){for(this.open(e,t,i);!this.see(FuToken.END_OF_FILE);){let e=this.#ie(),t=this.#Qe(),i=this.#Xe(),r=this.eat(FuToken.PUBLIC);switch(this.currentToken){case FuToken.CLASS:this.#rt(e,t,i,r,FuCallType.NORMAL);break;case FuToken.STATIC:case FuToken.ABSTRACT:case FuToken.SEALED:this.#rt(e,t,i,r,this.#Ze());break;case FuToken.ENUM:this.#st(e,t,i,r);break;case FuToken.NATIVE:this.host.program.topLevelNatives.push(this.#We().content);break;default:this.reportError("Expected class or enum"),this.nextToken()}}}}export class FuSemaHost extends FuParserHost{getResourceLength(e,t){return 0}}export class GenHost extends FuSemaHost{}export class FuConsoleHost extends GenHost{#at=!1;hasErrors(){return this.#at}setErrors(e){this.#at=e}reportError(e,t,i,r,s){this.#at=!0,console.error(`${e}(${t+1}): ERROR: ${s}`)}}export class FuSema{#nt;#ht=null;#ot;#ut=new Set;#ct={};#lt=Object.assign(new FuType,{name:"poison"});setHost(e){this.#nt=e}#wt(e,t){this.#nt.reportStatementError(e,t)}#Tt(e,t){return this.#wt(e,t),this.#lt}#dt(e){if(e.hasBaseClass()){let t;this.#ot=e,(t=this.#nt.program.tryLookup(e.baseClass.name,!0))instanceof FuClass?(e.isPublic&&!t.isPublic&&this.#wt(e.baseClass,"Public class cannot derive from an internal class"),e.baseClass.symbol=t,t.hasSubclasses=!0,e.parent=t):this.#wt(e.baseClass,`Base class '${e.baseClass.name}' not found`)}this.#nt.program.classes.push(e)}#pt(e){let t=e,i=e;do{if(t=t.parent,null==t)return;if(t.id==FuId.EXCEPTION_CLASS&&(e.id=FuId.EXCEPTION_CLASS),t=t.parent,null==t)return;t.id==FuId.EXCEPTION_CLASS&&(e.id=FuId.EXCEPTION_CLASS),i=i.parent}while(i!=t);this.#ot=e,this.#wt(e,`Circular inheritance for class '${e.name}'`)}static#Ft(e){let t;(t=e.type)instanceof FuArrayStorageType&&(t.ptrTaken=!0)}#Et(e,t){if(e==this.#lt||t==this.#lt)return!1;if(!t.isAssignableFrom(e.type))return this.#wt(e,`Cannot convert '${e.type}' to '${t}'`),!1;let i;if((i=e)instanceof FuPrefixExpr&&i.op==FuToken.NEW&&!(t instanceof FuDynamicPtrType)){let t=e.type.class.id==FuId.ARRAY_PTR_CLASS?"array":"object";return this.#wt(e,`Dynamically allocated ${t} must be assigned to a '${e.type}' reference`),!1}return FuSema.#Ft(e),!0}#yt(e,t){let i=this.#Et(e,t);return i&&t.id==FuId.STRING_PTR_TYPE&&e.isNewString(!0)?(this.#wt(e,"New string must be assigned to 'string()'"),!1):i}#It(e){let t=0,i="";for(let r=0;r<e.parts.length;r++){let s=e.parts[r];i+=s.prefix;let a=this.#St(s.argument);if(this.#Et(a,this.#nt.program.system.printableType))if(a.type instanceof FuIntegerType)switch(s.format){case 32:let e;if((e=a)instanceof FuLiteralLong&&null==s.widthExpr){i+=`${e.value}`;continue}break;case 68:case 100:case 88:case 120:null!=s.widthExpr&&s.precision>=0&&this.#wt(s.widthExpr,"Cannot format an integer with both width and precision");break;default:this.#wt(a,"Invalid format")}else if(a.type instanceof FuFloatingType)switch(s.format){case 32:case 70:case 102:case 69:case 101:break;default:this.#wt(a,"Invalid format")}else if(32!=s.format)this.#wt(a,"Invalid format");else{let e;if((e=a)instanceof FuLiteralString&&null==s.widthExpr){i+=e.value;continue}}let n=e.parts[t++];n.prefix=i,n.argument=a,n.widthExpr=s.widthExpr,n.width=null!=s.widthExpr?this.#Ct(s.widthExpr):0,n.format=s.format,n.precision=s.precision,i=""}return i+=e.suffix,0==t?this.#nt.program.system.newLiteralString(i,e.loc):(e.type=this.#nt.program.system.stringStorageType,e.parts.splice(t,e.parts.length-t),e.suffix=i,e)}#At(e,t){if(null==e.symbol){if(e.symbol=t.tryLookup(e.name,null==e.left),null==e.symbol)return this.#Tt(e,`'${e.name}' not found`);e.type=e.symbol.type}let i;if(!(t instanceof FuEnum)&&(i=e.symbol)instanceof FuConst&&(this.#_t(i),i.value instanceof FuLiteral||i.value instanceof FuSymbolReference)){let t;return i.type instanceof FuFloatingType&&(t=i.value)instanceof FuLiteralLong?this.#ft(e,Number(t.value)):i.value}return e}#Rt(){for(let e=this.#ot;null!=e;e=e.parent){let t;if((t=e)instanceof FuContainerType)return t}throw new Error}#Lt(e){let t=this.#Rt();if(e.parent!=t){e.parent.cppFriends.add(t.name)}}#Nt(e){if(null==e.left){let t,i,r=this.#At(e,this.#ot);if((t=e.symbol)instanceof FuMember){let i;t.visibility==FuVisibility.PRIVATE&&(i=t.parent)instanceof FuClass&&i!=this.#Rt()?this.#wt(e,`Cannot access private member '${e.name}'`):t.visibility==FuVisibility.INTERNAL&&this.#Lt(t),t.isStatic()||null!=this.#ht&&!this.#ht.isStatic()||this.#wt(e,`Cannot use instance member '${e.name}' from static context`)}if((i=r)instanceof FuSymbolReference){let e;if((e=i.symbol)instanceof FuVar){let t;if((t=e.parent)instanceof FuFor)t.isIndVarUsed=!0;else if(this.#ct.hasOwnProperty(e))return this.#ct[e]}else i.symbol.id==FuId.REGEX_OPTIONS_ENUM&&(this.#nt.program.regexOptionsEnum=!0)}return r}let t,i,r=this.#St(e.left,!0);if(r==this.#lt)return r;let s=(i=r)instanceof FuSymbolReference&&i.symbol.id==FuId.BASE_PTR;if(s){if(null==this.#ht)return this.#Tt(r,"'base' invalid outside methods");if(this.#ht.isStatic())return this.#Tt(r,"'base' invalid in static context");let e;if(!((e=this.#ht.parent.parent)instanceof FuClass))return this.#Tt(r,"No base class");t=e}else{let e,i;if((e=r)instanceof FuSymbolReference&&(i=e.symbol)instanceof FuScope)t=i;else{let e;t=r.type,(e=t)instanceof FuClassType&&(t=e.class)}}let a,n=this.#At(e,t);if((a=e.symbol)instanceof FuMember){switch(a.visibility){case FuVisibility.PRIVATE:a.parent==this.#ht.parent&&this.#ht.parent==t||this.#wt(e,`Cannot access private member '${e.name}'`);break;case FuVisibility.INTERNAL:this.#Lt(a);break;case FuVisibility.PROTECTED:if(s)break;let i=t;this.#ht.parent.isSameOrBaseOf(i)||this.#wt(e,`Cannot access protected member '${e.name}'`);break;case FuVisibility.NUMERIC_ELEMENT_TYPE:let n;(n=r.type)instanceof FuClassType&&!(n.getElementType()instanceof FuNumericType)&&this.#wt(e,"Method restricted to collections of numbers");break;case FuVisibility.FINAL_VALUE_TYPE:r.type.asClassType().getValueType().isFinal()||this.#wt(e,"Method restricted to dictionaries with storage values");break;default:switch(e.symbol.id){case FuId.ARRAY_LENGTH:let t;if((t=r.type)instanceof FuArrayStorageType)return this.#gt(e,BigInt(t.length));break;case FuId.STRING_LENGTH:let i;if((i=r)instanceof FuLiteralString){let t=i.getAsciiLength();if(t>=0)return this.#gt(e,BigInt(t))}}}if(!(a instanceof FuMethodGroup)){let t;(t=r)instanceof FuSymbolReference&&t.symbol instanceof FuType?a.isStatic()||this.#wt(e,`Cannot use instance member '${e.name}' without an object`):a.isStatic()&&this.#wt(e,`'${e.name}' is static`)}}return n!=e?n:Object.assign(new FuSymbolReference,{loc:e.loc,left:r,name:e.name,symbol:e.symbol,type:e.type})}static#mt(e,t){return null==t?e:t.min<e.min?t.max>=e.max?t:FuRangeType.new(t.min,e.max):t.max>e.max?FuRangeType.new(e.min,t.max):e}#Pt(e,t){let i=this.#nt.program.system.promoteIntegerTypes(e.type,t.type);return this.#Et(e,i),this.#Et(t,i),i}#kt(e,t){let i=this.#nt.program.system.intType;return this.#Et(e,i),this.#Et(t,i),e.type instanceof FuRangeType?i:e.type}#bt(e,t){let i=this.#nt.program.system.promoteNumericTypes(e.type,t.type);return this.#Et(e,i),this.#Et(t,i),i}static#Ot(e){return-2147483648==e?2147483647:-e}static#Mt(e,t){let i=e+t;if(i>=0){if(e<0&&t<0)return-2147483648}else if(e>0&&t>0)return 2147483647;return i}static#Dt(e,t){return-2147483648==t?e<0?e^t:2147483647:FuSema.#Mt(e,-t)}static#xt(e,t){return 0==e||0==t?0:-2147483648==e?t>>31^e:-2147483648==t?e>>31^t:(2147483647/Math.abs(e)|0)<Math.abs(t)?(e^t)>>31^2147483647:e*t}static#Gt(e,t){return-2147483648==e&&-1==t?2147483647:e/t|0}static#Ut(e,t){return e>>(t>=31||t<0?31:t)}static#vt(e,t,i){let r,s,a=e.getVariableBits(),n=i.getVariableBits();switch(t){case FuToken.AND:r=e.min&i.min&~FuRangeType.getMask(~e.min&~i.min&(a|n)),s=(e.max|a)&(i.max|n),s>e.max&&(s=e.max),s>i.max&&(s=i.max);break;case FuToken.OR:r=e.min&~a|i.min&~n,s=e.max|i.max|FuRangeType.getMask(e.max&i.max&FuRangeType.getMask(a|n)),r<e.min&&(r=e.min),r<i.min&&(r=i.min);break;case FuToken.XOR:let t=a|n;r=(e.min^i.min)&~t,s=e.max^i.max|t;break;default:throw new Error}return r>s?FuRangeType.new(s,r):FuRangeType.new(r,s)}#Bt(e,t){return e.type instanceof FuEnum&&(e.type.id==FuId.BOOL_TYPE||e.type instanceof FuEnumFlags||this.#wt(e,`Define flags enumeration as 'enum* ${e.type}'`),this.#Et(t,e.type),!0)}#Yt(e,t,i){let r,s;if((r=e.type)instanceof FuRangeType&&(s=i.type)instanceof FuRangeType){let e,i,a=null;if(s.min>=0?(e=null,i=s):s.max<0?(e=s,i=null):(e=FuRangeType.new(s.min,-1),i=FuRangeType.new(0,s.max)),r.min<0){let s=r.max<0?r:FuRangeType.new(r.min,-1);null!=e&&(a=FuSema.#vt(s,t,e)),null!=i&&(a=FuSema.#mt(FuSema.#vt(s,t,i),a))}if(r.max>=0){let s=r.min>=0?r:FuRangeType.new(0,r.max);null!=e&&(a=FuSema.#mt(FuSema.#vt(s,t,e),a)),null!=i&&(a=FuSema.#mt(FuSema.#vt(s,t,i),a))}return a}return this.#Bt(e,i)?e.type:this.#Pt(e,i)}static#Vt(e,t,i,r){if(e>t){let i=e;e=t,t=i}if(i>r){let e=i;i=r,r=e}return FuRangeType.new(e<=i?e:i,t>=r?t:r)}#Ht(e,t){let i=t?new FuLiteralTrue:new FuLiteralFalse;return i.loc=e.loc,i.type=this.#nt.program.system.boolType,i}#gt(e,t){return this.#nt.program.system.newLiteralLong(t,e.loc)}#ft(e,t){return Object.assign(new FuLiteralDouble,{loc:e.loc,type:this.#nt.program.system.doubleType,value:t})}#Wt(e){for(;;){let t;if(e instanceof FuSymbolReference){const t=e;if(t.symbol instanceof FuVar){if(t.symbol.isAssigned=!0,t.symbol.parent instanceof FuFor){t.symbol.parent.isRange=!1}else t.symbol.parent instanceof FuForeach&&this.#wt(e,"Cannot assign a foreach iteration variable");for(let e=this.#ot;!(e instanceof FuClass);e=e.parent){let i,r;(i=e)instanceof FuFor&&i.isRange&&(r=i.cond)instanceof FuBinaryExpr&&r.right.isReferenceTo(t.symbol)&&(i.isRange=!1)}return}if(!(t.symbol instanceof FuField))return t.symbol instanceof FuStaticProperty?void 0:void this.#wt(e,"Cannot modify this");if(null==t.left)return void(this.#ht.isMutator()||this.#wt(e,"Cannot modify field in a non-mutating method"));if(!(t.left.type instanceof FuStorageType)){if(t.left.type instanceof FuReadWriteClassType)return;if(t.left.type instanceof FuClassType)return void this.#wt(e,"Cannot modify field through a read-only reference");throw new Error}e=t.left}else{if(!((t=e)instanceof FuBinaryExpr&&t.op==FuToken.LEFT_BRACKET)){if(e instanceof FuCallExpr){const t=e;if(t.type instanceof FuReadWriteClassType)return;if(t.type instanceof FuClassType)return void this.#wt(e,"Cannot modify this");throw new Error}return void this.#wt(e,"Cannot modify this")}if(!(t.left.type instanceof FuStorageType)){if(t.left.type instanceof FuReadWriteClassType)return;if(t.left.type instanceof FuClassType)return void this.#wt(e,"Cannot modify collection through a read-only reference");throw new Error}e=t.left}}}#Qt(e,t){let i=Object.assign(new FuInterpolatedString,{loc:e.loc,type:this.#nt.program.system.stringStorageType});if(i.parts.push(...e.parts),0==t.parts.length)i.suffix=e.suffix+t.suffix;else{i.parts.push(...t.parts);let r=i.parts[e.parts.length];r.prefix=e.suffix+r.prefix,i.suffix=t.suffix}return i}#Xt(e){let t;if((t=e)instanceof FuInterpolatedString)return t;let i,r=Object.assign(new FuInterpolatedString,{loc:e.loc,type:this.#nt.program.system.stringStorageType});return(i=e)instanceof FuLiteral?r.suffix=i.getLiteralString():(r.addPart("",e),r.suffix=""),r}#Kt(e,t){if(e.type instanceof FuEnum)this.#Et(t,e.type);else{let i=this.#nt.program.system.doubleType;this.#Et(e,i),this.#Et(t,i)}}#jt(e){e.parent=this.#ot,this.#ot=e}#Jt(){this.#ot=this.#ot.parent}#qt(e,t){switch(e.callType){case FuCallType.STATIC:this.#wt(t,"Cannot instantiate static class");break;case FuCallType.ABSTRACT:this.#wt(t,"Cannot instantiate abstract class")}}#zt(e){if(null!=e.type)return e;let t,i;if((i=e.inner)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACE){let r;if(t=this.#$t(i.left,!0),!((r=t)instanceof FuClassType)||r instanceof FuReadWriteClassType)return this.#Tt(e,"Invalid argument to new");this.#qt(r.class,e);let s=i.right;return this.#Zt(r,s),e.type=Object.assign(new FuDynamicPtrType,{loc:e.loc,class:r.class}),e.inner=s,e}if(t=this.#$t(e.inner,!0),t instanceof FuArrayStorageType){const i=t;return e.type=Object.assign(new FuDynamicPtrType,{loc:e.loc,class:this.#nt.program.system.arrayPtrClass,typeArg0:i.getElementType()}),e.inner=i.lengthExpr,e}if(t instanceof FuStorageType){const i=t;return e.type=Object.assign(new FuDynamicPtrType,{loc:e.loc,class:i.class,typeArg0:i.typeArg0,typeArg1:i.typeArg1}),e.inner=null,e}return this.#Tt(e,"Invalid argument to new")}#ei(e){let t,i;switch(e.op){case FuToken.INCREMENT:case FuToken.DECREMENT:if(t=this.#St(e.inner),t==this.#lt)return t;let r;if(this.#Wt(t),this.#Et(t,this.#nt.program.system.doubleType),(r=t.type)instanceof FuRangeType){let t=e.op==FuToken.INCREMENT?1:-1;i=FuRangeType.new(r.min+t,r.max+t)}else i=t.type;return e.inner=t,e.type=i,e;case FuToken.MINUS:if(t=this.#St(e.inner),t==this.#lt)return t;let s;if(this.#Et(t,this.#nt.program.system.doubleType),(s=t.type)instanceof FuRangeType){if(s.min==s.max)return this.#gt(e,BigInt(-s.min));i=FuRangeType.new(FuSema.#Ot(s.max),FuSema.#Ot(s.min))}else{let r;if((r=t)instanceof FuLiteralDouble)return this.#ft(e,-r.value);{let r;if((r=t)instanceof FuLiteralLong)return this.#gt(e,-r.value);i=t.type}}break;case FuToken.TILDE:if(t=this.#St(e.inner),t==this.#lt)return t;if(t.type instanceof FuEnumFlags)i=t.type;else{let e;this.#Et(t,this.#nt.program.system.intType),i=(e=t.type)instanceof FuRangeType?FuRangeType.new(~e.max,~e.min):t.type}break;case FuToken.EXCLAMATION_MARK:t=this.#ti(e.inner),i=this.#nt.program.system.boolType;break;case FuToken.NEW:return this.#zt(e);case FuToken.RESOURCE:let a;if(!((a=this.#ii(e.inner))instanceof FuLiteralString))return this.#Tt(e.inner,"Resource name must be a string");t=a,i=Object.assign(new FuArrayStorageType,{class:this.#nt.program.system.arrayStorageClass,typeArg0:this.#nt.program.system.byteType,length:this.#nt.getResourceLength(a.value,e)});break;default:throw new Error}return Object.assign(new FuPrefixExpr,{loc:e.loc,op:e.op,inner:t,type:i})}#ri(e){switch(e.inner=this.#St(e.inner),e.op){case FuToken.INCREMENT:case FuToken.DECREMENT:return this.#Wt(e.inner),this.#Et(e.inner,this.#nt.program.system.doubleType),e.type=e.inner.type,e;default:return this.#Tt(e,`Unexpected ${FuLexer.tokenToString(e.op)}`)}}static#si(e,t){if(e instanceof FuNumericType)return t instanceof FuNumericType;if(e instanceof FuEnum)return e==t;if(e instanceof FuClassType){const i=e;if(e.nullable&&t.id==FuId.NULL_TYPE)return!0;if(e instanceof FuStorageType&&t instanceof FuOwningType||e instanceof FuDynamicPtrType&&t instanceof FuStorageType)return!1;let r;return(r=t)instanceof FuClassType&&(i.class.isSameOrBaseOf(r.class)||r.class.isSameOrBaseOf(i.class))&&i.equalTypeArguments(r)}return e.id==FuId.NULL_TYPE&&t.nullable}#ai(e,t,i){if(!FuSema.#si(t.type,i.type))return this.#Tt(e,`Cannot compare '${t.type}' with '${i.type}'`);let r,s;if((r=t.type)instanceof FuRangeType&&(s=i.type)instanceof FuRangeType){if(r.min==r.max&&r.min==s.min&&r.min==s.max)return this.#Ht(e,e.op==FuToken.EQUAL);if(r.max<s.min||r.min>s.max)return this.#Ht(e,e.op==FuToken.NOT_EQUAL)}else{let r,s,a,n,h,o;if((r=t)instanceof FuLiteralLong&&(s=i)instanceof FuLiteralLong)return this.#Ht(e,e.op==FuToken.NOT_EQUAL!=(r.value==s.value));if((a=t)instanceof FuLiteralDouble&&(n=i)instanceof FuLiteralDouble)return this.#Ht(e,e.op==FuToken.NOT_EQUAL!=(a.value==n.value));if((h=t)instanceof FuLiteralString&&(o=i)instanceof FuLiteralString)return this.#Ht(e,e.op==FuToken.NOT_EQUAL!=(h.value==o.value));if(t instanceof FuLiteralNull&&i instanceof FuLiteralNull||t instanceof FuLiteralFalse&&i instanceof FuLiteralFalse||t instanceof FuLiteralTrue&&i instanceof FuLiteralTrue)return this.#Ht(e,e.op==FuToken.EQUAL);if(t instanceof FuLiteralFalse&&i instanceof FuLiteralTrue||t instanceof FuLiteralTrue&&i instanceof FuLiteralFalse)return this.#Ht(e,e.op==FuToken.NOT_EQUAL);if(t.isConstEnum()&&i.isConstEnum())return this.#Ht(e,e.op==FuToken.NOT_EQUAL!=(t.intValue()==i.intValue()))}return FuSema.#Ft(t),FuSema.#Ft(i),Object.assign(new FuBinaryExpr,{loc:e.loc,left:t,op:e.op,right:i,type:this.#nt.program.system.boolType})}#ni(e,t){e.type instanceof FuDynamicPtrType&&!t.isUnique()&&(e.setShared(),t.setShared())}#hi(e,t,i,r,s,a,n){i.isSameOrBaseOf(e.class)?this.#wt(r,`'${t}' is '${e.class.name}', '${s} ${i.name}' would ${a}`):e.class.isSameOrBaseOf(i)||this.#wt(r,`'${e.class.name}' is not base class of '${i.name}', '${s} ${i.name}' would ${n}`)}#oi(e,t,i,r,s,a){let n;if(!((n=t.type)instanceof FuClassType)||n instanceof FuStorageType)this.#wt(t.typeExpr,`'${r}' with non-reference type`);else{let h=e.type;if(!(n instanceof FuReadWriteClassType)||h instanceof FuDynamicPtrType||!(n instanceof FuDynamicPtrType)&&h instanceof FuReadWriteClassType){let t;this.#hi(h,e,n.class,i,r,s,a),(t=n)instanceof FuDynamicPtrType&&(e.setShared(),t.unique=!1)}else this.#wt(t.typeExpr,`'${h}' cannot be casted to '${n}'`)}}#ui(e,t,i){let r,s,a;if(!((r=t.type)instanceof FuClassType)||t.type instanceof FuStorageType)return this.#Tt(e,"Left hand side of the 'is' operator must be an object reference");if((s=i)instanceof FuSymbolReference&&(a=s.symbol)instanceof FuClass)this.#hi(r,t,a,e,"is","always equal 'true'","always equal 'false'");else{if(!(i instanceof FuVar))return this.#Tt(e,"Right hand side of the 'is' operator must be a class name");{const r=i;this.#oi(t,r,e,"is","always equal 'true'","always equal 'false'")}}return e.left=t,e.type=this.#nt.program.system.boolType,e}#ci(e){let t,i,r=this.#St(e.left),s=this.#St(e.right,e.op==FuToken.IS);if(r==this.#lt||r.type==this.#lt||s==this.#lt||s.type==this.#lt)return this.#lt;switch(e.op){case FuToken.LEFT_BRACKET:let i;if(!((i=r.type)instanceof FuClassType))return this.#Tt(e,"Cannot index this object");switch(i.class.id){case FuId.STRING_CLASS:let a;if(this.#Et(s,this.#nt.program.system.intType),(a=s.type)instanceof FuRangeType&&a.max<0)this.#wt(s,"Negative index");else{let t,i;if((t=r)instanceof FuLiteralString&&(i=s)instanceof FuLiteralLong){let r=i.value;if(r>=0&&r<=2147483647){let i=t.getAsciiAt(Number(r));if(i>=0)return FuLiteralChar.new(i,e.loc)}}}t=this.#nt.program.system.charType;break;case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:let n;if(this.#Et(s,this.#nt.program.system.intType),(n=s.type)instanceof FuRangeType)if(n.max<0)this.#wt(s,"Negative index");else{let e;(e=i)instanceof FuArrayStorageType&&n.min>=e.length&&this.#wt(s,"Array index out of bounds")}t=i.getElementType();break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:this.#Et(s,i.getKeyType()),t=i.getValueType();break;default:return this.#Tt(e,"Cannot index this object")}break;case FuToken.PLUS:let a,n;if((a=r.type)instanceof FuRangeType&&(n=s.type)instanceof FuRangeType)t=FuRangeType.new(FuSema.#Mt(a.min,n.min),FuSema.#Mt(a.max,n.max));else if(r.type instanceof FuStringType){let i,a;if(this.#Et(s,this.#nt.program.system.stringPtrType),(i=r)instanceof FuLiteral&&(a=s)instanceof FuLiteral)return this.#nt.program.system.newLiteralString(i.getLiteralString()+a.getLiteralString(),e.loc);if(r instanceof FuInterpolatedString||s instanceof FuInterpolatedString)return this.#Qt(this.#Xt(r),this.#Xt(s));t=this.#nt.program.system.stringStorageType}else t=this.#bt(r,s);break;case FuToken.MINUS:let h,o;t=(h=r.type)instanceof FuRangeType&&(o=s.type)instanceof FuRangeType?FuRangeType.new(FuSema.#Dt(h.min,o.max),FuSema.#Dt(h.max,o.min)):this.#bt(r,s);break;case FuToken.ASTERISK:let u,c;t=(u=r.type)instanceof FuRangeType&&(c=s.type)instanceof FuRangeType?FuSema.#Vt(FuSema.#xt(u.min,c.min),FuSema.#xt(u.min,c.max),FuSema.#xt(u.max,c.min),FuSema.#xt(u.max,c.max)):this.#bt(r,s);break;case FuToken.SLASH:let l,w;if((l=r.type)instanceof FuRangeType&&(w=s.type)instanceof FuRangeType){let e=w.min;0==e&&(e=1);let i=w.max;0==i&&(i=-1),t=FuSema.#Vt(FuSema.#Gt(l.min,e),FuSema.#Gt(l.min,i),FuSema.#Gt(l.max,e),FuSema.#Gt(l.max,i))}else t=this.#bt(r,s);break;case FuToken.MOD:let T,d;if((T=r.type)instanceof FuRangeType&&(d=s.type)instanceof FuRangeType){let i=~Math.min(d.min,-d.max);if(i<0)return this.#Tt(e,"Mod zero");t=FuRangeType.new(T.min>=0?0:Math.max(T.min,-i),T.max<0?0:Math.min(T.max,i))}else t=this.#Pt(r,s);break;case FuToken.AND:case FuToken.OR:case FuToken.XOR:t=this.#Yt(r,e.op,s);break;case FuToken.SHIFT_LEFT:let p,F;if((p=r.type)instanceof FuRangeType&&(F=s.type)instanceof FuRangeType&&p.min==p.max&&F.min==F.max){let e=p.min<<F.min;t=FuRangeType.new(e,e)}else t=this.#kt(r,s);break;case FuToken.SHIFT_RIGHT:let E,y;(E=r.type)instanceof FuRangeType&&(y=s.type)instanceof FuRangeType?(y.min<0&&(y=FuRangeType.new(0,32)),t=FuRangeType.new(FuSema.#Ut(E.min,E.min<0?y.min:y.max),FuSema.#Ut(E.max,E.max<0?y.max:y.min))):t=this.#kt(r,s);break;case FuToken.EQUAL:case FuToken.NOT_EQUAL:return this.#ai(e,r,s);case FuToken.LESS:let I,S;if((I=r.type)instanceof FuRangeType&&(S=s.type)instanceof FuRangeType){if(I.max<S.min)return this.#Ht(e,!0);if(I.min>=S.max)return this.#Ht(e,!1)}else this.#Kt(r,s);t=this.#nt.program.system.boolType;break;case FuToken.LESS_OR_EQUAL:let C,A;if((C=r.type)instanceof FuRangeType&&(A=s.type)instanceof FuRangeType){if(C.max<=A.min)return this.#Ht(e,!0);if(C.min>A.max)return this.#Ht(e,!1)}else this.#Kt(r,s);t=this.#nt.program.system.boolType;break;case FuToken.GREATER:let _,f;if((_=r.type)instanceof FuRangeType&&(f=s.type)instanceof FuRangeType){if(_.min>f.max)return this.#Ht(e,!0);if(_.max<=f.min)return this.#Ht(e,!1)}else this.#Kt(r,s);t=this.#nt.program.system.boolType;break;case FuToken.GREATER_OR_EQUAL:let R,L;if((R=r.type)instanceof FuRangeType&&(L=s.type)instanceof FuRangeType){if(R.min>=L.max)return this.#Ht(e,!0);if(R.max<L.min)return this.#Ht(e,!1)}else this.#Kt(r,s);t=this.#nt.program.system.boolType;break;case FuToken.COND_AND:if(this.#Et(r,this.#nt.program.system.boolType),this.#Et(s,this.#nt.program.system.boolType),r instanceof FuLiteralTrue)return s;if(r instanceof FuLiteralFalse||s instanceof FuLiteralTrue)return r;t=this.#nt.program.system.boolType;break;case FuToken.COND_OR:if(this.#Et(r,this.#nt.program.system.boolType),this.#Et(s,this.#nt.program.system.boolType),r instanceof FuLiteralTrue||s instanceof FuLiteralFalse)return r;if(r instanceof FuLiteralFalse)return s;t=this.#nt.program.system.boolType;break;case FuToken.ASSIGN:let N,g;return this.#Wt(r),this.#yt(s,r.type),r.type instanceof FuStorageType&&s instanceof FuSymbolReference&&!((N=r)instanceof FuSymbolReference&&(g=N.symbol)instanceof FuNamedValue&&g.isAssignableStorage())&&this.#wt(s,"Cannot copy object storage"),this.#ni(r,s),e.left=r,e.right=s,e.type=r.type,e;case FuToken.ADD_ASSIGN:return this.#Wt(r),r.type.id==FuId.STRING_STORAGE_TYPE?this.#Et(s,this.#nt.program.system.stringPtrType):(this.#Et(r,this.#nt.program.system.doubleType),this.#Et(s,r.type)),e.left=r,e.right=s,e.type=r.type,e;case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:return this.#Wt(r),this.#Et(r,this.#nt.program.system.doubleType),this.#Et(s,r.type),e.left=r,e.right=s,e.type=r.type,e;case FuToken.MOD_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:return this.#Wt(r),this.#Et(r,this.#nt.program.system.intType),this.#Et(s,this.#nt.program.system.intType),e.left=r,e.right=s,e.type=r.type,e;case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:return this.#Wt(r),this.#Bt(r,s)||(this.#Et(r,this.#nt.program.system.intType),this.#Et(s,this.#nt.program.system.intType)),e.left=r,e.right=s,e.type=r.type,e;case FuToken.IS:return this.#ui(e,r,s);case FuToken.RANGE:return this.#Tt(e,"Range within an expression");default:throw new Error}return(i=t)instanceof FuRangeType&&i.min==i.max?this.#gt(e,BigInt(i.min)):Object.assign(new FuBinaryExpr,{loc:e.loc,left:r,op:e.op,right:s,type:t})}#li(e,t){if(e.id==FuId.STRING_STORAGE_TYPE)return t?this.#nt.program.system.stringNullablePtrType:this.#nt.program.system.stringPtrType;let i,r;if((i=e)instanceof FuStorageType)return Object.assign(new FuReadWriteClassType,{class:i.class.id==FuId.ARRAY_STORAGE_CLASS?this.#nt.program.system.arrayPtrClass:i.class,nullable:t,typeArg0:i.typeArg0,typeArg1:i.typeArg1});if(t&&(r=e)instanceof FuClassType&&!r.nullable){let t;return t=e instanceof FuDynamicPtrType?new FuDynamicPtrType:e instanceof FuReadWriteClassType?new FuReadWriteClassType:new FuClassType,t.class=r.class,t.nullable=!0,t.typeArg0=r.typeArg0,t.typeArg1=r.typeArg1,t}return e}static#wi(e,t){for(;;){if(e.isSameOrBaseOf(t))return e;let i;if(!((i=e.parent)instanceof FuClass))return null;e=i}}#Ti(e,t){let i,r;if((i=e.type)instanceof FuRangeType&&(r=t.type)instanceof FuRangeType)return FuSema.#mt(i,r);let s,a,n=e.type.nullable||t.type.nullable,h=this.#li(e.type,n);if(h.isAssignableFrom(t.type))return h;if(h=this.#li(t.type,n),h.isAssignableFrom(e.type))return h;if((s=e.type)instanceof FuClassType&&(a=t.type)instanceof FuClassType&&s.equalTypeArguments(a)){let e=FuSema.#wi(s.class,a.class);if(null!=e){let t;return t=s instanceof FuReadWriteClassType&&a instanceof FuReadWriteClassType?s instanceof FuDynamicPtrType&&a instanceof FuDynamicPtrType?new FuDynamicPtrType:new FuReadWriteClassType:new FuClassType,t.class=e,t.nullable=n,t.typeArg0=s.typeArg0,t.typeArg1=s.typeArg1,t}}return this.#Tt(e,`Incompatible types: '${e.type}' and '${t.type}'`)}#di(e){let t=this.#ti(e.cond),i=this.#St(e.onTrue),r=this.#St(e.onFalse);if(i==this.#lt||i.type==this.#lt||r==this.#lt||r.type==this.#lt)return this.#lt;let s=this.#Ti(i,r);return this.#Et(i,s),this.#Et(r,s),t instanceof FuLiteralTrue?i:t instanceof FuLiteralFalse?r:Object.assign(new FuSelectExpr,{loc:e.loc,cond:t,onTrue:i,onFalse:r,type:s})}#pi(e,t){switch(t.id){case FuId.TYPE_PARAM0:return e.typeArg0;case FuId.TYPE_PARAM0_NOT_FINAL:return e.typeArg0.isFinal()?null:e.typeArg0;case FuId.TYPE_PARAM1:return e.typeArg1}let i;if((i=t)instanceof FuClassType&&1==i.class.typeParameterCount&&i.typeArg0.id==FuId.TYPE_PARAM0){let r=t instanceof FuReadWriteClassType?new FuReadWriteClassType:new FuClassType;return r.class=i.class,r.typeArg0=e.typeArg0,r}return t}#Fi(e,t,i){let r=t.firstParameter();for(const t of i){if(null==r)return!1;let i,s=r.type;if(null!=e&&(i=e.type)instanceof FuClassType&&(s=this.#pi(i,s)),!s.isAssignableFrom(t.type))return!1;r=r.nextVar()}return null==r||null!=r.value}static#Ei(e,t){return e.throws.some((e=>{let i;return(i=e.symbol)instanceof FuClass&&i.isSameOrBaseOf(t)}))}#yi(e,t){let i,r;if(!((i=this.#St(e.method))instanceof FuSymbolReference))return this.#lt;if(null==i.symbol)return this.#lt;if(i.symbol instanceof FuMethod){r=i.symbol}else{if(!(i.symbol instanceof FuMethodGroup))return this.#Tt(i,"Expected a method");{const e=i.symbol;r=e.methods[0],this.#Fi(i.left,r,t)||(r=e.methods[1])}}if(!r.isStatic()&&r.isMutator())if(null==i.left)this.#ht.isMutator()||this.#wt(e.method,`Cannot call mutating method '${r.name}' from a non-mutating method`);else{let e;if((e=i.left)instanceof FuSymbolReference&&e.symbol.id==FuId.BASE_PTR);else if(i.left.type instanceof FuStorageType)this.#Wt(i.left);else if(!(i.left.type instanceof FuReadWriteClassType))switch(r.id){case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:case FuId.LONG_TRY_PARSE:case FuId.DOUBLE_TRY_PARSE:let e,t;(e=i.left)instanceof FuSymbolReference&&(t=e.symbol)instanceof FuVar&&(t.isAssigned=!0);break;default:this.#wt(i.left,`Cannot call mutating method '${r.name}' on a read-only reference`)}}let s,a=0;for(let s=r.firstParameter();null!=s;s=s.nextVar()){let n,h=s.type;if(null!=i.left&&(n=i.left.type)instanceof FuClassType&&(h=this.#pi(n,h),null==h))continue;if(a>=t.length){if(null!=s.value)break;return this.#Tt(e,`Too few arguments for '${r.name}'`)}let o,u=t[a++];h.id==FuId.TYPE_PARAM0_PREDICATE&&(o=u)instanceof FuLambdaExpr?(o.first.type=i.left.type.asClassType().typeArg0,this.#jt(o),o.body=this.#St(o.body),this.#Jt(),this.#Et(o.body,this.#nt.program.system.boolType),this.#Et(o.body,this.#nt.program.system.boolType)):(this.#Et(u,h),h instanceof FuDynamicPtrType&&u.setShared())}if(a<t.length)return this.#Tt(t[a],`Too many arguments for '${r.name}'`);for(const t of r.throws){if(null==this.#ht){this.#wt(e.method,`Cannot call method '${r.name}' here because it is marked 'throws'`);break}let i;(i=t.symbol)instanceof FuClass&&!FuSema.#Ei(this.#ht,i)&&this.#wt(e.method,`Method marked 'throws ${i.name}' called from a method without it`)}if(i.symbol=r,r.isStatic()&&(s=r.body)instanceof FuReturn&&t.every((e=>e instanceof FuLiteral))&&!this.#ut.has(r)){this.#ut.add(r),a=0;for(let e=r.firstParameter();null!=e;e=e.nextVar())a<t.length?this.#ct[e]=t[a++]:this.#ct[e]=e.value;let e=this.#ot;s.parent=r.parameters,this.#ot=s;let i=this.#St(s.value);this.#ot=e;for(let e=r.firstParameter();null!=e;e=e.nextVar())delete this.#ct[e];if(this.#ut.delete(r),i instanceof FuLiteral)return i}if(null!=this.#ht&&this.#ht.calls.add(r),0==Object.keys(this.#ct).length){e.method=i;let s,a=r.type;null!=i.left&&(s=i.left.type)instanceof FuClassType?a=this.#pi(s,a):t.some((e=>null==e.type))||(a.id==FuId.FLOATING_TYPE?a=t.some((e=>e.type.id==FuId.DOUBLE_TYPE))?this.#nt.program.system.doubleType:this.#nt.program.system.floatType:a.id==FuId.NUMERIC_TYPE&&(a=t.some((e=>e.type.id==FuId.DOUBLE_TYPE))?this.#nt.program.system.doubleType:t.some((e=>e.type.id==FuId.FLOAT_TYPE))?this.#nt.program.system.floatType:t.some((e=>e.type.id==FuId.LONG_TYPE))?this.#nt.program.system.longType:t.some((e=>e.type.id==FuId.N_INT_TYPE))?this.#nt.program.system.nIntType:this.#nt.program.system.intType)),e.type=a}return e}#Ii(e){if(0==Object.keys(this.#ct).length){let t=e.arguments_;for(let e=0;e<t.length;e++)t[e]instanceof FuLambdaExpr||(t[e]=this.#St(t[e]));return this.#yi(e,t)}{const t=[];for(const i of e.arguments_)t.push(this.#St(i));return this.#yi(e,t)}}#Zt(e,t){for(const i of t.items){let t=i;console.assert(t.op==FuToken.ASSIGN);let r,s=t.left;this.#At(s,e.class),(r=s.symbol)instanceof FuField?(t.right=this.#St(t.right),this.#Et(t.right,s.type),this.#ni(t.left,t.right),this.#Lt(r)):this.#wt(t.left,"Expected a field")}}static#Si(e){let t;(t=e.type)instanceof FuDynamicPtrType&&(null==e.value||e.value.isUnique()?t.unique=!0:e.value.setShared())}#Ci(e){let t=this.#Ai(e);if(null!=e.value){let i,r;if((i=t)instanceof FuStorageType&&(r=e.value)instanceof FuAggregateInitializer)this.#Zt(i,r);else if(e.value=this.#St(e.value),!e.isAssignableStorage()){let i;if((i=t)instanceof FuArrayStorageType){let r;t=i.getElementType(),(r=e.value)instanceof FuLiteral&&r.isDefaultValue()||this.#wt(e.value,"Only null, zero and false supported as an array initializer")}else t instanceof FuStorageType&&e.value instanceof FuSymbolReference&&this.#wt(e.value,"Cannot copy object storage");this.#yt(e.value,t)}}FuSema.#Si(e),this.#ot.add(e)}#St(e,t=!1){if(e instanceof FuAggregateInitializer){let t=e.items;for(let e=0;e<t.length;e++)t[e]=this.#St(t[e]);return e}if(e instanceof FuLiteral)return e;if(e instanceof FuInterpolatedString){const t=e;return this.#It(t)}if(e instanceof FuSymbolReference){const i=e;return e=this.#Nt(i),t||e!=i||i.symbol instanceof FuNamedValue?e:(this.#wt(i,`'${i}' is not an expression`),this.#lt)}if(e instanceof FuPrefixExpr){const t=e;return this.#ei(t)}if(e instanceof FuPostfixExpr){const t=e;return this.#ri(t)}if(e instanceof FuBinaryExpr){const t=e;return this.#ci(t)}if(e instanceof FuSelectExpr){const t=e;return this.#di(t)}if(e instanceof FuCallExpr){const t=e;return this.#Ii(t)}if(e instanceof FuLambdaExpr)return this.#wt(e,"Unexpected lambda expression"),e;if(e instanceof FuVar){const t=e;return this.#Ci(t),e}if(e==this.#lt)return e;throw new Error}#ti(e){return e=this.#St(e),this.#Et(e,this.#nt.program.system.boolType),e}static#_i(e,t,i){let r;switch(t){case FuToken.END_OF_FILE:r=new FuClassType;break;case FuToken.EXCLAMATION_MARK:r=new FuReadWriteClassType;break;case FuToken.HASH:r=new FuDynamicPtrType;break;default:throw new Error}return r.class=e,r.nullable=i,r}#fi(e,t,i){const r=[];for(const e of i.items)r.push(this.#$t(e,!1));r.length==t.typeParameterCount?(e.class=t,e.typeArg0=r[0],2==r.length&&(e.typeArg1=r[1])):this.#wt(i,`Expected ${t.typeParameterCount} type arguments for '${t.name}', got ${r.length}`)}#Ri(e,t,i){return t!=FuToken.END_OF_FILE&&this.#wt(e,`Unexpected ${FuLexer.tokenToString(t)} on a non-reference type`),i?(this.#wt(e,"Nullable value types not supported"),!1):t==FuToken.END_OF_FILE}#Li(e,t,i){if(e instanceof FuSymbolReference){const r=e;let s;if((s=this.#nt.program.tryLookup(r.name,!0))instanceof FuType){let a;if(r.symbol=s,(a=s)instanceof FuClass){a.id==FuId.MATCH_CLASS&&t!=FuToken.END_OF_FILE&&this.#wt(e,"Read-write references to the built-in class Match are not supported");let s,n=FuSema.#_i(a,t,i);if((s=r.left)instanceof FuAggregateInitializer)this.#fi(n,a,s);else{if(null!=r.left)return this.#Tt(e,"Invalid type");n.name=a.name}return n}return null!=r.left?this.#Tt(e,"Invalid type"):(s.id==FuId.STRING_PTR_TYPE&&i&&(s=this.#nt.program.system.stringNullablePtrType,i=!1),this.#Ri(e,t,i)?s:this.#lt)}return this.#Tt(e,`Type '${r.name}' not found`)}if(e instanceof FuCallExpr){const r=e;if(!this.#Ri(e,t,i))return this.#lt;if(0!=r.arguments_.length)return this.#Tt(r,"Expected empty parentheses for storage type");let s,a;if((s=r.method.left)instanceof FuAggregateInitializer){let e;if((e=this.#nt.program.tryLookup(r.method.name,!0))instanceof FuClass){let t=new FuStorageType;return this.#fi(t,e,s),t}return this.#Tt(s,`'${r.method.name}' is not a class`)}return null!=r.method.left?this.#Tt(e,"Invalid type"):"string"==r.method.name?this.#nt.program.system.stringStorageType:(a=this.#nt.program.tryLookup(r.method.name,!0))instanceof FuClass?(this.#qt(a,e),r.method.symbol=a,Object.assign(new FuStorageType,{class:a})):this.#Tt(e,`Class '${r.method.name}' not found`)}return this.#Tt(e,"Invalid type")}#$t(e,t){let i,r,s,a=null;(i=e)instanceof FuBinaryExpr&&i.op==FuToken.RANGE&&(a=i.left,e=i.right);let n,h=null,o=null;for(;;){let i,a,n;if((i=e)instanceof FuPostfixExpr&&i.op==FuToken.QUESTION_MARK?(e=i.inner,r=!0):r=!1,(a=e)instanceof FuPostfixExpr&&(a.op==FuToken.EXCLAMATION_MARK||a.op==FuToken.HASH)?(e=a.inner,s=a.op):s=FuToken.END_OF_FILE,!((n=e)instanceof FuBinaryExpr&&n.op==FuToken.LEFT_BRACKET))break;if(null!=n.right){if(!this.#Ri(e,s,r))return this.#lt;let i=this.#St(n.right),a=Object.assign(new FuArrayStorageType,{class:this.#nt.program.system.arrayStorageClass,typeArg0:h,lengthExpr:i,length:0});if(this.#Et(i,this.#nt.program.system.intType)&&(!t||n.left.isIndexing())){let t;if((t=i)instanceof FuLiteralLong){let i=t.value;i<0?this.#wt(e,"Expected non-negative integer"):i>2147483647?this.#wt(e,"Integer too big"):a.length=Number(i)}else this.#wt(i,"Expected constant value")}h=a}else{let e=h;h=FuSema.#_i(this.#nt.program.system.arrayPtrClass,s,r),h.typeArg0=e}null==o&&(o=h),e=n.left}if(null!=a){if(!this.#Ri(e,s,r))return this.#lt;let t=this.#Ct(a),i=this.#Ct(e);if(t>i)return this.#Tt(e,"Range min greater than max");n=FuRangeType.new(t,i)}else n=this.#Li(e,s,r);return null==h?n:(o.typeArg0=n,h)}#Ai(e){return e.type=this.#$t(e.typeExpr,!1),e.type}#Ni(e){e.cond=this.#ti(e.cond),null!=e.message&&(e.message=this.#St(e.message),e.message.type instanceof FuStringType||this.#wt(e.message,"The second argument of 'assert' must be a string"))}#gi(e){let t=!0;for(const i of e){let e;if((e=i)instanceof FuConst){if(this.#_t(e),this.#ot.add(e),e.type instanceof FuArrayStorageType){let t=this.#Rt(),i=null;for(const r of t.constArrays)r.name==e.name&&r.inMethod==e.inMethod&&(i=r);null!=i&&(0==i.inMethodIndex&&(i.inMethodIndex=1),e.inMethodIndex=i.inMethodIndex+1),t.constArrays.push(e)}}else this.#mi(i);if(!t)return this.#wt(i,"Unreachable statement"),!1;t=i.completesNormally()}return t}#Pi(e){e.type==this.#lt||e.isAssigned||(e.type instanceof FuStorageType?!(e.type instanceof FuArrayStorageType)&&e.value instanceof FuLiteralNull:null==e.value)&&this.#wt(e,"Uninitialized variable")}#ki(e){this.#jt(e),e.setCompletesNormally(this.#gi(e.statements));for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuVar&&this.#Pi(e)}this.#Jt()}#bi(e){null!=e.cond?(e.cond=this.#ti(e.cond),e.setCompletesNormally(!(e.cond instanceof FuLiteralTrue))):e.setCompletesNormally(!1)}#Oi(e){this.#jt(e),this.#bi(e),this.#mi(e.body),this.#Jt()}#Mi(e){let t,i,r,s;if(this.#jt(e),null!=e.init&&this.#mi(e.init),this.#bi(e),null!=e.advance&&this.#mi(e.advance),(t=e.init)instanceof FuVar&&t.type instanceof FuIntegerType&&null!=t.value&&(i=e.cond)instanceof FuBinaryExpr&&i.left.isReferenceTo(t)&&(i.right instanceof FuLiteral||(r=i.right)instanceof FuSymbolReference&&r.symbol instanceof FuVar)&&null!=e.advance){let r,s,a,n=0n;if((r=e.advance)instanceof FuUnaryExpr&&null!=r.inner&&r.inner.isReferenceTo(t))switch(r.op){case FuToken.INCREMENT:n=1n;break;case FuToken.DECREMENT:n=-1n}else if((s=e.advance)instanceof FuBinaryExpr&&s.left.isReferenceTo(t)&&(a=s.right)instanceof FuLiteralLong)switch(s.op){case FuToken.ADD_ASSIGN:n=a.value;break;case FuToken.SUB_ASSIGN:n=-a.value}(n>0&&(i.op==FuToken.LESS||i.op==FuToken.LESS_OR_EQUAL)||n<0&&(i.op==FuToken.GREATER||i.op==FuToken.GREATER_OR_EQUAL))&&(e.isRange=!0,e.rangeStep=n,e.isIndVarUsed=!1)}this.#mi(e.body),(s=e.init)instanceof FuVar&&this.#Pi(s),this.#Jt()}#Di(e){this.#jt(e);let t=e.getVar();if(this.#Ai(t),this.#St(e.collection)!=this.#lt){let i;if((i=e.collection.type)instanceof FuClassType)switch(i.class.id){case FuId.STRING_CLASS:1==e.count()&&t.type.isAssignableFrom(this.#nt.program.system.intType)||this.#wt(t.typeExpr,"Expected 'int' iterator variable");break;case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:1!=e.count()?this.#wt(e.getValueVar(),"Expected one iterator variable"):t.type.isAssignableFrom(i.getElementType())||this.#wt(t.typeExpr,`Cannot convert '${i.getElementType()}' to '${t.type}'`);break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:if(2!=e.count())this.#wt(t,"Expected '(TKey key, TValue value)' iterator");else{let r=e.getValueVar();this.#Ai(r),t.type.isAssignableFrom(i.getKeyType())||this.#wt(t,`Cannot convert '${i.getKeyType()}' to '${t.type}'`),r.type.isAssignableFrom(i.getValueType())||this.#wt(r,`Cannot convert '${i.getValueType()}' to '${r.type}'`)}break;default:this.#wt(e.collection,`'foreach' invalid on '${i.class.name}'`)}else this.#wt(e.collection,`'foreach' invalid on '${e.collection.type}'`)}e.setCompletesNormally(!0),this.#mi(e.body),this.#Jt()}#xi(e){e.cond=this.#ti(e.cond),this.#mi(e.onTrue),null!=e.onFalse?(this.#mi(e.onFalse),e.setCompletesNormally(e.onTrue.completesNormally()||e.onFalse.completesNormally())):e.setCompletesNormally(!0)}#Gi(e){e.lock=this.#St(e.lock),this.#Et(e.lock,this.#nt.program.system.lockPtrType),this.#mi(e.body)}#Ui(e){if(this.#ht.type.id==FuId.VOID_TYPE)null!=e.value&&this.#wt(e.value,"Void method cannot return a value");else if(null==e.value)this.#wt(e,"Missing return value");else{let t,i;this.#jt(e),e.value=this.#St(e.value),this.#yt(e.value,this.#ht.type),this.#ht.type instanceof FuDynamicPtrType&&e.value.setShared(),(t=e.value)instanceof FuSymbolReference&&(i=t.symbol)instanceof FuVar&&(i.type.isFinal()&&!(this.#ht.type instanceof FuStorageType)||i.type.id==FuId.STRING_STORAGE_TYPE&&this.#ht.type.id!=FuId.STRING_STORAGE_TYPE)&&this.#wt(t,"Returning dangling reference to local storage"),this.#Jt()}}#vi(e,t,i){let r,s;if(this.#St(i,!0)instanceof FuLiteralNull);else if((r=this.#St(i,!0))instanceof FuSymbolReference&&(s=r.symbol)instanceof FuClass)this.#hi(t,e.value,s,i,"case","always match","never match");else if(this.#St(i,!0)instanceof FuVar){const t=this.#St(i,!0);this.#oi(e.value,t,t,"case","always match","never match")}else this.#wt(i,"Expected 'case Class'")}#Bi(e){if(this.#jt(e),e.value=this.#St(e.value),e.value!=this.#lt&&e.value.type!=this.#lt){let t,i;(t=e.value.type)instanceof FuIntegerType&&t.id!=FuId.LONG_TYPE||e.value.type instanceof FuEnum||(i=e.value.type)instanceof FuClassType&&!(i instanceof FuStorageType)||this.#wt(e.value,`'switch' on type '${e.value.type}' - expected 'int', 'enum', 'string' or object reference`)}e.setCompletesNormally(!1);for(const t of e.cases){if(e.value!=this.#lt)for(let i=0;i<t.values.length;i++){let r,s=t.values[i];if((r=e.value.type)instanceof FuClassType&&r.class.id!=FuId.STRING_CLASS){let t;(t=s)instanceof FuBinaryExpr&&t.op==FuToken.WHEN?(this.#vi(e,r,t.left),t.right=this.#ti(t.right)):this.#vi(e,r,s)}else{let r;(r=s)instanceof FuBinaryExpr&&r.op==FuToken.WHEN?(r.left=this.#ii(r.left),this.#Et(r.left,e.value.type),r.right=this.#ti(r.right)):(t.values[i]=this.#ii(s),this.#Et(t.values[i],e.value.type))}}this.#gi(t.body)&&this.#wt(t.body.at(-1),"'case' must end with 'break', 'continue', 'return' or 'throw'")}if(e.defaultBody.length>0){this.#gi(e.defaultBody)&&this.#wt(e.defaultBody.at(-1),"'default' must end with 'break', 'continue', 'return' or 'throw'")}this.#Jt()}#Yi(e){this.#Nt(e)instanceof FuSymbolReference&&e.symbol instanceof FuClass&&e.symbol.id==FuId.EXCEPTION_CLASS||this.#wt(e,"Expected an exception class")}#Vi(e){let t;this.#Yi(e.class),(t=e.class.symbol)instanceof FuClass&&!FuSema.#Ei(this.#ht,t)&&this.#wt(e,`Method must be marked 'throws ${t.name}'`),null!=e.message&&(e.message=this.#St(e.message),e.message.type instanceof FuStringType||this.#wt(e.message,"Exception accepts a string argument"))}#Hi(e){this.#jt(e),this.#bi(e),this.#mi(e.body),this.#Jt()}#mi(e){if(e instanceof FuAssert){const t=e;this.#Ni(t)}else if(e instanceof FuBlock){const t=e;this.#ki(t)}else if(e instanceof FuBreak){e.loopOrSwitch.setCompletesNormally(!0)}else if(e instanceof FuContinue||e instanceof FuNative);else if(e instanceof FuDoWhile){const t=e;this.#Oi(t)}else if(e instanceof FuFor){const t=e;this.#Mi(t)}else if(e instanceof FuForeach){const t=e;this.#Di(t)}else if(e instanceof FuIf){const t=e;this.#xi(t)}else if(e instanceof FuLock){const t=e;this.#Gi(t)}else if(e instanceof FuReturn){const t=e;this.#Ui(t)}else if(e instanceof FuSwitch){const t=e;this.#Bi(t)}else if(e instanceof FuThrow){const t=e;this.#Vi(t)}else if(e instanceof FuWhile){const t=e;this.#Hi(t)}else{if(!(e instanceof FuExpr))throw new Error;{const t=e;this.#St(t)}}}#ii(e){return(e=this.#St(e))instanceof FuLiteral||e.isConstEnum()||this.#wt(e,"Expected constant value"),e}#Ct(e){let t;if((t=this.#ii(e))instanceof FuLiteralLong){let i=t.value;return i<-2147483648||i>2147483647?(this.#wt(e,"Only 32-bit ranges supported"),0):Number(i)}return this.#wt(e,"Expected integer"),0}#_t(e){switch(e.visitStatus){case FuVisitStatus.NOT_YET:break;case FuVisitStatus.IN_PROGRESS:return e.value=this.#Tt(e,`Circular dependency in value of constant '${e.name}'`),void(e.visitStatus=FuVisitStatus.DONE);case FuVisitStatus.DONE:return}let t;if(e.visitStatus=FuVisitStatus.IN_PROGRESS,this.#ot instanceof FuEnum||this.#Ai(e),e.value=this.#St(e.value),(t=e.value)instanceof FuAggregateInitializer){let i;if((i=e.type)instanceof FuClassType){let r,s=i.getElementType();(r=i)instanceof FuArrayStorageType?r.length!=t.items.length&&this.#wt(e,`Declared ${r.length} elements, initialized ${t.items.length}`):i instanceof FuReadWriteClassType?this.#wt(e,"Invalid constant type"):e.type=Object.assign(new FuArrayStorageType,{class:this.#nt.program.system.arrayStorageClass,typeArg0:s,length:t.items.length}),t.type=e.type;for(const e of t.items)this.#Et(e,s)}else this.#wt(e,`Array initializer for scalar constant '${e.name}'`)}else this.#ot instanceof FuEnum&&e.value.type instanceof FuRangeType&&e.value instanceof FuLiteral||(e.value instanceof FuLiteral||e.value.isConstEnum()?this.#Et(e.value,e.type):e.value!=this.#lt&&this.#wt(e.value,`Value for constant '${e.name}' is not constant`));e.inMethod=this.#ht,e.visitStatus=FuVisitStatus.DONE}#Wi(e){if(this.#ot=e,e instanceof FuClass){for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuConst&&this.#_t(e)}}else{if(!(e instanceof FuEnum))throw new Error;{const t=e;let i=null;for(let e=t.first;null!=e;e=e.next){let r;(r=e)instanceof FuConst&&(null!=r.value?(this.#_t(r),t.hasExplicitValue=!0):r.value=Object.assign(new FuImplicitEnumValue,{value:null==i?0:i.value.intValue()+1}),i=r)}}}}#Qi(e){this.#ot=e;for(let t=e.first;null!=t;t=t.next)if(t instanceof FuField){const e=t;this.#Ai(e),e.visibility!=FuVisibility.PROTECTED&&FuSema.#Si(e)}else if(t instanceof FuMethod){const e=t;e.typeExpr==this.#nt.program.system.voidType?e.type=this.#nt.program.system.voidType:this.#Ai(e),"ToString"==e.name&&e.callType!=FuCallType.STATIC&&1==e.parameters.count()&&(e.id=FuId.CLASS_TO_STRING);for(let t=e.firstParameter();null!=t;t=t.nextVar())this.#Ai(t),null!=t.value&&(t.value=this.#ii(t.value),this.#Et(t.value,t.type));if("Main"==e.name){switch(e.visibility==FuVisibility.PUBLIC&&e.callType==FuCallType.STATIC||this.#wt(e,"'Main' method must be 'public static'"),e.type.id!=FuId.VOID_TYPE&&e.type.id!=FuId.INT_TYPE&&this.#wt(e.typeExpr,"'Main' method must return 'void' or 'int'"),e.getParametersCount()){case 0:break;case 1:let t,i=e.firstParameter();if((t=i.type)instanceof FuClassType&&t.isArray()&&!(t instanceof FuReadWriteClassType)&&!t.nullable){let e=t.getElementType();if(e.id==FuId.STRING_PTR_TYPE&&!e.nullable&&null==i.value){t.id=FuId.MAIN_ARGS_TYPE,t.class=this.#nt.program.system.arrayStorageClass;break}}this.#wt(i,"'Main' method parameter must be 'string[]'");break;default:this.#wt(e,"'Main' method must have no parameters or one 'string[]' parameter")}null!=this.#nt.program.main?this.#wt(e,"Duplicate 'Main' method"):(e.id=FuId.MAIN,this.#nt.program.main=e)}for(const t of e.throws)this.#Yi(t)}}#Xi(e){null!=e.constructor_&&(this.#ot=e.constructor_.parameters,this.#ht=e.constructor_,this.#mi(e.constructor_.body),this.#ht=null);for(let t=e.first;null!=t;t=t.next){let i,r=e.parent.tryLookup(t.name,!1);if(r==t&&(r=null),t instanceof FuField){const e=t;if(null!=e.value&&(e.value=this.#St(e.value),!e.isAssignableStorage())){let t;this.#yt(e.value,(t=e.type)instanceof FuArrayStorageType?t.getElementType():e.type)}}else if(t instanceof FuMethod){const e=t;if(e.callType!=FuCallType.ABSTRACT){if(e.callType==FuCallType.OVERRIDE||e.callType==FuCallType.SEALED){let t;if((t=r)instanceof FuMethod){t.isAbstractVirtualOrOverride()?e.visibility!=t.visibility?this.#wt(e,"Access modifier different from the overridden method"):e.isMutator()!=t.isMutator()&&(e.isMutator()?this.#wt(e,"Mutating method cannot override a non-mutating method"):this.#wt(e,"Non-mutating method cannot override a mutating method")):this.#wt(e,"Base method is not abstract or virtual"),e.type.equalsType(t.type)||this.#wt(e.typeExpr,"Base method has a different return type");let i=t.firstParameter();for(let t=e.firstParameter();;t=t.nextVar()){if(null==t){null!=i&&this.#wt(e,"Fewer parameters than the overridden method");break}if(null==i){this.#wt(t,"More parameters than the overridden method");break}if(!t.type.equalsType(i.type)){this.#wt(t.typeExpr,"Base method has a different parameter type");break}i=i.nextVar()}t.calls.add(e)}else this.#wt(e,"No method to override");r=null}this.#ot=e.parameters,this.#ht=e,this.#mi(e.body),e.type.id!=FuId.VOID_TYPE&&e.body.completesNormally()&&this.#wt(e,"Method can complete without a return value"),this.#ht=null}}(i=r)instanceof FuMember&&i.visibility!=FuVisibility.PRIVATE&&(t instanceof FuMethod&&r instanceof FuMethod?this.#wt(t,`Method defined in base class '${r.parent.name}'. Did you mean 'override'?`):this.#wt(t,`Duplicate definition of '${t.name}' in base class '${r.parent.name}'`))}}static#Ki(e){if(!e.isLive){e.isLive=!0;for(const t of e.calls)FuSema.#Ki(t)}}static#ji(e){if(e.isPublic)for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuMethod&&(e.visibility==FuVisibility.PUBLIC||e.visibility==FuVisibility.PROTECTED)&&FuSema.#Ki(e)}null!=e.constructor_&&FuSema.#Ki(e.constructor_)}process(){let e=this.#nt.program;for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuClass&&this.#dt(e)}for(const t of e.classes)this.#pt(t);for(let t=e.first;null!=t;t=t.next){let e=t;this.#Wi(e)}for(const t of e.classes)this.#Qi(t);for(const t of e.classes)this.#Xi(t);for(const t of e.classes)FuSema.#ji(t)}}export class GenBase extends FuVisitor{#nt;#Ji;#qi=new StringWriter;indent=0;atLineStart=!0;#zi=!1;#$i=!1;inHeaderFile=!1;#Zi={};currentMethod=null;writtenTypes=new Set;switchesWithGoto=[];currentTemporaries=[];setHost(e){this.#nt=e}#wt(e,t){this.#nt.reportStatementError(e,t)}notSupported(e,t){this.#wt(e,`${t} not supported when targeting ${this.getTargetName()}`)}notYet(e,t){this.#wt(e,`${t} not supported yet when targeting ${this.getTargetName()}`)}startLine(){if(this.atLineStart){this.#zi&&(this.#zi=!1,this.#Ji.write(String.fromCharCode(10)),this.indent++);for(let e=0;e<this.indent;e++)this.#Ji.write(String.fromCharCode(9));this.atLineStart=!1}}writeChar(e){this.startLine(),this.#Ji.write(String.fromCodePoint(e))}write(e){this.startLine(),this.#Ji.write(e)}visitLiteralNull(){this.write("null")}visitLiteralFalse(){this.write("false")}visitLiteralTrue(){this.write("true")}visitLiteralLong(e){this.#Ji.write(String(e))}getLiteralChars(){return 0}visitLiteralChar(e){if(e<this.getLiteralChars()){switch(this.writeChar(39),e){case 10:this.write("\\n");break;case 13:this.write("\\r");break;case 9:this.write("\\t");break;case 39:this.write("\\'");break;case 92:this.write("\\\\");break;default:this.writeChar(e)}this.writeChar(39)}else this.#Ji.write(String(e))}visitLiteralDouble(e){let t=`${e}`;this.write(t);for(const e of t)switch(e.codePointAt(0)){case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:break;default:return}this.write(".0")}visitLiteralString(e){this.writeChar(34),this.write(e),this.writeChar(34)}#er(e){e>=65&&e<=90&&(e+=32),this.#Ji.write(String.fromCharCode(e))}#tr(e){e>=97&&e<=122&&(e-=32),this.#Ji.write(String.fromCharCode(e))}writeLowercase(e){this.startLine();for(const t of e)this.#er(t.codePointAt(0))}writeCamelCase(e){this.startLine(),this.#er(e.charCodeAt(0)),this.#Ji.write(e.substring(1))}writePascalCase(e){this.startLine(),this.#tr(e.charCodeAt(0)),this.#Ji.write(e.substring(1))}writeUppercaseWithUnderscores(e){this.startLine();let t=!0;for(const i of e)!t&&i.codePointAt(0)>=65&&i.codePointAt(0)<=90?(this.#Ji.write(String.fromCharCode(95)),this.#Ji.write(String.fromCharCode(i.codePointAt(0)))):this.#tr(i.codePointAt(0)),t=!1}writeLowercaseWithUnderscores(e){this.startLine();let t=!0;for(const i of e)i.codePointAt(0)>=65&&i.codePointAt(0)<=90?(t||this.#Ji.write(String.fromCharCode(95)),this.#er(i.codePointAt(0))):this.#Ji.write(String.fromCharCode(i.codePointAt(0))),t=!1}writeNewLine(){this.#Ji.write(String.fromCharCode(10)),this.atLineStart=!0}writeCharLine(e){this.writeChar(e),this.writeNewLine()}writeLine(e){this.write(e),this.writeNewLine()}writeUppercaseConstName(e){null!=e.inMethod&&(this.writeUppercaseWithUnderscores(e.inMethod.name),this.writeChar(95)),this.writeUppercaseWithUnderscores(e.name),e.inMethodIndex>0&&(this.writeChar(95),this.visitLiteralLong(BigInt(e.inMethodIndex)))}writeBanner(){this.writeLine('// Generated automatically with "fut". Do not edit.')}createFile(e,t){this.#Ji=this.#nt.createFile(e,t),this.writeBanner()}closeFile(){this.#nt.closeFile()}openStringWriter(){this.#Ji=this.#qi}closeStringWriter(){this.#Ji.write(this.#qi.toString()),this.#qi.clear()}include(e){this.#Zi.hasOwnProperty(e)||(this.#Zi[e]=this.inHeaderFile)}writeIncludes(e,t){for(const[i,r]of Object.entries(this.#Zi).sort(((e,t)=>e[0].localeCompare(t[0]))))r==this.inHeaderFile&&(this.write(e),this.write(i),this.writeLine(t));if(!this.inHeaderFile)for(const e in this.#Zi)delete this.#Zi[e]}startDocLine(){this.write(" * ")}writeXmlDoc(e){for(const t of e)switch(t.codePointAt(0)){case 38:this.write("&amp;");break;case 60:this.write("&lt;");break;case 62:this.write("&gt;");break;default:this.writeChar(t.codePointAt(0))}}writeDocCode(e){this.writeXmlDoc(e)}writeDocPara(e,t){t&&(this.writeNewLine(),this.write(" * <p>"));for(const t of e.children)if(t instanceof FuDocText){const e=t;this.writeXmlDoc(e.text)}else if(t instanceof FuDocCode){const e=t;this.write("<code>"),this.writeDocCode(e.text),this.write("</code>")}else{if(!(t instanceof FuDocLine))throw new Error;this.writeNewLine(),this.startDocLine()}}writeDocList(e){this.writeNewLine(),this.writeLine(" * <ul>");for(const t of e.items)this.write(" * <li>"),this.writeDocPara(t,!1),this.writeLine("</li>");this.write(" * </ul>")}writeDocBlock(e,t){if(e instanceof FuDocPara){const i=e;this.writeDocPara(i,t)}else{if(!(e instanceof FuDocList))throw new Error;{const t=e;this.writeDocList(t)}}}writeContent(e){if(this.startDocLine(),this.writeDocPara(e.summary,!1),this.writeNewLine(),e.details.length>0){if(this.startDocLine(),1==e.details.length)this.writeDocBlock(e.details[0],!1);else for(const t of e.details)this.writeDocBlock(t,!0);this.writeNewLine()}}writeDoc(e){null!=e&&(this.writeLine("/**"),this.writeContent(e),this.writeLine(" */"))}writeSelfDoc(e){}writeParameterDoc(e,t){this.write(" * @param "),this.writeName(e),this.writeChar(32),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeReturnDoc(e){}writeThrowsDoc(e){this.write(" * @throws "),this.writeExceptionClass(e.symbol),this.writeChar(32),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeParametersAndThrowsDoc(e){let t=!0;for(let i=e.firstParameter();null!=i;i=i.nextVar())null!=i.documentation&&(this.writeParameterDoc(i,t),t=!1);this.writeReturnDoc(e);for(const t of e.throws)null!=t.documentation&&this.writeThrowsDoc(t)}writeMethodDoc(e){null!=e.documentation&&(this.writeLine("/**"),this.writeContent(e.documentation),this.writeSelfDoc(e),this.writeParametersAndThrowsDoc(e),this.writeLine(" */"))}writeTopLevelNatives(e){for(const t of e.topLevelNatives)this.write(t)}openBlock(){this.writeCharLine(123),this.indent++}closeBlock(){this.indent--,this.writeCharLine(125)}endStatement(){this.writeCharLine(59)}writeComma(e){e>0&&(0==(15&e)?(this.writeCharLine(44),this.writeChar(9)):this.write(", "))}writeBytes(e){let t=0;for(const i of e)this.writeComma(t++),this.visitLiteralLong(BigInt(i))}getTypeId(e,t){return t&&e instanceof FuRangeType?FuId.INT_TYPE:e.id}writeLocalName(e,t){e instanceof FuField&&this.write("this."),this.writeName(e)}writeDoubling(e,t){for(const i of e)i.codePointAt(0)==t&&this.writeChar(i.codePointAt(0)),this.writeChar(i.codePointAt(0))}writePrintfWidth(e){null!=e.widthExpr&&this.visitLiteralLong(BigInt(e.width)),e.precision>=0&&(this.writeChar(46),this.visitLiteralLong(BigInt(e.precision)))}static#ir(e,t){if(e instanceof FuIntegerType)return 120==t||88==t?t:100;if(!(e instanceof FuNumericType)){if(e instanceof FuClassType)return 115;throw new Error}switch(t){case 69:case 101:case 102:case 71:case 103:return t;case 70:return 102;default:return 103}}writePrintfFormat(e){for(const t of e.parts)this.writeDoubling(t.prefix,37),this.writeChar(37),this.writePrintfWidth(t),this.writeChar(GenBase.#ir(t.argument.type,t.format));this.writeDoubling(e.suffix,37)}writePyFormat(e){(null!=e.widthExpr||e.precision>=0||32!=e.format&&68!=e.format)&&this.writeChar(58),null!=e.widthExpr&&(e.width>=0?(e.argument.type instanceof FuNumericType||this.writeChar(62),this.visitLiteralLong(BigInt(e.width))):(this.writeChar(60),this.visitLiteralLong(BigInt(-e.width)))),e.precision>=0&&(this.writeChar(e.argument.type instanceof FuIntegerType?48:46),this.visitLiteralLong(BigInt(e.precision))),32!=e.format&&68!=e.format&&this.writeChar(e.format),this.writeChar(125)}writeInterpolatedStringArg(e){e.accept(this,FuPriority.ARGUMENT)}writeInterpolatedStringArgs(e){for(const t of e.parts)this.write(", "),this.writeInterpolatedStringArg(t.argument)}writePrintf(e,t){this.writeChar(34),this.writePrintfFormat(e),t&&this.write("\\n"),this.writeChar(34),this.writeInterpolatedStringArgs(e),this.writeChar(41)}writePostfix(e,t){e.accept(this,FuPriority.PRIMARY),this.write(t)}writeCall(e,t,i=null,r=null){this.write(e),this.writeChar(40),t.accept(this,FuPriority.ARGUMENT),null!=i&&(this.write(", "),i.accept(this,FuPriority.ARGUMENT),null!=r&&(this.write(", "),r.accept(this,FuPriority.ARGUMENT))),this.writeChar(41)}writeMemberOp(e,t){this.writeChar(46)}writeMethodCall(e,t,i,r=null){e.accept(this,FuPriority.PRIMARY),this.writeMemberOp(e,null),this.writeCall(t,i,r)}writeInParentheses(e){this.writeChar(40);let t=!0;for(const i of e)t||this.write(", "),i.accept(this,FuPriority.ARGUMENT),t=!1;this.writeChar(41)}writeSelectValues(e,t){this.writeCoerced(e,t.onTrue,FuPriority.SELECT),this.write(" : "),this.writeCoerced(e,t.onFalse,FuPriority.SELECT)}writeCoercedSelect(e,t,i){i>FuPriority.SELECT&&this.writeChar(40),t.cond.accept(this,FuPriority.SELECT_COND),this.write(" ? "),this.writeSelectValues(e,t),i>FuPriority.SELECT&&this.writeChar(41)}writeCoercedInternal(e,t,i){t.accept(this,i)}writeCoerced(e,t,i){let r;(r=t)instanceof FuSelectExpr?this.writeCoercedSelect(e,r,i):this.writeCoercedInternal(e,t,i)}writeCoercedExpr(e,t){this.writeCoerced(e,t,FuPriority.ARGUMENT)}writeStronglyCoerced(e,t){this.writeCoerced(e,t,FuPriority.ARGUMENT)}writeCoercedLiteral(e,t){t.accept(this,FuPriority.ARGUMENT)}writeCoercedLiterals(e,t){for(let i=0;i<t.length;i++)this.writeComma(i),this.writeCoercedLiteral(e,t[i])}writeCoercedArgs(e,t){let i=e.firstParameter(),r=!0;for(const e of t)r||this.write(", "),r=!1,this.writeStronglyCoerced(i.type,e),i=i.nextVar()}writeCoercedArgsInParentheses(e,t){this.writeChar(40),this.writeCoercedArgs(e,t),this.writeChar(41)}writeNewArrayStorage(e){this.writeNewArray(e.getElementType(),e.lengthExpr,FuPriority.ARGUMENT)}writeNewStorage(e){if(e instanceof FuArrayStorageType){const t=e;this.writeNewArrayStorage(t)}else{if(!(e instanceof FuStorageType))throw new Error;{const t=e;this.writeNew(t,FuPriority.ARGUMENT)}}}writeArrayStorageInit(e,t){this.write(" = "),this.writeNewArrayStorage(e)}writeNewWithFields(e,t){this.writeNew(e,FuPriority.ARGUMENT)}writeStorageInit(e){let t;if(this.write(" = "),(t=e.value)instanceof FuAggregateInitializer){let i=e.type;this.writeNewWithFields(i,t)}else this.writeNewStorage(e.type)}writeVarInit(e){let t;(t=e.type)instanceof FuArrayStorageType?this.writeArrayStorageInit(t,e.value):e.type.isFinal()&&e.value instanceof FuLiteralNull||(null==e.value||e.value instanceof FuAggregateInitializer?!e.type.isFinal()||e.parent instanceof FuParameters||this.writeStorageInit(e):(this.write(" = "),this.writeCoercedExpr(e.type,e.value)))}writeVar(e){this.writeTypeAndName(e),this.writeVarInit(e)}visitVar(e){this.writeVar(e)}writeObjectLiteral(e,t){let i=" { ";for(const r of e.items){this.write(i);let e=r,s=e.left;this.writeName(s.symbol),this.write(t),this.writeCoerced(e.left.type,e.right,FuPriority.ARGUMENT),i=", "}this.write(" }")}static#rr(e){let t,i,r=e.value;return(t=r)instanceof FuPrefixExpr&&(r=t.inner),(i=r)instanceof FuAggregateInitializer?i:null}#sr(e,t){let i=t,r=i.left;this.writeMemberOp(e,r),this.writeName(r.symbol),this.write(" = "),this.writeCoerced(r.type,i.right,FuPriority.ARGUMENT),this.endStatement()}writeInitCode(e){let t=GenBase.#rr(e);if(null!=t)for(const i of t.items)this.writeLocalName(e,FuPriority.PRIMARY),this.#sr(e,i)}defineIsVar(e){let t;(t=e.right)instanceof FuVar&&(this.ensureChildBlock(),this.writeVar(t),this.endStatement())}writeArrayElement(e,t){this.writeLocalName(e,FuPriority.PRIMARY);for(let e=0;e<t;e++)this.write("[_i"),this.visitLiteralLong(BigInt(e)),this.writeChar(93)}openLoop(e,t,i){this.write("for ("),this.write(e),this.write(" _i"),this.visitLiteralLong(BigInt(t)),this.write(" = 0; _i"),this.visitLiteralLong(BigInt(t)),this.write(" < "),this.visitLiteralLong(BigInt(i)),this.write("; _i"),this.visitLiteralLong(BigInt(t)),this.write("++) "),this.openBlock()}writeTemporaryName(e){this.write("futemp"),this.visitLiteralLong(BigInt(e))}tryWriteTemporary(e){let t=this.currentTemporaries.indexOf(e);return!(t<0)&&(this.writeTemporaryName(t),!0)}writeResourceName(e){for(const t of e)this.writeChar(FuLexer.isLetterOrDigit(t.codePointAt(0))?t.codePointAt(0):95)}visitPrefixExpr(e,t){switch(e.op){case FuToken.INCREMENT:this.write("++");break;case FuToken.DECREMENT:this.write("--");break;case FuToken.MINUS:let i;this.writeChar(45),(i=e.inner)instanceof FuPrefixExpr&&(i.op==FuToken.MINUS||i.op==FuToken.DECREMENT)&&this.writeChar(32);break;case FuToken.TILDE:this.writeChar(126);break;case FuToken.EXCLAMATION_MARK:this.writeChar(33);break;case FuToken.NEW:let r=e.type;if(r.class.id==FuId.ARRAY_PTR_CLASS)this.writeNewArray(r.getElementType(),e.inner,t);else{let i;(i=e.inner)instanceof FuAggregateInitializer?this.tryWriteTemporary(e)||this.writeNewWithFields(r,i):this.writeNew(r,t)}return;case FuToken.RESOURCE:let s=e.inner,a=e.type;return void this.writeResource(s.value,a.length);default:throw new Error}e.inner.accept(this,FuPriority.PRIMARY)}visitPostfixExpr(e,t){switch(e.inner.accept(this,FuPriority.PRIMARY),e.op){case FuToken.INCREMENT:this.write("++");break;case FuToken.DECREMENT:this.write("--");break;default:throw new Error}}isWholeArray(e,t,i){let r,s;return(r=e.type)instanceof FuArrayStorageType&&t.isLiteralZero()&&(s=i)instanceof FuLiteralLong&&r.length==s.value}startAdd(e){e.isLiteralZero()||(e.accept(this,FuPriority.ADD),this.write(" + "))}writeAdd(e,t){let i;if((i=e)instanceof FuLiteralLong){let e,r=i.value;if(0==r)return void t.accept(this,FuPriority.ARGUMENT);if((e=t)instanceof FuLiteralLong)return void this.visitLiteralLong(r+e.value)}else if(t.isLiteralZero())return void e.accept(this,FuPriority.ARGUMENT);e.accept(this,FuPriority.ADD),this.write(" + "),t.accept(this,FuPriority.ADD)}writeStartEnd(e,t){e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeAdd(e,t)}static#ar(e){switch(e){case FuPriority.OR:case FuPriority.XOR:case FuPriority.AND:case FuPriority.SHIFT:return!0;default:return!1}}writeBinaryOperand(e,t,i){e.accept(this,t)}writeBinaryExpr(e,t,i,r,s){t&&this.writeChar(40),this.writeBinaryOperand(e.left,i,e),this.write(r),this.writeBinaryOperand(e.right,s,e),t&&this.writeChar(41)}writeBinaryExpr2(e,t,i,r){this.writeBinaryExpr(e,t>i,i,r,i)}static getEqOp(e){return e?" != ":" == "}writeEqualOperand(e,t){e.accept(this,FuPriority.EQUALITY)}writeEqualExpr(e,t,i,r){i>FuPriority.COND_AND&&this.writeChar(40),this.writeEqualOperand(e,t),this.write(r),this.writeEqualOperand(t,e),i>FuPriority.COND_AND&&this.writeChar(41)}writeEqual(e,t,i,r){this.writeEqualExpr(e,t,i,GenBase.getEqOp(r))}writeRel(e,t,i){this.writeBinaryExpr(e,t>FuPriority.COND_AND,FuPriority.REL,i,FuPriority.REL)}writeAnd(e,t){this.writeBinaryExpr(e,t>FuPriority.COND_AND&&t!=FuPriority.AND,FuPriority.AND," & ",FuPriority.AND)}writeAssignRight(e){this.writeCoerced(e.left.type,e.right,FuPriority.ARGUMENT)}writeAssign(e,t){t>FuPriority.ASSIGN&&this.writeChar(40),e.left.accept(this,FuPriority.ASSIGN),this.write(" = "),this.writeAssignRight(e),t>FuPriority.ASSIGN&&this.writeChar(41)}writeOpAssignRight(e){e.right.accept(this,FuPriority.ARGUMENT)}writeIndexing(e,t){e.accept(this,FuPriority.PRIMARY),this.writeChar(91),t.accept(this,FuPriority.ARGUMENT),this.writeChar(93)}writeIndexingExpr(e,t){this.writeIndexing(e.left,e.right)}getIsOperator(){return" is "}visitBinaryExpr(e,t){switch(e.op){case FuToken.PLUS:this.writeBinaryExpr(e,t>FuPriority.ADD||GenBase.#ar(t),FuPriority.ADD," + ",FuPriority.ADD);break;case FuToken.MINUS:this.writeBinaryExpr(e,t>FuPriority.ADD||GenBase.#ar(t),FuPriority.ADD," - ",FuPriority.MUL);break;case FuToken.ASTERISK:this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.MUL," * ",FuPriority.PRIMARY);break;case FuToken.SLASH:this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.MUL," / ",FuPriority.PRIMARY);break;case FuToken.MOD:this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.MUL," % ",FuPriority.PRIMARY);break;case FuToken.SHIFT_LEFT:this.writeBinaryExpr(e,t>FuPriority.SHIFT,FuPriority.SHIFT," << ",FuPriority.MUL);break;case FuToken.SHIFT_RIGHT:this.writeBinaryExpr(e,t>FuPriority.SHIFT,FuPriority.SHIFT," >> ",FuPriority.MUL);break;case FuToken.EQUAL:this.writeEqual(e.left,e.right,t,!1);break;case FuToken.NOT_EQUAL:this.writeEqual(e.left,e.right,t,!0);break;case FuToken.LESS:this.writeRel(e,t," < ");break;case FuToken.LESS_OR_EQUAL:this.writeRel(e,t," <= ");break;case FuToken.GREATER:this.writeRel(e,t," > ");break;case FuToken.GREATER_OR_EQUAL:this.writeRel(e,t," >= ");break;case FuToken.AND:this.writeAnd(e,t);break;case FuToken.OR:this.writeBinaryExpr2(e,t,FuPriority.OR," | ");break;case FuToken.XOR:this.writeBinaryExpr(e,t>FuPriority.XOR||t==FuPriority.OR,FuPriority.XOR," ^ ",FuPriority.XOR);break;case FuToken.COND_AND:this.writeBinaryExpr(e,t>FuPriority.COND_AND||t==FuPriority.COND_OR,FuPriority.COND_AND," && ",FuPriority.COND_AND);break;case FuToken.COND_OR:this.writeBinaryExpr2(e,t,FuPriority.COND_OR," || ");break;case FuToken.ASSIGN:this.writeAssign(e,t);break;case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:t>FuPriority.ASSIGN&&this.writeChar(40),e.left.accept(this,FuPriority.ASSIGN),this.writeChar(32),this.write(e.getOpString()),this.writeChar(32),this.writeOpAssignRight(e),t>FuPriority.ASSIGN&&this.writeChar(41);break;case FuToken.LEFT_BRACKET:e.left.type instanceof FuStringType?this.writeCharAt(e):this.writeIndexingExpr(e,t);break;case FuToken.IS:if(t>FuPriority.REL&&this.writeChar(40),e.left.accept(this,FuPriority.REL),this.write(this.getIsOperator()),e.right instanceof FuSymbolReference){const t=e.right;this.writeName(t.symbol)}else{if(!(e.right instanceof FuVar))throw new Error;{const t=e.right;this.writeTypeAndName(t)}}t>FuPriority.REL&&this.writeChar(41);break;default:throw new Error}}writeArrayLength(e,t){this.writePostfix(e,".length")}static isReferenceTo(e,t){let i;return(i=e)instanceof FuSymbolReference&&i.symbol.id==t}writeJavaMatchProperty(e,t){switch(e.symbol.id){case FuId.MATCH_START:return this.writePostfix(e.left,".start()"),!0;case FuId.MATCH_END:return this.writePostfix(e.left,".end()"),!0;case FuId.MATCH_LENGTH:return t>FuPriority.ADD&&this.writeChar(40),this.writePostfix(e.left,".end() - "),this.writePostfix(e.left,".start()"),t>FuPriority.ADD&&this.writeChar(41),!0;case FuId.MATCH_VALUE:return this.writePostfix(e.left,".group()"),!0;default:return!1}}visitSymbolReference(e,t){null==e.left?this.writeLocalName(e.symbol,t):e.symbol.id==FuId.STRING_LENGTH?this.writeStringLength(e.left):e.symbol.id==FuId.ARRAY_LENGTH?this.writeArrayLength(e.left,t):(e.left.accept(this,FuPriority.PRIMARY),this.writeMemberOp(e.left,e),this.writeName(e.symbol))}writeNotPromoted(e,t){t.accept(this,FuPriority.ARGUMENT)}writeEnumAsInt(e,t){e.accept(this,t)}writeEnumHasFlag(e,t,i){i>FuPriority.EQUALITY&&this.writeChar(40);let r=t[0].intValue();0==(r&r-1)&&0!=r?(this.writeChar(40),this.writeEnumAsInt(e,FuPriority.AND),this.write(" & "),this.writeEnumAsInt(t[0],FuPriority.AND),this.write(") != 0")):(this.write("(~"),this.writeEnumAsInt(e,FuPriority.PRIMARY),this.write(" & "),this.writeEnumAsInt(t[0],FuPriority.AND),this.write(") == 0")),i>FuPriority.EQUALITY&&this.writeChar(41)}writeTryParseRadix(e){this.write(", "),2==e.length?e[1].accept(this,FuPriority.ARGUMENT):this.write("10")}writeListAdd(e,t,i){e.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(t),this.writeChar(40);let r=e.type.asClassType().getElementType();0==i.length?this.writeNewStorage(r):this.writeNotPromoted(r,i[0]),this.writeChar(41)}writeListInsert(e,t,i,r=", "){e.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(t),this.writeChar(40),i[0].accept(this,FuPriority.ARGUMENT),this.write(r);let s=e.type.asClassType().getElementType();1==i.length?this.writeNewStorage(s):this.writeNotPromoted(s,i[1]),this.writeChar(41)}writeDictionaryAdd(e,t){this.writeIndexing(e,t[0]),this.write(" = "),this.writeNewStorage(e.type.asClassType().getValueType())}writeClampAsMinMax(e){e[0].accept(this,FuPriority.ARGUMENT),this.write(", "),e[1].accept(this,FuPriority.ARGUMENT),this.write("), "),e[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41)}getRegexOptions(e){let t=e.at(-1);return t.type instanceof FuEnum?t.intValue():RegexOptions.NONE}writeRegexOptions(e,t,i,r,s,a,n){let h=this.getRegexOptions(e);return h!=RegexOptions.NONE&&(this.write(t),0!=(h&RegexOptions.IGNORE_CASE)&&this.write(s),0!=(h&RegexOptions.MULTILINE)&&(0!=(h&RegexOptions.IGNORE_CASE)&&this.write(i),this.write(a)),0!=(h&RegexOptions.SINGLELINE)&&(h!=RegexOptions.SINGLELINE&&this.write(i),this.write(n)),this.write(r),!0)}visitCallExpr(e,t){let i=e.method.symbol;this.writeCallExpr(e.type,e.method.left,i,e.arguments_,t)}visitSelectExpr(e,t){this.writeCoercedSelect(e.type,e,t)}ensureChildBlock(){this.#zi&&(this.atLineStart=!1,this.#zi=!1,this.writeChar(32),this.openBlock(),this.#$i=!0)}static hasTemporaries(e){if(e instanceof FuAggregateInitializer){return e.items.some((e=>GenBase.hasTemporaries(e)))}if(e instanceof FuLiteral||e instanceof FuLambdaExpr)return!1;if(e instanceof FuInterpolatedString){return e.parts.some((e=>GenBase.hasTemporaries(e.argument)))}if(e instanceof FuSymbolReference){const t=e;return null!=t.left&&GenBase.hasTemporaries(t.left)}if(e instanceof FuUnaryExpr){const t=e;return null!=t.inner&&(GenBase.hasTemporaries(t.inner)||t.inner instanceof FuAggregateInitializer)}if(e instanceof FuBinaryExpr){const t=e;return GenBase.hasTemporaries(t.left)||(t.op==FuToken.IS?t.right instanceof FuVar:GenBase.hasTemporaries(t.right))}if(e instanceof FuSelectExpr){const t=e;return GenBase.hasTemporaries(t.cond)||GenBase.hasTemporaries(t.onTrue)||GenBase.hasTemporaries(t.onFalse)}if(e instanceof FuCallExpr){const t=e;return GenBase.hasTemporaries(t.method)||t.arguments_.some((e=>GenBase.hasTemporaries(e)))}throw new Error}defineObjectLiteralTemporary(e){let t;if((t=e.inner)instanceof FuAggregateInitializer){this.ensureChildBlock();let i=this.currentTemporaries.indexOf(e.type);i<0?(i=this.currentTemporaries.length,this.startTemporaryVar(e.type),this.currentTemporaries.push(e)):this.currentTemporaries[i]=e,this.writeTemporaryName(i),this.write(" = ");let r=e.type;this.writeNew(r,FuPriority.ARGUMENT),this.endStatement();for(const r of t.items)this.writeTemporaryName(i),this.#sr(e,r)}}writeTemporariesNotSubstring(e){this.writeTemporaries(e)}writeOwningTemporary(e){}writeArgTemporary(e,t,i){}writeTemporaries(e){if(e instanceof FuVar){const t=e;if(null!=t.value){let e;(e=t.value)instanceof FuUnaryExpr&&e.inner instanceof FuAggregateInitializer?this.writeTemporaries(e.inner):this.writeTemporaries(t.value)}}else if(e instanceof FuAggregateInitializer){const t=e;for(const e of t.items){let t=e;this.writeTemporaries(t.right)}}else if(e instanceof FuLiteral||e instanceof FuLambdaExpr);else if(e instanceof FuInterpolatedString){const t=e;for(const e of t.parts)this.writeTemporariesNotSubstring(e.argument)}else if(e instanceof FuSymbolReference){const t=e;null!=t.left&&(this.writeTemporaries(t.left),this.writeOwningTemporary(t.left))}else if(e instanceof FuUnaryExpr){const t=e;null!=t.inner&&(this.writeTemporaries(t.inner),this.defineObjectLiteralTemporary(t))}else if(e instanceof FuBinaryExpr){const t=e;this.writeTemporariesNotSubstring(t.left),t.op==FuToken.IS?this.defineIsVar(t):(this.writeTemporaries(t.right),t.op!=FuToken.ASSIGN&&this.writeOwningTemporary(t.right))}else if(e instanceof FuSelectExpr){const t=e;this.writeTemporaries(t.cond),this.writeTemporaries(t.onTrue),this.writeTemporaries(t.onFalse)}else{if(!(e instanceof FuCallExpr))throw new Error;{const t=e;this.writeTemporaries(t.method);let i=t.method.symbol,r=i.firstParameter();for(const e of t.arguments_)this.writeTemporaries(e),this.writeArgTemporary(i,r,e),r=r.nextVar()}}}cleanupTemporary(e,t){}cleanupTemporaries(){for(let e=this.currentTemporaries.length;--e>=0;){let t=this.currentTemporaries[e];t instanceof FuType||(this.cleanupTemporary(e,t),this.currentTemporaries[e]=t.type)}}visitExpr(e){let t;this.writeTemporaries(e),e.accept(this,FuPriority.STATEMENT),this.writeCharLine(59),(t=e)instanceof FuVar&&this.writeInitCode(t),this.cleanupTemporaries()}visitConst(e){}visitAssert(e){let t;(t=e.cond)instanceof FuBinaryExpr&&t.op==FuToken.IS&&t.right instanceof FuVar?this.writeAssertCast(t):this.writeAssert(e)}writeFirstStatements(e,t){for(let i=0;i<t;i++)e[i].acceptStatement(this)}writeStatements(e){this.writeFirstStatements(e,e.length)}cleanupBlock(e){}trimTemporariesAndCloseBlock(e){this.currentTemporaries.splice(e,this.currentTemporaries.length-e),this.closeBlock()}visitBlock(e){this.#zi&&(this.atLineStart=!1,this.#zi=!1,this.writeChar(32)),this.openBlock();let t=this.currentTemporaries.length;this.writeStatements(e.statements),this.cleanupBlock(e),this.trimTemporariesAndCloseBlock(t)}writeChild(e){let t=this.#$i;this.atLineStart=!0,this.#zi=!0,this.#$i=!1;let i=this.currentTemporaries.length;e.acceptStatement(this),this.#$i?this.trimTemporariesAndCloseBlock(i):e instanceof FuBlock||this.indent--,this.#$i=t}startBreakGoto(){this.write("goto fuafterswitch")}visitBreak(e){let t;if((t=e.loopOrSwitch)instanceof FuSwitch){let e=this.switchesWithGoto.indexOf(t);if(e>=0)return this.startBreakGoto(),this.visitLiteralLong(BigInt(e)),void this.writeCharLine(59)}this.writeLine("break;")}visitContinue(e){this.writeLine("continue;")}visitDoWhile(e){this.write("do"),this.writeChild(e.body),this.write("while ("),e.cond.accept(this,FuPriority.ARGUMENT),this.writeLine(");")}visitFor(e){null!=e.cond&&this.writeTemporaries(e.cond),this.write("for ("),null!=e.init&&e.init.accept(this,FuPriority.STATEMENT),this.writeChar(59),null!=e.cond&&(this.writeChar(32),e.cond.accept(this,FuPriority.ARGUMENT)),this.writeChar(59),null!=e.advance&&(this.writeChar(32),e.advance.accept(this,FuPriority.STATEMENT)),this.writeChar(41),this.writeChild(e.body)}embedIfWhileIsVar(e,t){return!1}#nr(e){this.embedIfWhileIsVar(e,!0),e.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}startIf(e){this.write("if ("),this.#nr(e)}#hr(e){if(this.startIf(e.cond),this.writeChild(e.onTrue),null!=e.onFalse){let t;if(this.write("else"),(t=e.onFalse)instanceof FuIf){let e=this.#$i;this.atLineStart=!0,this.#zi=!0,this.#$i=!1,this.embedIfWhileIsVar(t.cond,!1)||this.writeTemporaries(t.cond),this.#$i?(this.#hr(t),this.closeBlock()):(this.atLineStart=!1,this.#zi=!1,this.writeChar(32),this.#hr(t)),this.#$i=e}else this.writeChild(e.onFalse)}}visitIf(e){this.embedIfWhileIsVar(e.cond,!1)||this.writeTemporaries(e.cond),this.#hr(e)}visitNative(e){this.write(e.content)}visitReturn(e){null==e.value?this.writeLine("return;"):(this.writeTemporaries(e.value),this.write("return "),this.writeStronglyCoerced(this.currentMethod.type,e.value),this.writeCharLine(59),this.cleanupTemporaries())}defineVar(e){let t;(t=e)instanceof FuVar&&(this.writeVar(t),this.endStatement())}writeSwitchCaseTypeVar(e){}writeSwitchValue(e){e.accept(this,FuPriority.ARGUMENT)}writeSwitchCaseValue(e,t){let i;(i=t)instanceof FuBinaryExpr&&i.op==FuToken.WHEN?(this.writeSwitchCaseValue(e,i.left),this.write(" when "),i.right.accept(this,FuPriority.ARGUMENT)):this.writeCoercedLiteral(e.value.type,t)}writeSwitchCaseBody(e){this.writeStatements(e)}writeSwitchCase(e,t){for(const i of t.values)this.write("case "),this.writeSwitchCaseValue(e,i),this.writeCharLine(58);this.indent++,this.writeSwitchCaseBody(t.body),this.indent--}startSwitch(e){this.write("switch ("),this.writeSwitchValue(e.value),this.writeLine(") {");for(const t of e.cases)this.writeSwitchCase(e,t)}writeSwitchCaseCond(e,t,i){let r;(r=t)instanceof FuBinaryExpr&&r.op==FuToken.WHEN?(i>FuPriority.SELECT_COND&&this.writeChar(40),this.writeSwitchCaseCond(e,r.left,FuPriority.COND_AND),this.write(" && "),r.right.accept(this,FuPriority.COND_AND),i>FuPriority.SELECT_COND&&this.writeChar(41)):this.writeEqual(e.value,t,i,!1)}writeIfCaseBody(e,t,i,r){let s=FuSwitch.lengthWithoutTrailingBreak(e);t&&FuSwitch.hasEarlyBreak(e)?(this.indent++,this.writeNewLine(),this.write("do "),this.openBlock(),this.writeFirstStatements(e,s),this.closeBlock(),this.writeLine("while (false);"),this.indent--):1!=s||e[0]instanceof FuIf||e[0]instanceof FuSwitch?(this.writeChar(32),this.openBlock(),this.writeFirstStatements(e,s),this.closeBlock()):this.writeChild(e[0])}writeSwitchAsIfs(e,t){for(const t of e.cases)for(const e of t.values){let t;(t=e)instanceof FuBinaryExpr&&t.op==FuToken.WHEN?(this.defineVar(t.left),this.writeTemporaries(t)):this.writeSwitchCaseTypeVar(e)}let i="if (";for(const r of e.cases){let s=1==r.values.length?FuPriority.ARGUMENT:FuPriority.COND_OR;for(const t of r.values)this.write(i),this.writeSwitchCaseCond(e,t,s),i=" || ";this.writeChar(41),this.writeIfCaseBody(r.body,t,e,r),i="else if ("}e.hasDefault()&&(this.write("else"),this.writeIfCaseBody(e.defaultBody,t,e,null))}visitSwitch(e){this.writeTemporaries(e.value),this.startSwitch(e),e.defaultBody.length>0&&(this.writeLine("default:"),this.indent++,this.writeSwitchCaseBody(e.defaultBody),this.indent--),this.writeCharLine(125)}writeException(){this.write("Exception")}writeExceptionClass(e){"Exception"==e.name?this.writeException():this.writeName(e)}writeThrowMessage(e){null!=e&&e.accept(this,FuPriority.ARGUMENT)}writeThrowArgument(e){this.writeExceptionClass(e.class.symbol),this.writeChar(40),this.writeThrowMessage(e.message),this.writeChar(41)}visitThrow(e){this.write("throw new "),this.writeThrowArgument(e),this.writeCharLine(59)}visitWhile(e){this.embedIfWhileIsVar(e.cond,!1)||this.writeTemporaries(e.cond),this.write("while ("),this.#nr(e.cond),this.writeChild(e.body)}flattenBlock(e){let t;(t=e)instanceof FuBlock?this.writeStatements(t.statements):e.acceptStatement(this)}hasInitCode(e){return null!=GenBase.#rr(e)}needsConstructor(e){for(let t=e.first;null!=t;t=t.next){let e;if((e=t)instanceof FuField&&this.hasInitCode(e))return!0}return null!=e.constructor_}writeInitField(e){this.writeInitCode(e)}writeConstructorBody(e){for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuField&&this.writeInitField(e)}if(null!=e.constructor_){this.currentMethod=e.constructor_;let t=e.constructor_.body;this.writeStatements(t.statements),this.currentMethod=null}this.switchesWithGoto.length=0,this.currentTemporaries.length=0}writeParameter(e){this.writeTypeAndName(e)}writeRemainingParameters(e,t,i){for(let r=e.firstParameter();null!=r;r=r.nextVar())t||this.write(", "),t=!1,this.writeParameter(r),i&&this.writeVarInit(r);this.writeChar(41)}writeParameters(e,t){this.writeChar(40),this.writeRemainingParameters(e,!0,t)}isShortMethod(e){return!1}writeBody(e){if(e.callType==FuCallType.ABSTRACT)this.writeCharLine(59);else{if(this.currentMethod=e,this.isShortMethod(e)){this.write(" => ");let t=e.body;this.writeCoerced(e.type,t.value,FuPriority.ARGUMENT),this.writeCharLine(59)}else this.writeNewLine(),this.openBlock(),this.flattenBlock(e.body),this.closeBlock();this.currentMethod=null}}writePublic(e){e.isPublic&&this.write("public ")}writeEnumValue(e){this.writeDoc(e.documentation),this.writeName(e),e.value instanceof FuImplicitEnumValue||(this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT))}visitEnumValue(e,t){null!=t&&this.writeCharLine(44),this.writeEnumValue(e)}writeRegexOptionsEnum(e){e.regexOptionsEnum&&this.writeEnum(e.system.regexOptionsEnum)}startClass(e,t,i){this.write("class "),this.write(e.name),this.write(t),e.hasBaseClass()&&(this.write(i),this.writeExceptionClass(e.parent))}openClass(e,t,i){this.startClass(e,t,i),this.writeNewLine(),this.openBlock()}writeMembers(e,t){for(let t=e.first;null!=t;t=t.next)if(t instanceof FuConst){const e=t;this.writeConst(e)}else if(t instanceof FuField){const e=t;this.writeField(e)}else if(t instanceof FuMethod){const e=t;this.writeMethod(e),this.switchesWithGoto.length=0,this.currentTemporaries.length=0}else{if(!(t instanceof FuNative))throw new Error;{const e=t;this.visitNative(e)}}if(t)for(const t of e.constArrays)this.writeConst(t)}writeBaseClass(e,t){if("Exception"==e.name)return!1;if(this.writtenTypes.has(e))return!1;let i;return this.writtenTypes.add(e),(i=e.parent)instanceof FuClass&&this.writeClass(i,t),!0}writeTypes(e){this.writeRegexOptionsEnum(e);for(let t=e.first;null!=t;t=t.next)if(t instanceof FuClass){const i=t;this.writeClass(i,e)}else{if(!(t instanceof FuEnum))throw new Error;{const e=t;this.writeEnum(e)}}}}export class GenTyped extends GenBase{writeCoercedLiteral(e,t){t.accept(this,FuPriority.ARGUMENT),null!=e&&e.id==FuId.FLOAT_TYPE&&t instanceof FuLiteralDouble&&this.writeChar(102)}writeTypeAndName(e){this.writeType(e.type,!0),this.writeChar(32),this.writeName(e)}visitAggregateInitializer(e){this.write("{ "),this.writeCoercedLiterals(e.type.asClassType().getElementType(),e.items),this.write(" }")}writeArrayStorageLength(e){let t=e.type;this.visitLiteralLong(BigInt(t.length))}writeNewArray(e,t,i){for(this.write("new "),this.writeType(e.getBaseType(),!1),this.writeChar(91),t.accept(this,FuPriority.ARGUMENT),this.writeChar(93);e.isArray();){let t;this.writeChar(91),(t=e)instanceof FuArrayStorageType&&t.lengthExpr.accept(this,FuPriority.ARGUMENT),this.writeChar(93),e=e.asClassType().getElementType()}}getOneAscii(e){let t;return(t=e)instanceof FuLiteralString?t.getOneAscii():-1}writeCharMethodCall(e,t,i){e.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(t),this.writeChar(40),i instanceof FuLiteralChar||this.write("(char) "),i.accept(this,FuPriority.PRIMARY),this.writeChar(41)}static isNarrower(e,t){switch(e){case FuId.S_BYTE_RANGE:switch(t){case FuId.BYTE_RANGE:case FuId.SHORT_RANGE:case FuId.U_SHORT_RANGE:case FuId.INT_TYPE:case FuId.N_INT_TYPE:case FuId.LONG_TYPE:return!0;default:return!1}case FuId.BYTE_RANGE:switch(t){case FuId.S_BYTE_RANGE:case FuId.SHORT_RANGE:case FuId.U_SHORT_RANGE:case FuId.INT_TYPE:case FuId.N_INT_TYPE:case FuId.LONG_TYPE:return!0;default:return!1}case FuId.SHORT_RANGE:switch(t){case FuId.U_SHORT_RANGE:case FuId.INT_TYPE:case FuId.N_INT_TYPE:case FuId.LONG_TYPE:return!0;default:return!1}case FuId.U_SHORT_RANGE:switch(t){case FuId.SHORT_RANGE:case FuId.INT_TYPE:case FuId.N_INT_TYPE:case FuId.LONG_TYPE:return!0;default:return!1}case FuId.INT_TYPE:return t==FuId.LONG_TYPE;default:return!1}}getStaticCastInner(e,t){let i,r;if((i=t)instanceof FuBinaryExpr&&i.op==FuToken.AND&&(r=i.right)instanceof FuLiteralLong&&e instanceof FuIntegerType){let s;switch(e.id){case FuId.BYTE_RANGE:case FuId.S_BYTE_RANGE:s=255n;break;case FuId.SHORT_RANGE:case FuId.U_SHORT_RANGE:s=65535n;break;case FuId.INT_TYPE:s=4294967295n;break;default:return t}if((r.value&s)==s)return i.left}return t}writeStaticCastType(e){this.writeChar(40),this.writeType(e,!1),this.write(") ")}writeStaticCast(e,t){this.writeStaticCastType(e),this.getStaticCastInner(e,t).accept(this,FuPriority.PRIMARY)}writeNotPromoted(e,t){e instanceof FuIntegerType&&GenTyped.isNarrower(e.id,this.getTypeId(t.type,!0))?this.writeStaticCast(e,t):this.writeCoercedLiteral(e,t)}isPromoted(e){let t;return!((t=e)instanceof FuBinaryExpr&&(t.op==FuToken.LEFT_BRACKET||t.isAssign()))}writeAssignRight(e){if(e.left.isIndexing()){if(e.right instanceof FuLiteralLong)return void this.writeCoercedLiteral(e.left.type,e.right);let t=e.left.type.id,i=this.getTypeId(e.right.type,this.isPromoted(e.right));if(t==FuId.S_BYTE_RANGE&&i==FuId.S_BYTE_RANGE)return void e.right.accept(this,FuPriority.ASSIGN);if(GenTyped.isNarrower(t,i))return void this.writeStaticCast(e.left.type,e.right)}super.writeAssignRight(e)}writeCoercedInternal(e,t,i){if(e instanceof FuIntegerType&&e.id!=FuId.LONG_TYPE&&t.type.id==FuId.LONG_TYPE)this.writeStaticCast(e,t);else if(e.id==FuId.FLOAT_TYPE&&t.type.id==FuId.DOUBLE_TYPE){let i;(i=t)instanceof FuLiteralDouble?(this.visitLiteralDouble(i.value),this.writeChar(102)):this.writeStaticCast(e,t)}else if(e instanceof FuIntegerType&&t.type.id==FuId.FLOAT_INT_TYPE){let i;if((i=t)instanceof FuCallExpr&&i.method.symbol.id==FuId.MATH_TRUNCATE){let e;if((e=t=i.arguments_[0])instanceof FuLiteralDouble)return void this.visitLiteralLong(BigInt(Math.trunc(e.value)))}this.writeStaticCast(e,t)}else super.writeCoercedInternal(e,t,i)}writeCharAt(e){this.writeIndexing(e.left,e.right)}startTemporaryVar(e){this.writeType(e,!0),this.writeChar(32)}writeAssertCast(e){let t=e.right;this.writeTypeAndName(t),this.write(" = "),this.writeStaticCast(t.type,e.left),this.writeCharLine(59)}writeExceptionConstructor(e,t){this.write("public "),this.write(e.name),this.writeLine(t)}}export class GenCCppD extends GenTyped{visitLiteralLong(e){-0x8000000000000000==e?this.write("(-9223372036854775807 - 1)"):super.visitLiteralLong(e)}static#or(e,t){let i;return(i=e.type)instanceof FuClassType&&i.class.id!=FuId.STRING_CLASS&&i.isAssignableFrom(t.type)}writeEqual(e,t,i,r){let s;if(GenCCppD.#or(e,t))s=e.type;else{if(!GenCCppD.#or(t,e))return void super.writeEqual(e,t,i,r);s=t.type}i>FuPriority.EQUALITY&&this.writeChar(40),this.writeCoerced(s,e,FuPriority.EQUALITY),this.write(GenCCppD.getEqOp(r)),this.writeCoerced(s,t,FuPriority.EQUALITY),i>FuPriority.EQUALITY&&this.writeChar(41)}visitConst(e){e.type instanceof FuArrayStorageType&&this.writeConst(e)}writeSwitchAsIfsWithGoto(e){if(e.cases.some((e=>FuSwitch.hasEarlyBreakAndContinue(e.body)))||FuSwitch.hasEarlyBreakAndContinue(e.defaultBody)){let t=this.switchesWithGoto.length;this.switchesWithGoto.push(e),this.writeSwitchAsIfs(e,!1),this.write("fuafterswitch"),this.visitLiteralLong(BigInt(t)),this.writeLine(": ;")}else this.writeSwitchAsIfs(e,!0)}}export class GenCCpp extends GenCCppD{writeDocCode(e){"null"==e?this.visitLiteralNull():this.writeXmlDoc(e)}#ur(){this.writeIncludes("#include <",">")}getLiteralChars(){return 127}writeNumericType(e){switch(e){case FuId.S_BYTE_RANGE:this.includeStdInt(),this.write("int8_t");break;case FuId.BYTE_RANGE:this.includeStdInt(),this.write("uint8_t");break;case FuId.SHORT_RANGE:this.includeStdInt(),this.write("int16_t");break;case FuId.U_SHORT_RANGE:this.includeStdInt(),this.write("uint16_t");break;case FuId.INT_TYPE:this.write("int");break;case FuId.N_INT_TYPE:this.includeStdDef(),this.write("ptrdiff_t");break;case FuId.LONG_TYPE:this.includeStdInt(),this.write("int64_t");break;case FuId.FLOAT_TYPE:this.write("float");break;case FuId.DOUBLE_TYPE:this.write("double");break;default:throw new Error}}writeArrayLength(e,t){t>FuPriority.ADD&&this.writeChar(40),this.write("argc - 1"),t>FuPriority.ADD&&this.writeChar(41)}writeArgsIndexing(e){let t;this.write("argv["),(t=e)instanceof FuLiteralLong?this.visitLiteralLong(1n+t.value):(this.write("1 + "),e.accept(this,FuPriority.ADD)),this.writeChar(93)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.MATH_NA_N:this.includeMath(),this.write("NAN");break;case FuId.MATH_NEGATIVE_INFINITY:this.includeMath(),this.write("-INFINITY");break;case FuId.MATH_POSITIVE_INFINITY:this.includeMath(),this.write("INFINITY");break;default:super.visitSymbolReference(e,t)}}static isStringEmpty(e){let t;return(t=e.left)instanceof FuSymbolReference&&t.symbol.id==FuId.STRING_LENGTH&&e.right.isLiteralZero()?t.left:null}writeArrayPtrAdd(e,t){t.isLiteralZero()?this.writeArrayPtr(e,FuPriority.ARGUMENT):(this.writeArrayPtr(e,FuPriority.ADD),this.write(" + "),t.accept(this,FuPriority.MUL))}static isStringSubstring(e){let t;if((t=e)instanceof FuCallExpr){let e=t.method.symbol.id;if(e==FuId.STRING_SUBSTRING&&2==t.arguments_.length||e==FuId.U_T_F8_GET_STRING)return t}return null}static isUTF8GetString(e){return e.method.symbol.id==FuId.U_T_F8_GET_STRING}static isTrimSubstring(e){let t,i=GenCCpp.isStringSubstring(e.right);return null!=i&&!GenCCpp.isUTF8GetString(i)&&(t=e.left)instanceof FuSymbolReference&&i.method.left.isReferenceTo(t.symbol)&&i.arguments_[0].isLiteralZero()?i.arguments_[1]:null}writeStringLiteralWithNewLine(e){this.writeChar(34),this.write(e),this.write('\\n"')}writeUnreachable(e){this.write("abort();"),null!=e.message&&(this.write(" // "),e.message.accept(this,FuPriority.ARGUMENT)),this.writeNewLine()}writeAssert(e){e.completesNormally()?(this.writeTemporaries(e.cond),this.includeAssert(),this.write("assert("),null==e.message?e.cond.accept(this,FuPriority.ARGUMENT):(e.cond.accept(this,FuPriority.COND_AND),this.write(" && "),e.message.accept(this,FuPriority.ARGUMENT)),this.writeLine(");")):this.writeUnreachable(e)}visitReturn(e){null==e.value&&this.currentMethod.id==FuId.MAIN?this.writeLine("return 0;"):super.visitReturn(e)}visitSwitch(e){e.value.type instanceof FuStringType||e.hasWhen()?this.writeSwitchAsIfsWithGoto(e):super.visitSwitch(e)}writeMethods(e){for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuMethod&&(this.writeMethod(e),this.currentTemporaries.length=0)}}writeClass(e,t){if(this.writeBaseClass(e,t)){for(let i=e.first;null!=i;i=i.next){let e,r;(e=i)instanceof FuField&&(r=e.type.getBaseType())instanceof FuStorageType&&r.class.id==FuId.NONE&&this.writeClass(r.class,t)}this.writeClassInternal(e)}}static#cr(e,t){let i=e.length;for(let t=i;--t>=0&&47!=e.charCodeAt(t)&&92!=e.charCodeAt(t);)if(46==e.charCodeAt(t)){i=t;break}return e.substring(0,i)+t}createHeaderFile(e,t){this.createFile(null,GenCCpp.#cr(e,t)),this.writeLine("#pragma once"),this.#ur()}static#lr(e){let t=e.length,i=t,r=t;for(;--r>=0&&47!=e.charCodeAt(r)&&92!=e.charCodeAt(r);)46==e.charCodeAt(r)&&i==t&&(i=r);return r++,e.substring(r,r+i-r)}createImplementationFile(e,t,i){this.createFile(null,t),this.writeTopLevelNatives(e),this.#ur(),this.write('#include "'),this.write(GenCCpp.#lr(t)),this.write(i),this.writeCharLine(34)}}export class GenC extends GenCCpp{namespace;#wr=new Set;#Tr=new Set;#dr=new Set;#pr;#Fr;#Er;#yr;#Ir;#Sr;#Cr;#Ar;#_r;#fr;#Rr;#Lr;#Nr;#gr;#mr;#Pr;#kr=new Set;#br;#Or;#Mr=new Set;#Dr=new Set;#xr=[];#Gr;currentClass;getTargetName(){return"C"}writeSelfDoc(e){e.callType!=FuCallType.STATIC&&(this.write(" * @param self This <code>"),this.writeName(e.parent),this.writeLine("</code>."))}writeReturnDoc(e){0!=e.throws.length&&(this.write(" * @return <code>"),this.#Ur(e.type,!1),this.writeLine("</code> on error."))}writeThrowsDoc(e){}includeStdInt(){this.include("stdint.h")}includeStdDef(){this.include("stddef.h")}includeAssert(){this.include("assert.h")}includeMath(){this.include("math.h")}includeStdBool(){this.include("stdbool.h")}visitLiteralNull(){this.write("NULL")}writePrintfLongPrefix(){this.write("ll")}writePrintfWidth(e){super.writePrintfWidth(e),null!=GenC.isStringSubstring(e.argument)&&(console.assert(e.precision<0),this.write(".*")),e.argument.type.id==FuId.N_INT_TYPE?this.writeChar(116):e.argument.type.id==FuId.LONG_TYPE&&this.writePrintfLongPrefix()}writeInterpolatedStringArgBase(e){e.type.id==FuId.LONG_TYPE?(this.write("(long long) "),e.accept(this,FuPriority.PRIMARY)):e.accept(this,FuPriority.ARGUMENT)}#vr(e,t){GenC.isUTF8GetString(e)?(t&&this.write("(const char *) "),this.writeArrayPtrAdd(e.arguments_[0],e.arguments_[1])):this.writeArrayPtrAdd(e.method.left,e.arguments_[0])}static#Br(e){let t,i;return(t=e)instanceof FuBinaryExpr&&t.op==FuToken.LEFT_BRACKET&&(i=t.left.type)instanceof FuClassType&&2==i.class.typeParameterCount&&i.getValueType()instanceof FuStorageType}startTemporaryVar(e){this.#Yr(e,!0,!0)}#Vr(e,t){for(;t!=e;t=t.parent)this.write(".base")}#Hr(e,t,i){let r,s;(r=t.type)instanceof FuStorageType&&r.class.id==FuId.NONE&&!GenC.#Br(t)?(this.writeChar(38),t.accept(this,FuPriority.PRIMARY),this.#Vr(e,r.class)):(s=t.type)instanceof FuClassType&&s.class!=e?(this.writeChar(38),this.writePostfix(t,"->base"),this.#Vr(e,s.class.parent)):t.accept(this,i)}writeInterpolatedStringArg(e){let t=GenC.isStringSubstring(e);if(null!=t)GenC.#Wr(t).accept(this,FuPriority.ARGUMENT),this.write(", "),this.#vr(t,!0);else{let t;(t=e.type)instanceof FuClassType&&t.class.id!=FuId.STRING_CLASS?(this.write(this.namespace),this.write(t.class.name),this.write("_ToString("),this.#Hr(t.class,e,FuPriority.ARGUMENT),this.writeChar(41)):this.writeInterpolatedStringArgBase(e)}}visitInterpolatedString(e,t){this.tryWriteTemporary(e)||(this.include("stdarg.h"),this.include("stdio.h"),this.#_r=!0,this.write("FuString_Format("),this.writePrintf(e,!1))}writeCamelCaseNotKeyword(e){switch(e){case"this":this.write("self");break;case"Asm":case"Assert":case"Auto":case"Bool":case"Break":case"Byte":case"Case":case"Char":case"Class":case"Const":case"Continue":case"Default":case"Do":case"Double":case"Else":case"Enum":case"Extern":case"False":case"Float":case"For":case"Foreach":case"Goto":case"If":case"Inline":case"Int":case"Long":case"Nullptr":case"Register":case"Restrict":case"Return":case"Short":case"Signed":case"Sizeof":case"Static":case"Struct":case"Switch":case"True":case"Typedef":case"Typeof":case"Union":case"Unsigned":case"Void":case"Volatile":case"While":case"asm":case"auto":case"char":case"extern":case"goto":case"inline":case"nullptr":case"register":case"restrict":case"signed":case"sizeof":case"struct":case"typedef":case"typeof":case"union":case"unsigned":case"volatile":this.writeCamelCase(e),this.writeChar(95);break;default:this.writeCamelCase(e)}}writeName(e){e instanceof FuContainerType?(this.write(this.namespace),this.write(e.name)):e instanceof FuMethod?(this.write(this.namespace),this.write(e.parent.name),this.writeChar(95),this.write(e.name)):e instanceof FuConst?(e.parent instanceof FuContainerType&&(this.write(this.namespace),this.write(e.parent.name),this.writeChar(95)),this.writeUppercaseWithUnderscores(e.name)):this.writeCamelCaseNotKeyword(e.name)}#Qr(e,t){e.collection.type.id==FuId.MAIN_ARGS_TYPE?this.write("argv"):e.collection.accept(this,FuPriority.PRIMARY),this.writeChar(91),this.writeCamelCaseNotKeyword(t.name),this.writeChar(93)}#Xr(e){console.assert(e instanceof FuClass),this.write("self->");for(let t=this.currentClass;t!=e;t=t.parent)this.write("base.")}writeLocalName(e,t){let i;if((i=e.parent)instanceof FuForeach){let r=i.collection.type;if(r.class.id==FuId.STRING_CLASS||!(r.class.id!=FuId.LIST_CLASS||r.getElementType()instanceof FuStorageType))return t==FuPriority.PRIMARY&&this.writeChar(40),this.writeChar(42),this.writeCamelCaseNotKeyword(e.name),void(t==FuPriority.PRIMARY&&this.writeChar(41));if(r.class.id==FuId.ARRAY_STORAGE_CLASS)return void(r.getElementType()instanceof FuStorageType?(t>FuPriority.ADD&&this.writeChar(40),i.collection.accept(this,FuPriority.ADD),this.write(" + "),this.writeCamelCaseNotKeyword(e.name),t>FuPriority.ADD&&this.writeChar(41)):this.#Qr(i,e))}e instanceof FuField&&this.#Xr(e.parent),this.writeName(e)}#Kr(e,t){this.#Rr=!0,this.write("FuMatch_GetPos("),e.left.accept(this,FuPriority.ARGUMENT),this.write(", "),this.visitLiteralLong(BigInt(t)),this.writeChar(41)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.STRING_LENGTH:this.writeStringLength(e.left);break;case FuId.CONSOLE_ERROR:this.include("stdio.h"),this.write("stderr");break;case FuId.LIST_COUNT:case FuId.STACK_COUNT:this.writePostfix(e.left,"->len");break;case FuId.QUEUE_COUNT:e.left.accept(this,FuPriority.PRIMARY),e.left.type instanceof FuStorageType?this.writeChar(46):this.write("->"),this.write("length");break;case FuId.HASH_SET_COUNT:case FuId.DICTIONARY_COUNT:this.writeCall("g_hash_table_size",e.left);break;case FuId.SORTED_SET_COUNT:case FuId.SORTED_DICTIONARY_COUNT:this.writeCall("g_tree_nnodes",e.left);break;case FuId.MATCH_START:this.#Kr(e,0);break;case FuId.MATCH_END:this.#Kr(e,1);break;case FuId.MATCH_LENGTH:this.#Kr(e,2);break;case FuId.MATCH_VALUE:this.tryWriteTemporary(e)||(this.write("g_match_info_fetch("),e.left.accept(this,FuPriority.ARGUMENT),this.write(", 0)"));break;default:if(null==e.left||e.symbol instanceof FuConst)this.writeLocalName(e.symbol,t);else if(GenC.#Br(e.left))this.writePostfix(e.left,"->"),this.writeName(e.symbol);else{let i,r,s;(i=e.left)instanceof FuSymbolReference&&(r=i.symbol.parent)instanceof FuForeach&&(s=r.collection.type)instanceof FuArrayStorageType?(this.#Qr(r,i.symbol),this.#jr(s.getElementType(),e.symbol.parent),this.writeName(e.symbol)):super.visitSymbolReference(e,t)}}}#Jr(e){this.include("glib.h"),this.write(e)}writeStringPtrType(){this.write("const char *")}writeClassType(e,t){switch(e.class.id){case FuId.NONE:e instanceof FuReadWriteClassType||this.write("const "),this.writeName(e.class),e instanceof FuStorageType?t&&this.writeChar(32):this.write(" *");break;case FuId.STRING_CLASS:e.id==FuId.STRING_STORAGE_TYPE?this.write("char *"):this.writeStringPtrType();break;case FuId.LIST_CLASS:case FuId.STACK_CLASS:this.#Jr("GArray *");break;case FuId.QUEUE_CLASS:this.#Jr("GQueue "),e instanceof FuStorageType||this.writeChar(42);break;case FuId.HASH_SET_CLASS:case FuId.DICTIONARY_CLASS:this.#Jr("GHashTable *");break;case FuId.SORTED_SET_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.#Jr("GTree *");break;case FuId.TEXT_WRITER_CLASS:this.include("stdio.h"),this.write("FILE *");break;case FuId.STRING_WRITER_CLASS:this.#Jr("GString *");break;case FuId.REGEX_CLASS:e instanceof FuReadWriteClassType||this.write("const "),this.#Jr("GRegex *");break;case FuId.MATCH_CLASS:e instanceof FuReadWriteClassType||this.write("const "),this.#Jr("GMatchInfo *");break;case FuId.LOCK_CLASS:this.notYet(e,"Lock"),this.include("threads.h"),this.write("mtx_t ");break;default:this.notSupported(e,e.class.name)}}#qr(e){let t;(t=e)instanceof FuClassType&&t.isArray()&&(this.#qr(t.getElementType()),e instanceof FuArrayStorageType||(t.getElementType()instanceof FuArrayStorageType&&this.writeChar(40),e instanceof FuReadWriteClassType||this.write("const "),this.writeChar(42)))}#Yr(e,t,i){let r=e.getBaseType();if(r instanceof FuIntegerType)this.writeNumericType(this.getTypeId(r,t&&e==r)),i&&this.writeChar(32);else if(r instanceof FuEnum)r.id==FuId.BOOL_TYPE?(this.includeStdBool(),this.write("bool")):this.writeName(r),i&&this.writeChar(32);else if(r instanceof FuClassType){const e=r;this.writeClassType(e,i)}else this.write(r.name),i&&this.writeChar(32);this.#qr(e)}#zr(e){for(;e.isArray();){let t,i=e.asClassType().getElementType();(t=e)instanceof FuArrayStorageType?(this.writeChar(91),this.visitLiteralLong(BigInt(t.length)),this.writeChar(93)):i instanceof FuArrayStorageType&&this.writeChar(41),e=i}}#$r(e){e.type.id==FuId.VOID_TYPE&&e.throws.length>0?(this.includeStdBool(),this.write("bool ")):this.#Yr(e.type,!0,!0)}writeType(e,t){let i;this.#Yr(e,t,(i=e)instanceof FuClassType&&i.class.id==FuId.ARRAY_PTR_CLASS),this.#zr(e)}writeTypeAndName(e){this.#Yr(e.type,!0,!0),this.writeName(e),this.#zr(e.type)}#Zr(e){this.writeChar(40),this.#Yr(e,!1,!0),this.write(e.isArray()?"(*)":"*"),this.#zr(e),this.write(") ")}#es(e,t,i){e?(this.write("(FuMethodPtr) "),this.writeName(t),this.writeChar(95),this.write(i)):this.write("NULL")}static#ts(e){let t;return e.id==FuId.STRING_STORAGE_TYPE||e instanceof FuDynamicPtrType||(t=e)instanceof FuStorageType&&t.class.id==FuId.MATCH_CLASS}static#is(e){if(GenC.#ts(e))return!0;let t;if((t=e)instanceof FuStorageType)switch(t.class.id){case FuId.LIST_CLASS:case FuId.QUEUE_CLASS:case FuId.STACK_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.STRING_WRITER_CLASS:case FuId.MATCH_CLASS:case FuId.LOCK_CLASS:return!0;default:return GenC.#rs(t.class)}return!1}static#ss(e){let t,i=e.type;for(;(t=i)instanceof FuArrayStorageType;)i=t.getElementType();return GenC.#is(i)}static#rs(e){for(let t=e.first;null!=t;t=t.next){let e;if((e=t)instanceof FuField&&GenC.#ss(e))return!0}let t;return(t=e.parent)instanceof FuClass&&GenC.#rs(t)}#as(e){this.#es(this.needsConstructor(e),e,"Construct"),this.write(", "),this.#es(GenC.#rs(e),e,"Destruct")}#ns(e){switch(this.write("FuList_Free"),e){case FuId.NONE:this.write("Shared");break;case FuId.STRING_CLASS:this.write("String");break;case FuId.LIST_CLASS:this.write("List");break;case FuId.QUEUE_CLASS:this.write("Queue");break;case FuId.DICTIONARY_CLASS:this.write("HashTable");break;case FuId.SORTED_DICTIONARY_CLASS:this.write("Tree");break;case FuId.REGEX_CLASS:this.write("Regex");break;case FuId.MATCH_CLASS:this.write("Match");break;default:throw new Error}}#hs(e){this.#kr.add(e),this.#ns(e)}#os(e){switch(e.class.id){case FuId.NONE:case FuId.ARRAY_PTR_CLASS:e instanceof FuDynamicPtrType?(this.#mr=!0,this.#hs(FuId.NONE)):(this.write("(GDestroyNotify) "),this.writeName(e.class),this.write("_Destruct"));break;case FuId.STRING_CLASS:this.#hs(FuId.STRING_CLASS);break;case FuId.LIST_CLASS:case FuId.STACK_CLASS:this.#hs(FuId.LIST_CLASS);break;case FuId.QUEUE_CLASS:this.#hs(FuId.QUEUE_CLASS);break;case FuId.HASH_SET_CLASS:case FuId.DICTIONARY_CLASS:this.#hs(FuId.DICTIONARY_CLASS);break;case FuId.SORTED_SET_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.#hs(FuId.SORTED_DICTIONARY_CLASS);break;case FuId.STRING_WRITER_CLASS:this.#hs(FuId.STRING_WRITER_CLASS);break;case FuId.REGEX_CLASS:this.#hs(FuId.REGEX_CLASS);break;case FuId.MATCH_CLASS:this.#hs(FuId.MATCH_CLASS);break;default:throw new Error}}writeNewArray(e,t,i){if(this.#Nr=!0,i>FuPriority.MUL&&this.writeChar(40),this.#Zr(e),this.write("FuShared_Make("),t.accept(this,FuPriority.ARGUMENT),this.write(", sizeof("),this.writeType(e,!1),this.write("), "),e instanceof FuStringStorageType)this.#Lr=!0,this.write("(FuMethodPtr) FuPtr_Construct, "),this.#hs(FuId.STRING_CLASS);else if(e instanceof FuStorageType){const t=e;this.#as(t.class)}else if(e instanceof FuDynamicPtrType){const t=e;this.#Lr=!0,this.write("(FuMethodPtr) FuPtr_Construct, "),this.#os(t)}else this.write("NULL, NULL");this.writeChar(41),i>FuPriority.MUL&&this.writeChar(41)}static#Wr(e){return e.arguments_[GenC.isUTF8GetString(e)?2:1]}#us(e){e.isNewString(!1)?e.accept(this,FuPriority.ARGUMENT):(this.include("string.h"),this.writeCall("strdup",e))}writeArrayStorageInit(e,t){let i;if(null==t)GenC.#ts(e.getStorageType())&&this.write(" = { NULL }");else{if(!((i=t)instanceof FuLiteral&&i.isDefaultValue()))throw new Error;this.write(" = { "),i.accept(this,FuPriority.ARGUMENT),this.write(" }")}}static#cs(e){return e.unique&&e.class.id==FuId.ARRAY_PTR_CLASS&&!GenC.#ls(e.getElementType())}#ws(e){switch(e.class.id){case FuId.NONE:case FuId.ARRAY_PTR_CLASS:case FuId.JSON_ELEMENT_CLASS:let t;return(t=e)instanceof FuDynamicPtrType?(GenC.#cs(t)?this.write("free"):(this.#mr=!0,this.write("FuShared_Release")),!1):(this.writeName(e.class),this.write("_Destruct"),!0);case FuId.STRING_CLASS:return this.write("free"),!1;case FuId.LIST_CLASS:case FuId.STACK_CLASS:return this.write("g_array_unref"),!1;case FuId.QUEUE_CLASS:return this.write(GenC.#ls(e.getElementType())?"g_queue_clear_full":"g_queue_clear"),!0;case FuId.HASH_SET_CLASS:case FuId.DICTIONARY_CLASS:return this.write("g_hash_table_unref"),!1;case FuId.SORTED_SET_CLASS:case FuId.SORTED_DICTIONARY_CLASS:return this.write("g_tree_unref"),!1;case FuId.STRING_WRITER_CLASS:return this.write("g_string_free"),!1;case FuId.REGEX_CLASS:return this.write("g_regex_unref"),!1;case FuId.MATCH_CLASS:return this.write("g_match_info_unref"),!1;case FuId.LOCK_CLASS:return this.write("mtx_destroy"),!0;default:throw new Error}}#Ts(e){let t=this.#ws(e);this.writeChar(40),t&&this.writeChar(38)}static#ls(e){return e instanceof FuOwningType||e instanceof FuStringStorageType}#ds(e){e:if(null==e)this.write("NULL");else if(e instanceof FuStringStorageType||e instanceof FuArrayStorageType)this.write("free");else if(e instanceof FuOwningType){const t=e;if(t.class.id==FuId.NONE){if(e instanceof FuStorageType){GenC.#rs(t.class)?(this.write("(GDestroyNotify) "),this.writeName(t.class),this.write("_Delete")):this.write("free");break e}}else this.write("(GDestroyNotify) ");this.#ws(t)}else this.write("NULL")}#ps(e){this.write(e instanceof FuStringType?"g_str_hash, g_str_equal":"NULL, NULL")}#Fs(e,t){this.write("g_hash_table_new"),GenC.#ls(e)||GenC.#ls(t)?(this.write("_full("),this.#ps(e),this.write(", "),this.#ds(e),this.write(", "),this.#ds(t)):(this.writeChar(40),this.#ps(e)),this.writeChar(41)}#Es(e,t){e.id!=FuId.STRING_PTR_TYPE||GenC.#ls(t)?(this.write("g_tree_new_full(FuTree_Compare"),e instanceof FuIntegerType?(this.#br=!0,this.write("Integer")):e instanceof FuStringType?(this.#Or=!0,this.write("String")):this.notSupported(e,e.toString()),this.write(", NULL, "),this.#ds(e),this.write(", "),this.#ds(t)):this.write("g_tree_new((GCompareFunc) strcmp"),this.writeChar(41)}writeNew(e,t){switch(e.class.id){case FuId.LIST_CLASS:case FuId.STACK_CLASS:this.write("g_array_new(FALSE, FALSE, sizeof("),this.writeType(e.getElementType(),!1),this.write("))");break;case FuId.QUEUE_CLASS:this.write("G_QUEUE_INIT");break;case FuId.HASH_SET_CLASS:this.#Fs(e.getElementType(),null);break;case FuId.SORTED_SET_CLASS:this.#Es(e.getElementType(),null);break;case FuId.DICTIONARY_CLASS:this.#Fs(e.getKeyType(),e.getValueType());break;case FuId.SORTED_DICTIONARY_CLASS:this.#Es(e.getKeyType(),e.getValueType());break;case FuId.STRING_WRITER_CLASS:this.write("g_string_new(NULL)");break;default:this.#Nr=!0,t>FuPriority.MUL&&this.writeChar(40),this.writeStaticCastType(e),this.write("FuShared_Make(1, sizeof("),this.writeName(e.class),this.write("), "),this.#as(e.class),this.writeChar(41),t>FuPriority.MUL&&this.writeChar(41)}}static#ys(e){switch(e.id){case FuId.LIST_CLASS:case FuId.QUEUE_CLASS:case FuId.STACK_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.STRING_WRITER_CLASS:return!0;default:return!1}}writeStorageInit(e){GenC.#ys(e.type.asClassType().class)&&super.writeStorageInit(e)}writeVarInit(e){null==e.value&&GenC.#ts(e.type)?this.write(" = NULL"):super.writeVarInit(e)}#Is(e,t){this.write(" = "),null!=t?this.writeCoerced(e,t,FuPriority.ARGUMENT):this.writeNewStorage(e)}#Ss(e,t){let i;this.ensureChildBlock();let r=null!=t||(i=e)instanceof FuStorageType&&GenC.#ys(i.class),s=this.currentTemporaries.indexOf(e);return s<0?(s=this.currentTemporaries.length,this.#Yr(e,!1,!0),this.writeTemporaryName(s),this.#zr(e),r&&this.#Is(e,t),this.writeCharLine(59),this.currentTemporaries.push(t)):r&&(this.writeTemporaryName(s),this.#Is(e,t),this.writeCharLine(59),this.currentTemporaries[s]=t),s}static#Cs(e){return e.isNewString(!1)||e instanceof FuCallExpr&&e.type instanceof FuOwningType}writeOwningTemporary(e){GenC.#Cs(e)&&this.#Ss(e.type,e)}writeTemporariesNotSubstring(e){this.writeTemporaries(e),null==GenC.isStringSubstring(e)&&this.writeOwningTemporary(e)}writeArgTemporary(e,t,i){e.id==FuId.CONSOLE_WRITE||e.id==FuId.CONSOLE_WRITE_LINE||t.type.id==FuId.TYPE_PARAM0_NOT_FINAL||t.type instanceof FuOwningType||this.writeOwningTemporary(i)}#As(){return this.currentTemporaries.some((e=>!(e instanceof FuType)))}cleanupTemporary(e,t){let i;!GenC.#is(t.type)||(i=t)instanceof FuPrefixExpr&&i.inner instanceof FuAggregateInitializer||(this.#Ts(t.type.asClassType()),this.writeTemporaryName(e),this.writeLine(");"))}writeVar(e){if(super.writeVar(e),GenC.#ss(e)){let t=e;this.#xr.push(t)}}#_s(e,t){e instanceof FuNumericType||e instanceof FuEnum?this.writeCall("GINT_TO_POINTER",t):e.id==FuId.STRING_PTR_TYPE&&t.type.id==FuId.STRING_PTR_TYPE?(this.write("(gpointer) "),t.accept(this,FuPriority.PRIMARY)):this.writeCoerced(e,t,FuPriority.ARGUMENT)}#fs(e){this.writeChar(38),e.accept(this,FuPriority.PRIMARY)}#Rs(e){e.type instanceof FuStorageType?this.#fs(e):e.type instanceof FuClassType?e.accept(this,FuPriority.ARGUMENT):(this.write("(gconstpointer) "),e.accept(this,FuPriority.PRIMARY))}#Ls(e){this.write(e.id==FuId.N_INT_TYPE?"GPOINTER_TO_SIZE(":"GPOINTER_TO_INT(")}#Ns(e){e.type instanceof FuStorageType?this.#fs(e):e.accept(this,FuPriority.ARGUMENT)}#gs(e,t,i){let r,s=t.type.asClassType().getElementType();i==FuPriority.STATEMENT?r=!1:s instanceof FuIntegerType&&s.id!=FuId.LONG_TYPE?(this.#Ls(s),r=!0):(r=i>FuPriority.MUL,r&&this.writeChar(40),this.writeStaticCastType(s)),this.write(e),this.writeChar(40),this.#Ns(t),this.writeChar(41),r&&this.writeChar(41)}#ms(e,t){let i=e.type;this.write(i.class.id==FuId.SORTED_DICTIONARY_CLASS?"g_tree_insert(":"g_hash_table_insert("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.#_s(i.getKeyType(),t),this.write(", ")}writeAssign(e,t){let i,r;if((i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&2==r.class.typeParameterCount)this.#ms(i.left,i.right),this.#_s(r.getValueType(),e.right),this.writeChar(41);else if(e.left.type.id==FuId.STRING_STORAGE_TYPE){let i=GenC.isTrimSubstring(e);null!=i&&t==FuPriority.STATEMENT?(this.writeIndexing(e.left,i),this.write(" = '\\0'")):(this.#Fr=!0,this.write("FuString_Assign(&"),e.left.accept(this,FuPriority.PRIMARY),this.write(", "),this.#us(e.right),this.writeChar(41))}else{let i;(i=e.left.type)instanceof FuDynamicPtrType?i.class.id==FuId.REGEX_CLASS?super.writeAssign(e,t):GenC.#cs(i)?(this.ensureChildBlock(),this.write("free("),e.left.accept(this,FuPriority.ARGUMENT),this.writeLine(");"),super.writeAssign(e,t)):(this.#Pr=!0,this.write("FuShared_Assign((void **) &"),e.left.accept(this,FuPriority.PRIMARY),this.write(", "),e.right instanceof FuSymbolReference?(this.#gr=!0,this.writeCall("FuShared_AddRef",e.right)):e.right.accept(this,FuPriority.ARGUMENT),this.writeChar(41)):super.writeAssign(e,t)}}static#Ps(e){let t;if((t=e)instanceof FuBinaryExpr&&t.op==FuToken.ASSIGN)return GenC.#Ps(t.right);if(e instanceof FuCallExpr){let t=e.method.symbol;return t.throws.length>0?t:null}return null}static#ks(e){let t;return(t=e)instanceof FuStorageType&&(t.class.id==FuId.LIST_CLASS||t.class.id==FuId.STACK_CLASS)&&GenC.#is(t.getElementType())}hasInitCode(e){if(e.isAssignableStorage())return!1;let t;return e instanceof FuField&&(null!=e.value||GenC.#ts(e.type.getStorageType()))||null!=e.value&&null!=GenC.#Ps(e.value)||(t=e.type.getStorageType())instanceof FuStorageType&&(GenC.#ys(t.class)||t.class.id==FuId.LOCK_CLASS||this.needsConstructor(t.class))||GenC.#ks(e.type)||super.hasInitCode(e)}#bs(e){switch(this.write("if ("),e.type.id){case FuId.FLOAT_TYPE:case FuId.DOUBLE_TYPE:return this.includeMath(),this.write("isnan("),FuPriority.ARGUMENT;case FuId.VOID_TYPE:return this.writeChar(33),FuPriority.PRIMARY;default:return FuPriority.EQUALITY}}#Os(e){if(!GenC.#ss(e))return;this.ensureChildBlock();let t,i=e.type,r=0;for(;(t=i)instanceof FuArrayStorageType;)this.includeStdDef(),this.write("for (ptrdiff_t _i"),this.visitLiteralLong(BigInt(r)),this.write(" = "),this.visitLiteralLong(BigInt(t.length-1)),this.write("; _i"),this.visitLiteralLong(BigInt(r)),this.write(" >= 0; _i"),this.visitLiteralLong(BigInt(r)),this.writeLine("--)"),this.indent++,r++,i=t.getElementType();let s=i;this.#Ts(s),this.writeLocalName(e,FuPriority.PRIMARY);for(let e=0;e<r;e++)this.write("[_i"),this.visitLiteralLong(BigInt(e)),this.writeChar(93);s.class.id==FuId.QUEUE_CLASS&&GenC.#ls(s.getElementType())?(this.write(", "),this.#ds(s.getElementType())):s.class.id==FuId.STRING_WRITER_CLASS&&this.write(", TRUE"),this.writeLine(");"),this.indent-=r}#Ms(e=null){for(let t=this.#xr.length;--t>=0;){let i=this.#xr[t];i!=e&&this.#Os(i)}}#Ds(e){this.visitLiteralLong(BigInt(e.min-1))}#Ur(e,t){switch(e.id){case FuId.VOID_TYPE:this.write("false");break;case FuId.FLOAT_TYPE:case FuId.DOUBLE_TYPE:t&&this.includeMath(),this.write("NAN");break;default:let i;(i=e)instanceof FuRangeType?this.#Ds(i):this.write("NULL")}}#xs(){this.#Ms(),this.write("return "),this.#Ur(this.currentMethod.type,!0),this.writeCharLine(59)}#Gs(e){switch(e.type.id){case FuId.FLOAT_TYPE:case FuId.DOUBLE_TYPE:this.writeChar(41);break;case FuId.VOID_TYPE:break;default:let t;this.write(" == "),(t=e.type)instanceof FuRangeType?this.#Ds(t):this.visitLiteralNull()}this.writeChar(41),this.#xr.length>0?(this.writeChar(32),this.openBlock(),this.#xs(),this.closeBlock()):(this.writeNewLine(),this.indent++,this.#xs(),this.indent--)}writeInitCode(e){if(!this.hasInitCode(e))return;let t,i,r=e.type,s=0;for(;(t=r)instanceof FuArrayStorageType;)this.openLoop("size_t",s++,t.length),r=t.getElementType();if((i=r)instanceof FuStorageType&&i.class.id==FuId.LOCK_CLASS)this.write("mtx_init(&"),this.writeArrayElement(e,s),this.writeLine(", mtx_plain | mtx_recursive);");else{let t;if((t=r)instanceof FuStorageType&&this.needsConstructor(t.class))this.writeName(t.class),this.write("_Construct(&"),this.writeArrayElement(e,s),this.writeLine(");");else if(e instanceof FuField&&(this.writeArrayElement(e,s),s>0?(this.write(" = "),GenC.#ts(r)?this.write("NULL"):e.value.accept(this,FuPriority.ARGUMENT)):this.writeVarInit(e),this.writeCharLine(59)),null!=e.value){let t=GenC.#Ps(e.value);null!=t&&(this.#bs(t),this.writeArrayElement(e,s),this.#Gs(t))}}for(GenC.#ks(r)&&(this.write("g_array_set_clear_func("),this.writeArrayElement(e,s),this.write(", "),this.#os(r.asClassType().getElementType().asClassType()),this.writeLine(");"));--s>=0;)this.closeBlock();super.writeInitCode(e)}#jr(e,t){e instanceof FuStorageType?this.writeChar(46):this.write("->");for(let i=e.asClassType().class;i!=t;i=i.parent)this.write("base.")}writeMemberOp(e,t){this.#jr(e.type,t.symbol.parent)}writeArrayPtr(e,t){let i;(i=e.type)instanceof FuClassType&&i.class.id==FuId.LIST_CLASS?(this.writeChar(40),this.writeType(i.getElementType(),!1),this.write(" *) "),this.writePostfix(e,"->data")):e.accept(this,t)}writeCoercedInternal(e,t,i){let r;if(e instanceof FuDynamicPtrType){const r=e;let s;if(GenC.#cs(r)&&(s=t)instanceof FuPrefixExpr){console.assert(s.op==FuToken.NEW);let e=s.type;this.#Zr(e.getElementType()),this.write("malloc("),s.inner.accept(this,FuPriority.MUL),this.write(" * sizeof("),this.writeType(e.getElementType(),!1),this.write("))")}else t instanceof FuSymbolReference&&i!=FuPriority.EQUALITY?(r.class.id==FuId.ARRAY_PTR_CLASS?this.#Zr(r.getElementType()):(this.writeChar(40),this.writeName(r.class),this.write(" *) ")),this.#gr=!0,this.writeCall("FuShared_AddRef",t)):r.class.id!=FuId.ARRAY_PTR_CLASS?this.#Hr(r.class,t,i):super.writeCoercedInternal(e,t,i)}else(r=e)instanceof FuClassType&&r.class.id!=FuId.STRING_CLASS&&r.class.id!=FuId.ARRAY_PTR_CLASS&&!(r instanceof FuStorageType)?r.class.id==FuId.QUEUE_CLASS&&t.type instanceof FuStorageType?this.#fs(t):this.#Hr(r.class,t,i):e.id==FuId.STRING_STORAGE_TYPE?this.#us(t):t.type.id==FuId.STRING_STORAGE_TYPE?t.accept(this,i):super.writeCoercedInternal(e,t,i)}writeSubstringEqual(e,t,i,r){i>FuPriority.EQUALITY&&this.writeChar(40),this.include("string.h"),this.write("memcmp("),this.#vr(e,!1),this.write(", "),this.visitLiteralString(t),this.write(", "),this.visitLiteralLong(BigInt(t.length)),this.writeChar(41),this.write(GenC.getEqOp(r)),this.writeChar(48),i>FuPriority.EQUALITY&&this.writeChar(41)}writeEqualStringInternal(e,t,i,r){i>FuPriority.EQUALITY&&this.writeChar(40),this.include("string.h"),this.writeCall("strcmp",e,t),this.write(GenC.getEqOp(r)),this.writeChar(48),i>FuPriority.EQUALITY&&this.writeChar(41)}writeEqual(e,t,i,r){if(e.type instanceof FuStringType&&t.type instanceof FuStringType){let s,a=GenC.isStringSubstring(e);if(null!=a&&(s=t)instanceof FuLiteralString){let t=GenC.#Wr(a),n=s.getAsciiLength();if(n>=0){let h,o=s.value;return void((h=t)instanceof FuLiteralLong?(h.value!=n&&this.notYet(e,"String comparison with unmatched length"),this.writeSubstringEqual(a,o,i,r)):r?(i>FuPriority.COND_OR&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" != "),this.visitLiteralLong(BigInt(n)),n>0&&(this.write(" || "),this.writeSubstringEqual(a,o,FuPriority.COND_OR,!0)),i>FuPriority.COND_OR&&this.writeChar(41)):((i>FuPriority.COND_AND||i==FuPriority.COND_OR)&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" == "),this.visitLiteralLong(BigInt(n)),n>0&&(this.write(" && "),this.writeSubstringEqual(a,o,FuPriority.COND_AND,!1)),(i>FuPriority.COND_AND||i==FuPriority.COND_OR)&&this.writeChar(41)))}}this.writeEqualStringInternal(e,t,i,r)}else super.writeEqual(e,t,i,r)}writeStringLength(e){this.includeStdDef(),this.include("string.h"),this.writeCall("(ptrdiff_t) strlen",e)}#Us(e,t,i){this.include("string.h"),this.write("FuString_"),this.writeCall(e,t,i[0])}#vs(e){this.write(", sizeof(");let t=e.id;this.writeNumericType(t),this.write("), FuCompare_"),this.writeNumericType(t),this.writeChar(41),this.#Mr.add(t)}writeArrayFill(e,t){this.write("for ("),this.write(1!=t.length&&this.getTypeId(t[2].type,!0)==FuId.INT_TYPE?"int":"size_t"),this.write(" _i = 0; _i < "),1==t.length?this.writeArrayStorageLength(e):t[2].accept(this,FuPriority.REL),this.writeLine("; _i++)"),this.writeChar(9),e.accept(this,FuPriority.PRIMARY),this.writeChar(91),t.length>1&&this.startAdd(t[1]),this.write("_i] = "),t[0].accept(this,FuPriority.ARGUMENT)}#Bs(e,t,i,r){let s,a=e.type.asClassType().getElementType(),n=this.#Ss(a,a.isFinal()?null:r.at(-1));(s=a)instanceof FuStorageType&&this.needsConstructor(s.class)&&(this.writeName(s.class),this.write("_Construct(&futemp"),this.visitLiteralLong(BigInt(n)),this.writeLine(");")),this.write(i),this.writeChar(40),e.accept(this,FuPriority.ARGUMENT),t&&(this.write(", "),r[0].accept(this,FuPriority.ARGUMENT)),this.write(", futemp"),this.visitLiteralLong(BigInt(n)),this.writeChar(41),this.currentTemporaries[n]=a}#Ys(e,t,i){this.write(t),this.writeChar(40),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Rs(i),this.writeChar(41)}#Vs(e,t){let i=0;for(let r=e.firstParameter();null!=r;r=r.nextVar())(i>0||e.callType!=FuCallType.STATIC)&&this.write(", "),i>=t.length?r.value.accept(this,FuPriority.ARGUMENT):this.writeCoerced(r.type,t[i],FuPriority.ARGUMENT),i++;this.writeChar(41)}#Hs(e){this.writeRegexOptions(e,""," | ","","G_REGEX_CASELESS","G_REGEX_MULTILINE","G_REGEX_DOTALL")||this.writeChar(48)}writePrintfNotInterpolated(e,t){if(this.write('"%'),e[0].type instanceof FuIntegerType){e[0].type.id==FuId.LONG_TYPE&&this.writePrintfLongPrefix(),this.writeChar(100)}else e[0].type instanceof FuFloatingType?this.writeChar(103):this.writeChar(115);t&&this.write("\\n"),this.write('", '),this.writeInterpolatedStringArgBase(e[0]),this.writeChar(41)}#Ws(e,t,i){if(0==t.length)e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?(this.write("g_string_append_c("),e.accept(this,FuPriority.ARGUMENT),this.write(", '\\n'")):(this.write("putc('\\n', "),e.accept(this,FuPriority.ARGUMENT)),this.writeChar(41);else{let r;if((r=t[0])instanceof FuInterpolatedString)this.write(e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?"g_string_append_printf(":"fprintf("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writePrintf(r,i);else if(t[0].type instanceof FuNumericType)this.write(e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?"g_string_append_printf(":"fprintf("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writePrintfNotInterpolated(t,i);else if(i){let i;(i=t[0])instanceof FuLiteralString?(e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?(this.write("g_string_append("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeStringLiteralWithNewLine(i.value)):(this.write("fputs("),this.writeStringLiteralWithNewLine(i.value),this.write(", "),e.accept(this,FuPriority.ARGUMENT)),this.writeChar(41)):(this.write(e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?"g_string_append_printf(":"fprintf("),e.accept(this,FuPriority.ARGUMENT),this.write(', "%s\\n", '),t[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41))}else e.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?this.writeCall("g_string_append",e,t[0]):this.writeCall("fputs",t[0],e)}}#Qs(e,t){if(this.include("stdio.h"),0==e.length)this.write("putchar('\\n')");else{let i;(i=e[0])instanceof FuInterpolatedString?(this.write("printf("),this.writePrintf(i,t)):e[0].type instanceof FuNumericType?(this.write("printf("),this.writePrintfNotInterpolated(e,t)):t?this.writeCall("puts",e[0]):(this.write("fputs("),e[0].accept(this,FuPriority.ARGUMENT),this.write(", stdout)"))}}static#Xs(e){for(;!e.addsVirtualMethods();){e=e.parent}return e}static#Ks(e){for(let t=null;;){let i;if(e.addsVirtualMethods()&&(t=e),!((i=e.parent)instanceof FuClass))return t;e=i}}writeCCall(e,t,i){let r=this.currentClass,s=t.parent;if(GenC.isReferenceTo(e,FuId.BASE_PTR))this.writeName(t),this.write("(&self->base"),this.#Vr(s,r.parent);else{if(t.isAbstractVirtualOrOverride()){let i=s;if(t.callType==FuCallType.OVERRIDE){s=t.getDeclaringMethod().parent}null!=e&&(r=e.type.asClassType().class);let a=GenC.#Ks(r),n=GenC.#Xs(i);n!=a&&(this.write("((const "),this.writeName(n),this.write("Vtbl *) ")),null!=e?(e.accept(this,FuPriority.PRIMARY),this.#jr(e.type,a)):this.#Xr(a),this.write("vtbl"),n!=a&&this.writeChar(41),this.write("->"),this.writeCamelCase(t.name)}else this.writeName(t);this.writeChar(40),t.callType!=FuCallType.STATIC&&(null!=e?this.#Hr(s,e,FuPriority.ARGUMENT):r==s?this.write("self"):(this.write("&self->base"),this.#Vr(s,r.parent)))}this.#Vs(t,i)}#js(e,t,i){this.includeStdBool(),this.include("errno.h"),this.write(e),this.write("_TryParse(&"),t.accept(this,FuPriority.PRIMARY),this.write(", "),i[0].accept(this,FuPriority.ARGUMENT),t.type instanceof FuIntegerType&&this.writeTryParseRadix(i),this.writeChar(41)}writeStringSubstringStart(e,t,i){console.assert(1==t.length),i>FuPriority.ADD&&this.writeChar(40),this.writeAdd(e,t[0]),i>FuPriority.ADD&&this.writeChar(41)}#Js(e){this.write("FuArray_Contains_");let t=e.type.asClassType().getElementType().id;switch(t){case FuId.NONE:this.write("object((const void * const *) ");break;case FuId.STRING_STORAGE_TYPE:case FuId.STRING_PTR_TYPE:t=FuId.STRING_PTR_TYPE,this.include("string.h"),this.write("string((const char * const *) ");break;default:this.writeNumericType(t),this.write("((const "),this.writeNumericType(t),this.write(" *) ")}this.#Dr.add(t)}#qs(e,t){this.write("g_array_index("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeType(t,!1),this.write(", ")}#zs(e,t){this.includeMath(),this.writeLowercase(e),t.some((e=>e.type.id==FuId.DOUBLE_TYPE))||this.writeChar(102),this.writeInParentheses(t)}#$s(e,t,i){switch(e.id){case FuId.INT_TYPE:this.#wr.add(t.id),this.write("FuInt_");break;case FuId.N_INT_TYPE:this.#Tr.add(t.id),this.write("FuNInt_");break;case FuId.LONG_TYPE:this.#dr.add(t.id),this.write("FuLong_");break;default:return!0}return this.write(t.name),this.writeInParentheses(i),!1}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.CLASS_TO_STRING:this.writeCCall(t,i,r);break;case FuId.ENUM_FROM_INT:this.writeStaticCast(e,r[0]);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:t.accept(this,s);break;case FuId.INT_TRY_PARSE:this.include("limits.h"),this.#wr.add(FuId.INT_TRY_PARSE),this.#js("FuInt",t,r);break;case FuId.N_INT_TRY_PARSE:this.include("limits.h"),this.#Tr.add(FuId.INT_TRY_PARSE),this.#js("FuNInt",t,r);break;case FuId.LONG_TRY_PARSE:this.#dr.add(FuId.INT_TRY_PARSE),this.#js("FuLong",t,r);break;case FuId.DOUBLE_TRY_PARSE:this.#pr=!0,this.#js("FuDouble",t,r);break;case FuId.STRING_CONTAINS:this.include("string.h"),s>FuPriority.EQUALITY&&this.writeChar(40);let a=this.getOneAscii(r[0]);a>=0?(this.write("strchr("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.visitLiteralChar(a),this.writeChar(41)):this.writeCall("strstr",t,r[0]),this.write(" != NULL"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.STRING_ENDS_WITH:this.#Cr=!0,this.#Us("EndsWith",t,r);break;case FuId.STRING_INDEX_OF:this.#Ir=!0,this.includeStdDef(),this.#Us("IndexOf",t,r);break;case FuId.STRING_LAST_INDEX_OF:this.#Sr=!0,this.includeStdDef(),this.#Us("LastIndexOf",t,r);break;case FuId.STRING_REPLACE:this.include("string.h"),this.#yr=!0,this.#Ar=!0,this.writeCall("FuString_Replace",t,r[0],r[1]);break;case FuId.STRING_STARTS_WITH:s>FuPriority.EQUALITY&&this.writeChar(40);let n=this.getOneAscii(r[0]);n>=0?(this.writePostfix(t,"[0] == "),this.visitLiteralChar(n)):(this.include("string.h"),this.write("strncmp("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", strlen("),r[0].accept(this,FuPriority.ARGUMENT),this.write(")) == 0")),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.STRING_SUBSTRING:1==r.length?this.writeStringSubstringStart(t,r,s):(this.include("string.h"),this.#Er=!0,this.write("FuString_Substring("),this.writeArrayPtrAdd(t,r[0]),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.writeChar(41));break;case FuId.STRING_TO_LOWER:this.#Jr("g_utf8_strdown("),t.accept(this,FuPriority.ARGUMENT),this.write(", -1)");break;case FuId.STRING_TO_UPPER:this.#Jr("g_utf8_strup("),t.accept(this,FuPriority.ARGUMENT),this.write(", -1)");break;case FuId.ARRAY_BINARY_SEARCH_ALL:case FuId.ARRAY_BINARY_SEARCH_PART:s>FuPriority.ADD&&this.writeChar(40),this.write("(const ");let h=t.type.asClassType().getElementType();this.writeType(h,!1),this.write(" *) bsearch(&"),r[0].accept(this,FuPriority.PRIMARY),this.write(", "),1==r.length?this.writeArrayPtr(t,FuPriority.ARGUMENT):this.writeArrayPtrAdd(t,r[1]),this.write(", "),1==r.length?this.writeArrayStorageLength(t):r[2].accept(this,FuPriority.ARGUMENT),this.#vs(h),this.write(" - "),this.writeArrayPtr(t,FuPriority.MUL),s>FuPriority.ADD&&this.writeChar(41);break;case FuId.ARRAY_CONTAINS:this.#Js(t),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeArrayStorageLength(t),this.write(", "),this.#Ns(r[0]),this.writeChar(41);break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:this.include("string.h");let o=t.type.asClassType().getElementType();GenC.#ts(o)&&this.notYet(t,"CopyTo for this type"),this.write("memcpy("),this.writeArrayPtrAdd(r[1],r[2]),this.write(", "),this.writeArrayPtrAdd(t,r[0]),this.write(", "),o.id==FuId.S_BYTE_RANGE||o.id==FuId.BYTE_RANGE?r[3].accept(this,FuPriority.ARGUMENT):(r[3].accept(this,FuPriority.MUL),this.write(" * sizeof("),this.writeType(o,!1),this.writeChar(41)),this.writeChar(41);break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:let u;(u=r[0])instanceof FuLiteral&&u.isDefaultValue()?(this.include("string.h"),this.write("memset("),1==r.length?(t.accept(this,FuPriority.ARGUMENT),this.write(", 0, sizeof("),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41)):(this.writeArrayPtrAdd(t,r[1]),this.write(", 0, "),r[2].accept(this,FuPriority.MUL),this.write(" * sizeof("),this.writeType(t.type.asClassType().getElementType(),!1),this.writeChar(41)),this.writeChar(41)):this.writeArrayFill(t,r);break;case FuId.ARRAY_SORT_ALL:this.write("qsort("),this.writeArrayPtr(t,FuPriority.ARGUMENT),this.write(", "),this.writeArrayStorageLength(t),this.#vs(t.type.asClassType().getElementType());break;case FuId.ARRAY_SORT_PART:case FuId.LIST_SORT_PART:this.write("qsort("),this.writeArrayPtrAdd(t,r[0]),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.#vs(t.type.asClassType().getElementType());break;case FuId.LIST_ADD:case FuId.STACK_PUSH:let c;(c=t.type.asClassType().getElementType())instanceof FuStorageType&&(c.class.id==FuId.ARRAY_STORAGE_CLASS||c.class.id==FuId.NONE&&!this.needsConstructor(c.class))?(this.write("g_array_set_size("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writePostfix(t,"->len + 1)")):this.#Bs(t,!1,"g_array_append_val",r);break;case FuId.LIST_CLEAR:case FuId.STACK_CLEAR:this.write("g_array_set_size("),t.accept(this,FuPriority.ARGUMENT),this.write(", 0)");break;case FuId.LIST_CONTAINS:this.#Js(t),this.writePostfix(t,"->data, "),this.writePostfix(t,"->len, "),this.#Ns(r[0]),this.writeChar(41);break;case FuId.LIST_INSERT:this.#Bs(t,!0,"g_array_insert_val",r);break;case FuId.LIST_LAST:case FuId.STACK_PEEK:this.#qs(t,t.type.asClassType().getElementType()),this.writePostfix(t,"->len - 1)");break;case FuId.LIST_REMOVE_AT:this.writeCall("g_array_remove_index",t,r[0]);break;case FuId.LIST_REMOVE_RANGE:this.writeCall("g_array_remove_range",t,r[0],r[1]);break;case FuId.LIST_SORT_ALL:this.write("g_array_sort("),t.accept(this,FuPriority.ARGUMENT);let l=t.type.asClassType().getElementType().id;this.write(", FuCompare_"),this.writeNumericType(l),this.writeChar(41),this.#Mr.add(l);break;case FuId.QUEUE_CLEAR:let w=t.type.asClassType().getElementType();GenC.#ls(w)?(this.write("g_queue_clear_full("),this.#Ns(t),this.write(", "),this.#ds(w)):(this.write("g_queue_clear("),this.#Ns(t)),this.writeChar(41);break;case FuId.QUEUE_DEQUEUE:this.#gs("g_queue_pop_head",t,s);break;case FuId.QUEUE_ENQUEUE:this.write("g_queue_push_tail("),this.#Ns(t),this.write(", "),this.#_s(t.type.asClassType().getElementType(),r[0]),this.writeChar(41);break;case FuId.QUEUE_PEEK:this.#gs("g_queue_peek_head",t,s);break;case FuId.STACK_POP:s==FuPriority.STATEMENT?this.writePostfix(t,"->len--"):(this.#qs(t,t.type.asClassType().getElementType()),this.write("--"),this.writePostfix(t,"->len)"));break;case FuId.HASH_SET_ADD:this.write("g_hash_table_add("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.#_s(t.type.asClassType().getElementType(),r[0]),this.writeChar(41);break;case FuId.HASH_SET_CLEAR:case FuId.DICTIONARY_CLEAR:this.writeCall("g_hash_table_remove_all",t);break;case FuId.HASH_SET_CONTAINS:case FuId.DICTIONARY_CONTAINS_KEY:this.#Ys(t,"g_hash_table_contains",r[0]);break;case FuId.HASH_SET_REMOVE:case FuId.DICTIONARY_REMOVE:this.#Ys(t,"g_hash_table_remove",r[0]);break;case FuId.SORTED_SET_ADD:this.write("g_tree_insert("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.#_s(t.type.asClassType().getKeyType(),r[0]),this.write(", NULL)");break;case FuId.DICTIONARY_ADD:this.#ms(t,r[0]);let T=t.type.asClassType().getValueType().asClassType();switch(T.class.id){case FuId.LIST_CLASS:case FuId.STACK_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.STRING_WRITER_CLASS:this.writeNewStorage(T);break;default:T.class.isPublic&&null!=T.class.constructor_&&T.class.constructor_.visibility==FuVisibility.PUBLIC?(this.writeName(T.class),this.write("_New()")):(this.write("malloc(sizeof("),this.writeType(T,!1),this.write("))"))}this.writeChar(41);break;case FuId.SORTED_SET_CLEAR:case FuId.SORTED_DICTIONARY_CLEAR:this.write("g_tree_destroy(g_tree_ref("),t.accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.SORTED_SET_CONTAINS:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:this.write("g_tree_lookup_extended("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Rs(r[0]),this.write(", NULL, NULL)");break;case FuId.SORTED_SET_REMOVE:case FuId.SORTED_DICTIONARY_REMOVE:this.#Ys(t,"g_tree_remove",r[0]);break;case FuId.TEXT_WRITER_WRITE:this.#Ws(t,r,!1);break;case FuId.TEXT_WRITER_WRITE_CHAR:t.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?this.writeCall("g_string_append_c",t,r[0]):this.writeCall("putc",r[0],t);break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:t.type.asClassType().class.id!=FuId.STRING_WRITER_CLASS?this.notSupported(t,i.name):this.writeCall("g_string_append_unichar",t,r[0]);break;case FuId.TEXT_WRITER_WRITE_LINE:this.#Ws(t,r,!0);break;case FuId.CONSOLE_WRITE:this.#Qs(r,!1);break;case FuId.CONSOLE_WRITE_LINE:this.#Qs(r,!0);break;case FuId.STRING_WRITER_CLEAR:this.write("g_string_truncate("),t.accept(this,FuPriority.ARGUMENT),this.write(", 0)");break;case FuId.STRING_WRITER_TO_STRING:this.writePostfix(t,"->str");break;case FuId.CONVERT_TO_BASE64_STRING:this.#Jr("g_base64_encode("),this.writeArrayPtrAdd(r[0],r[1]),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.U_T_F8_GET_BYTE_COUNT:this.writeStringLength(r[0]);break;case FuId.U_T_F8_GET_BYTES:this.include("string.h"),this.write("memcpy("),this.writeArrayPtrAdd(r[1],r[2]),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", strlen("),r[0].accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.U_T_F8_GET_STRING:this.include("string.h"),this.#Er=!0,this.write("FuString_Substring((const char *) "),this.writeArrayPtrAdd(r[0],r[1]),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.writeCall("getenv",r[0]);break;case FuId.REGEX_COMPILE:this.#Jr("g_regex_new("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Hs(r),this.write(", 0, NULL)");break;case FuId.REGEX_ESCAPE:this.#Jr("g_regex_escape_string("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", -1)");break;case FuId.REGEX_IS_MATCH_STR:this.#Jr("g_regex_match_simple("),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Hs(r),this.write(", 0)");break;case FuId.REGEX_IS_MATCH_REGEX:this.write("g_regex_match("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", 0, NULL)");break;case FuId.MATCH_FIND_STR:this.#fr=!0,this.write("FuMatch_Find(&"),t.accept(this,FuPriority.PRIMARY),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Hs(r),this.writeChar(41);break;case FuId.MATCH_FIND_REGEX:this.write("g_regex_match("),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", 0, &"),t.accept(this,FuPriority.PRIMARY),this.writeChar(41);break;case FuId.MATCH_GET_CAPTURE:this.writeCall("g_match_info_fetch",t,r[0]);break;case FuId.MATH_METHOD:case FuId.MATH_LOG2:this.#zs(i.name,r);break;case FuId.MATH_ABS:switch(r[0].type.id){case FuId.N_INT_TYPE:this.writeCall("(ptrdiff_t) llabs",r[0]);break;case FuId.LONG_TYPE:this.writeCall("llabs",r[0]);break;case FuId.FLOAT_TYPE:this.includeMath(),this.writeCall("fabsf",r[0]);break;case FuId.FLOAT_INT_TYPE:case FuId.DOUBLE_TYPE:this.includeMath(),this.writeCall("fabs",r[0]);break;default:this.writeCall("abs",r[0])}break;case FuId.MATH_CEILING:this.#zs("ceil",r);break;case FuId.MATH_CLAMP:this.#$s(e,i,r)&&(this.includeMath(),this.write(e.id==FuId.DOUBLE_TYPE?"fmin(fmax(":"fminf(fmaxf("),this.writeClampAsMinMax(r));break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.#zs("fma",r);break;case FuId.MATH_IS_FINITE:this.includeMath(),this.writeCall("isfinite",r[0]);break;case FuId.MATH_IS_INFINITY:this.includeMath(),this.writeCall("isinf",r[0]);break;case FuId.MATH_IS_NA_N:this.includeMath(),this.writeCall("isnan",r[0]);break;case FuId.MATH_MAX:case FuId.MATH_MIN:this.#$s(e,i,r)&&(this.writeChar(102),this.#zs(i.name,r));break;case FuId.MATH_ROUND:this.#zs("round",r);break;case FuId.MATH_TRUNCATE:this.#zs("trunc",r);break;default:this.notSupported(t,i.name)}}visitCallExpr(e,t){this.tryWriteTemporary(e)||super.visitCallExpr(e,t)}#Zs(e,t,i){let r=t.left.type.asClassType().getValueType();if(r instanceof FuIntegerType&&r.id!=FuId.LONG_TYPE)this.#Ls(r),this.#Ys(t.left,e,t.right),this.writeChar(41);else{let s;i>FuPriority.MUL&&this.writeChar(40),(s=r)instanceof FuStorageType&&(s.class.id==FuId.NONE||s.class.id==FuId.ARRAY_STORAGE_CLASS)?this.#Zr(r):(this.writeStaticCastType(r),r instanceof FuEnum&&(console.assert(i<=FuPriority.MUL,"Should close two parens"),this.write("GPOINTER_TO_INT("))),this.#Ys(t.left,e,t.right),(i>FuPriority.MUL||r instanceof FuEnum)&&this.writeChar(41)}}writeIndexingExpr(e,t){let i;if((i=e.left.type)instanceof FuClassType)switch(i.class.id){case FuId.ARRAY_STORAGE_CLASS:if(i.id==FuId.MAIN_ARGS_TYPE)return void this.writeArgsIndexing(e.right);break;case FuId.LIST_CLASS:return void(i.getElementType()instanceof FuArrayStorageType?(this.writeChar(40),this.#Zr(i.getElementType()),this.writePostfix(e.left,"->data)["),e.right.accept(this,FuPriority.ARGUMENT),this.writeChar(93)):(this.#qs(e.left,i.getElementType()),e.right.accept(this,FuPriority.ARGUMENT),this.writeChar(41)));case FuId.DICTIONARY_CLASS:return void this.#Zs("g_hash_table_lookup",e,t);case FuId.SORTED_DICTIONARY_CLASS:return void this.#Zs("g_tree_lookup",e,t)}super.writeIndexingExpr(e,t)}visitBinaryExpr(e,t){switch(e.op){case FuToken.PLUS:if(e.type.id==FuId.STRING_STORAGE_TYPE){if(this.tryWriteTemporary(e))return;return this.#_r=!0,this.include("stdarg.h"),this.include("stdio.h"),this.write('FuString_Format("%s%s", '),e.left.accept(this,FuPriority.ARGUMENT),this.write(", "),e.right.accept(this,FuPriority.ARGUMENT),void this.writeChar(41)}break;case FuToken.EQUAL:case FuToken.NOT_EQUAL:case FuToken.GREATER:let t=GenC.isStringEmpty(e);if(null!=t)return void this.writePostfix(t,e.op==FuToken.EQUAL?"[0] == '\\0'":"[0] != '\\0'");break;case FuToken.ADD_ASSIGN:if(e.left.type.id==FuId.STRING_STORAGE_TYPE){let t;return(t=e.right)instanceof FuInterpolatedString?(this.#Fr=!0,this.write("FuString_Assign(&"),e.left.accept(this,FuPriority.PRIMARY),this.#_r=!0,this.include("stdarg.h"),this.include("stdio.h"),this.write(', FuString_Format("%s'),this.writePrintfFormat(t),this.write('", '),e.left.accept(this,FuPriority.ARGUMENT),this.writeInterpolatedStringArgs(t),this.writeChar(41)):(this.include("string.h"),this.#yr=!0,this.write("FuString_Append(&"),e.left.accept(this,FuPriority.PRIMARY),this.write(", "),e.right.accept(this,FuPriority.ARGUMENT)),void this.writeChar(41)}break;case FuToken.IS:this.notSupported(e,"'is' operator")}super.visitBinaryExpr(e,t)}writeResource(e,t){this.write("FuResource_"),this.writeResourceName(e)}visitLambdaExpr(e){this.notSupported(e,"Lambda expression")}#ea(e){for(let t=this.#xr.length;--t>=0;){let i=this.#xr[t];if(!e.encloses(i))break;this.#Os(i)}}#ta(e){this.#xr.splice(e,this.#xr.length-e)}cleanupBlock(e){let t=this.#xr.length;for(;t>0;t--){let i=this.#xr[t-1];if(i.parent!=e)break;e.completesNormally()&&this.#Os(i)}this.#ta(t)}visitBlock(e){let t=this.#Gr;super.visitBlock(e),this.#Gr=t}visitBreak(e){this.#ea(e.loopOrSwitch),super.visitBreak(e)}visitContinue(e){this.#ea(e.loop),super.visitContinue(e)}visitExpr(e){let t=GenC.#Ps(e);if(null!=t)this.writeTemporaries(e),this.ensureChildBlock(),e.accept(this,this.#bs(t)),this.#Gs(t),this.cleanupTemporaries();else if(GenC.#Cs(e)){let t=e.type;this.writeTemporaries(e),this.#ws(t),this.writeChar(40),e.accept(this,FuPriority.ARGUMENT),t.class.id==FuId.STRING_WRITER_CLASS&&this.write(", TRUE"),this.writeLine(");"),this.cleanupTemporaries()}else super.visitExpr(e)}#ia(e){this.openBlock(),this.writeLine("GHashTableIter fudictit;"),this.write("g_hash_table_iter_init(&fudictit, "),e.collection.accept(this,FuPriority.ARGUMENT),this.writeLine(");")}#ra(e,t){this.writeTypeAndName(e),this.write(" = "),e.type instanceof FuIntegerType&&e.type.id!=FuId.LONG_TYPE?(this.#Ls(e.type),this.write(t),this.writeChar(41)):(this.writeStaticCastType(e.type),this.write(t)),this.writeCharLine(59)}visitForeach(e){let t;if((t=e.collection.type)instanceof FuClassType){let i=e.getVar().name;switch(t.class.id){case FuId.STRING_CLASS:this.write("for ("),this.writeStringPtrType(),this.writeCamelCaseNotKeyword(i),this.write(" = "),e.collection.accept(this,FuPriority.ARGUMENT),this.write("; *"),this.writeCamelCaseNotKeyword(i),this.write(" != '\\0'; "),this.writeCamelCaseNotKeyword(i),this.write("++)"),this.writeChild(e.body);break;case FuId.ARRAY_STORAGE_CLASS:let r;this.write("for (int "),this.writeCamelCaseNotKeyword(i),(r=t)instanceof FuArrayStorageType?(this.write(" = 0; "),this.writeCamelCaseNotKeyword(i),this.write(" < "),this.visitLiteralLong(BigInt(r.length))):(this.write(" = 1; "),this.writeCamelCaseNotKeyword(i),this.write(" < argc")),this.write("; "),this.writeCamelCaseNotKeyword(i),this.write("++)"),this.writeChild(e.body);break;case FuId.LIST_CLASS:this.write("for (");let s=t.getElementType();for(this.writeType(s,!1),this.write(" const *"),this.writeCamelCaseNotKeyword(i),this.write(" = ("),this.writeType(s,!1),this.write(" const *) "),this.writePostfix(e.collection,"->data, ");s.isArray();s=s.asClassType().getElementType())this.writeChar(42);s instanceof FuClassType&&!(s instanceof FuStorageType)&&this.write("* const "),this.write("*fuend = "),this.writeCamelCaseNotKeyword(i),this.write(" + "),this.writePostfix(e.collection,"->len; "),this.writeCamelCaseNotKeyword(i),this.write(" < fuend; "),this.writeCamelCaseNotKeyword(i),this.write("++)"),this.writeChild(e.body);break;case FuId.HASH_SET_CLASS:this.#ia(e),this.writeLine("gpointer fukey;"),this.write("while (g_hash_table_iter_next(&fudictit, &fukey, NULL)) "),this.openBlock(),this.#ra(e.getVar(),"fukey"),this.flattenBlock(e.body),this.closeBlock(),this.closeBlock();break;case FuId.SORTED_SET_CLASS:this.write("for (GTreeNode *fusetit = g_tree_node_first("),e.collection.accept(this,FuPriority.ARGUMENT),this.write("); fusetit != NULL; fusetit = g_tree_node_next(fusetit)) "),this.openBlock(),this.#ra(e.getVar(),"g_tree_node_key(fusetit)"),this.flattenBlock(e.body),this.closeBlock();break;case FuId.DICTIONARY_CLASS:this.#ia(e),this.writeLine("gpointer fukey, fuvalue;"),this.write("while (g_hash_table_iter_next(&fudictit, &fukey, &fuvalue)) "),this.openBlock(),this.#ra(e.getVar(),"fukey"),this.#ra(e.getValueVar(),"fuvalue"),this.flattenBlock(e.body),this.closeBlock(),this.closeBlock();break;case FuId.SORTED_DICTIONARY_CLASS:this.write("for (GTreeNode *fudictit = g_tree_node_first("),e.collection.accept(this,FuPriority.ARGUMENT),this.write("); fudictit != NULL; fudictit = g_tree_node_next(fudictit)) "),this.openBlock(),this.#ra(e.getVar(),"g_tree_node_key(fudictit)"),this.#ra(e.getValueVar(),"g_tree_node_value(fudictit)"),this.flattenBlock(e.body),this.closeBlock();break;default:this.notSupported(e.collection,t.class.name)}}else this.notSupported(e.collection,e.collection.type.toString())}startIf(e){this.#As()?(this.#Gr||(this.#Gr=!0,this.write("bool ")),this.write("fucondition = "),e.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59),this.cleanupTemporaries(),this.write("if (fucondition)")):super.startIf(e)}visitLock(e){this.write("mtx_lock(&"),e.lock.accept(this,FuPriority.PRIMARY),this.writeLine(");"),e.body.acceptStatement(this),this.write("mtx_unlock(&"),e.lock.accept(this,FuPriority.PRIMARY),this.writeLine(");")}visitReturn(e){let t,i;if(null==e.value||e.value instanceof FuLiteral)this.#Ms(),null==e.value&&this.currentMethod.throws.length>0?this.writeLine("return true;"):super.visitReturn(e);else if((t=e.value)instanceof FuSymbolReference&&(i=t.symbol)instanceof FuVar)if(this.#xr.includes(i)){let e;this.#Ms(i),this.write("return "),(e=this.currentMethod.type)instanceof FuClassType&&!(e instanceof FuStorageType)?this.#Hr(e.class,t,FuPriority.ARGUMENT):t.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59)}else this.#Ms(),super.visitReturn(e);else{this.writeTemporaries(e.value);let t,i,r=this.currentMethod.type instanceof FuNumericType?GenC.#Ps(e.value):null;null!=r&&((t=this.currentMethod.type)instanceof FuRangeType?(i=r.type)instanceof FuRangeType&&t.min==i.min:r.type instanceof FuFloatingType)&&(r=null),null!=r||0!=this.#xr.length||this.#As()?(this.ensureChildBlock(),this.#Yr(this.currentMethod.type,!0,!0),this.write("returnValue = "),this.writeCoerced(this.currentMethod.type,e.value,FuPriority.ARGUMENT),this.writeCharLine(59),this.cleanupTemporaries(),this.#Ms(),null!=r&&(this.#bs(r),this.write("returnValue"),this.#Gs(r)),this.writeLine("return returnValue;")):(this.#Ms(),super.visitReturn(e))}}writeSwitchCaseBody(e){let t;(e[0]instanceof FuVar||(t=e[0])instanceof FuConst&&t.type instanceof FuArrayStorageType)&&this.writeCharLine(59);let i=this.#xr.length;this.writeStatements(e),this.#ta(i)}visitSwitch(e){e.isTypeMatching()?this.notSupported(e,"Type-matching 'switch'"):super.visitSwitch(e)}visitThrow(e){this.#xs()}#sa(e,t,i){if(this.#xr.length>0)return!1;for(let i=0;i<t;i++){let t;if((t=e[i])instanceof FuVar&&GenC.#ss(t))return!1}let r;if(!((r=e[t])instanceof FuExpr))return!1;let s=GenC.#Ps(r);if(null==s)return!1;if(this.writeFirstStatements(e,t),this.write("return "),s.type instanceof FuNumericType){let e;(e=s.type)instanceof FuRangeType?(r.accept(this,FuPriority.EQUALITY),this.write(" != "),this.#Ds(e)):(this.includeMath(),this.writeCall("!isnan",r))}else s.type.id==FuId.VOID_TYPE?r.accept(this,FuPriority.SELECT):(r.accept(this,FuPriority.EQUALITY),this.write(" != NULL"));return null!=i&&(this.write(" ? "),i.accept(this,FuPriority.SELECT),this.write(" : "),this.#Ur(this.currentMethod.type,!0)),this.writeCharLine(59),!0}writeStatements(e){let t,i=e.length-2;i>=0&&(t=e[i+1])instanceof FuReturn&&this.#sa(e,i,t.value)||super.writeStatements(e)}writeEnum(e){this.writeNewLine(),this.writeDoc(e.documentation),this.write("typedef enum "),this.openBlock(),e.acceptValues(this),this.writeNewLine(),this.indent--,this.write("} "),this.writeName(e),this.writeCharLine(59)}#aa(e){e.callType!=FuCallType.STATIC&&e.id!=FuId.EXCEPTION_CLASS&&(this.write("typedef struct "),this.writeName(e),this.writeChar(32),this.writeName(e),this.writeCharLine(59))}writeTypedefs(e,t){for(let i=e.first;null!=i;i=i.next)if(i instanceof FuClass){const e=i;e.isPublic==t&&this.#aa(e)}else{if(!(i instanceof FuEnum))throw new Error;{const e=i;(e.isPublic||this.writtenTypes.has(e))==t&&this.writeEnum(e)}}}#na(e){this.writeChar(40),e.isMutator()||this.write("const "),this.writeName(e.parent),this.write(" *self"),this.writeRemainingParameters(e,!1,!1)}#ha(e){let t=e.parent;t.isPublic&&e.visibility==FuVisibility.PUBLIC||this.write("static "),this.#$r(e),this.writeName(t),this.writeChar(95),this.write(e.name),e.callType!=FuCallType.STATIC?this.#na(e):0==e.parameters.count()?this.write("(void)"):this.writeParameters(e,!1)}#oa(e){let t;(t=e.parent)instanceof FuClass&&this.#oa(t);for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuMethod&&e.isAbstractOrVirtual()&&(this.#$r(e),this.write("(*"),this.writeCamelCase(e.name),this.writeChar(41),this.#na(e),this.writeCharLine(59))}}#ua(e){this.write("typedef struct "),this.openBlock(),this.#oa(e),this.indent--,this.write("} "),this.writeName(e),this.writeLine("Vtbl;")}getConst(e){return"const "}writeConst(e){let t;(t=e.type)instanceof FuArrayStorageType?(this.write("static "),this.write(this.getConst(t)),this.writeTypeAndName(e),this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59)):e.visibility==FuVisibility.PUBLIC&&(this.write("#define "),this.writeName(e),this.writeChar(32),e.value.accept(this,FuPriority.ARGUMENT),this.writeNewLine())}writeField(e){throw new Error}static#ca(e){if(e.callType==FuCallType.STATIC||e.callType==FuCallType.ABSTRACT)return!1;for(let t=e.first;null!=t;t=t.next){let e;if((e=t)instanceof FuMethod)switch(e.callType){case FuCallType.VIRTUAL:case FuCallType.OVERRIDE:case FuCallType.SEALED:return!0}}return!1}needsConstructor(e){if(e.id==FuId.MATCH_CLASS)return!1;let t;return super.needsConstructor(e)||GenC.#ca(e)||(t=e.parent)instanceof FuClass&&this.needsConstructor(t)}#la(e,t){this.write("static void "),this.writeName(t),this.writeChar(95),this.write(e),this.writeChar(40),this.writeName(t),this.write(" *self)")}writeSignatures(e,t){for(let i=e.first;null!=i;i=i.next){let r,s;(r=i)instanceof FuConst&&(e.isPublic&&r.visibility==FuVisibility.PUBLIC)==t?(t&&(this.writeNewLine(),this.writeDoc(r.documentation)),this.writeConst(r)):(s=i)instanceof FuMethod&&s.isLive&&(e.isPublic&&s.visibility==FuVisibility.PUBLIC)==t&&s.callType!=FuCallType.ABSTRACT&&s.id!=FuId.MAIN&&(this.writeNewLine(),this.writeMethodDoc(s),this.#ha(s),this.writeCharLine(59))}}writeClassInternal(e){if(e.id!=FuId.EXCEPTION_CLASS){if(this.currentClass=e,e.callType!=FuCallType.STATIC){this.writeNewLine(),e.addsVirtualMethods()&&this.#ua(e),this.writeDoc(e.documentation),this.write("struct "),this.writeName(e),this.writeChar(32),this.openBlock(),GenC.#Ks(e)==e&&(this.write("const "),this.writeName(e),this.writeLine("Vtbl *vtbl;")),e.parent instanceof FuClass&&(this.writeName(e.parent),this.writeLine(" base;"));for(let t=e.first;null!=t;t=t.next)if(t instanceof FuField){const e=t;let i;this.inHeaderFile&&(i=e.type)instanceof FuEnum&&this.writtenTypes.add(i),this.writeDoc(e.documentation),this.writeTypeAndName(e),this.writeCharLine(59)}else if(t instanceof FuNative){const e=t;this.visitNative(e)}this.indent--,this.writeLine("};"),this.needsConstructor(e)&&(this.#la("Construct",e),this.writeCharLine(59)),GenC.#rs(e)&&(this.#la("Destruct",e),this.writeCharLine(59))}this.writeSignatures(e,!1)}}#wa(e,t){let i;(i=t.parent)instanceof FuClass&&this.#wa(e,i);for(let i=t.first;null!=i;i=i.next){let t;if((t=i)instanceof FuMethod&&t.isAbstractOrVirtual()){let i=e.tryLookup(t.name,!1);t!=i&&(this.writeChar(40),this.#$r(t),this.write("(*)"),this.#na(t),this.write(") ")),this.writeName(i),this.writeCharLine(44)}}}writeConstructor(e){if(!this.needsConstructor(e))return;let t;if(this.writeNewLine(),this.#la("Construct",e),this.writeNewLine(),this.openBlock(),(t=e.parent)instanceof FuClass&&this.needsConstructor(t)&&(this.writeName(t),this.writeLine("_Construct(&self->base);")),GenC.#ca(e)){let t=GenC.#Xs(e);this.write("static const "),this.writeName(t),this.write("Vtbl vtbl = "),this.openBlock(),this.#wa(e,t),this.indent--,this.writeLine("};");let i=GenC.#Ks(e);this.#Xr(i),this.write("vtbl = "),i!=t&&(this.write("(const "),this.writeName(i),this.write("Vtbl *) ")),this.writeLine("&vtbl;")}this.#Gr=!1,this.writeConstructorBody(e),this.closeBlock()}#Ta(e){if(null!=e){let t;this.#Ta(e.next),(t=e)instanceof FuField&&this.#Os(t)}}writeDestructor(e){if(!GenC.#rs(e))return;let t;this.writeNewLine(),this.#la("Destruct",e),this.writeNewLine(),this.openBlock(),this.#Ta(e.first),(t=e.parent)instanceof FuClass&&GenC.#rs(t)&&(this.writeName(t),this.writeLine("_Destruct(&self->base);")),this.closeBlock()}#da(e,t){e.isPublic&&null!=e.constructor_&&e.constructor_.visibility==FuVisibility.PUBLIC&&(this.writeNewLine(),this.writeName(e),this.write(" *"),this.writeName(e),this.write("_New(void)"),t?(this.writeNewLine(),this.openBlock(),this.writeName(e),this.write(" *self = ("),this.writeName(e),this.write(" *) malloc(sizeof("),this.writeName(e),this.writeLine("));"),this.needsConstructor(e)&&(this.writeLine("if (self != NULL)"),this.indent++,this.writeName(e),this.writeLine("_Construct(self);"),this.indent--),this.writeLine("return self;"),this.closeBlock(),this.writeNewLine()):this.writeCharLine(59),this.write("void "),this.writeName(e),this.write("_Delete("),this.writeName(e),this.write(" *self)"),t?(this.writeNewLine(),this.openBlock(),GenC.#rs(e)&&(this.writeLine("if (self == NULL)"),this.indent++,this.writeLine("return;"),this.indent--,this.writeName(e),this.writeLine("_Destruct(self);")),this.writeLine("free(self);"),this.closeBlock()):this.writeCharLine(59))}static#pa(e){switch(e.id){case FuId.VOID_TYPE:case FuId.FLOAT_TYPE:case FuId.DOUBLE_TYPE:return!0;default:return e instanceof FuRangeType||!(e instanceof FuStorageType)&&(e instanceof FuClassType&&!e.nullable)}}writeMethod(e){if(!e.isLive||e.callType==FuCallType.ABSTRACT)return;if(e.throws.length>0&&!GenC.#pa(e.type)&&this.notSupported(e,"Throwing from this method type"),this.writeNewLine(),e.id==FuId.MAIN)this.write("int main("),this.write(1==e.parameters.count()?"int argc, char **argv)":"void)");else{this.#ha(e);for(let t=e.firstParameter();null!=t;t=t.nextVar())GenC.#ss(t)&&this.#xr.push(t)}let t;if(this.writeNewLine(),this.currentMethod=e,this.#Gr=!1,this.openBlock(),(t=e.body)instanceof FuBlock){let i=t.statements;t.completesNormally()?e.throws.length>0&&e.type.id==FuId.VOID_TYPE?0!=i.length&&this.#sa(i,i.length-1,null)||(this.writeStatements(i),this.#Ms(),this.writeLine("return true;")):(this.writeStatements(i),this.#Ms()):this.writeStatements(i)}else e.body.acceptStatement(this);this.#xr.length=0,this.closeBlock(),this.currentMethod=null}#Fa(e,t,i,r){this.writeNewLine(),this.write("static "),this.write(e),this.write(" Fu"),this.write(t),this.writeChar(95),this.write(i),this.writeChar(40),this.write(r)}#Ea(e,t,i,r){this.#Fa(i,e,t,i),this.write(" x, "),this.write(i),this.writeLine(" y)"),this.openBlock(),this.write("return x "),this.writeChar(r),this.writeLine(" y ? x : y;"),this.closeBlock()}#ya(e,t,i){this.#Fa("bool",e,"TryParse",t),this.write(" *result, const char *str"),this.write(i),this.writeCharLine(41),this.openBlock(),this.writeLine("if (*str == '\\0')"),this.writeLine("\treturn false;"),this.writeLine("char *end;"),this.writeLine("errno = 0;")}#Ia(e,t,i){i.has(FuId.MATH_MIN)&&this.#Ea(e,"Min",t,60),i.has(FuId.MATH_MAX)&&this.#Ea(e,"Max",t,62),i.has(FuId.MATH_CLAMP)&&(this.#Fa(t,e,"Clamp",t),this.write(" x, "),this.write(t),this.write(" minValue, "),this.write(t),this.writeLine(" maxValue)"),this.openBlock(),this.writeLine("return x < minValue ? minValue : x > maxValue ? maxValue : x;"),this.closeBlock()),i.has(FuId.INT_TRY_PARSE)&&(this.#ya(e,t,", int base"),"Int"==e?(this.writeLine("long l = strtol(str, &end, base);"),this.writeLine("if (l < INT_MIN || l > INT_MAX || *end != '\\0' || errno != 0)"),this.writeLine("\treturn false;"),this.writeLine("*result = (int) l;"),this.writeLine("return true;")):"NInt"==e?(this.writeLine("*result ="),this.writeLine("#if PTRDIFF_MAX == LONG_MAX"),this.writeLine("\tstrtol"),this.writeLine("#else"),this.writeLine("\tstrtoll"),this.writeLine("#endif"),this.writeLine("\t(str, &end, base);"),this.writeLine("return *end == '\\0' && errno == 0;")):(this.writeLine("*result = strtoll(str, &end, base);"),this.writeLine("return *end == '\\0' && errno == 0;")),this.closeBlock())}#Sa(){this.#Ia("Int","int",this.#wr),this.#Ia("NInt","ptrdiff_t",this.#Tr),this.#Ia("Long","int64_t",this.#dr),this.#pr&&(this.#ya("Double","double",""),this.writeLine("*result = strtod(str, &end);"),this.writeLine("return *end == '\\0' && errno == 0;"),this.closeBlock()),this.#Fr&&(this.writeNewLine(),this.writeLine("static void FuString_Assign(char **str, char *value)"),this.openBlock(),this.writeLine("free(*str);"),this.writeLine("*str = value;"),this.closeBlock()),this.#Er&&(this.writeNewLine(),this.writeLine("static char *FuString_Substring(const char *str, size_t len)"),this.openBlock(),this.writeLine("char *p = malloc(len + 1);"),this.writeLine("memcpy(p, str, len);"),this.writeLine("p[len] = '\\0';"),this.writeLine("return p;"),this.closeBlock()),this.#yr&&(this.writeNewLine(),this.writeLine("static void FuString_AppendSubstring(char **str, const char *suffix, size_t suffixLen)"),this.openBlock(),this.writeLine("if (suffixLen == 0)"),this.writeLine("\treturn;"),this.writeLine("size_t prefixLen = *str == NULL ? 0 : strlen(*str);"),this.writeLine("*str = realloc(*str, prefixLen + suffixLen + 1);"),this.writeLine("memcpy(*str + prefixLen, suffix, suffixLen);"),this.writeLine("(*str)[prefixLen + suffixLen] = '\\0';"),this.closeBlock(),this.writeNewLine(),this.writeLine("static void FuString_Append(char **str, const char *suffix)"),this.openBlock(),this.writeLine("FuString_AppendSubstring(str, suffix, strlen(suffix));"),this.closeBlock()),this.#Ir&&(this.writeNewLine(),this.writeLine("static ptrdiff_t FuString_IndexOf(const char *str, const char *needle)"),this.openBlock(),this.writeLine("const char *p = strstr(str, needle);"),this.writeLine("return p == NULL ? -1 : p - str;"),this.closeBlock()),this.#Sr&&(this.writeNewLine(),this.writeLine("static ptrdiff_t FuString_LastIndexOf(const char *str, const char *needle)"),this.openBlock(),this.writeLine("if (needle[0] == '\\0')"),this.writeLine("\treturn (ptrdiff_t) strlen(str);"),this.writeLine("ptrdiff_t result = -1;"),this.writeLine("const char *p = strstr(str, needle);"),this.write("while (p != NULL) "),this.openBlock(),this.writeLine("result = p - str;"),this.writeLine("p = strstr(p + 1, needle);"),this.closeBlock(),this.writeLine("return result;"),this.closeBlock()),this.#Cr&&(this.writeNewLine(),this.writeLine("static bool FuString_EndsWith(const char *str, const char *suffix)"),this.openBlock(),this.writeLine("size_t strLen = strlen(str);"),this.writeLine("size_t suffixLen = strlen(suffix);"),this.writeLine("return strLen >= suffixLen && memcmp(str + strLen - suffixLen, suffix, suffixLen) == 0;"),this.closeBlock()),this.#Ar&&(this.writeNewLine(),this.writeLine("static char *FuString_Replace(const char *s, const char *oldValue, const char *newValue)"),this.openBlock(),this.write("for (char *result = NULL;;) "),this.openBlock(),this.writeLine("const char *p = strstr(s, oldValue);"),this.writeLine("if (p == NULL) {"),this.writeLine("\tFuString_Append(&result, s);"),this.writeLine('\treturn result == NULL ? strdup("") : result;'),this.writeCharLine(125),this.writeLine("FuString_AppendSubstring(&result, s, p - s);"),this.writeLine("FuString_Append(&result, newValue);"),this.writeLine("s = p + strlen(oldValue);"),this.closeBlock(),this.closeBlock()),this.#_r&&(this.writeNewLine(),this.writeLine("static char *FuString_Format(const char *format, ...)"),this.openBlock(),this.writeLine("va_list args;"),this.writeLine("va_start(args, format);"),this.writeLine("size_t len = vsnprintf(NULL, 0, format, args) + 1;"),this.writeLine("va_end(args);"),this.writeLine("va_start(args, format);"),this.writeLine("char *str = malloc(len);"),this.writeLine("vsnprintf(str, len, format, args);"),this.writeLine("va_end(args);"),this.writeLine("return str;"),this.closeBlock()),this.#fr&&(this.writeNewLine(),this.writeLine("static bool FuMatch_Find(GMatchInfo **match_info, const char *input, const char *pattern, GRegexCompileFlags options)"),this.openBlock(),this.writeLine("GRegex *regex = g_regex_new(pattern, options, 0, NULL);"),this.writeLine("bool result = g_regex_match(regex, input, 0, match_info);"),this.writeLine("g_regex_unref(regex);"),this.writeLine("return result;"),this.closeBlock()),this.#Rr&&(this.writeNewLine(),this.writeLine("static int FuMatch_GetPos(const GMatchInfo *match_info, int which)"),this.openBlock(),this.writeLine("int start;"),this.writeLine("int end;"),this.writeLine("g_match_info_fetch_pos(match_info, 0, &start, &end);"),this.writeLine("switch (which) {"),this.writeLine("case 0:"),this.writeLine("\treturn start;"),this.writeLine("case 1:"),this.writeLine("\treturn end;"),this.writeLine("default:"),this.writeLine("\treturn end - start;"),this.writeCharLine(125),this.closeBlock()),this.#Lr&&(this.writeNewLine(),this.writeLine("static void FuPtr_Construct(void **ptr)"),this.openBlock(),this.writeLine("*ptr = NULL;"),this.closeBlock()),(this.#Nr||this.#gr||this.#mr)&&(this.writeNewLine(),this.writeLine("typedef void (*FuMethodPtr)(void *);"),this.writeLine("typedef struct {"),this.indent++,this.writeLine("size_t count;"),this.writeLine("size_t unitSize;"),this.writeLine("size_t refCount;"),this.writeLine("FuMethodPtr destructor;"),this.indent--,this.writeLine("} FuShared;")),this.#Nr&&(this.writeNewLine(),this.writeLine("static void *FuShared_Make(size_t count, size_t unitSize, FuMethodPtr constructor, FuMethodPtr destructor)"),this.openBlock(),this.writeLine("FuShared *self = (FuShared *) malloc(sizeof(FuShared) + count * unitSize);"),this.writeLine("self->count = count;"),this.writeLine("self->unitSize = unitSize;"),this.writeLine("self->refCount = 1;"),this.writeLine("self->destructor = destructor;"),this.write("if (constructor != NULL) "),this.openBlock(),this.writeLine("for (size_t i = 0; i < count; i++)"),this.writeLine("\tconstructor((char *) (self + 1) + i * unitSize);"),this.closeBlock(),this.writeLine("return self + 1;"),this.closeBlock()),this.#gr&&(this.writeNewLine(),this.writeLine("static void *FuShared_AddRef(void *ptr)"),this.openBlock(),this.writeLine("if (ptr != NULL)"),this.writeLine("\t((FuShared *) ptr)[-1].refCount++;"),this.writeLine("return ptr;"),this.closeBlock()),(this.#mr||this.#Pr)&&(this.writeNewLine(),this.writeLine("static void FuShared_Release(void *ptr)"),this.openBlock(),this.writeLine("if (ptr == NULL)"),this.writeLine("\treturn;"),this.writeLine("FuShared *self = (FuShared *) ptr - 1;"),this.writeLine("if (--self->refCount != 0)"),this.writeLine("\treturn;"),this.write("if (self->destructor != NULL) "),this.openBlock(),this.writeLine("for (size_t i = self->count; i > 0;)"),this.writeLine("\tself->destructor((char *) ptr + --i * self->unitSize);"),this.closeBlock(),this.writeLine("free(self);"),this.closeBlock()),this.#Pr&&(this.writeNewLine(),this.writeLine("static void FuShared_Assign(void **ptr, void *value)"),this.openBlock(),this.writeLine("FuShared_Release(*ptr);"),this.writeLine("*ptr = value;"),this.closeBlock());for(const e of new Int32Array(this.#kr).sort()){switch(this.writeNewLine(),this.write("static void "),this.#ns(e),this.writeLine("(void *ptr)"),this.openBlock(),e){case FuId.NONE:this.write("FuShared_Release(*(void **)");break;case FuId.STRING_CLASS:this.write("free(*(char **)");break;case FuId.LIST_CLASS:this.write("g_array_unref(*(GArray **)");break;case FuId.QUEUE_CLASS:this.write("g_queue_clear((GQueue *)");break;case FuId.DICTIONARY_CLASS:this.write("g_hash_table_unref(*(GHashTable **)");break;case FuId.SORTED_DICTIONARY_CLASS:this.write("g_tree_unref(*(GTree **)");break;case FuId.REGEX_CLASS:this.write("g_regex_unref(*(GRegex **)");break;case FuId.MATCH_CLASS:this.write("g_match_info_unref(*(GMatchInfo **)");break;default:throw new Error}this.writeLine(" ptr);"),this.closeBlock()}this.#br&&(this.writeNewLine(),this.write("static int FuTree_CompareInteger(gconstpointer pa, gconstpointer pb, gpointer user_data)"),this.openBlock(),this.writeLine("gintptr a = (gintptr) pa;"),this.writeLine("gintptr b = (gintptr) pb;"),this.writeLine("return (a > b) - (a < b);"),this.closeBlock()),this.#Or&&(this.writeNewLine(),this.write("static int FuTree_CompareString(gconstpointer a, gconstpointer b, gpointer user_data)"),this.openBlock(),this.writeLine("return strcmp((const char *) a, (const char *) b);"),this.closeBlock());for(const e of new Int32Array(this.#Mr).sort()){switch(this.writeNewLine(),this.write("static int FuCompare_"),this.writeNumericType(e),this.writeLine("(const void *pa, const void *pb)"),this.openBlock(),this.writeNumericType(e),this.write(" a = *(const "),this.writeNumericType(e),this.writeLine(" *) pa;"),this.writeNumericType(e),this.write(" b = *(const "),this.writeNumericType(e),this.writeLine(" *) pb;"),e){case FuId.BYTE_RANGE:case FuId.S_BYTE_RANGE:case FuId.SHORT_RANGE:case FuId.U_SHORT_RANGE:this.writeLine("return a - b;");break;default:this.writeLine("return (a > b) - (a < b);")}this.closeBlock()}for(const e of new Int32Array(this.#Dr).sort())this.writeNewLine(),this.write("static bool FuArray_Contains_"),e==FuId.NONE?this.write("object(const void * const *a, size_t len, const void *"):e==FuId.STRING_PTR_TYPE?this.write("string(const char * const *a, size_t len, const char *"):(this.writeNumericType(e),this.write("(const "),this.writeNumericType(e),this.write(" *a, size_t len, "),this.writeNumericType(e)),this.writeLine(" value)"),this.openBlock(),this.writeLine("for (size_t i = 0; i < len; i++)"),e==FuId.STRING_PTR_TYPE?this.writeLine("\tif (strcmp(a[i], value) == 0)"):this.writeLine("\tif (a[i] == value)"),this.writeLine("\t\treturn true;"),this.writeLine("return false;"),this.closeBlock()}writeResources(e){if(0!=Object.keys(e).length){this.writeNewLine();for(const[t,i]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0]))))this.write("static const "),this.writeNumericType(FuId.BYTE_RANGE),this.writeChar(32),this.writeResource(t,-1),this.writeChar(91),this.visitLiteralLong(BigInt(i.length)),this.writeLine("] = {"),this.writeChar(9),this.writeBytes(i),this.writeLine(" };")}}writeProgram(e,t,i){this.namespace=i,this.writtenTypes.clear(),this.inHeaderFile=!0,this.openStringWriter();for(const t of e.classes)if(t.isPublic)for(let i=t.first;null!=i;i=i.next){let r;if((r=i)instanceof FuField&&r.visibility==FuVisibility.PUBLIC){this.writeClass(t,e);break}}for(const t of e.classes)this.#da(t,!1),this.writeSignatures(t,!0);this.createHeaderFile(t,".h"),this.writeLine("#ifdef __cplusplus"),this.writeLine('extern "C" {'),this.writeLine("#endif"),this.writeTypedefs(e,!0),this.closeStringWriter(),this.writeNewLine(),this.writeLine("#ifdef __cplusplus"),this.writeCharLine(125),this.writeLine("#endif"),this.closeFile(),this.inHeaderFile=!1,this.#wr.clear(),this.#Tr.clear(),this.#dr.clear(),this.#pr=!1,this.#Fr=!1,this.#Er=!1,this.#yr=!1,this.#Ir=!1,this.#Sr=!1,this.#Cr=!1,this.#Ar=!1,this.#_r=!1,this.#fr=!1,this.#Rr=!1,this.#Lr=!1,this.#Nr=!1,this.#gr=!1,this.#mr=!1,this.#Pr=!1,this.#kr.clear(),this.#br=!1,this.#Or=!1,this.#Mr.clear(),this.#Dr.clear(),this.openStringWriter();for(const t of e.classes)this.writeClass(t,e);this.writeResources(e.resources);for(const t of e.classes)this.currentClass=t,this.writeConstructor(t),this.writeDestructor(t),this.#da(t,!0),this.writeMethods(t);this.include("stdlib.h"),this.createImplementationFile(e,t,".h"),this.#Sa(),this.writeRegexOptionsEnum(e),this.writeTypedefs(e,!1),this.closeStringWriter(),this.closeFile()}}export class GenCl extends GenC{#Ca;#Aa;#_a;#fa;getTargetName(){return"OpenCL C"}includeStdBool(){}includeMath(){}writeNumericType(e){switch(e){case FuId.S_BYTE_RANGE:this.write("char");break;case FuId.BYTE_RANGE:this.write("uchar");break;case FuId.SHORT_RANGE:this.write("short");break;case FuId.U_SHORT_RANGE:this.write("ushort");break;case FuId.INT_TYPE:this.write("int");break;case FuId.N_INT_TYPE:this.write("ptrdiff_t");break;case FuId.LONG_TYPE:this.write("long");break;default:throw new Error}}writeStringPtrType(){this.write("constant char *")}writeClassType(e,t){switch(e.class.id){case FuId.NONE:e instanceof FuDynamicPtrType?this.notSupported(e,"Dynamic reference"):super.writeClassType(e,t);break;case FuId.STRING_CLASS:e.id==FuId.STRING_STORAGE_TYPE?this.notSupported(e,"string()"):this.writeStringPtrType();break;default:this.notSupported(e,e.class.name)}}writePrintfLongPrefix(){this.writeChar(108)}writeInterpolatedStringArgBase(e){e.accept(this,FuPriority.ARGUMENT)}visitInterpolatedString(e,t){this.notSupported(e,"Interpolated strings")}writeCamelCaseNotKeyword(e){switch(e){case"Constant":case"Global":case"Kernel":case"Local":case"Private":case"constant":case"global":case"kernel":case"local":case"private":this.writeCamelCase(e),this.writeChar(95);break;default:super.writeCamelCaseNotKeyword(e)}}getConst(e){return e.ptrTaken?"const ":"constant "}writeSubstringEqual(e,t,i,r){r&&this.writeChar(33),GenCl.isUTF8GetString(e)?(this.#fa=!0,this.write("FuBytes_Equals("),this.writeArrayPtrAdd(e.arguments_[0],e.arguments_[1])):(this.#_a=!0,this.write("FuString_StartsWith("),this.writeArrayPtrAdd(e.method.left,e.arguments_[0])),this.write(", "),this.visitLiteralString(t),this.writeChar(41)}writeEqualStringInternal(e,t,i,r){this.#Aa=!0,r&&this.writeChar(33),this.writeCall("FuString_Equals",e,t)}writeStringLength(e){this.#Ca=!0,this.writeCall("strlen",e)}#Qs(e,t){if(this.write("printf("),0==e.length)this.write('"\\n")');else{let i;(i=e[0])instanceof FuInterpolatedString?this.writePrintf(i,t):this.writePrintfNotInterpolated(e,t)}}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.CLASS_TO_STRING:this.writeCCall(t,i,r);break;case FuId.ENUM_FROM_INT:this.writeStaticCast(e,r[0]);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:t.accept(this,s);break;case FuId.STRING_STARTS_WITH:let a=this.getOneAscii(r[0]);a>=0?(s>FuPriority.EQUALITY&&this.writeChar(40),this.writePostfix(t,"[0] == "),this.visitLiteralChar(a),s>FuPriority.EQUALITY&&this.writeChar(41)):(this.#_a=!0,this.writeCall("FuString_StartsWith",t,r[0]));break;case FuId.STRING_SUBSTRING:1==r.length?this.writeStringSubstringStart(t,r,s):this.notSupported(t,"Substring");break;case FuId.ARRAY_COPY_TO:this.write("for (size_t _i = 0; _i < "),r[3].accept(this,FuPriority.REL),this.writeLine("; _i++)"),this.writeChar(9),r[1].accept(this,FuPriority.PRIMARY),this.writeChar(91),this.startAdd(r[2]),this.write("_i] = "),t.accept(this,FuPriority.PRIMARY),this.writeChar(91),this.startAdd(r[0]),this.write("_i]");break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:this.writeArrayFill(t,r);break;case FuId.CONSOLE_WRITE:this.#Qs(r,!1);break;case FuId.CONSOLE_WRITE_LINE:this.#Qs(r,!0);break;case FuId.U_T_F8_GET_BYTE_COUNT:this.writeStringLength(r[0]);break;case FuId.U_T_F8_GET_BYTES:this.write("for (size_t _i = 0; "),r[0].accept(this,FuPriority.PRIMARY),this.writeLine("[_i] != '\\0'; _i++)"),this.writeChar(9),r[1].accept(this,FuPriority.PRIMARY),this.writeChar(91),this.startAdd(r[2]),this.write("_i] = "),this.writePostfix(r[0],"[_i]");break;case FuId.MATH_METHOD:case FuId.MATH_CLAMP:case FuId.MATH_IS_FINITE:case FuId.MATH_IS_NA_N:case FuId.MATH_LOG2:case FuId.MATH_ROUND:this.writeLowercase(i.name),this.writeInParentheses(r);break;case FuId.MATH_ABS:r[0].type instanceof FuFloatingType&&this.writeChar(102),this.writeCall("abs",r[0]);break;case FuId.MATH_CEILING:this.writeCall("ceil",r[0]);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.writeCall("fma",r[0],r[1],r[2]);break;case FuId.MATH_IS_INFINITY:this.writeCall("isinf",r[0]);break;case FuId.MATH_MAX:(r[0].type instanceof FuFloatingType||r[1].type instanceof FuFloatingType)&&this.writeChar(102),this.writeCall("max",r[0],r[1]);break;case FuId.MATH_MIN:(r[0].type instanceof FuFloatingType||r[1].type instanceof FuFloatingType)&&this.writeChar(102),this.writeCall("min",r[0],r[1]);break;case FuId.MATH_TRUNCATE:this.writeCall("trunc",r[0]);break;default:this.notSupported(t,i.name)}}writeAssert(e){}writeSwitchCaseBody(e){e.every((e=>e instanceof FuAssert))?this.writeCharLine(59):super.writeSwitchCaseBody(e)}#Sa(){this.#Ca&&(this.writeNewLine(),this.writeLine("static ptrdiff_t strlen(constant char *str)"),this.openBlock(),this.writeLine("ptrdiff_t len = 0;"),this.writeLine("while (str[len] != '\\0')"),this.writeLine("\tlen++;"),this.writeLine("return len;"),this.closeBlock()),this.#Aa&&(this.writeNewLine(),this.writeLine("static bool FuString_Equals(constant char *str1, constant char *str2)"),this.openBlock(),this.writeLine("for (size_t i = 0; str1[i] == str2[i]; i++) {"),this.writeLine("\tif (str1[i] == '\\0')"),this.writeLine("\t\treturn true;"),this.writeCharLine(125),this.writeLine("return false;"),this.closeBlock()),this.#_a&&(this.writeNewLine(),this.writeLine("static bool FuString_StartsWith(constant char *str1, constant char *str2)"),this.openBlock(),this.writeLine("for (int i = 0; str2[i] != '\\0'; i++) {"),this.writeLine("\tif (str1[i] != str2[i])"),this.writeLine("\t\treturn false;"),this.writeCharLine(125),this.writeLine("return true;"),this.closeBlock()),this.#fa&&(this.writeNewLine(),this.writeLine("static bool FuBytes_Equals(const uchar *mem, constant char *str)"),this.openBlock(),this.writeLine("for (size_t i = 0; str[i] != '\\0'; i++) {"),this.writeLine("\tif (mem[i] != str[i])"),this.writeLine("\t\treturn false;"),this.writeCharLine(125),this.writeLine("return true;"),this.closeBlock())}writeProgram(e,t,i){this.namespace=i,this.writtenTypes.clear(),this.#Ca=!1,this.#Aa=!1,this.#_a=!1,this.#fa=!1,this.openStringWriter();for(const t of e.classes)this.currentClass=t,this.writeConstructor(t),this.writeDestructor(t),this.writeMethods(t);this.createFile(null,t),this.writeTopLevelNatives(e),this.writeRegexOptionsEnum(e),this.writeTypedefs(e,!0);for(const t of e.classes)this.writeSignatures(t,!0);this.writeTypedefs(e,!1);for(const t of e.classes)this.writeClass(t,e);this.writeResources(e.resources),this.#Sa(),this.closeStringWriter(),this.closeFile()}}export class GenCpp extends GenCCpp{#Ra;#La;#Na;#ga;#Ar;#ma;#Pa;getTargetName(){return"C++"}includeStdInt(){this.include("cstdint")}includeStdDef(){this.include("cstddef")}includeAssert(){this.include("cassert")}includeMath(){this.include("cmath")}visitLiteralNull(){this.write("nullptr")}#ka(e){e.accept(this,FuPriority.PRIMARY),this.writeMemberOp(e,null)}writeInterpolatedStringArg(e){let t;(t=e.type)instanceof FuClassType&&t.class.id!=FuId.STRING_CLASS?(this.#ka(e),this.write("toString()")):super.writeInterpolatedStringArg(e)}visitInterpolatedString(e,t){this.include("format"),this.write('std::format("');for(const t of e.parts)this.writeDoubling(t.prefix,123),this.writeChar(123),this.writePyFormat(t);this.writeDoubling(e.suffix,123),this.writeChar(34),this.writeInterpolatedStringArgs(e),this.writeChar(41)}#ba(e){switch(this.writeCamelCase(e),e){case"And":case"Asm":case"Auto":case"Bool":case"Break":case"Byte":case"Case":case"Catch":case"Char":case"Class":case"Const":case"Continue":case"Default":case"Delete":case"Do":case"Double":case"Else":case"Enum":case"Explicit":case"Export":case"Extern":case"False":case"Float":case"For":case"Friend":case"Goto":case"If":case"Inline":case"Int":case"Long":case"Namespace":case"New":case"Not":case"Nullptr":case"Operator":case"Or":case"Override":case"Private":case"Protected":case"Public":case"Register":case"Return":case"Short":case"Signed":case"Sizeof":case"Static":case"Struct":case"Switch":case"Throw":case"True":case"Try":case"Typedef":case"Union":case"Unsigned":case"Using":case"Virtual":case"Void":case"Volatile":case"While":case"Xor":case"and":case"asm":case"auto":case"catch":case"char":case"delete":case"explicit":case"export":case"extern":case"friend":case"goto":case"inline":case"namespace":case"not":case"nullptr":case"operator":case"or":case"private":case"register":case"signed":case"sizeof":case"struct":case"try":case"typedef":case"union":case"unsigned":case"using":case"volatile":case"xor":this.writeChar(95)}}writeName(e){if(e instanceof FuContainerType)this.write(e.name);else{if(!(e instanceof FuVar||e instanceof FuMember))throw new Error;this.#ba(e.name)}}writeLocalName(e,t){e instanceof FuField&&this.write("this->"),this.writeName(e)}#Oa(e,t,i){this.include("memory"),this.write(e),this.write(t?"unique":"shared"),this.write(i)}#Ma(e){let t,i,r=e.typeArg0;switch(e.class.id){case FuId.ARRAY_STORAGE_CLASS:t="array";break;case FuId.LIST_CLASS:t="vector";break;case FuId.QUEUE_CLASS:t="queue";break;case FuId.STACK_CLASS:t="stack";break;case FuId.PRIORITY_QUEUE_CLASS:return this.#Ra=!0,this.include("queue"),this.write("std::priority_queue<FuPriorityQueueEntry<"),this.writeType(r,!1),this.write(", "),this.writeType(e.typeArg1,!1),void this.write(">>");case FuId.HASH_SET_CLASS:t="unordered_set";break;case FuId.SORTED_SET_CLASS:t="set";break;case FuId.DICTIONARY_CLASS:t="unordered_map";break;case FuId.SORTED_DICTIONARY_CLASS:t="map";break;default:return void this.notSupported(e,e.class.name)}this.include(t),this.write("std::"),this.write(t),this.writeChar(60),this.writeType(r,!1),(i=e)instanceof FuArrayStorageType?(this.write(", "),this.visitLiteralLong(BigInt(i.length))):2==e.class.typeParameterCount&&(this.write(", "),this.writeType(e.getValueType(),!1)),this.writeChar(62)}#Da(e){if(e instanceof FuReadWriteClassType||this.write("const "),0==e.class.typeParameterCount)switch(e.class.id){case FuId.TEXT_WRITER_CLASS:this.include("iostream"),this.write("std::ostream");break;case FuId.STRING_WRITER_CLASS:this.include("sstream"),this.write("std::ostringstream");break;case FuId.REGEX_CLASS:this.include("regex"),this.write("std::regex");break;case FuId.MATCH_CLASS:this.include("regex"),this.write("std::cmatch");break;case FuId.LOCK_CLASS:this.include("mutex"),this.write("std::recursive_mutex");break;default:this.write(e.class.name)}else this.#Ma(e)}writeType(e,t){if(e instanceof FuIntegerType)this.writeNumericType(this.getTypeId(e,t));else if(e instanceof FuStringStorageType)this.include("string"),this.write("std::string");else if(e instanceof FuStringType)this.include("string_view"),this.write("std::string_view");else if(e instanceof FuDynamicPtrType){const t=e;switch(t.class.id){case FuId.REGEX_CLASS:this.include("regex"),this.write("std::regex");break;case FuId.ARRAY_PTR_CLASS:this.#Oa("std::",t.unique,"_ptr<"),this.writeType(t.getElementType(),!1),this.write("[]>");break;default:this.#Oa("std::",t.unique,"_ptr<"),this.#Da(t),this.writeChar(62)}}else if(e instanceof FuClassType){const t=e;t.class.id==FuId.ARRAY_PTR_CLASS?(this.writeType(t.getElementType(),!1),t instanceof FuReadWriteClassType||this.write(" const")):this.#Da(t),t instanceof FuStorageType||this.write(" *")}else this.write(e.name)}#xa(e,t,i){this.#Oa("std::make_",e,"<"),this.writeType(t,!1),this.writeCall("[]>",i)}writeNewArray(e,t,i){this.#xa(!1,e,t)}#Ga(e,t){this.#Oa("std::make_",e,"<"),this.#Da(t),this.write(">()")}writeNew(e,t){this.#Ga(!1,e)}writeStorageInit(e){}writeVarInit(e){if(null!=e.value&&e.type.id==FuId.STRING_STORAGE_TYPE)this.writeChar(123),e.value.accept(this,FuPriority.ARGUMENT),this.writeChar(125);else if(e.type instanceof FuArrayStorageType){let t;if(null==e.value);else{if(!((t=e.value)instanceof FuLiteral&&t.isDefaultValue()))throw new Error;this.write(" {}")}}else super.writeVarInit(e)}static#Ua(e){if(e.type instanceof FuDynamicPtrType)return!0;let t,i;return(t=e)instanceof FuSymbolReference&&(i=t.symbol.parent)instanceof FuForeach&&i.collection.type.asClassType().getElementType()instanceof FuDynamicPtrType}writeStaticCast(e,t){let i;(i=e)instanceof FuDynamicPtrType?(this.write("std::static_pointer_cast<"),this.write(i.class.name)):(this.write("static_cast<"),this.writeType(e,!1)),this.write(">("),t.type instanceof FuStorageType?(this.writeChar(38),t.accept(this,FuPriority.PRIMARY)):e instanceof FuDynamicPtrType||!GenCpp.#Ua(t)?this.getStaticCastInner(e,t).accept(this,FuPriority.ARGUMENT):this.writePostfix(t,".get()"),this.writeChar(41)}static#va(e){let t;return!((t=e)instanceof FuCallExpr&&t.method.symbol.id==FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE)&&e.type.id==FuId.STRING_PTR_TYPE}writeEqual(e,t,i,r){GenCpp.#va(e)&&t.type.id==FuId.NULL_TYPE?(this.writePostfix(e,".data()"),this.write(GenCpp.getEqOp(r)),this.write("nullptr")):e.type.id==FuId.NULL_TYPE&&GenCpp.#va(t)?(this.write("nullptr"),this.write(GenCpp.getEqOp(r)),this.writePostfix(t,".data()")):super.writeEqual(e,t,i,r)}static#Ba(e){let t;return(t=e)instanceof FuClassType&&!(e instanceof FuStorageType)&&t.class.id!=FuId.STRING_CLASS&&t.class.id!=FuId.ARRAY_PTR_CLASS}static#Ya(e){if(GenCpp.#Ba(e.type)){let t,i;return!((t=e)instanceof FuSymbolReference&&(i=t.symbol.parent)instanceof FuForeach&&(t.symbol==i.getVar()?i.collection.type.asClassType().typeArg0:i.collection.type.asClassType().typeArg1)instanceof FuStorageType)}return!1}writeIndexingExpr(e,t){let i=e.left.type;if(t!=FuPriority.ASSIGN)switch(i.class.id){case FuId.ARRAY_STORAGE_CLASS:if(i.id==FuId.MAIN_ARGS_TYPE)return this.include("string_view"),this.write("std::string_view("),this.writeArgsIndexing(e.right),void this.writeChar(41);break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:return this.#ka(e.left),this.write("find("),this.writeStronglyCoerced(i.getKeyType(),e.right),void this.write(")->second")}switch(GenCpp.#Ba(e.left.type)?(this.write("(*"),e.left.accept(this,FuPriority.PRIMARY),this.writeChar(41)):e.left.accept(this,FuPriority.PRIMARY),this.writeChar(91),i.class.id){case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:e.right.accept(this,FuPriority.ARGUMENT);break;default:this.writeStronglyCoerced(i.getKeyType(),e.right)}this.writeChar(93)}writeMemberOp(e,t){null!=t&&t.symbol instanceof FuConst?this.write("::"):GenCpp.#Ya(e)?this.write("->"):this.writeChar(46)}writeEnumAsInt(e,t){this.writeCall("static_cast<int>",e)}#Va(e,t){GenCpp.#Ya(e)?(this.writeChar(42),e.accept(this,FuPriority.PRIMARY)):e.accept(this,t)}#Ha(e,t,i,r,s=""){if(t==FuPriority.STATEMENT)this.#ka(e),this.write("pop()");else{let t=e.type.asClassType();this.write("[]("),this.#Ma(t),this.write(" &"),this.writeChar(i),this.write(") { "),this.writeType(t.getElementType(),!1),this.writeChar(32),this.write(r),this.write(" = "),this.writeChar(i),this.writeChar(46),this.write(r),this.write(s),this.write("(); "),this.writeChar(i),this.write(".pop(); return "),this.write(r),this.write("; }("),this.#Va(e,FuPriority.ARGUMENT),this.writeChar(41)}}#Wa(e){this.#ka(e),this.write("begin(), "),this.#ka(e),this.write("end()")}#Qa(e,t,i){this.writeArrayPtrAdd(e,t),this.write(", "),this.writeArrayPtrAdd(e,t),this.write(" + "),i.accept(this,FuPriority.MUL)}#Xa(e,t){e.accept(this,t),e instanceof FuLiteralString&&(this.include("string_view"),this.#La=!0,this.write("sv"))}#Us(e,t,i,r){this.#Xa(e,FuPriority.PRIMARY),this.writeChar(46),this.write(t);let s=this.getOneAscii(r[0]);s>=0?(this.writeChar(40),this.visitLiteralChar(s),this.writeChar(41)):this.writeCoercedArgsInParentheses(i,r)}#Ka(e,t,i){this.include("algorithm"),this.write("std::"),this.write(e),this.writeChar(40),this.#Wa(t),this.write(", "),null==i[0].type?i[0].accept(this,FuPriority.ARGUMENT):this.writeCoerced(t.type.asClassType().getElementType(),i[0],FuPriority.ARGUMENT),this.writeChar(41)}#ja(e,t,i){this.#ka(e),this.write(t),this.writeChar(40),this.writeCoerced(e.type.asClassType().getElementType(),i[0],FuPriority.ARGUMENT),this.writeChar(41)}#Ja(e,t){this.include("regex"),this.write("std::regex("),e[t].accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(e,", std::regex::ECMAScript | "," | ","","std::regex::icase","std::regex::multiline","std::regex::NOT_SUPPORTED_singleline"),this.writeChar(41)}#qa(e,t){if(this.include("iostream"),1==e.length){let i;if((i=e[0])instanceof FuInterpolatedString){let e=!1,r=!1,s=71;for(const t of i.parts){switch(t.format){case 69:case 71:case 88:e||(this.write(" << std::uppercase"),e=!0);break;case 101:case 103:case 120:e&&(this.write(" << std::nouppercase"),e=!1)}switch(t.format){case 69:case 101:69!=s&&(this.write(" << std::scientific"),s=69);break;case 70:case 102:70!=s&&(this.write(" << std::fixed"),s=70);break;case 88:case 120:r||(this.write(" << std::hex"),r=!0);break;default:r&&(this.write(" << std::dec"),r=!1),71!=s&&(this.write(" << std::defaultfloat"),s=71)}t.prefix.length>0&&(this.write(" << "),this.visitLiteralString(t.prefix)),this.write(" << "),t.argument.accept(this,FuPriority.MUL)}if(e&&this.write(" << std::nouppercase"),r&&this.write(" << std::dec"),71!=s&&this.write(" << std::defaultfloat"),i.suffix.length>0){if(this.write(" << "),t)return void this.writeStringLiteralWithNewLine(i.suffix);this.visitLiteralString(i.suffix)}}else{let i;if(this.write(" << "),t&&(i=e[0])instanceof FuLiteralString)return void this.writeStringLiteralWithNewLine(i.value);e[0]instanceof FuLiteralChar?this.writeCall("static_cast<int>",e[0]):e[0].accept(this,FuPriority.MUL)}}t&&this.write(" << '\\n'")}#za(e){e.type instanceof FuDynamicPtrType?e.accept(this,FuPriority.ARGUMENT):(this.writeChar(42),e.accept(this,FuPriority.PRIMARY))}#$s(e,t,i){this.include("algorithm"),this.write(t),this.writeChar(40);let r=!0;for(const t of i)r||this.write(", "),r=!1,t.type==e||e.id==FuId.INT_TYPE&&(t instanceof FuLiteralLong||this.isPromoted(t))?t.accept(this,FuPriority.ARGUMENT):this.writeStaticCast(e,t);this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.CLASS_TO_STRING:case FuId.LIST_CLEAR:case FuId.HASH_SET_CLEAR:case FuId.SORTED_SET_CLEAR:case FuId.DICTIONARY_CLEAR:case FuId.SORTED_DICTIONARY_CLEAR:null!=t&&(GenCpp.isReferenceTo(t,FuId.BASE_PTR)?(this.writeName(i.parent),this.write("::")):(t.accept(this,FuPriority.PRIMARY),i.callType==FuCallType.STATIC?this.write("::"):this.writeMemberOp(t,null))),this.writeName(i),this.writeCoercedArgsInParentheses(i,r);break;case FuId.ENUM_FROM_INT:this.writeStaticCast(e,r[0]);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:this.writeEnumAsInt(t,s);break;case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:case FuId.LONG_TRY_PARSE:case FuId.DOUBLE_TRY_PARSE:this.include("charconv"),this.include("string_view"),this.#ga=!0,this.writeCall("FuNumber_TryParse",t,r[0],2==r.length?r[1]:null);break;case FuId.STRING_CONTAINS:s>FuPriority.EQUALITY&&this.writeChar(40),this.#Us(t,"find",i,r),this.write(" != std::string::npos"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.STRING_ENDS_WITH:this.#Us(t,"ends_with",i,r);break;case FuId.STRING_INDEX_OF:this.write("static_cast<ptrdiff_t>("),this.#Us(t,"find",i,r),this.writeChar(41);break;case FuId.STRING_LAST_INDEX_OF:this.write("static_cast<ptrdiff_t>("),this.#Us(t,"rfind",i,r),this.writeChar(41);break;case FuId.STRING_REPLACE:this.#Ar=!0,this.writeCall("FuString_Replace",t,r[0],r[1]);break;case FuId.STRING_STARTS_WITH:this.#Us(t,"starts_with",i,r);break;case FuId.STRING_SUBSTRING:this.#Us(t,"substr",i,r);break;case FuId.STRING_TO_LOWER:this.#ma=!0,this.writeCall("FuString_ToLower",t);break;case FuId.STRING_TO_UPPER:this.#Pa=!0,this.writeCall("FuString_ToUpper",t);break;case FuId.ARRAY_BINARY_SEARCH_ALL:case FuId.ARRAY_BINARY_SEARCH_PART:this.include("algorithm"),s>FuPriority.ADD&&this.writeChar(40),this.write("std::lower_bound("),1==r.length?this.#Wa(t):this.#Qa(t,r[1],r[2]),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(") - "),this.writeArrayPtr(t,FuPriority.MUL),s>FuPriority.ADD&&this.writeChar(41);break;case FuId.ARRAY_CONTAINS:case FuId.LIST_CONTAINS:s>FuPriority.EQUALITY&&this.writeChar(40),this.#Ka("find",t,r),this.write(" != "),this.#ka(t),this.write("end()"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:this.include("algorithm"),this.write("std::copy_n("),this.writeArrayPtrAdd(t,r[0]),this.write(", "),r[3].accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeArrayPtrAdd(r[1],r[2]),this.writeChar(41);break;case FuId.ARRAY_FILL_ALL:this.#ja(t,"fill",r);break;case FuId.ARRAY_FILL_PART:this.include("algorithm"),this.write("std::fill_n("),this.writeArrayPtrAdd(t,r[1]),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeCoerced(t.type.asClassType().getElementType(),r[0],FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ARRAY_SORT_ALL:case FuId.LIST_SORT_ALL:this.include("algorithm"),this.write("std::sort("),this.#Wa(t),this.writeChar(41);break;case FuId.ARRAY_SORT_PART:case FuId.LIST_SORT_PART:this.include("algorithm"),this.write("std::sort("),this.#Qa(t,r[0],r[1]),this.writeChar(41);break;case FuId.LIST_ADD:0==r.length?(this.#ka(t),this.write("emplace_back()")):this.#ja(t,"push_back",r);break;case FuId.LIST_ADD_RANGE:this.#ka(t),this.write("insert("),this.#ka(t),this.write("end(), "),this.#Wa(r[0]),this.writeChar(41);break;case FuId.LIST_ALL:this.#Ka("all_of",t,r);break;case FuId.LIST_ANY:this.include("algorithm"),this.#Ka("any_of",t,r);break;case FuId.LIST_INDEX_OF:{let e=t.type.asClassType();this.write("[](const "),this.#Ma(e),this.write(" &v, "),this.writeType(e.getElementType(),!1),this.include("algorithm"),this.write(" value) { auto i = std::find(v.begin(), v.end(), value); return i == v.end() ? -1 : i - v.begin(); }("),this.#Va(t,FuPriority.ARGUMENT),this.write(", "),this.writeCoerced(e.getElementType(),r[0],FuPriority.ARGUMENT),this.writeChar(41)}break;case FuId.LIST_INSERT:this.#ka(t),1==r.length?(this.write("emplace("),this.writeArrayPtrAdd(t,r[0])):(this.write("insert("),this.writeArrayPtrAdd(t,r[0]),this.write(", "),this.writeCoerced(t.type.asClassType().getElementType(),r[1],FuPriority.ARGUMENT)),this.writeChar(41);break;case FuId.LIST_LAST:this.#ka(t),this.write("back()");break;case FuId.LIST_REMOVE_AT:this.#ka(t),this.write("erase("),this.writeArrayPtrAdd(t,r[0]),this.writeChar(41);break;case FuId.LIST_REMOVE_RANGE:this.#ka(t),this.write("erase("),this.#Qa(t,r[0],r[1]),this.writeChar(41);break;case FuId.QUEUE_CLEAR:case FuId.STACK_CLEAR:case FuId.PRIORITY_QUEUE_CLEAR:this.#Va(t,FuPriority.ASSIGN),this.write(" = {}");break;case FuId.QUEUE_DEQUEUE:this.#Ha(t,s,113,"front");break;case FuId.QUEUE_ENQUEUE:this.writeMethodCall(t,"push",r[0]);break;case FuId.QUEUE_PEEK:this.#ka(t),this.write("front()");break;case FuId.STACK_PEEK:this.#ka(t),this.write("top()");break;case FuId.STACK_POP:this.#Ha(t,s,115,"top");break;case FuId.STACK_PUSH:this.#ja(t,"push",r);break;case FuId.PRIORITY_QUEUE_DEQUEUE:this.#Ha(t,s,113,"top","().get");break;case FuId.PRIORITY_QUEUE_ENQUEUE:this.writeMethodCall(t,"emplace",r[0],r[1]);break;case FuId.PRIORITY_QUEUE_PEEK:this.#ka(t),this.write("top().get()");break;case FuId.HASH_SET_ADD:case FuId.SORTED_SET_ADD:this.#ja(t,t.type.asClassType().getElementType().id==FuId.STRING_STORAGE_TYPE&&r[0].type.id==FuId.STRING_PTR_TYPE?"emplace":"insert",r);break;case FuId.HASH_SET_CONTAINS:case FuId.SORTED_SET_CONTAINS:this.#ja(t,"contains",r);break;case FuId.HASH_SET_REMOVE:case FuId.SORTED_SET_REMOVE:case FuId.DICTIONARY_REMOVE:case FuId.SORTED_DICTIONARY_REMOVE:this.writeMethodCall(t,"erase",r[0]);break;case FuId.DICTIONARY_ADD:this.writeIndexing(t,r[0]);break;case FuId.DICTIONARY_CONTAINS_KEY:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:s>FuPriority.EQUALITY&&this.writeChar(40),this.#ka(t),this.write("count("),this.writeStronglyCoerced(t.type.asClassType().getKeyType(),r[0]),this.write(") != 0"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE:this.#Va(t,FuPriority.SHIFT),this.#qa(r,!1);break;case FuId.TEXT_WRITER_WRITE_CHAR:let a;this.#Va(t,FuPriority.SHIFT),this.write(" << "),(a=r[0])instanceof FuLiteralChar&&a.value<127?r[0].accept(this,FuPriority.MUL):this.writeCall("static_cast<char>",r[0]);break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:let n;(n=r[0])instanceof FuLiteralChar&&n.value<127?(this.#Va(t,FuPriority.SHIFT),this.write(" << "),r[0].accept(this,FuPriority.MUL)):(this.write("if ("),r[0].accept(this,FuPriority.REL),this.writeLine(" < 0x80)"),this.writeChar(9),this.#Va(t,FuPriority.SHIFT),this.write(" << "),this.writeCall("static_cast<char>",r[0]),this.writeCharLine(59),this.write("else if ("),r[0].accept(this,FuPriority.REL),this.writeLine(" < 0x800)"),this.writeChar(9),this.#Va(t,FuPriority.SHIFT),this.write(" << static_cast<char>(0xc0 | "),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 6) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.AND),this.writeLine(" & 0x3f));"),this.write("else if ("),r[0].accept(this,FuPriority.REL),this.writeLine(" < 0x10000)"),this.writeChar(9),this.#Va(t,FuPriority.SHIFT),this.write(" << static_cast<char>(0xe0 | "),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 12) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 6 & 0x3f)) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.AND),this.writeLine(" & 0x3f));"),this.writeLine("else"),this.writeChar(9),this.#Va(t,FuPriority.SHIFT),this.write(" << static_cast<char>(0xf0 | "),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 18) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 12 & 0x3f)) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.SHIFT),this.write(" >> 6 & 0x3f)) << static_cast<char>(0x80 | ("),r[0].accept(this,FuPriority.AND),this.write(" & 0x3f))"));break;case FuId.TEXT_WRITER_WRITE_LINE:this.#Va(t,FuPriority.SHIFT),this.#qa(r,!0);break;case FuId.STRING_WRITER_CLEAR:this.include("string"),this.#ka(t),this.write("str(std::string())");break;case FuId.CONSOLE_WRITE:this.write("std::cout"),this.#qa(r,!1);break;case FuId.CONSOLE_WRITE_LINE:this.write("std::cout"),this.#qa(r,!0);break;case FuId.STRING_WRITER_TO_STRING:this.#ka(t),this.write("str()");break;case FuId.U_T_F8_GET_BYTE_COUNT:r[0]instanceof FuLiteral?(s>FuPriority.ADD&&this.writeChar(40),this.write("sizeof("),r[0].accept(this,FuPriority.ARGUMENT),this.write(") - 1"),s>FuPriority.ADD&&this.writeChar(41)):this.writeStringLength(r[0]);break;case FuId.U_T_F8_GET_BYTES:r[0]instanceof FuLiteral?(this.include("algorithm"),this.write("std::copy_n("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", sizeof("),r[0].accept(this,FuPriority.ARGUMENT),this.write(") - 1, "),this.writeArrayPtrAdd(r[1],r[2]),this.writeChar(41)):(this.writePostfix(r[0],".copy(reinterpret_cast<char *>("),this.writeArrayPtrAdd(r[1],r[2]),this.write("), "),this.writePostfix(r[0],".size())"));break;case FuId.U_T_F8_GET_STRING:this.include("string_view"),this.write("std::string_view(reinterpret_cast<const char *>("),this.writeArrayPtrAdd(r[0],r[1]),this.write("), "),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.include("cstdlib"),this.write("std::getenv("),r[0].type.id==FuId.STRING_STORAGE_TYPE?this.writePostfix(r[0],".c_str()"):r[0]instanceof FuLiteralString?r[0].accept(this,FuPriority.ARGUMENT):(this.include("string"),this.write("std::string("),r[0].accept(this,FuPriority.ARGUMENT),this.write(").c_str()")),this.writeChar(41);break;case FuId.REGEX_COMPILE:this.#Ja(r,0);break;case FuId.REGEX_IS_MATCH_STR:case FuId.REGEX_IS_MATCH_REGEX:case FuId.MATCH_FIND_STR:case FuId.MATCH_FIND_REGEX:this.write("std::regex_search("),r[0].type.id==FuId.STRING_STORAGE_TYPE?this.writePostfix(r[0],".c_str()"):r[0].type.id!=FuId.STRING_PTR_TYPE||r[0]instanceof FuLiteral?r[0].accept(this,FuPriority.ARGUMENT):this.#Wa(r[0]),i.id!=FuId.MATCH_FIND_STR&&i.id!=FuId.MATCH_FIND_REGEX||(this.write(", "),t.accept(this,FuPriority.ARGUMENT)),this.write(", "),i.id==FuId.REGEX_IS_MATCH_REGEX?this.#za(t):i.id==FuId.MATCH_FIND_REGEX?this.#za(r[1]):this.#Ja(r,1),this.writeChar(41);break;case FuId.MATCH_GET_CAPTURE:this.#ka(t),this.writeCall("str",r[0]);break;case FuId.MATH_METHOD:case FuId.MATH_ABS:case FuId.MATH_IS_FINITE:case FuId.MATH_IS_NA_N:case FuId.MATH_LOG2:case FuId.MATH_ROUND:this.includeMath(),this.write("std::"),this.writeLowercase(i.name),this.writeInParentheses(r);break;case FuId.MATH_CEILING:this.includeMath(),this.writeCall("std::ceil",r[0]);break;case FuId.MATH_CLAMP:this.#$s(e,"std::clamp",r);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.includeMath(),this.writeCall("std::fma",r[0],r[1],r[2]);break;case FuId.MATH_IS_INFINITY:this.includeMath(),this.writeCall("std::isinf",r[0]);break;case FuId.MATH_MAX:this.#$s(e,"(std::max)",r);break;case FuId.MATH_MIN:this.#$s(e,"(std::min)",r);break;case FuId.MATH_TRUNCATE:this.includeMath(),this.writeCall("std::trunc",r[0]);break;default:this.notSupported(t,i.name)}}writeResource(e,t){this.write("FuResource::"),this.writeResourceName(e)}writeArrayPtr(e,t){let i;e.type instanceof FuArrayStorageType||e.type instanceof FuStringType?this.writePostfix(e,".data()"):e.type instanceof FuDynamicPtrType?this.writePostfix(e,".get()"):(i=e.type)instanceof FuClassType&&i.class.id==FuId.LIST_CLASS?(this.#ka(e),this.write("begin()")):e.accept(this,t)}writeCoercedInternal(e,t,i){if(e instanceof FuStorageType);else if(e instanceof FuDynamicPtrType){let i;if(e.unique&&(i=t)instanceof FuPrefixExpr){console.assert(i.op==FuToken.NEW);let e=i.type;return void(e.class.id==FuId.ARRAY_PTR_CLASS?this.#xa(!0,e.getElementType(),i.inner):this.#Ga(!0,e))}}else if(e instanceof FuClassType){const r=e;if(r.class.id==FuId.STRING_CLASS)return void(t.type.id==FuId.NULL_TYPE?(this.include("string_view"),this.write("std::string_view()")):t.accept(this,i));if(r.class.id==FuId.ARRAY_PTR_CLASS)return void this.writeArrayPtr(t,i);if(GenCpp.#Ua(t))return void(r.class.id==FuId.REGEX_CLASS?(this.writeChar(38),t.accept(this,FuPriority.PRIMARY)):this.writePostfix(t,".get()"));if(t.type instanceof FuClassType&&!GenCpp.#Ya(t))return this.writeChar(38),void(t instanceof FuCallExpr?(this.write("static_cast<"),r instanceof FuReadWriteClassType||this.write("const "),this.writeName(r.class),this.writeCall(" &>",t)):t.accept(this,FuPriority.PRIMARY))}super.writeCoercedInternal(e,t,i)}writeSelectValues(e,t){let i,r;(i=t.onTrue.type)instanceof FuClassType&&(r=t.onFalse.type)instanceof FuClassType&&!i.class.isSameOrBaseOf(r.class)&&!r.class.isSameOrBaseOf(i.class)?(this.writeStaticCast(e,t.onTrue),this.write(" : "),this.writeStaticCast(e,t.onFalse)):super.writeSelectValues(e,t)}writeStringLength(e){this.write("std::ssize("),this.#Xa(e,FuPriority.ARGUMENT),this.writeChar(41)}#Kr(e,t){this.#ka(e.left),this.write(t),this.write("()")}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.write("std::cerr");break;case FuId.LIST_COUNT:case FuId.QUEUE_COUNT:case FuId.STACK_COUNT:case FuId.PRIORITY_QUEUE_COUNT:case FuId.HASH_SET_COUNT:case FuId.SORTED_SET_COUNT:case FuId.DICTIONARY_COUNT:case FuId.SORTED_DICTIONARY_COUNT:case FuId.ORDERED_DICTIONARY_COUNT:this.write("std::ssize("),this.#Va(e.left,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.MATCH_START:this.#Kr(e,"position");break;case FuId.MATCH_END:t>FuPriority.ADD&&this.writeChar(40),this.#Kr(e,"position"),this.write(" + "),this.#Kr(e,"length"),t>FuPriority.ADD&&this.writeChar(41);break;case FuId.MATCH_LENGTH:this.#Kr(e,"length");break;case FuId.MATCH_VALUE:this.#Kr(e,"str");break;default:super.visitSymbolReference(e,t)}}#$a(e){this.write(">("),GenCpp.#Ua(e)?this.writePostfix(e,".get()"):e.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}#Za(e,t,i){let r;i>FuPriority.ASSIGN&&this.writeChar(40),this.writeName(t),this.write(" = "),(r=t.type)instanceof FuDynamicPtrType?(this.write("std::dynamic_pointer_cast<"),this.write(r.class.name),this.writeCall(">",e)):(this.write("dynamic_cast<"),this.writeType(t.type,!0),this.#$a(e)),i>FuPriority.ASSIGN&&this.writeChar(41)}visitBinaryExpr(e,t){switch(e.op){case FuToken.PLUS:if(e.type.id==FuId.STRING_STORAGE_TYPE)return t>FuPriority.ADD&&this.writeChar(40),this.writeStronglyCoerced(e.type,e.left),this.write(" + "),this.writeStronglyCoerced(e.type,e.right),void(t>FuPriority.ADD&&this.writeChar(41));break;case FuToken.EQUAL:case FuToken.NOT_EQUAL:case FuToken.GREATER:let i=GenCpp.isStringEmpty(e);if(null!=i)return e.op!=FuToken.EQUAL&&this.writeChar(33),void this.writePostfix(i,".empty()");break;case FuToken.ASSIGN:let r=GenCpp.isTrimSubstring(e);if(null!=r&&e.left.type.id==FuId.STRING_STORAGE_TYPE&&t==FuPriority.STATEMENT)return void this.writeMethodCall(e.left,"resize",r);break;case FuToken.IS:if(e.right instanceof FuSymbolReference){const i=e.right;return(t==FuPriority.SELECT||t>=FuPriority.OR&&t<=FuPriority.MUL)&&this.write("!!"),this.write("dynamic_cast<const "),this.write(i.symbol.name),this.write(" *"),void this.#$a(e.left)}if(e.right instanceof FuVar){const i=e.right;return void this.#Za(e.left,i,t)}throw new Error}super.visitBinaryExpr(e,t)}static#en(e,t){if(e instanceof FuAggregateInitializer){return e.items.some((e=>GenCpp.#en(e,t)))}if(e instanceof FuLiteral)return!1;if(e instanceof FuInterpolatedString){return e.parts.some((e=>GenCpp.#en(e.argument,t)))}if(e instanceof FuSymbolReference){const i=e;if(null!=i.left)return GenCpp.#en(i.left,t);let r;return(r=i.symbol)instanceof FuMember?!r.isStatic():i.symbol instanceof FuVar&&!t.encloses(i.symbol)}if(e instanceof FuUnaryExpr){const i=e;return null!=i.inner&&GenCpp.#en(i.inner,t)}if(e instanceof FuBinaryExpr){const i=e;return!!GenCpp.#en(i.left,t)||i.op!=FuToken.IS&&GenCpp.#en(i.right,t)}if(e instanceof FuSelectExpr){const i=e;return GenCpp.#en(i.cond,t)||GenCpp.#en(i.onTrue,t)||GenCpp.#en(i.onFalse,t)}if(e instanceof FuCallExpr){const i=e;return GenCpp.#en(i.method,t)||i.arguments_.some((e=>GenCpp.#en(e,t)))}if(e instanceof FuLambdaExpr){const i=e;return GenCpp.#en(i.body,t)}throw new Error}visitLambdaExpr(e){this.writeChar(91),GenCpp.#en(e.body,e)&&this.writeChar(38),this.write("]("),e.first.type instanceof FuOwningType||e.first.type.id==FuId.STRING_STORAGE_TYPE?(this.write("const "),this.writeType(e.first.type,!1),this.write(" &")):(this.writeType(e.first.type,!1),this.writeChar(32)),this.writeName(e.first),this.write(") { "),this.writeTemporaries(e.body),this.write("return "),e.body.accept(this,FuPriority.ARGUMENT),this.write("; }")}writeUnreachable(e){this.include("cstdlib"),this.write("std::"),super.writeUnreachable(e)}writeConst(e){this.write("static constexpr "),this.writeTypeAndName(e),this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59)}visitForeach(e){let t=e.getVar();this.write("for (");let i=e.collection.type;if(i.class.id==FuId.STRING_CLASS)this.writeTypeAndName(t),this.write(" : "),this.#Xa(e.collection,FuPriority.ARGUMENT);else{if(2==e.count())this.write("const auto &["),this.#ba(t.name),this.write(", "),this.#ba(e.getValueVar().name),this.writeChar(93);else if(i.getElementType()instanceof FuStorageType){const e=i.getElementType();t.type instanceof FuReadWriteClassType||this.write("const "),this.write(e.class.name),this.write(" &"),this.#ba(t.name)}else if(i.getElementType()instanceof FuDynamicPtrType){const e=i.getElementType();this.write("const "),this.writeType(e,!0),this.write(" &"),this.#ba(t.name)}else this.writeTypeAndName(t);this.write(" : "),i.id==FuId.MAIN_ARGS_TYPE?(this.include("span"),this.write("std::span(argv + 1, argc - 1)")):this.#Va(e.collection,FuPriority.ARGUMENT)}this.writeChar(41),this.writeChild(e.body)}embedIfWhileIsVar(e,t){let i,r;return(i=e)instanceof FuBinaryExpr&&i.op==FuToken.IS&&(r=i.right)instanceof FuVar&&(t&&this.writeType(r.type,!0),!0)}visitLock(e){this.openBlock(),this.write("const std::lock_guard<std::recursive_mutex> lock("),e.lock.accept(this,FuPriority.ARGUMENT),this.writeLine(");"),this.flattenBlock(e.body),this.closeBlock()}writeStronglyCoerced(e,t){if(e.id!=FuId.STRING_STORAGE_TYPE||t.type.id!=FuId.STRING_PTR_TYPE||t instanceof FuLiteral){let i=GenCpp.isStringSubstring(t);null!=i&&e.id==FuId.STRING_STORAGE_TYPE&&(GenCpp.isUTF8GetString(i)?i.arguments_[0]:i.method.left).type.id!=FuId.STRING_STORAGE_TYPE?(this.write("std::string("),GenCpp.isUTF8GetString(i)?(this.write("reinterpret_cast<const char *>("),this.writeArrayPtrAdd(i.arguments_[0],i.arguments_[1]),this.write("), "),i.arguments_[2].accept(this,FuPriority.ARGUMENT)):(this.writeArrayPtrAdd(i.method.left,i.arguments_[0]),this.write(", "),i.arguments_[1].accept(this,FuPriority.ARGUMENT)),this.writeChar(41)):super.writeStronglyCoerced(e,t)}else this.writeCall("std::string",t)}writeSwitchCaseCond(e,t,i){let r;if((r=t)instanceof FuSymbolReference&&r.symbol instanceof FuClass)this.write("dynamic_cast<const "),this.write(r.symbol.name),this.write(" *"),this.#$a(e.value);else if(t instanceof FuVar){const r=t;i==FuPriority.ARGUMENT&&this.writeType(r.type,!0),this.#Za(e.value,r,i)}else super.writeSwitchCaseCond(e,t,i)}static#tn(e){let t;return(t=e)instanceof FuBinaryExpr&&t.op==FuToken.IS&&t.right instanceof FuVar}#in(e){if(e instanceof FuVar)return!0;if(e instanceof FuAssert){const t=e;return GenCpp.#tn(t.cond)}if(e instanceof FuBlock||e instanceof FuBreak||e instanceof FuConst||e instanceof FuContinue||e instanceof FuLock||e instanceof FuNative||e instanceof FuThrow)return!1;if(e instanceof FuIf){const t=e;return GenCpp.hasTemporaries(t.cond)&&!GenCpp.#tn(t.cond)}if(e instanceof FuLoop){const t=e;return null!=t.cond&&GenCpp.hasTemporaries(t.cond)}if(e instanceof FuReturn){const t=e;return null!=t.value&&GenCpp.hasTemporaries(t.value)}if(e instanceof FuSwitch){const t=e;return GenCpp.hasTemporaries(t.value)}if(e instanceof FuExpr){const t=e;return GenCpp.hasTemporaries(t)}throw new Error}writeSwitchCaseBody(e){let t=!1,i=this.currentTemporaries.length;for(const i of e)!t&&this.#in(i)&&(this.openBlock(),t=!0),i.acceptStatement(this);t&&this.trimTemporariesAndCloseBlock(i)}visitSwitch(e){e.isTypeMatching()?this.writeSwitchAsIfsWithGoto(e):super.visitSwitch(e)}writeException(){this.include("stdexcept"),this.write("std::runtime_error")}writeThrowMessage(e){null==e?this.write('""'):e.type.id!=FuId.STRING_PTR_TYPE||e instanceof FuLiteralString?e.accept(this,FuPriority.ARGUMENT):this.writeCall("std::string",e)}visitThrow(e){this.write("throw "),this.writeThrowArgument(e),this.writeCharLine(59)}#rn(e){0!=e.length&&(this.writeNewLine(),this.write("namespace "),this.writeLine(e),this.writeCharLine(123))}#sn(e){0!=e.length&&this.writeCharLine(125)}writeEnum(e){this.writeNewLine(),this.writeDoc(e.documentation),this.write("enum class "),this.writeLine(e.name),this.openBlock(),e.acceptValues(this),this.writeNewLine(),this.indent--,this.writeLine("};"),e instanceof FuEnumFlags&&(this.include("type_traits"),this.#Na=!0,this.write("FU_ENUM_FLAG_OPERATORS("),this.write(e.name),this.writeCharLine(41))}static#an(e){switch(e.callType){case FuCallType.STATIC:return FuVisibility.PRIVATE;case FuCallType.ABSTRACT:return FuVisibility.PROTECTED;default:return FuVisibility.PUBLIC}}static#nn(e,t){for(let i=e.first;null!=i;i=i.next){let e;if((e=i)instanceof FuMember&&e.visibility==t)return!0}return!1}writeField(e){this.writeDoc(e.documentation),this.writeVar(e),this.writeCharLine(59)}#hn(e,t){this.writeParameters(e,t),e.callType==FuCallType.STATIC||e.isMutator()||this.write(" const")}#on(e,t,i){let r=GenCpp.#an(e)==t,s=t==FuVisibility.PUBLIC&&(e.hasSubclasses||e.addsVirtualMethods()),a=t==FuVisibility.PRIVATE&&e.last instanceof FuNative;if(r||s||a||GenCpp.#nn(e,t)){this.indent--,this.writeLine(i),this.indent++,r&&(e.id==FuId.EXCEPTION_CLASS?(this.write("using "),"Exception"==e.baseClass.name?this.write("std::runtime_error::runtime_error"):(this.write(e.baseClass.name),this.write("::"),this.write(e.baseClass.name))):(null!=e.constructor_&&this.writeDoc(e.constructor_.documentation),this.write(e.name),this.write("()"),e.callType==FuCallType.STATIC?this.write(" = delete"):this.needsConstructor(e)||this.write(" = default")),this.writeCharLine(59)),s&&(this.write("virtual ~"),this.write(e.name),this.writeLine("() = default;"));for(let i=e.first;null!=i;i=i.next)if(i instanceof FuConst){const e=i;if(e.visibility!=t)continue;this.writeDoc(e.documentation),this.writeConst(e)}else if(i instanceof FuField){const e=i;e.visibility==t&&this.writeField(e)}else if(i instanceof FuMethod){const e=i;if(e.visibility!=t||e.id==FuId.MAIN)continue;switch(this.writeMethodDoc(e),e.callType){case FuCallType.STATIC:this.write("static ");break;case FuCallType.ABSTRACT:case FuCallType.VIRTUAL:this.write("virtual ")}switch(this.writeTypeAndName(e),this.#hn(e,!0),e.callType){case FuCallType.ABSTRACT:this.write(" = 0");break;case FuCallType.OVERRIDE:this.write(" override");break;case FuCallType.SEALED:this.write(" final")}this.writeCharLine(59)}else{if(!(i instanceof FuNative))throw new Error;{const e=i;let r=e.getFollowingMember();t==(null!=r?r.visibility:FuVisibility.PRIVATE)&&this.visitNative(e)}}}}writeClassInternal(e){this.writeNewLine(),this.writeDoc(e.documentation),this.openClass(e,e.callType==FuCallType.SEALED?" final":""," : public "),this.#on(e,FuVisibility.PUBLIC,"public:"),this.#on(e,FuVisibility.PROTECTED,"protected:"),this.#on(e,FuVisibility.INTERNAL,"private: // internal");for(const t of Array.from(e.cppFriends).sort())this.write("friend "),this.write(t),this.writeCharLine(59);this.#on(e,FuVisibility.PRIVATE,"private:"),this.indent--,this.writeLine("};")}#un(e){this.needsConstructor(e)&&(this.write(e.name),this.write("::"),this.write(e.name),this.writeLine("()"),this.openBlock(),this.writeConstructorBody(e),this.closeBlock())}writeMethod(e){e.callType!=FuCallType.ABSTRACT&&(this.writeNewLine(),e.id==FuId.MAIN?(this.write("int main("),1==e.parameters.count()&&this.write("int argc, char **argv"),this.writeChar(41)):(this.writeType(e.type,!0),this.writeChar(32),this.write(e.parent.name),this.write("::"),this.#ba(e.name),this.#hn(e,!1)),this.writeBody(e))}#cn(e,t){if(0!=Object.keys(e).length){this.writeNewLine(),this.writeLine("namespace"),this.openBlock(),this.writeLine("namespace FuResource"),this.openBlock();for(const[i,r]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0]))))t||this.write("extern "),this.include("array"),this.include("cstdint"),this.write("const std::array<uint8_t, "),this.visitLiteralLong(BigInt(r.length)),this.write("> "),this.writeResourceName(i),t&&(this.writeLine(" = {"),this.writeChar(9),this.writeBytes(r),this.write(" }")),this.writeCharLine(59);this.closeBlock(),this.closeBlock()}}writeProgram(e,t,i){this.writtenTypes.clear(),this.inHeaderFile=!0,this.#Ra=!1,this.#La=!1,this.#Na=!1,this.#ga=!1,this.#Ar=!1,this.#ma=!1,this.#Pa=!1,this.openStringWriter(),this.#rn(i),this.writeRegexOptionsEnum(e);for(let t=e.first;null!=t;t=t.next){let e;(e=t)instanceof FuEnum?this.writeEnum(e):(this.write("class "),this.write(t.name),this.writeCharLine(59))}for(const t of e.classes)this.writeClass(t,e);this.#sn(i),this.createHeaderFile(t,".hpp"),this.#Na&&(this.writeLine("#define FU_ENUM_FLAG_OPERATORS(T) \\"),this.writeLine("\tinline constexpr T operator~(T a) { return static_cast<T>(~static_cast<std::underlying_type_t<T>>(a)); } \\"),this.writeLine("\tinline constexpr T operator&(T a, T b) { return static_cast<T>(static_cast<std::underlying_type_t<T>>(a) & static_cast<std::underlying_type_t<T>>(b)); } \\"),this.writeLine("\tinline constexpr T operator|(T a, T b) { return static_cast<T>(static_cast<std::underlying_type_t<T>>(a) | static_cast<std::underlying_type_t<T>>(b)); } \\"),this.writeLine("\tinline constexpr T operator^(T a, T b) { return static_cast<T>(static_cast<std::underlying_type_t<T>>(a) ^ static_cast<std::underlying_type_t<T>>(b)); } \\"),this.writeLine("\tinline constexpr T &operator&=(T &a, T b) { return (a = a & b); } \\"),this.writeLine("\tinline constexpr T &operator|=(T &a, T b) { return (a = a | b); } \\"),this.writeLine("\tinline constexpr T &operator^=(T &a, T b) { return (a = a ^ b); }")),this.closeStringWriter(),this.closeFile(),this.inHeaderFile=!1,this.openStringWriter(),this.#cn(e.resources,!1),this.#rn(i);for(const t of e.classes)this.#un(t),this.writeMethods(t);this.#cn(e.resources,!0),this.#sn(i),this.#Ar&&(this.include("string"),this.include("string_view")),this.createImplementationFile(e,t,".hpp"),this.#La&&this.writeLine("using namespace std::string_view_literals;"),this.#ga&&(this.writeNewLine(),this.writeLine("template <class T, class... Args>"),this.writeLine("bool FuNumber_TryParse(T &number, std::string_view s, Args... args)"),this.openBlock(),this.writeLine("const char *end = s.data() + s.size();"),this.writeLine("auto result = std::from_chars(s.data(), end, number, args...);"),this.writeLine("return result.ec == std::errc{} && result.ptr == end;"),this.closeBlock()),this.#Ar&&(this.writeNewLine(),this.writeLine("static std::string FuString_Replace(std::string_view s, std::string_view oldValue, std::string_view newValue)"),this.openBlock(),this.writeLine("std::string result;"),this.writeLine("result.reserve(s.size());"),this.writeLine("for (std::string_view::size_type i = 0;;) {"),this.writeLine("\tauto j = s.find(oldValue, i);"),this.writeLine("\tif (j == std::string::npos) {"),this.writeLine("\t\tresult.append(s, i);"),this.writeLine("\t\treturn result;"),this.writeLine("\t}"),this.writeLine("\tresult.append(s, i, j - i);"),this.writeLine("\tresult.append(newValue);"),this.writeLine("\ti = j + oldValue.size();"),this.writeCharLine(125),this.closeBlock()),(this.#ma||this.#Pa)&&(this.writeNewLine(),this.writeLine("#ifdef _WIN32"),this.writeNewLine(),this.writeLine("#include <Windows.h>"),this.writeNewLine(),this.writeLine("static std::string FuString_Win32LCMap(std::string_view s, DWORD flags)"),this.openBlock(),this.writeLine("int size = MultiByteToWideChar(CP_UTF8, 0, s.data(), (int) s.size(), nullptr, 0);"),this.writeLine("std::wstring wide(size, 0);"),this.writeLine("MultiByteToWideChar(CP_UTF8, 0, s.data(), (int) s.size(), wide.data(), size);"),this.writeLine("size = LCMapStringEx(LOCALE_NAME_SYSTEM_DEFAULT, LCMAP_LINGUISTIC_CASING | flags, wide.data(), size, nullptr, 0, nullptr, nullptr, 0);"),this.writeLine("std::wstring wideResult(size, 0);"),this.writeLine("LCMapStringEx(LOCALE_NAME_SYSTEM_DEFAULT, LCMAP_LINGUISTIC_CASING | flags, wide.data(), wide.size(), wideResult.data(), size, nullptr, nullptr, 0);"),this.writeLine("int resultSize = WideCharToMultiByte(CP_UTF8, 0, wideResult.data(), size, nullptr, 0, nullptr, nullptr);"),this.writeLine("std::string result(resultSize, 0);"),this.writeLine("WideCharToMultiByte(CP_UTF8, 0, wideResult.data(), size, result.data(), resultSize, nullptr, nullptr);"),this.writeLine("return result;"),this.closeBlock(),this.#ma&&(this.writeNewLine(),this.writeLine("static std::string FuString_ToLower(std::string_view s)"),this.openBlock(),this.writeLine("return FuString_Win32LCMap(s, LCMAP_LOWERCASE);"),this.closeBlock()),this.#Pa&&(this.writeNewLine(),this.writeLine("static std::string FuString_ToUpper(std::string_view s)"),this.openBlock(),this.writeLine("return FuString_Win32LCMap(s, LCMAP_UPPERCASE);"),this.closeBlock()),this.writeNewLine(),this.writeLine("#else"),this.writeNewLine(),this.writeLine("#include <unicode/unistr.h>"),this.#ma&&(this.writeNewLine(),this.writeLine("static std::string FuString_ToLower(std::string_view s)"),this.openBlock(),this.writeLine("std::string result;"),this.writeLine("return icu::UnicodeString::fromUTF8(s).toLower().toUTF8String(result);"),this.closeBlock()),this.#Pa&&(this.writeNewLine(),this.writeLine("static std::string FuString_ToUpper(std::string_view s)"),this.openBlock(),this.writeLine("std::string result;"),this.writeLine("return icu::UnicodeString::fromUTF8(s).toUpper().toUTF8String(result);"),this.closeBlock()),this.writeNewLine(),this.writeLine("#endif")),this.#Ra&&(this.writeLine("template <class TElement, class TPriority>"),this.writeLine("class FuPriorityQueueEntry"),this.openBlock(),this.writeLine("TPriority priority;"),this.writeLine("TElement element;"),this.indent--,this.writeLine("public:"),this.indent++,this.writeLine("FuPriorityQueueEntry(const TElement &element, const TPriority &priority) : priority(priority), element(element) {}"),this.writeLine("const TElement &get() const { return element; }"),this.writeLine("bool operator<(const FuPriorityQueueEntry &that) const { return that.priority < priority; }"),this.indent--,this.writeLine("};")),this.closeStringWriter(),this.closeFile()}}export class GenCs extends GenTyped{getTargetName(){return"C++"}startDocLine(){this.write("/// ")}writeDocPara(e,t){t&&(this.writeNewLine(),this.write("/// <para>"));for(const t of e.children)if(t instanceof FuDocText){const e=t;this.writeXmlDoc(e.text)}else if(t instanceof FuDocCode){const e=t;switch(e.text){case"true":case"false":case"null":this.write('<see langword="'),this.write(e.text),this.write('" />');break;default:this.write("<c>"),this.writeXmlDoc(e.text),this.write("</c>")}}else{if(!(t instanceof FuDocLine))throw new Error;this.writeNewLine(),this.startDocLine()}t&&this.write("</para>")}writeDocList(e){this.writeNewLine(),this.writeLine('/// <list type="bullet">');for(const t of e.items)this.write("/// <item>"),this.writeDocPara(t,!1),this.writeLine("</item>");this.write("/// </list>")}writeDoc(e){if(null!=e&&(this.write("/// <summary>"),this.writeDocPara(e.summary,!1),this.writeLine("</summary>"),e.details.length>0)){if(this.write("/// <remarks>"),1==e.details.length)this.writeDocBlock(e.details[0],!1);else for(const t of e.details)this.writeDocBlock(t,!0);this.writeLine("</remarks>")}}writeName(e){let t;if((t=e)instanceof FuConst&&null!=t.inMethod)return this.write(t.inMethod.name),this.writeChar(95),this.write(e.name),void(t.inMethodIndex>0&&this.visitLiteralLong(BigInt(t.inMethodIndex)));switch(this.write(e.name),e.name){case"as":case"await":case"catch":case"char":case"checked":case"decimal":case"delegate":case"event":case"explicit":case"extern":case"finally":case"fixed":case"goto":case"implicit":case"interface":case"is":case"lock":case"namespace":case"object":case"operator":case"out":case"params":case"private":case"readonly":case"ref":case"sbyte":case"sizeof":case"stackalloc":case"struct":case"try":case"typeof":case"ulong":case"unchecked":case"unsafe":case"using":case"volatile":this.writeChar(95)}}getLiteralChars(){return 65536}#ln(e){switch(e){case FuVisibility.PRIVATE:break;case FuVisibility.INTERNAL:this.write("internal ");break;case FuVisibility.PROTECTED:this.write("protected ");break;case FuVisibility.PUBLIC:this.write("public ");break;default:throw new Error}}#wn(e,t){switch(e){case FuCallType.STATIC:this.write("static ");break;case FuCallType.NORMAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.VIRTUAL:this.write("virtual ");break;case FuCallType.OVERRIDE:this.write("override ");break;case FuCallType.SEALED:this.write(t)}}#Tn(e){this.include("System.Collections.Generic"),this.writeChar(60),this.writeType(e,!1),this.writeChar(62)}writeType(e,t){if(e instanceof FuIntegerType)switch(this.getTypeId(e,t)){case FuId.S_BYTE_RANGE:this.write("sbyte");break;case FuId.BYTE_RANGE:this.write("byte");break;case FuId.SHORT_RANGE:this.write("short");break;case FuId.U_SHORT_RANGE:this.write("ushort");break;case FuId.INT_TYPE:case FuId.N_INT_TYPE:this.write("int");break;case FuId.LONG_TYPE:this.write("long");break;default:throw new Error}else if(e instanceof FuClassType){const t=e;switch(t.class.id){case FuId.STRING_CLASS:this.write("string");break;case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:this.writeType(t.getElementType(),!1),this.write("[]");break;case FuId.LIST_CLASS:case FuId.QUEUE_CLASS:case FuId.STACK_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.write(t.class.name),this.#Tn(t.getElementType());break;case FuId.PRIORITY_QUEUE_CLASS:case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.include("System.Collections.Generic"),this.write(t.class.name),this.writeChar(60),this.writeType(t.getKeyType(),!1),this.write(", "),this.writeType(t.getValueType(),!1),this.writeChar(62);break;case FuId.ORDERED_DICTIONARY_CLASS:this.include("System.Collections.Specialized"),this.write("OrderedDictionary");break;case FuId.TEXT_WRITER_CLASS:case FuId.STRING_WRITER_CLASS:this.include("System.IO"),this.write(t.class.name);break;case FuId.REGEX_CLASS:case FuId.MATCH_CLASS:this.include("System.Text.RegularExpressions"),this.write(t.class.name);break;case FuId.JSON_ELEMENT_CLASS:this.include("System.Text.Json"),this.write("JsonElement");break;case FuId.LOCK_CLASS:this.write("object");break;default:this.write(t.class.name)}}else this.write(e.name)}writeNewWithFields(e,t){this.write("new "),this.writeType(e,!1),this.writeObjectLiteral(t," = ")}writeCoercedLiteral(e,t){let i;t instanceof FuLiteralChar&&(i=e)instanceof FuRangeType&&i.max<=255?this.writeStaticCast(e,t):super.writeCoercedLiteral(e,t)}isPromoted(e){return super.isPromoted(e)||e instanceof FuLiteralChar}visitInterpolatedString(e,t){this.write('$"');for(const t of e.parts)this.writeDoubling(t.prefix,123),this.writeChar(123),t.argument.accept(this,FuPriority.SELECT_COND),null!=t.widthExpr&&(this.writeChar(44),this.visitLiteralLong(BigInt(t.width))),32!=t.format&&(this.writeChar(58),this.writeChar(t.format),t.precision>=0&&this.visitLiteralLong(BigInt(t.precision))),this.writeChar(125);this.writeDoubling(e.suffix,123),this.writeChar(34)}writeNewArray(e,t,i){let r;for(this.write("new "),this.writeType(e.getBaseType(),!1),this.writeChar(91),t.accept(this,FuPriority.ARGUMENT),this.writeChar(93);(r=e)instanceof FuClassType&&r.isArray();)this.write("[]"),e=r.getElementType()}writeNew(e,t){this.write("new "),this.writeType(e,!1),this.write("()")}hasInitCode(e){let t;return(t=e.type)instanceof FuArrayStorageType&&t.getElementType()instanceof FuStorageType}writeInitCode(e){if(!this.hasInitCode(e))return;let t,i,r=e.type,s=0;for(;(t=r.getElementType())instanceof FuArrayStorageType;)this.openLoop("int",s++,r.length),this.writeArrayElement(e,s),this.write(" = "),this.writeNewArray(t.getElementType(),t.lengthExpr,FuPriority.ARGUMENT),this.writeCharLine(59),r=t;for((i=r.getElementType())instanceof FuStorageType&&(this.openLoop("int",s++,r.length),this.writeArrayElement(e,s),this.write(" = "),this.writeNew(i,FuPriority.ARGUMENT),this.writeCharLine(59));--s>=0;)this.closeBlock()}writeResource(e,t){this.write("FuResource."),this.writeResourceName(e)}writeStringLength(e){this.writePostfix(e,".Length")}writeArrayLength(e,t){this.writePostfix(e,".Length")}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.include("System"),this.write("Console.Error");break;case FuId.MATCH_START:this.writePostfix(e.left,".Index");break;case FuId.MATCH_END:t>FuPriority.ADD&&this.writeChar(40),this.writePostfix(e.left,".Index + "),this.writeStringLength(e.left),t>FuPriority.ADD&&this.writeChar(41);break;case FuId.MATH_NA_N:case FuId.MATH_NEGATIVE_INFINITY:case FuId.MATH_POSITIVE_INFINITY:this.write("float."),this.write(e.symbol.name);break;default:let i,r;if((i=e.symbol.parent)instanceof FuForeach&&(r=i.collection.type)instanceof FuClassType&&r.class.id==FuId.ORDERED_DICTIONARY_CLASS){t==FuPriority.PRIMARY&&this.writeChar(40);let s=i.getVar();e.symbol==s?(this.writeStaticCastType(r.getKeyType()),this.writeName(s),this.write(".Key")):(this.writeStaticCastType(r.getValueType()),this.writeName(s),this.write(".Value")),t==FuPriority.PRIMARY&&this.writeChar(41)}else super.visitSymbolReference(e,t)}}#dn(e,t,i){i>FuPriority.EQUALITY&&this.writeChar(40),this.writePostfix(e,".ValueKind == JsonValueKind."),this.write(t),i>FuPriority.EQUALITY&&this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.ENUM_FROM_INT:this.writeStaticCast(e,r[0]);break;case FuId.ENUM_TO_INT:this.write("(int) "),t.accept(this,FuPriority.PRIMARY);break;case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:case FuId.LONG_TRY_PARSE:case FuId.DOUBLE_TRY_PARSE:if(this.writeType(t.type,!1),this.write(".TryParse("),r[0].accept(this,FuPriority.ARGUMENT),2==r.length){let e;(e=r[1])instanceof FuLiteralLong&&16==e.value||this.notSupported(r[1],"Radix"),this.include("System.Globalization"),this.write(", NumberStyles.HexNumber, null")}this.write(", out "),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.STRING_INDEX_OF:case FuId.STRING_LAST_INDEX_OF:t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(i.name),this.writeChar(40);let a=this.getOneAscii(r[0]);a>=0?this.visitLiteralChar(a):r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ARRAY_BINARY_SEARCH_ALL:case FuId.ARRAY_BINARY_SEARCH_PART:this.include("System"),this.write("Array.BinarySearch("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),3==r.length&&(r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.write(", ")),this.writeNotPromoted(t.type.asClassType().getElementType(),r[0]),this.writeChar(41);break;case FuId.ARRAY_CONTAINS:this.include("System.Linq"),this.writeMethodCall(t,"Contains",r[0]);break;case FuId.ARRAY_COPY_TO:this.include("System"),this.write("Array.Copy("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeCoercedArgs(i,r),this.writeChar(41);break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:let n;this.include("System"),(n=r[0])instanceof FuLiteral&&n.isDefaultValue()?(this.write("Array.Clear("),t.accept(this,FuPriority.ARGUMENT),1==r.length&&(this.write(", 0, "),this.writeArrayStorageLength(t))):(this.write("Array.Fill("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeNotPromoted(t.type.asClassType().getElementType(),r[0])),3==r.length&&(this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT)),this.writeChar(41);break;case FuId.ARRAY_SORT_ALL:this.include("System"),this.writeCall("Array.Sort",t);break;case FuId.ARRAY_SORT_PART:this.include("System"),this.writeCall("Array.Sort",t,r[0],r[1]);break;case FuId.LIST_ADD:case FuId.HASH_SET_ADD:case FuId.SORTED_SET_ADD:this.writeListAdd(t,"Add",r);break;case FuId.LIST_ALL:this.writeMethodCall(t,"TrueForAll",r[0]);break;case FuId.LIST_ANY:this.writeMethodCall(t,"Exists",r[0]);break;case FuId.LIST_INSERT:this.writeListInsert(t,"Insert",r);break;case FuId.LIST_LAST:this.writePostfix(t,"[^1]");break;case FuId.QUEUE_ENQUEUE:this.writeListAdd(t,"Enqueue",r);break;case FuId.STACK_PUSH:this.writeListAdd(t,"Push",r);break;case FuId.LIST_SORT_PART:this.writePostfix(t,".Sort("),this.writeCoercedArgs(i,r),this.write(", null)");break;case FuId.DICTIONARY_ADD:this.writePostfix(t,".Add("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeNewStorage(t.type.asClassType().getValueType()),this.writeChar(41);break;case FuId.ORDERED_DICTIONARY_CONTAINS_KEY:this.writeMethodCall(t,"Contains",r[0]);break;case FuId.TEXT_WRITER_WRITE:case FuId.TEXT_WRITER_WRITE_LINE:case FuId.CONSOLE_WRITE:case FuId.CONSOLE_WRITE_LINE:this.include("System"),t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(i.name),this.writeChar(40),0!=r.length&&(r[0]instanceof FuLiteralChar?(this.write("(int) "),r[0].accept(this,FuPriority.PRIMARY)):r[0].accept(this,FuPriority.ARGUMENT)),this.writeChar(41);break;case FuId.STRING_WRITER_CLEAR:this.writePostfix(t,".GetStringBuilder().Clear()");break;case FuId.TEXT_WRITER_WRITE_CHAR:this.writeCharMethodCall(t,"Write",r[0]);break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:let h;this.writePostfix(t,".Write("),(h=r[0])instanceof FuLiteralChar&&h.value<65536?r[0].accept(this,FuPriority.ARGUMENT):(this.include("System.Text"),this.writeCall("new Rune",r[0])),this.writeChar(41);break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.include("System"),t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(i.name),this.writeInParentheses(r);break;case FuId.U_T_F8_GET_BYTE_COUNT:this.include("System.Text"),this.writeCall("Encoding.UTF8.GetByteCount",r[0]);break;case FuId.U_T_F8_GET_BYTES:this.include("System.Text"),this.write("Encoding.UTF8.GetBytes("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", 0, "),this.writePostfix(r[0],".Length, "),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.U_T_F8_GET_STRING:this.include("System.Text"),this.write("Encoding.UTF8.GetString"),this.writeInParentheses(r);break;case FuId.REGEX_COMPILE:this.include("System.Text.RegularExpressions"),this.write("new Regex"),this.writeInParentheses(r);break;case FuId.REGEX_ESCAPE:case FuId.REGEX_IS_MATCH_STR:case FuId.REGEX_IS_MATCH_REGEX:this.include("System.Text.RegularExpressions"),t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(i.name),this.writeInParentheses(r);break;case FuId.MATCH_FIND_STR:this.include("System.Text.RegularExpressions"),this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = Regex.Match"),this.writeInParentheses(r),this.write(").Success");break;case FuId.MATCH_FIND_REGEX:this.include("System.Text.RegularExpressions"),this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = "),this.writeMethodCall(r[1],"Match",r[0]),this.write(").Success");break;case FuId.MATCH_GET_CAPTURE:this.writePostfix(t,".Groups["),r[0].accept(this,FuPriority.ARGUMENT),this.write("].Value");break;case FuId.JSON_ELEMENT_PARSE:this.write("JsonDocument.Parse("),r[0].accept(this,FuPriority.ARGUMENT),this.write(").RootElement");break;case FuId.JSON_ELEMENT_IS_OBJECT:this.#dn(t,"Object",s);break;case FuId.JSON_ELEMENT_IS_ARRAY:this.#dn(t,"Array",s);break;case FuId.JSON_ELEMENT_IS_STRING:this.#dn(t,"String",s);break;case FuId.JSON_ELEMENT_IS_NUMBER:this.#dn(t,"Number",s);break;case FuId.JSON_ELEMENT_IS_BOOLEAN:s>FuPriority.COND_OR&&this.writeChar(40),this.writePostfix(t,".ValueKind == JsonValueKind.True || "),this.writePostfix(t,".ValueKind == JsonValueKind.False"),s>FuPriority.COND_OR&&this.writeChar(41);break;case FuId.JSON_ELEMENT_IS_NULL:this.#dn(t,"Null",s);break;case FuId.JSON_ELEMENT_GET_OBJECT:this.include("System.Linq"),this.writePostfix(t,".EnumerateObject().ToDictionary(p => p.Name, p => p.Value)");break;case FuId.JSON_ELEMENT_GET_ARRAY:this.include("System.Linq"),this.writePostfix(t,".EnumerateArray().ToList()");break;case FuId.MATH_METHOD:case FuId.MATH_CEILING:case FuId.MATH_FUSED_MULTIPLY_ADD:case FuId.MATH_LOG2:case FuId.MATH_ROUND:case FuId.MATH_TRUNCATE:this.include("System"),this.write("Math"),r.some((e=>e.type.id==FuId.DOUBLE_TYPE))||this.writeChar(70),this.writeChar(46),this.write(i.name),this.writeInParentheses(r);break;case FuId.MATH_ABS:case FuId.MATH_CLAMP:case FuId.MATH_MAX:case FuId.MATH_MIN:this.include("System"),this.write("Math."),this.write(i.name),this.writeInParentheses(r);break;case FuId.MATH_IS_FINITE:case FuId.MATH_IS_INFINITY:case FuId.MATH_IS_NA_N:this.write("double."),this.writeCall(i.name,r[0]);break;default:null!=t&&(t.accept(this,FuPriority.PRIMARY),this.writeChar(46)),this.writeName(i),this.writeCoercedArgsInParentheses(i,r)}}#pn(e){e.right.type.id==FuId.INT_TYPE||e.right.type instanceof FuRangeType?(this.writePostfix(e.left,"[(object) "),e.right.accept(this,FuPriority.PRIMARY),this.writeChar(93)):super.writeIndexingExpr(e,FuPriority.AND)}writeIndexingExpr(e,t){let i;(i=e.left.type)instanceof FuClassType&&i.class.id==FuId.ORDERED_DICTIONARY_CLASS?(t==FuPriority.PRIMARY&&this.writeChar(40),this.writeStaticCastType(e.type),this.#pn(e),t==FuPriority.PRIMARY&&this.writeChar(41)):super.writeIndexingExpr(e,t)}writeAssign(e,t){let i,r;(i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&r.class.id==FuId.ORDERED_DICTIONARY_CLASS?(this.#pn(i),this.write(" = "),this.writeAssignRight(e)):super.writeAssign(e,t)}visitBinaryExpr(e,t){switch(e.op){case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:t>FuPriority.ASSIGN&&this.writeChar(40),e.left.accept(this,FuPriority.ASSIGN),this.writeChar(32),this.write(e.getOpString()),this.writeChar(32),this.writeAssignRight(e),t>FuPriority.ASSIGN&&this.writeChar(41);break;default:super.visitBinaryExpr(e,t)}}visitLambdaExpr(e){this.writeName(e.first),this.write(" => "),e.body.accept(this,FuPriority.STATEMENT)}defineObjectLiteralTemporary(e){}defineIsVar(e){}writeAssert(e){e.completesNormally()?(this.include("System.Diagnostics"),this.write("Debug.Assert("),e.cond.accept(this,FuPriority.ARGUMENT),null!=e.message&&(this.write(", "),e.message.accept(this,FuPriority.ARGUMENT))):(this.include("System"),this.write("throw new NotImplementedException("),null!=e.message&&e.message.accept(this,FuPriority.ARGUMENT)),this.writeLine(");")}visitForeach(e){let t;this.write("foreach ("),(t=e.collection.type)instanceof FuClassType&&2==t.class.typeParameterCount?t.class.id==FuId.ORDERED_DICTIONARY_CLASS?(this.include("System.Collections"),this.write("DictionaryEntry "),this.writeName(e.getVar())):(this.writeChar(40),this.writeTypeAndName(e.getVar()),this.write(", "),this.writeTypeAndName(e.getValueVar()),this.writeChar(41)):this.writeTypeAndName(e.getVar()),this.write(" in "),e.collection.accept(this,FuPriority.ARGUMENT),this.writeChar(41),this.writeChild(e.body)}visitLock(e){this.writeCall("lock ",e.lock),this.writeChild(e.body)}writeException(){this.include("System"),this.write("Exception")}writeEnum(e){this.writeNewLine(),this.writeDoc(e.documentation),e instanceof FuEnumFlags&&(this.include("System"),this.writeLine("[Flags]")),this.writePublic(e),this.write("enum "),this.writeLine(e.name),this.openBlock(),e.acceptValues(this),this.writeNewLine(),this.closeBlock()}writeRegexOptionsEnum(e){e.regexOptionsEnum&&this.include("System.Text.RegularExpressions")}writeConst(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),this.write(e.type instanceof FuArrayStorageType?"static readonly ":"const "),this.writeTypeAndName(e),this.write(" = "),this.writeCoercedExpr(e.type,e.value),this.writeCharLine(59)}writeField(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),e.type.isFinal()&&!e.isAssignableStorage()&&this.write("readonly "),this.writeVar(e),this.writeCharLine(59)}writeParameterDoc(e,t){this.write('/// <param name="'),this.writeName(e),this.write('">'),this.writeDocPara(e.documentation.summary,!1),this.writeLine("</param>")}writeThrowsDoc(e){this.write('/// <exception cref="'),this.writeExceptionClass(e.symbol),this.write('">'),this.writeDocPara(e.documentation.summary,!1),this.writeLine("</exception>")}isShortMethod(e){return e.body instanceof FuReturn}writeMethod(e){e.id==FuId.CLASS_TO_STRING&&e.callType==FuCallType.ABSTRACT||(this.writeNewLine(),this.writeDoc(e.documentation),this.writeParametersAndThrowsDoc(e),this.#ln(e.visibility),e.id==FuId.CLASS_TO_STRING?this.write("override "):this.#wn(e.callType,"sealed override "),this.writeTypeAndName(e),this.writeParameters(e,!0),this.writeBody(e))}writeClass(e,t){this.writeNewLine(),this.writeDoc(e.documentation),this.writePublic(e),this.#wn(e.callType,"sealed "),this.openClass(e,""," : "),this.needsConstructor(e)?(null!=e.constructor_?(this.writeDoc(e.constructor_.documentation),this.#ln(e.constructor_.visibility)):this.write("internal "),this.write(e.name),this.writeLine("()"),this.openBlock(),this.writeConstructorBody(e),this.closeBlock()):e.id==FuId.EXCEPTION_CLASS&&(this.writeExceptionConstructor(e,"() { }"),this.writeExceptionConstructor(e,"(String message) : base(message) { }"),this.writeExceptionConstructor(e,"(String message, Exception innerException) : base(message, innerException) { }")),this.writeMembers(e,!0),this.closeBlock()}#cn(e){this.writeNewLine(),this.writeLine("internal static class FuResource"),this.openBlock();for(const[t,i]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0]))))this.write("internal static readonly byte[] "),this.writeResourceName(t),this.writeLine(" = {"),this.writeChar(9),this.writeBytes(i),this.writeLine(" };");this.closeBlock()}writeProgram(e,t,i){this.openStringWriter(),0!=i.length&&(this.write("namespace "),this.writeLine(i),this.openBlock()),this.writeTopLevelNatives(e),this.writeTypes(e),Object.keys(e.resources).length>0&&this.#cn(e.resources),0!=i.length&&this.closeBlock(),this.createFile(null,t),this.writeIncludes("using ",";"),this.closeStringWriter(),this.closeFile()}}export class GenD extends GenCCppD{#Fn;#En;#yn;#In;#Sn;#Cn;getTargetName(){return"D"}startDocLine(){this.write("/// ")}writeDocPara(e,t){t&&(this.writeNewLine(),this.startDocLine());for(const t of e.children)if(t instanceof FuDocText){const e=t;this.writeXmlDoc(e.text)}else if(t instanceof FuDocCode){const e=t;this.writeChar(96),this.writeXmlDoc(e.text),this.writeChar(96)}else{if(!(t instanceof FuDocLine))throw new Error;this.writeNewLine(),this.startDocLine()}t&&this.writeNewLine()}writeParameterDoc(e,t){t&&(this.startDocLine(),this.writeLine("Params:")),this.startDocLine(),this.writeName(e),this.write(" = "),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeThrowsDoc(e){this.write("/// Throws: "),this.writeExceptionClass(e.symbol),this.writeChar(32),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeDocList(e){this.writeLine("///"),this.writeLine("/// <ul>");for(const t of e.items)this.write("/// <li>"),this.writeDocPara(t,!1),this.writeLine("</li>");this.writeLine("/// </ul>"),this.write("///")}writeDoc(e){if(null!=e&&(this.startDocLine(),this.writeDocPara(e.summary,!1),this.writeNewLine(),e.details.length>0)){if(this.startDocLine(),1==e.details.length)this.writeDocBlock(e.details[0],!1);else for(const t of e.details)this.writeDocBlock(t,!0);this.writeNewLine()}}writeName(e){if(e instanceof FuContainerType)this.write(e.name);else switch(this.writeCamelCase(e.name),e.name){case"Abstract":case"Alias":case"Align":case"Asm":case"Assert":case"Auto":case"Body":case"Bool":case"Break":case"Byte":case"Case":case"Cast":case"Catch":case"Cdouble":case"Cent":case"Cfloat":case"Char":case"Class":case"Const":case"Continue":case"Creal":case"Dchar":case"Debug":case"Default":case"Delegate":case"Delete":case"Deprecated":case"Do":case"Double":case"Else":case"Enum":case"Export":case"Extern":case"False":case"Final":case"Finally":case"Float":case"For":case"Foreach":case"Foreach_reverse":case"Function":case"Goto":case"Idouble":case"If":case"IfLoat":case"Immutable":case"Import":case"In":case"Inout":case"Int":case"Interface":case"Invariant":case"Ireal":case"Is":case"Lazy":case"Long":case"Macro":case"Mixin":case"Module":case"New":case"Nothrow":case"Null":case"Out":case"Override":case"Package":case"Pragma":case"Private":case"Protected":case"Public":case"Pure":case"Real":case"Ref":case"Return":case"Scope":case"Shared":case"Short":case"Sizeof":case"Static":case"String":case"Struct":case"Super":case"Switch":case"Synchronized":case"Template":case"Throw":case"True":case"Try":case"Typeid":case"Typeof":case"Ubyte":case"Ucent":case"Uint":case"Ulong":case"Union":case"Unittest":case"Ushort":case"Version":case"Void":case"Wchar":case"While":case"With":case"alias":case"align":case"asm":case"auto":case"body":case"cast":case"catch":case"cdouble":case"cent":case"cfloat":case"char":case"creal":case"dchar":case"debug":case"delegate":case"delete":case"deprecated":case"export":case"extern":case"final":case"finally":case"foreach_reverse":case"function":case"goto":case"idouble":case"ifloat":case"immutable":case"import":case"in":case"inout":case"interface":case"invariant":case"ireal":case"lazy":case"macro":case"mixin":case"module":case"nothrow":case"out":case"package":case"pragma":case"private":case"pure":case"real":case"ref":case"scope":case"shared":case"sizeof":case"struct":case"super":case"synchronized":case"template":case"try":case"typeid":case"typeof":case"ubyte":case"ucent":case"uint":case"ulong":case"union":case"unittest":case"ushort":case"version":case"wchar":case"with":case"__FILE__":case"__FILE_FULL_PATH__":case"__MODULE__":case"__LINE__":case"__FUNCTION__":case"__PRETTY_FUNCTION__":case"__gshared":case"__traits":case"__vector":case"__parameters":this.writeChar(95)}}getLiteralChars(){return 65536}#ln(e){switch(e){case FuVisibility.PRIVATE:this.write("private ");break;case FuVisibility.INTERNAL:case FuVisibility.PUBLIC:break;case FuVisibility.PROTECTED:this.write("protected ");break;default:throw new Error}}#wn(e,t){switch(e){case FuCallType.STATIC:this.write("static ");break;case FuCallType.NORMAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.VIRTUAL:break;case FuCallType.OVERRIDE:this.write("override ");break;case FuCallType.SEALED:this.write(t)}}static#An(e){let t;if((t=e)instanceof FuClassType){let e;return!((e=t)instanceof FuStorageType)||e.class.id!=FuId.ARRAY_STORAGE_CLASS}return!1}static#_n(e){for(;!(e instanceof FuReadWriteClassType);){let t;if(!((t=e.getElementType())instanceof FuClassType))return!0;if(t.class.id!=FuId.ARRAY_PTR_CLASS)return!1;e=t}return!1}static#fn(e){let t;return(t=e.getElementType())instanceof FuClassType&&t.class.id==FuId.JSON_ELEMENT_CLASS}static#Rn(e){let t;return(t=e)instanceof FuClassType&&(t.class.id==FuId.LIST_CLASS||t.class.id==FuId.STACK_CLASS||t.class.id==FuId.QUEUE_CLASS)&&!GenD.#fn(t)}#Tn(e){this.writeType(e,!1),GenD.#Rn(e)&&this.writeChar(42)}writeType(e,t){if(e instanceof FuIntegerType)switch(this.getTypeId(e,t)){case FuId.S_BYTE_RANGE:this.write("byte");break;case FuId.BYTE_RANGE:this.write("ubyte");break;case FuId.SHORT_RANGE:this.write("short");break;case FuId.U_SHORT_RANGE:this.write("ushort");break;case FuId.INT_TYPE:this.write("int");break;case FuId.N_INT_TYPE:this.write("ptrdiff_t");break;case FuId.LONG_TYPE:this.write("long");break;default:throw new Error}else if(e instanceof FuClassType){const i=e;switch(i.class.id){case FuId.STRING_CLASS:this.write("string");break;case FuId.ARRAY_STORAGE_CLASS:case FuId.ARRAY_PTR_CLASS:let e;t&&GenD.#_n(i)?(this.write("const("),this.#Tn(i.getElementType()),this.writeChar(41)):this.#Tn(i.getElementType()),this.writeChar(91),(e=i)instanceof FuArrayStorageType&&this.visitLiteralLong(BigInt(e.length)),this.writeChar(93);break;case FuId.LIST_CLASS:case FuId.STACK_CLASS:GenD.#fn(i)?(this.include("std.json"),this.write("JSONValue[]")):(this.include("std.container.array"),this.write("Array!("),this.#Tn(i.getElementType()),this.writeChar(41));break;case FuId.QUEUE_CLASS:this.include("std.container.dlist"),this.write("DList!("),this.#Tn(i.getElementType()),this.writeChar(41);break;case FuId.HASH_SET_CLASS:this.write("bool["),this.#Tn(i.getElementType()),this.writeChar(93);break;case FuId.DICTIONARY_CLASS:this.#Tn(i.getValueType()),this.writeChar(91),this.writeType(i.getKeyType(),!1),this.writeChar(93);break;case FuId.SORTED_SET_CLASS:this.include("std.container.rbtree"),this.write("RedBlackTree!("),this.#Tn(i.getElementType()),this.writeChar(41);break;case FuId.SORTED_DICTIONARY_CLASS:this.include("std.container.rbtree"),this.include("std.typecons"),this.write("RedBlackTree!(Tuple!("),this.#Tn(i.getKeyType()),this.write(", "),this.#Tn(i.getValueType()),this.write('), "a[0] < b[0]")');break;case FuId.ORDERED_DICTIONARY_CLASS:this.include("std.typecons"),this.write("Tuple!(Array!("),this.#Tn(i.getValueType()),this.write('), "data", size_t['),this.writeType(i.getKeyType(),!1),this.write('], "dict")');break;case FuId.TEXT_WRITER_CLASS:this.include("std.stdio"),this.write("File");break;case FuId.REGEX_CLASS:this.include("std.regex"),this.write("Regex!char");break;case FuId.MATCH_CLASS:this.include("std.regex"),this.write("Captures!string");break;case FuId.JSON_ELEMENT_CLASS:this.include("std.json"),this.write("JSONValue");break;case FuId.LOCK_CLASS:this.write("Object");break;default:this.write(i.class.name)}}else this.write(e.name)}writeTypeAndName(e){this.writeType(e.type,!0),GenD.#Rn(e.type)&&this.writeChar(42),this.writeChar(32),this.writeName(e)}visitAggregateInitializer(e){this.write("[ "),this.writeCoercedLiterals(e.type.asClassType().getElementType(),e.items),this.write(" ]")}writeStaticCast(e,t){this.write("cast("),this.writeType(e,!1),this.write(")("),this.getStaticCastInner(e,t).accept(this,FuPriority.ARGUMENT),this.writeChar(41)}visitInterpolatedString(e,t){this.include("std.format"),this.write("format("),this.writePrintf(e,!1)}writeStorageInit(e){this.write(" = "),this.writeNewStorage(e.type)}writeVarInit(e){e.type instanceof FuArrayStorageType||super.writeVarInit(e)}hasInitCode(e){if(null!=e.value&&!(e.value instanceof FuLiteral))return!0;let t,i=e.type;if((t=i)instanceof FuArrayStorageType){let e;for(;(e=t.getElementType())instanceof FuArrayStorageType;)t=e;i=t.getElementType()}return i instanceof FuStorageType}writeInitField(e){this.writeInitCode(e)}writeInitCode(e){if(!this.hasInitCode(e))return;let t;if((t=e.type)instanceof FuArrayStorageType){let i,r,s=0;for(;(i=t.getElementType())instanceof FuArrayStorageType;)this.openLoop("size_t",s++,t.length),t=i;for((r=t.getElementType())instanceof FuStorageType&&(this.openLoop("size_t",s++,t.length),this.writeArrayElement(e,s),this.write(" = "),this.writeNew(r,FuPriority.ARGUMENT),this.writeCharLine(59));--s>=0;)this.closeBlock()}else{let t;if((t=e.type)instanceof FuReadWriteClassType)switch(t.class.id){case FuId.STRING_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.ARRAY_PTR_CLASS:case FuId.DICTIONARY_CLASS:case FuId.HASH_SET_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:case FuId.REGEX_CLASS:case FuId.MATCH_CLASS:case FuId.LOCK_CLASS:break;default:e.parent instanceof FuClass&&(this.writeName(e),this.write(" = "),null==e.value?this.writeNew(t,FuPriority.ARGUMENT):this.writeCoercedExpr(e.type,e.value),this.writeCharLine(59)),super.writeInitCode(e)}}}writeNewArray(e,t,i){this.write("new "),this.writeType(e,!1),this.writeChar(91),t.accept(this,FuPriority.ARGUMENT),this.writeChar(93)}#Ln(e){this.writeChar(40),this.writeType(e,!1),this.write(").init")}writeNew(e,t){GenD.#An(e)?(this.write("new "),this.writeType(e,!1)):this.#Ln(e)}writeResource(e,t){this.write("FuResource."),this.writeResourceName(e)}writeStringLength(e){this.writePostfix(e,".length")}#Nn(e,t=FuPriority.PRIMARY){GenD.#Rn(e.type)?(this.write("(*"),e.accept(this,t),this.writeChar(41)):e.accept(this,t)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.write("stderr");break;case FuId.LIST_COUNT:case FuId.STACK_COUNT:case FuId.HASH_SET_COUNT:case FuId.DICTIONARY_COUNT:case FuId.SORTED_SET_COUNT:case FuId.SORTED_DICTIONARY_COUNT:this.writeStringLength(e.left);break;case FuId.QUEUE_COUNT:this.include("std.range"),this.#Nn(e.left),this.write("[].walkLength");break;case FuId.MATCH_START:this.writePostfix(e.left,".pre.length");break;case FuId.MATCH_END:t>FuPriority.ADD&&this.writeChar(40),this.writePostfix(e.left,".pre.length + "),this.writePostfix(e.left,".hit.length"),t>FuPriority.ADD&&this.writeChar(41);break;case FuId.MATCH_LENGTH:this.writePostfix(e.left,".hit.length");break;case FuId.MATCH_VALUE:this.writePostfix(e.left,".hit");break;case FuId.MATH_NA_N:this.write("double.nan");break;case FuId.MATH_NEGATIVE_INFINITY:this.write("-double.infinity");break;case FuId.MATH_POSITIVE_INFINITY:this.write("double.infinity");break;default:super.visitSymbolReference(e,t)}}#qa(e,t){if(this.include("std.stdio"),0==e.length)this.write("writeln()");else{let i;(i=e[0])instanceof FuInterpolatedString?(this.write(t?"writefln(":"writef("),this.writePrintf(i,!1)):this.writeCall(t?"writeln":"write",e[0])}}#gn(e,t,i){this.#Nn(e,FuPriority.PRIMARY),this.writeChar(91),t.isLiteralZero()&&null==i||(t.accept(this,FuPriority.ARGUMENT),this.write(" .. "),null==i?this.writeChar(36):t instanceof FuLiteralLong?this.writeAdd(t,i):(this.write("$][0 .. "),i.accept(this,FuPriority.ARGUMENT))),this.writeChar(93)}#mn(e,t,i=0){if(t.length<=i){let t=e;this.writeNew(t,FuPriority.ARGUMENT)}else this.writeCoercedExpr(e,t[i]);this.writeChar(41)}#dn(e,t,i){i>FuPriority.EQUALITY&&this.writeChar(40),this.writePostfix(e,".type == JSONType."),this.write(t),i>FuPriority.EQUALITY&&this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.ENUM_FROM_INT:this.writeStaticCast(e,r[0]);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:t.accept(this,s);break;case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:case FuId.LONG_TRY_PARSE:case FuId.DOUBLE_TRY_PARSE:this.include("std.conv"),this.write("() { try { "),this.writePostfix(t," = "),this.writePostfix(r[0],".to!"),this.writeType(t.type,!1),2==r.length&&(this.writeChar(40),r[1].accept(this,FuPriority.ARGUMENT),this.writeChar(41)),this.write("; return true; } catch (ConvException e) return false; }()");break;case FuId.STRING_CONTAINS:this.include("std.algorithm"),this.writeMethodCall(t,"canFind",r[0]);break;case FuId.STRING_ENDS_WITH:this.include("std.string"),this.writeMethodCall(t,"endsWith",r[0]);break;case FuId.STRING_INDEX_OF:this.include("std.string"),this.writeMethodCall(t,"indexOf",r[0]);break;case FuId.STRING_LAST_INDEX_OF:this.include("std.string"),this.writeMethodCall(t,"lastIndexOf",r[0]);break;case FuId.STRING_REPLACE:this.include("std.string"),this.writeMethodCall(t,"replace",r[0],r[1]);break;case FuId.STRING_STARTS_WITH:this.include("std.string"),this.writeMethodCall(t,"startsWith",r[0]);break;case FuId.STRING_SUBSTRING:this.#gn(t,r[0],2==r.length?r[1]:null);break;case FuId.STRING_TO_LOWER:this.include("std.uni"),this.writePostfix(t,".toLower()");break;case FuId.STRING_TO_UPPER:this.include("std.uni"),this.writePostfix(t,".toUpper()");break;case FuId.ARRAY_BINARY_SEARCH_ALL:case FuId.ARRAY_BINARY_SEARCH_PART:this.include("std.range"),this.write("() { size_t fubegin = "),3==r.length?r[1].accept(this,FuPriority.ARGUMENT):this.writeChar(48),this.write("; auto fusearch = "),this.#Nn(t),this.writeChar(91),3==r.length&&(this.write("fubegin .. fubegin + "),r[2].accept(this,FuPriority.ADD)),this.write("].assumeSorted.trisect("),this.writeNotPromoted(t.type.asClassType().getElementType(),r[0]),this.write("); return fusearch[1].length ? fubegin + fusearch[0].length : -1; }()");break;case FuId.ARRAY_CONTAINS:case FuId.LIST_CONTAINS:this.include("std.algorithm"),this.#Nn(t),this.writeCall("[].canFind",r[0]);break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:this.include("std.algorithm"),this.#gn(t,r[0],r[3]),this.write(".copy("),this.#gn(r[1],r[2],null),this.writeChar(41);break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:this.include("std.algorithm"),3==r.length?this.#gn(t,r[1],r[2]):(this.#Nn(t),this.write("[]")),this.write(".fill("),this.writeNotPromoted(t.type.asClassType().getElementType(),r[0]),this.writeChar(41);break;case FuId.ARRAY_SORT_ALL:case FuId.ARRAY_SORT_PART:case FuId.LIST_SORT_ALL:case FuId.LIST_SORT_PART:this.include("std.algorithm"),2==r.length?this.#gn(t,r[0],r[1]):(this.#Nn(t),this.write("[]")),this.write(".sort");break;case FuId.LIST_ADD:case FuId.QUEUE_ENQUEUE:this.writePostfix(t,".insertBack("),this.#mn(t.type.asClassType().getElementType(),r);break;case FuId.LIST_ADD_RANGE:this.#Nn(t),this.write(" ~= "),this.#Nn(r[0]),this.write("[]");break;case FuId.LIST_ALL:this.include("std.algorithm"),this.#Nn(t),this.writeCall("[].all!",r[0]);break;case FuId.LIST_ANY:this.include("std.algorithm"),this.#Nn(t),this.write("[].any!("),r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.LIST_INSERT:this.#Fn=!0,this.writePostfix(t,".insertInPlace("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#mn(t.type.asClassType().getElementType(),r,1);break;case FuId.LIST_LAST:this.writePostfix(t,".back");break;case FuId.LIST_REMOVE_AT:case FuId.LIST_REMOVE_RANGE:this.#En=!0,this.writePostfix(t,".removeAt"),this.writeInParentheses(r);break;case FuId.LIST_INDEX_OF:this.include("std.algorithm"),this.#Nn(t),this.writeCall("[].countUntil",r[0]);break;case FuId.QUEUE_DEQUEUE:this.#yn=!0,this.include("std.container.dlist"),this.#Nn(t),this.write(".dequeue()");break;case FuId.QUEUE_PEEK:this.writePostfix(t,".front");break;case FuId.STACK_PEEK:this.writePostfix(t,".back");break;case FuId.STACK_PUSH:this.#Nn(t),this.write(" ~= "),this.writeCoercedExpr(t.type.asClassType().getElementType(),r[0]);break;case FuId.STACK_POP:this.#In=!0,this.#Nn(t),this.write(".pop()");break;case FuId.HASH_SET_ADD:this.writePostfix(t,".require("),this.writeCoercedExpr(t.type.asClassType().getElementType(),r[0]),this.write(", true)");break;case FuId.HASH_SET_CLEAR:case FuId.SORTED_SET_CLEAR:case FuId.DICTIONARY_CLEAR:case FuId.SORTED_DICTIONARY_CLEAR:this.writePostfix(t,".clear()");break;case FuId.HASH_SET_CONTAINS:case FuId.SORTED_SET_CONTAINS:case FuId.DICTIONARY_CONTAINS_KEY:this.writeChar(40),r[0].accept(this,FuPriority.REL),this.write(" in "),t.accept(this,FuPriority.PRIMARY),this.writeChar(41);break;case FuId.SORTED_SET_ADD:this.writePostfix(t,".insert("),this.#mn(t.type.asClassType().getElementType(),r,0);break;case FuId.SORTED_SET_REMOVE:this.writeMethodCall(t,"removeKey",r[0]);break;case FuId.DICTIONARY_ADD:t.type.asClassType().class.id==FuId.SORTED_DICTIONARY_CLASS?(this.#Sn=!0,this.writePostfix(t,".replace(")):this.writePostfix(t,".require("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#mn(t.type.asClassType().getValueType(),r,1);break;case FuId.SORTED_DICTIONARY_CONTAINS_KEY:this.write("tuple("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Ln(t.type.asClassType().getValueType()),this.write(") in "),this.#Nn(t);break;case FuId.SORTED_DICTIONARY_REMOVE:this.#Nn(t),this.write(".removeKey(tuple("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.#Ln(t.type.asClassType().getValueType()),this.write("))");break;case FuId.TEXT_WRITER_WRITE:case FuId.TEXT_WRITER_WRITE_LINE:this.writePostfix(t,"."),this.#qa(r,i.id==FuId.TEXT_WRITER_WRITE_LINE);break;case FuId.TEXT_WRITER_WRITE_CHAR:this.writePostfix(t,".write("),r[0]instanceof FuLiteralChar||this.write("cast(char) "),r[0].accept(this,FuPriority.PRIMARY),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:this.writePostfix(t,".write(cast(dchar) "),r[0].accept(this,FuPriority.PRIMARY),this.writeChar(41);break;case FuId.CONSOLE_WRITE:case FuId.CONSOLE_WRITE_LINE:this.#qa(r,i.id==FuId.CONSOLE_WRITE_LINE);break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.include("std.process"),this.writeCall("environment.get",r[0]);break;case FuId.CONVERT_TO_BASE64_STRING:this.include("std.base64"),this.write("Base64.encode("),this.isWholeArray(r[0],r[1],r[2])?r[0].accept(this,FuPriority.ARGUMENT):this.#gn(r[0],r[1],r[2]),this.writeChar(41);break;case FuId.U_T_F8_GET_BYTE_COUNT:this.writePostfix(r[0],".length");break;case FuId.U_T_F8_GET_BYTES:this.include("std.string"),this.include("std.algorithm"),this.writePostfix(r[0],".representation.copy("),this.#gn(r[1],r[2],null),this.writeChar(41);break;case FuId.U_T_F8_GET_STRING:this.write("cast(string) "),this.#gn(r[0],r[1],r[2]);break;case FuId.REGEX_COMPILE:this.include("std.regex"),this.write("regex("),r[0].accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(r,', "',"",'"',"i","m","s"),this.writeChar(41);break;case FuId.REGEX_ESCAPE:this.include("std.regex"),this.include("std.conv"),this.writePostfix(r[0],".escaper.to!string");break;case FuId.REGEX_IS_MATCH_REGEX:this.include("std.regex"),this.writePostfix(r[0],".matchFirst("),(r.length>1?r[1]:t).accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.REGEX_IS_MATCH_STR:this.include("std.regex"),this.writePostfix(r[0],".matchFirst("),this.getRegexOptions(r)!=RegexOptions.NONE&&this.write("regex("),(r.length>1?r[1]:t).accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(r,', "',"",'")',"i","m","s"),this.writeChar(41);break;case FuId.MATCH_FIND_STR:this.include("std.regex"),this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = "),r[0].accept(this,FuPriority.PRIMARY),this.write(".matchFirst("),this.getRegexOptions(r)!=RegexOptions.NONE&&this.write("regex("),r[1].accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(r,', "',"",'")',"i","m","s"),this.write("))");break;case FuId.MATCH_FIND_REGEX:this.include("std.regex"),this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = "),this.writeMethodCall(r[0],"matchFirst",r[1]),this.writeChar(41);break;case FuId.MATCH_GET_CAPTURE:this.writeIndexing(t,r[0]);break;case FuId.JSON_ELEMENT_PARSE:this.writeCall("parseJSON",r[0]);break;case FuId.JSON_ELEMENT_IS_OBJECT:this.#dn(t,"object",s);break;case FuId.JSON_ELEMENT_IS_ARRAY:this.#dn(t,"array",s);break;case FuId.JSON_ELEMENT_IS_STRING:this.#dn(t,"string",s);break;case FuId.JSON_ELEMENT_IS_NUMBER:this.#dn(t,"float_",s);break;case FuId.JSON_ELEMENT_IS_BOOLEAN:s>FuPriority.COND_OR&&this.writeChar(40),this.writePostfix(t,".type == JSONType.true_ || "),this.writePostfix(t,".type == JSONType.false_"),s>FuPriority.COND_OR&&this.writeChar(41);break;case FuId.JSON_ELEMENT_IS_NULL:this.#dn(t,"null_",s);break;case FuId.JSON_ELEMENT_GET_OBJECT:this.writePostfix(t,".object");break;case FuId.JSON_ELEMENT_GET_ARRAY:this.writePostfix(t,".array");break;case FuId.JSON_ELEMENT_GET_STRING:this.writePostfix(t,".str");break;case FuId.JSON_ELEMENT_GET_DOUBLE:this.writePostfix(t,".get!double");break;case FuId.JSON_ELEMENT_GET_BOOLEAN:this.writePostfix(t,".boolean");break;case FuId.MATH_METHOD:case FuId.MATH_ABS:case FuId.MATH_IS_FINITE:case FuId.MATH_IS_INFINITY:case FuId.MATH_IS_NA_N:case FuId.MATH_LOG2:case FuId.MATH_ROUND:this.include("std.math"),this.writeCamelCase(i.name),this.writeInParentheses(r);break;case FuId.MATH_CEILING:this.include("std.math"),this.writeCall("ceil",r[0]);break;case FuId.MATH_CLAMP:case FuId.MATH_MAX:case FuId.MATH_MIN:this.include("std.algorithm"),this.writeLowercase(i.name),this.writeInParentheses(r);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.include("std.math"),this.writeCall("fma",r[0],r[1],r[2]);break;case FuId.MATH_TRUNCATE:this.include("std.math"),this.writeCall("trunc",r[0]);break;default:null!=t&&(GenD.isReferenceTo(t,FuId.BASE_PTR)?this.write("super."):(this.#Nn(t),this.writeChar(46))),this.writeName(i),this.writeCoercedArgsInParentheses(i,r)}}writeIndexingExpr(e,t){this.#Nn(e.left);let i=e.left.type;switch(i.class.id){case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.DICTIONARY_CLASS:case FuId.LIST_CLASS:this.writeChar(91),e.right.accept(this,FuPriority.ARGUMENT),this.writeChar(93);break;case FuId.SORTED_DICTIONARY_CLASS:console.assert(t!=FuPriority.ASSIGN),this.#Cn=!0,this.include("std.container.rbtree"),this.include("std.typecons"),this.write(".find("),this.writeStronglyCoerced(i.getKeyType(),e.right),this.writeChar(41);break;case FuId.ORDERED_DICTIONARY_CLASS:this.notSupported(e,"OrderedDictionary");break;default:throw new Error}}static#Pn(e){let t;return e instanceof FuLiteralNull||(t=e.type)instanceof FuClassType&&t.class.id==FuId.ARRAY_PTR_CLASS}writeEqual(e,t,i,r){GenD.#Pn(e)||GenD.#Pn(t)?this.writeEqualExpr(e,t,i,r?" !is ":" is "):super.writeEqual(e,t,i,r)}writeAssign(e,t){let i,r;if((i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&r.class.id===FuId.SORTED_DICTIONARY_CLASS)return this.#Sn=!0,this.writePostfix(i.left,".replace("),i.right.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeNotPromoted(e.type,e.right),void this.writeChar(41);super.writeAssign(e,t)}#Za(e,t,i){let r,s;if(i>FuPriority.EQUALITY&&this.writeChar(40),(r=t)instanceof FuSymbolReference&&(s=r.symbol)instanceof FuClass)this.write("cast("),this.write(s.name),this.write(") "),e.accept(this,FuPriority.PRIMARY);else{if(!(t instanceof FuVar))throw new Error;{const i=t;this.writeChar(40),this.writeName(i),this.write(" = cast("),this.write(i.type.name),this.write(") "),e.accept(this,FuPriority.PRIMARY),this.writeChar(41)}}this.write(" !is null"),i>FuPriority.EQUALITY&&this.writeChar(41)}visitBinaryExpr(e,t){switch(e.op){case FuToken.IS:return void this.#Za(e.left,e.right,t>=FuPriority.OR&&t<=FuPriority.MUL?FuPriority.PRIMARY:t);case FuToken.PLUS:if(e.type.id==FuId.STRING_STORAGE_TYPE)return e.left.accept(this,FuPriority.ASSIGN),this.write(" ~ "),void e.right.accept(this,FuPriority.ASSIGN);break;case FuToken.ADD_ASSIGN:if(e.left.type.id==FuId.STRING_STORAGE_TYPE)return e.left.accept(this,FuPriority.ASSIGN),this.write(" ~= "),void this.writeAssignRight(e)}super.visitBinaryExpr(e,t)}visitLambdaExpr(e){this.writeName(e.first),this.write(" => "),e.body.accept(this,FuPriority.STATEMENT)}writeAssert(e){this.write("assert("),e.cond.accept(this,FuPriority.ARGUMENT),null!=e.message&&(this.write(", "),e.message.accept(this,FuPriority.ARGUMENT)),this.writeLine(");")}visitForeach(e){let t,i;this.write("foreach ("),(t=e.collection.type)instanceof FuClassType&&2==t.class.typeParameterCount?(this.writeTypeAndName(e.getVar()),this.write(", "),this.writeTypeAndName(e.getValueVar())):this.writeTypeAndName(e.getVar()),this.write("; "),this.#Nn(e.collection),(i=e.collection.type)instanceof FuClassType&&i.class.id==FuId.HASH_SET_CLASS&&this.write(".byKey"),this.writeChar(41),this.writeChild(e.body)}visitLock(e){this.writeCall("synchronized ",e.lock),this.writeChild(e.body)}writeSwitchCaseTypeVar(e){this.defineVar(e)}writeSwitchCaseCond(e,t,i){let r;(r=t)instanceof FuSymbolReference&&r.symbol instanceof FuClass||t instanceof FuVar?this.#Za(e.value,t,i):super.writeSwitchCaseCond(e,t,i)}visitSwitch(e){this.writeTemporaries(e.value),e.isTypeMatching()||e.hasWhen()?this.writeSwitchAsIfsWithGoto(e):(this.startSwitch(e),this.writeLine("default:"),this.indent++,e.defaultBody.length>0?this.writeSwitchCaseBody(e.defaultBody):this.writeLine("assert(false);"),this.indent--,this.writeCharLine(125))}writeThrowMessage(e){null==e?this.write('""'):e.accept(this,FuPriority.ARGUMENT)}writeEnum(e){this.writeNewLine(),this.writeDoc(e.documentation),this.writePublic(e),this.write("enum "),this.write(e.name),this.openBlock(),e.acceptValues(this),this.writeNewLine(),this.closeBlock()}writeConst(e){this.writeDoc(e.documentation),this.write("static immutable "),this.writeTypeAndName(e),this.write(" = "),this.writeCoercedExpr(e.type,e.value),this.writeCharLine(59)}writeField(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),this.writeTypeAndName(e),e.value instanceof FuLiteral&&(this.write(" = "),this.writeCoercedExpr(e.type,e.value)),this.writeCharLine(59)}isShortMethod(e){let t;return(t=e.body)instanceof FuReturn&&!GenD.hasTemporaries(t.value)}writeMethod(e){e.id==FuId.CLASS_TO_STRING&&e.callType==FuCallType.ABSTRACT||(this.writeNewLine(),this.writeDoc(e.documentation),this.writeParametersAndThrowsDoc(e),this.#ln(e.visibility),e.id==FuId.CLASS_TO_STRING?this.write("override "):this.#wn(e.callType,"final override "),this.writeTypeAndName(e),this.writeParameters(e,!0),this.writeBody(e))}writeClass(e,t){this.writeNewLine(),this.writeDoc(e.documentation),e.callType==FuCallType.SEALED&&this.write("final "),this.openClass(e,""," : "),this.needsConstructor(e)?(null!=e.constructor_?(this.writeDoc(e.constructor_.documentation),this.#ln(e.constructor_.visibility)):this.write("private "),this.writeLine("this()"),this.openBlock(),this.writeConstructorBody(e),this.closeBlock()):e.id==FuId.EXCEPTION_CLASS&&(this.include("std.exception"),this.writeLine("mixin basicExceptionCtors;")),this.writeMembers(e,!1),this.closeBlock()}static#kn(e){switch(e.symbol.id){case FuId.ARRAY_LENGTH:case FuId.STRING_LENGTH:case FuId.LIST_COUNT:return!0;default:return!1}}writeCoercedInternal(e,t,i){if(e instanceof FuRangeType)this.writeStaticCast(e,t);else{let r;e instanceof FuIntegerType&&(r=t)instanceof FuSymbolReference&&GenD.#kn(r)||e instanceof FuFloatingType&&!(t.type instanceof FuFloatingType)?this.writeStaticCast(e,t):e instanceof FuClassType&&!(e instanceof FuArrayStorageType)&&t.type instanceof FuArrayStorageType?(super.writeCoercedInternal(e,t,FuPriority.PRIMARY),this.write("[]")):super.writeCoercedInternal(e,t,i)}}#cn(e){this.writeNewLine(),this.writeLine("private static struct FuResource"),this.openBlock();for(const[t,i]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0]))))this.write("private static immutable ubyte[] "),this.writeResourceName(t),this.writeLine(" = ["),this.writeChar(9),this.writeBytes(i),this.writeLine(" ];");this.closeBlock()}#bn(e,t){this.writeNewLine(),this.writeType(e.type,!0),1==e.parameters.count()?(this.write(" main(string[] args) => "),this.writeName(e.parent),this.writeLine(".main(args[1 .. $]);")):(this.write(" main() => "),0!=t.length&&(this.write(t),this.writeChar(46)),this.writeName(e.parent),this.writeLine(".main();"))}writeProgram(e,t,i){this.#Fn=!1,this.#En=!1,this.#yn=!1,this.#In=!1,this.#Sn=!1,this.#Cn=!1,this.openStringWriter(),0!=i.length&&(this.write("struct "),this.writeLine(i),this.openBlock(),this.writeLine("static:")),this.writeTopLevelNatives(e),this.writeTypes(e),Object.keys(e.resources).length>0&&this.#cn(e.resources),0!=i.length&&this.closeBlock(),this.createFile(null,t),(this.#Fn||this.#En||this.#In)&&this.include("std.container.array"),this.#Sn&&(this.include("std.container.rbtree"),this.include("std.typecons")),this.writeIncludes("import ",";"),this.#Fn&&(this.writeNewLine(),this.writeLine("private void insertInPlace(T, U...)(Array!T* arr, size_t pos, auto ref U stuff)"),this.openBlock(),this.writeLine("arr.insertAfter((*arr)[0 .. pos], stuff);"),this.closeBlock()),this.#En&&(this.writeNewLine(),this.writeLine("private void removeAt(T)(Array!T* arr, size_t pos, size_t count = 1)"),this.openBlock(),this.writeLine("arr.linearRemove((*arr)[pos .. pos + count]);"),this.closeBlock()),this.#yn&&(this.writeNewLine(),this.writeLine("private T dequeue(T)(ref DList!T q)"),this.openBlock(),this.writeLine("scope(exit) q.removeFront(); return q.front;"),this.closeBlock()),this.#In&&(this.writeNewLine(),this.writeLine("private T pop(T)(ref Array!T stack)"),this.openBlock(),this.writeLine("scope(exit) stack.removeBack(); return stack.back;"),this.closeBlock()),this.#Cn&&(this.writeNewLine(),this.writeLine('private U find(T, U)(RedBlackTree!(Tuple!(T, U), "a[0] < b[0]") dict, T key)'),this.openBlock(),this.writeLine("return dict.equalRange(tuple(key, U.init)).front[1];"),this.closeBlock()),this.#Sn&&(this.writeNewLine(),this.writeLine('private void replace(T, U)(RedBlackTree!(Tuple!(T, U), "a[0] < b[0]") dict, T key, lazy U value)'),this.openBlock(),this.writeLine("dict.removeKey(tuple(key, U.init));"),this.writeLine("dict.insert(tuple(key, value));"),this.closeBlock()),this.closeStringWriter(),null!=e.main&&this.#bn(e.main,i),this.closeFile()}}export class GenJava extends GenTyped{#On;#Mn;#Ra;getTargetName(){return"Java"}visitLiteralLong(e){super.visitLiteralLong(e),(e<-2147483648||e>2147483647)&&this.writeChar(76)}getLiteralChars(){return 65536}#Dn(e,t){switch(e.type.id){case FuId.LONG_TYPE:this.write("Long");break;case FuId.FLOAT_TYPE:this.write("Float");break;case FuId.DOUBLE_TYPE:case FuId.FLOAT_INT_TYPE:this.write("Double");break;case FuId.STRING_PTR_TYPE:case FuId.STRING_STORAGE_TYPE:return void e.accept(this,t);default:if(!(e.type instanceof FuIntegerType)){if(e.type instanceof FuClassType)return void this.writePostfix(e,".toString()");throw new Error}this.write("Integer")}this.writeCall(".toString",e)}writePrintfWidth(e){e.precision>=0&&e.argument.type instanceof FuIntegerType?(this.writeChar(48),this.visitLiteralLong(BigInt(e.precision))):super.writePrintfWidth(e)}visitInterpolatedString(e,t){0==e.suffix.length&&1==e.parts.length&&0==e.parts[0].prefix.length&&null==e.parts[0].widthExpr&&32==e.parts[0].format?this.#Dn(e.parts[0].argument,t):(this.write("String.format("),this.writePrintf(e,!1))}#ba(e){switch(this.writeCamelCase(e),e){case"Abstract":case"Assert":case"Boolean":case"Break":case"Byte":case"Case":case"Catch":case"Char":case"Class":case"Const":case"Continue":case"Default":case"Do":case"Double":case"Else":case"Enum":case"Extends":case"False":case"Final":case"Finally":case"Float":case"For":case"Foreach":case"Goto":case"If":case"Implements":case"Import":case"Instanceof":case"Int":case"Interface":case"Long":case"Native":case"New":case"Null":case"Package":case"Private":case"Protected":case"Public":case"Return":case"Short":case"Static":case"Strictfp":case"String":case"Super":case"Switch":case"Synchronized":case"Transient":case"Throw":case"Throws":case"True":case"Try":case"Void":case"Volatile":case"While":case"Yield":case"boolean":case"catch":case"char":case"extends":case"final":case"finally":case"goto":case"implements":case"import":case"instanceof":case"interface":case"package":case"private":case"strictfp":case"super":case"synchronized":case"transient":case"try":case"volatile":case"yield":this.writeChar(95)}}writeName(e){if(e instanceof FuContainerType)this.write(e.name);else if(e instanceof FuConst){const t=e;this.writeUppercaseConstName(t)}else if(e instanceof FuVar){let t;if((t=e.parent)instanceof FuForeach&&2==t.count()){let i=t.getVar();this.#ba(i.name),this.write(e==i?".getKey()":".getValue()")}else this.#ba(e.name)}else{if(!(e instanceof FuMember))throw new Error;this.#ba(e.name)}}#ln(e){switch(e){case FuVisibility.PRIVATE:this.write("private ");break;case FuVisibility.INTERNAL:break;case FuVisibility.PROTECTED:this.write("protected ");break;case FuVisibility.PUBLIC:this.write("public ");break;default:throw new Error}}getTypeId(e,t){let i=super.getTypeId(e,t);switch(i){case FuId.BYTE_RANGE:return FuId.S_BYTE_RANGE;case FuId.U_SHORT_RANGE:return FuId.INT_TYPE;default:return i}}static#xn(e){for(let t=e.first;null!=t;t=t.next){let e;if((e=t)instanceof FuConst&&!(e.value instanceof FuImplicitEnumValue))return!1}return!0}#Ma(e,t){this.include("java.util."+e),this.write(e),this.writeChar(60),this.#Gn(t,!1,!0),this.writeChar(62)}#Un(e,t){this.write(e),this.writeChar(60),this.#Gn(t.getKeyType(),!1,!0),this.write(", "),this.#Gn(t.getValueType(),!1,!0),this.writeChar(62)}#Gn(e,t,i){if(e instanceof FuNumericType)switch(this.getTypeId(e,t)){case FuId.S_BYTE_RANGE:this.write(i?"Byte":"byte");break;case FuId.SHORT_RANGE:this.write(i?"Short":"short");break;case FuId.INT_TYPE:case FuId.N_INT_TYPE:this.write(i?"Integer":"int");break;case FuId.LONG_TYPE:this.write(i?"Long":"long");break;case FuId.FLOAT_TYPE:this.write(i?"Float":"float");break;case FuId.DOUBLE_TYPE:this.write(i?"Double":"double");break;default:throw new Error}else if(e instanceof FuEnum){const t=e;this.write(t.id==FuId.BOOL_TYPE?i?"Boolean":"boolean":GenJava.#xn(t)?t.name:i?"Integer":"int")}else if(e instanceof FuClassType){const t=e;switch(t.class.id){case FuId.STRING_CLASS:this.write("String");break;case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:this.writeType(t.getElementType(),!1),this.write("[]");break;case FuId.LIST_CLASS:this.#Ma("ArrayList",t.getElementType());break;case FuId.QUEUE_CLASS:this.#Ma("ArrayDeque",t.getElementType());break;case FuId.STACK_CLASS:this.#Ma("Stack",t.getElementType());break;case FuId.PRIORITY_QUEUE_CLASS:this.#Ra=!0,this.include("java.util.PriorityQueue"),this.write("PriorityQueue<FuPriorityQueueEntry<"),this.#Gn(t.typeArg0,!1,!0),this.write(", "),this.#Gn(t.typeArg1,!1,!0),this.write(">>");break;case FuId.HASH_SET_CLASS:this.#Ma("HashSet",t.getElementType());break;case FuId.SORTED_SET_CLASS:this.#Ma("TreeSet",t.getElementType());break;case FuId.DICTIONARY_CLASS:this.include("java.util.HashMap"),this.#Un("HashMap",t);break;case FuId.SORTED_DICTIONARY_CLASS:this.include("java.util.TreeMap"),this.#Un("TreeMap",t);break;case FuId.ORDERED_DICTIONARY_CLASS:this.include("java.util.LinkedHashMap"),this.#Un("LinkedHashMap",t);break;case FuId.TEXT_WRITER_CLASS:this.write("Appendable");break;case FuId.STRING_WRITER_CLASS:this.include("java.io.StringWriter"),this.write("StringWriter");break;case FuId.REGEX_CLASS:this.include("java.util.regex.Pattern"),this.write("Pattern");break;case FuId.MATCH_CLASS:this.include("java.util.regex.Matcher"),this.write("Matcher");break;case FuId.LOCK_CLASS:this.write("Object");break;default:this.write(t.class.name)}}else this.write(e.name)}writeType(e,t){this.#Gn(e,t,!1)}writeNew(e,t){this.write("new "),this.writeType(e,!1),this.write("()")}writeResource(e,t){this.write("FuResource.getByteArray("),this.visitLiteralString(e),this.write(", "),this.visitLiteralLong(BigInt(t)),this.writeChar(41)}static#vn(e){let t;return e.id==FuId.BYTE_RANGE&&(t=e)instanceof FuRangeType&&t.max>127}static#Bn(e){return e.isIndexing()&&GenJava.#vn(e.type)}#Yn(e){e.left.type.isArray()?super.writeIndexingExpr(e,FuPriority.AND):this.writeMethodCall(e.left,"get",e.right)}visitPrefixExpr(e,t){if(e.op!=FuToken.INCREMENT&&e.op!=FuToken.DECREMENT||!GenJava.#Bn(e.inner))super.visitPrefixExpr(e,t);else{t>FuPriority.AND&&this.writeChar(40),this.write(e.op==FuToken.INCREMENT?"++":"--");let i=e.inner;this.#Yn(i),t!=FuPriority.STATEMENT&&this.write(" & 0xff"),t>FuPriority.AND&&this.writeChar(41)}}visitPostfixExpr(e,t){if(e.op!=FuToken.INCREMENT&&e.op!=FuToken.DECREMENT||!GenJava.#Bn(e.inner))super.visitPostfixExpr(e,t);else{t>FuPriority.AND&&this.writeChar(40);let i=e.inner;this.#Yn(i),this.write(e.op==FuToken.INCREMENT?"++":"--"),t!=FuPriority.STATEMENT&&this.write(" & 0xff"),t>FuPriority.AND&&this.writeChar(41)}}#Vn(e){e.value>=128&&this.write("(byte) "),e.accept(this,FuPriority.PRIMARY)}writeEqual(e,t,i,r){if(e.type instanceof FuStringType&&t.type.id!=FuId.NULL_TYPE||t.type instanceof FuStringType&&e.type.id!=FuId.NULL_TYPE)r&&this.writeChar(33),this.writeMethodCall(e,"equals",t);else{let s;if(GenJava.#Bn(e)&&(s=t)instanceof FuLiteralLong&&s.type.id==FuId.BYTE_RANGE){i>FuPriority.EQUALITY&&this.writeChar(40);let t=e;this.#Yn(t),this.write(GenJava.getEqOp(r)),this.#Vn(s),i>FuPriority.EQUALITY&&this.writeChar(41)}else super.writeEqual(e,t,i,r)}}writeCoercedLiteral(e,t){if(GenJava.#vn(e)){let e=t;this.#Vn(e)}else super.writeCoercedLiteral(e,t)}writeCoercedInternal(e,t,i){let r;e.id==FuId.FLOAT_TYPE&&(r=t)instanceof FuCallExpr&&r.method.symbol.type.id==FuId.FLOATING_TYPE?this.writeStaticCast(e,t):super.writeCoercedInternal(e,t,i)}writeRel(e,t,i){let r;(r=e.left.type)instanceof FuEnum&&GenJava.#xn(r)?(t>FuPriority.COND_AND&&this.writeChar(40),this.writeMethodCall(e.left,"compareTo",e.right),this.write(i),this.writeChar(48),t>FuPriority.COND_AND&&this.writeChar(41)):super.writeRel(e,t,i)}writeAnd(e,t){let i;if(GenJava.#Bn(e.left)&&(i=e.right)instanceof FuLiteralLong){t>FuPriority.COND_AND&&t!=FuPriority.AND&&this.writeChar(40);let r=e.left;this.#Yn(r),this.write(" & "),this.visitLiteralLong(255n&i.value),t>FuPriority.COND_AND&&t!=FuPriority.AND&&this.writeChar(41)}else super.writeAnd(e,t)}writeStringLength(e){this.writePostfix(e,".length()")}writeCharAt(e){this.writeMethodCall(e.left,"charAt",e.right)}static#Hn(e){let t;if((t=e.symbol.parent)instanceof FuForeach){let i=t.collection.type;if(i.class.id==FuId.STRING_CLASS)return!1;let r=e.symbol==t.first?i.getElementType():i.getValueType();return GenJava.#vn(r)}return!1}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.write("System.err");break;case FuId.LIST_COUNT:case FuId.QUEUE_COUNT:case FuId.STACK_COUNT:case FuId.PRIORITY_QUEUE_COUNT:case FuId.HASH_SET_COUNT:case FuId.SORTED_SET_COUNT:case FuId.DICTIONARY_COUNT:case FuId.SORTED_DICTIONARY_COUNT:case FuId.ORDERED_DICTIONARY_COUNT:e.left.accept(this,FuPriority.PRIMARY),this.writeMemberOp(e.left,e),this.write("size()");break;case FuId.MATH_NA_N:this.write("Float.NaN");break;case FuId.MATH_NEGATIVE_INFINITY:this.write("Float.NEGATIVE_INFINITY");break;case FuId.MATH_POSITIVE_INFINITY:this.write("Float.POSITIVE_INFINITY");break;default:if(this.writeJavaMatchProperty(e,t))break;GenJava.#Hn(e)?(t>FuPriority.AND&&this.writeChar(40),super.visitSymbolReference(e,FuPriority.AND),this.write(" & 0xff"),t>FuPriority.AND&&this.writeChar(41)):super.visitSymbolReference(e,t)}}#Wn(e,t,i){this.include("java.util.Arrays"),this.write("Arrays."),this.write(t),this.writeChar(40),e.accept(this,FuPriority.ARGUMENT),this.write(", "),3==i.length&&(this.writeStartEnd(i[1],i[2]),this.write(", ")),this.writeNotPromoted(e.type.asClassType().getElementType(),i[0]),this.writeChar(41)}#Qn(e,t){e.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(t),this.write("()")}#Xn(e,t,i){GenJava.#vn(e.type.asClassType().getElementType())?(i>FuPriority.AND&&this.writeChar(40),this.#Qn(e,t),this.write(" & 0xff"),i>FuPriority.AND&&this.writeChar(41)):this.#Qn(e,t)}#qa(e,t,i){let r;1==t.length&&(r=t[0])instanceof FuInterpolatedString?(this.write(".format("),this.writePrintf(r,i)):(this.write(".print"),i&&this.write("ln"),this.writeCoercedArgsInParentheses(e,t))}#Kn(e,t){this.include("java.util.regex.Pattern"),this.write("Pattern.compile("),e[t].accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(e,", "," | ","","Pattern.CASE_INSENSITIVE","Pattern.MULTILINE","Pattern.DOTALL"),this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.CLASS_TO_STRING:case FuId.STRING_CONTAINS:case FuId.STRING_ENDS_WITH:case FuId.STRING_INDEX_OF:case FuId.STRING_LAST_INDEX_OF:case FuId.STRING_REPLACE:case FuId.STRING_STARTS_WITH:case FuId.LIST_CLEAR:case FuId.LIST_CONTAINS:case FuId.LIST_INDEX_OF:case FuId.QUEUE_CLEAR:case FuId.STACK_CLEAR:case FuId.PRIORITY_QUEUE_CLEAR:case FuId.HASH_SET_CLEAR:case FuId.HASH_SET_REMOVE:case FuId.SORTED_SET_CLEAR:case FuId.SORTED_SET_REMOVE:case FuId.DICTIONARY_CLEAR:case FuId.DICTIONARY_CONTAINS_KEY:case FuId.DICTIONARY_REMOVE:case FuId.SORTED_DICTIONARY_CLEAR:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:case FuId.SORTED_DICTIONARY_REMOVE:case FuId.ORDERED_DICTIONARY_CLEAR:case FuId.ORDERED_DICTIONARY_CONTAINS_KEY:case FuId.ORDERED_DICTIONARY_REMOVE:case FuId.STRING_WRITER_TO_STRING:case FuId.MATH_METHOD:case FuId.MATH_ABS:case FuId.MATH_MAX:case FuId.MATH_MIN:null!=t&&(GenJava.isReferenceTo(t,FuId.BASE_PTR)?this.write("super"):t.accept(this,FuPriority.PRIMARY),this.writeChar(46)),this.writeName(i),this.writeCoercedArgsInParentheses(i,r);break;case FuId.ENUM_FROM_INT:r[0].accept(this,s);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:let e=t.type;GenJava.#xn(e)?this.writePostfix(t,".ordinal()"):t.accept(this,s);break;case FuId.DOUBLE_TRY_PARSE:this.include("java.util.function.DoubleSupplier"),this.write("!Double.isNaN("),t.accept(this,FuPriority.ASSIGN),this.write(" = ((DoubleSupplier) () -> { try { return Double.parseDouble("),r[0].accept(this,FuPriority.ARGUMENT),this.write("); } catch (NumberFormatException e) { return Double.NaN; } }).getAsDouble())");break;case FuId.STRING_SUBSTRING:this.writePostfix(t,".substring("),r[0].accept(this,FuPriority.ARGUMENT),2==r.length&&(this.write(", "),this.writeAdd(r[0],r[1])),this.writeChar(41);break;case FuId.STRING_TO_LOWER:this.writePostfix(t,".toLowerCase()");break;case FuId.STRING_TO_UPPER:this.writePostfix(t,".toUpperCase()");break;case FuId.ARRAY_BINARY_SEARCH_ALL:case FuId.ARRAY_BINARY_SEARCH_PART:this.#Wn(t,"binarySearch",r);break;case FuId.ARRAY_COPY_TO:this.write("System.arraycopy("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeCoercedArgs(i,r),this.writeChar(41);break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:this.#Wn(t,"fill",r);break;case FuId.ARRAY_SORT_ALL:this.include("java.util.Arrays"),this.writeCall("Arrays.sort",t);break;case FuId.ARRAY_SORT_PART:this.include("java.util.Arrays"),this.write("Arrays.sort("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeStartEnd(r[0],r[1]),this.writeChar(41);break;case FuId.LIST_ADD:case FuId.QUEUE_ENQUEUE:case FuId.HASH_SET_ADD:case FuId.SORTED_SET_ADD:this.writeListAdd(t,"add",r);break;case FuId.LIST_ADD_RANGE:this.writeMethodCall(t,"addAll",r[0]);break;case FuId.LIST_ALL:this.writeMethodCall(t,"stream().allMatch",r[0]);break;case FuId.LIST_ANY:this.writeMethodCall(t,"stream().anyMatch",r[0]);break;case FuId.LIST_COPY_TO:this.write("for (int _i = 0; _i < "),r[3].accept(this,FuPriority.REL),this.writeLine("; _i++)"),this.write("\t"),r[1].accept(this,FuPriority.PRIMARY),this.writeChar(91),this.startAdd(r[2]),this.write("_i] = "),this.writePostfix(t,".get("),this.startAdd(r[0]),this.write("_i)");break;case FuId.LIST_INSERT:this.writeListInsert(t,"add",r);break;case FuId.LIST_LAST:this.writePostfix(t,".get("),this.writePostfix(t,".size() - 1)");break;case FuId.LIST_REMOVE_AT:this.writeMethodCall(t,"remove",r[0]);break;case FuId.LIST_REMOVE_RANGE:this.writePostfix(t,".subList("),this.writeStartEnd(r[0],r[1]),this.write(").clear()");break;case FuId.LIST_SORT_ALL:this.writePostfix(t,".sort(null)");break;case FuId.LIST_SORT_PART:this.writePostfix(t,".subList("),this.writeStartEnd(r[0],r[1]),this.write(").sort(null)");break;case FuId.QUEUE_DEQUEUE:this.#Xn(t,"remove",s);break;case FuId.QUEUE_PEEK:this.#Xn(t,"element",s);break;case FuId.STACK_PEEK:this.#Xn(t,"peek",s);break;case FuId.STACK_POP:this.#Xn(t,"pop",s);break;case FuId.STACK_PUSH:this.writeListAdd(t,"push",r);break;case FuId.PRIORITY_QUEUE_DEQUEUE:this.#Xn(t,"remove().get",s);break;case FuId.PRIORITY_QUEUE_ENQUEUE:this.writePostfix(t,".add(new FuPriorityQueueEntry("),this.writeNotPromoted(t.type.asClassType().getElementType(),r[0]),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.PRIORITY_QUEUE_PEEK:this.#Xn(t,"element().get",s);break;case FuId.HASH_SET_CONTAINS:case FuId.SORTED_SET_CONTAINS:this.writeListAdd(t,"contains",r);break;case FuId.DICTIONARY_ADD:this.writePostfix(t,".put("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeNewStorage(t.type.asClassType().getValueType()),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE:GenJava.isReferenceTo(t,FuId.CONSOLE_ERROR)?(this.write("System.err"),this.#qa(i,r,!1)):t.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?(this.writePostfix(t,".append("),this.#Dn(r[0],FuPriority.ARGUMENT),this.writeChar(41)):(this.write("try { "),this.writePostfix(t,".append("),this.#Dn(r[0],FuPriority.ARGUMENT),this.include("java.io.IOException"),this.write("); } catch (IOException e) { throw new RuntimeException(e); }"));break;case FuId.TEXT_WRITER_WRITE_CHAR:GenJava.isReferenceTo(t,FuId.CONSOLE_ERROR)?this.writeCharMethodCall(t,"print",r[0]):t.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?this.writeCharMethodCall(t,"append",r[0]):(this.write("try { "),this.writeCharMethodCall(t,"append",r[0]),this.include("java.io.IOException"),this.write("; } catch (IOException e) { throw new RuntimeException(e); }"));break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:GenJava.isReferenceTo(t,FuId.CONSOLE_ERROR)?(this.writeCall("System.err.print(Character.toChars",r[0]),this.writeChar(41)):t.type.asClassType().class.id==FuId.STRING_WRITER_CLASS?(this.writeMethodCall(t,"append(Character.toString",r[0]),this.writeChar(41)):(this.write("try { "),this.writeMethodCall(t,"append(Character.toString",r[0]),this.include("java.io.IOException"),this.write("); } catch (IOException e) { throw new RuntimeException(e); }"));break;case FuId.TEXT_WRITER_WRITE_LINE:if(GenJava.isReferenceTo(t,FuId.CONSOLE_ERROR))this.write("System.err"),this.#qa(i,r,!0);else{if(this.write("try { "),this.writePostfix(t,".append("),0==r.length)this.write("'\\n'");else{let e;(e=r[0])instanceof FuInterpolatedString?(this.write("String.format("),this.writePrintf(e,!0)):(this.#Dn(r[0],FuPriority.ARGUMENT),this.write(").append('\\n'"))}this.include("java.io.IOException"),this.write("); } catch (IOException e) { throw new RuntimeException(e); }")}break;case FuId.STRING_WRITER_CLEAR:this.writePostfix(t,".getBuffer().setLength(0)");break;case FuId.CONSOLE_WRITE:this.write("System.out"),this.#qa(i,r,!1);break;case FuId.CONSOLE_WRITE_LINE:this.write("System.out"),this.#qa(i,r,!0);break;case FuId.CONVERT_TO_BASE64_STRING:this.include("java.util.Base64"),this.isWholeArray(r[0],r[1],r[2])?this.writeCall("Base64.getEncoder().encodeToString",r[0]):(this.include("java.nio.ByteBuffer"),this.writeCall("new String(Base64.getEncoder().encode(ByteBuffer.wrap",r[0],r[1],r[2]),this.write(").array())"));break;case FuId.U_T_F8_GET_BYTE_COUNT:this.include("java.nio.charset.StandardCharsets"),this.writePostfix(r[0],".getBytes(StandardCharsets.UTF_8).length");break;case FuId.U_T_F8_GET_BYTES:this.include("java.nio.ByteBuffer"),this.include("java.nio.CharBuffer"),this.include("java.nio.charset.StandardCharsets"),this.write("StandardCharsets.UTF_8.newEncoder().encode(CharBuffer.wrap("),r[0].accept(this,FuPriority.ARGUMENT),this.write("), ByteBuffer.wrap("),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.write(", "),this.writePostfix(r[1],".length"),r[2].isLiteralZero()||(this.write(" - "),r[2].accept(this,FuPriority.MUL)),this.write("), true)");break;case FuId.U_T_F8_GET_STRING:this.include("java.nio.charset.StandardCharsets"),this.write("new String("),this.writeCoercedArgs(i,r),this.write(", StandardCharsets.UTF_8)");break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.writeCall("System.getenv",r[0]);break;case FuId.REGEX_COMPILE:this.#Kn(r,0);break;case FuId.REGEX_ESCAPE:this.include("java.util.regex.Pattern"),this.writeCall("Pattern.quote",r[0]);break;case FuId.REGEX_IS_MATCH_STR:this.#Kn(r,1),this.writeCall(".matcher",r[0]),this.write(".find()");break;case FuId.REGEX_IS_MATCH_REGEX:this.writeMethodCall(t,"matcher",r[0]),this.write(".find()");break;case FuId.MATCH_FIND_STR:case FuId.MATCH_FIND_REGEX:this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = "),i.id==FuId.MATCH_FIND_STR?this.#Kn(r,1):r[1].accept(this,FuPriority.PRIMARY),this.writeCall(".matcher",r[0]),this.write(").find()");break;case FuId.MATCH_GET_CAPTURE:this.writeMethodCall(t,"group",r[0]);break;case FuId.MATH_CEILING:this.writeCall("Math.ceil",r[0]);break;case FuId.MATH_CLAMP:this.write("Math.min(Math.max("),this.writeClampAsMinMax(r);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.writeCall("Math.fma",r[0],r[1],r[2]);break;case FuId.MATH_IS_FINITE:this.writeCall("Double.isFinite",r[0]);break;case FuId.MATH_IS_INFINITY:this.writeCall("Double.isInfinite",r[0]);break;case FuId.MATH_IS_NA_N:this.writeCall("Double.isNaN",r[0]);break;case FuId.MATH_LOG2:s>FuPriority.MUL&&this.writeChar(40),this.writeCall("Math.log",r[0]),this.write(" * 1.4426950408889635"),s>FuPriority.MUL&&this.writeChar(41);break;case FuId.MATH_ROUND:this.writeCall("Math.rint",r[0]);break;default:this.notSupported(t,i.name)}}writeIndexingExpr(e,t){t!=FuPriority.ASSIGN&&GenJava.#vn(e.type)?(t>FuPriority.AND&&this.writeChar(40),this.#Yn(e),this.write(" & 0xff"),t>FuPriority.AND&&this.writeChar(41)):this.#Yn(e)}isPromoted(e){return super.isPromoted(e)||GenJava.#Bn(e)}writeAssignRight(e){let t;!GenJava.#Bn(e.left)&&(t=e.right)instanceof FuBinaryExpr&&t.isAssign()&&GenJava.#vn(e.right.type)?(this.writeChar(40),super.writeAssignRight(e),this.write(") & 0xff")):super.writeAssignRight(e)}writeAssign(e,t){let i,r;(i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&!r.isArray()?(this.writePostfix(i.left,r.class.id==FuId.LIST_CLASS?".set(":".put("),i.right.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeNotPromoted(e.type,e.right),this.writeChar(41)):super.writeAssign(e,t)}getIsOperator(){return" instanceof "}writeVar(e){e.type.isFinal()&&!e.isAssignableStorage()&&this.write("final "),super.writeVar(e)}hasInitCode(e){return e.type instanceof FuArrayStorageType&&e.type.getStorageType()instanceof FuStorageType||super.hasInitCode(e)}writeInitCode(e){if(!this.hasInitCode(e))return;let t;if((t=e.type)instanceof FuArrayStorageType){let i,r=0;for(;(i=t.getElementType())instanceof FuArrayStorageType;)this.openLoop("int",r++,t.length),t=i;this.openLoop("int",r++,t.length),this.writeArrayElement(e,r),this.write(" = ");let s=t.getElementType();for(this.writeNew(s,FuPriority.ARGUMENT),this.writeCharLine(59);--r>=0;)this.closeBlock()}else super.writeInitCode(e)}visitLambdaExpr(e){this.writeName(e.first),this.write(" -> "),e.body.accept(this,FuPriority.STATEMENT)}defineIsVar(e){}writeAssert(e){e.completesNormally()?(this.write("assert "),e.cond.accept(this,FuPriority.ARGUMENT),null!=e.message&&(this.write(" : "),e.message.accept(this,FuPriority.ARGUMENT))):(this.write("throw new AssertionError("),null!=e.message&&e.message.accept(this,FuPriority.ARGUMENT),this.writeChar(41)),this.writeCharLine(59)}startBreakGoto(){this.write("break fuswitch")}visitForeach(e){this.write("for (");let t=e.collection.type;switch(t.class.id){case FuId.STRING_CLASS:return this.write("int _i = 0; _i < "),this.writeStringLength(e.collection),this.write("; _i++) "),this.openBlock(),this.writeTypeAndName(e.getVar()),this.write(" = "),e.collection.accept(this,FuPriority.PRIMARY),this.writeLine(".charAt(_i);"),this.flattenBlock(e.body),void this.closeBlock();case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:this.include("java.util.Map"),this.#Un("Map.Entry",t),this.writeChar(32),this.write(e.getVar().name),this.write(" : "),this.writePostfix(e.collection,".entrySet()");break;default:this.writeTypeAndName(e.getVar()),this.write(" : "),e.collection.accept(this,FuPriority.ARGUMENT)}this.writeChar(41),this.writeChild(e.body)}static#jn(e){return e==FuId.INT_TRY_PARSE||e==FuId.N_INT_TRY_PARSE||e==FuId.LONG_TRY_PARSE||e==FuId.DOUBLE_TRY_PARSE}visitIf(e){let t,i;if(null==e.onFalse&&(t=e.cond)instanceof FuPrefixExpr&&t.op==FuToken.EXCLAMATION_MARK&&(i=t.inner)instanceof FuCallExpr&&GenJava.#jn(i.method.symbol.id)){switch(this.write("try "),this.openBlock(),i.method.left.accept(this,FuPriority.ASSIGN),this.write(" = "),i.method.symbol.id){case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:this.write("Integer.parseInt");break;case FuId.LONG_TRY_PARSE:this.write("Long.parseLong");break;case FuId.DOUBLE_TRY_PARSE:this.write("Double.parseDouble");break;default:throw new Error}this.writeChar(40),i.arguments_[0].accept(this,FuPriority.ARGUMENT),2==i.arguments_.length&&(this.write(", "),i.arguments_[1].accept(this,FuPriority.ARGUMENT)),this.writeLine(");"),this.closeBlock(),this.write("catch (NumberFormatException e) "),this.openBlock(),e.onTrue instanceof FuReturn||e.onTrue instanceof FuThrow||(i.method.left.accept(this,FuPriority.ASSIGN),this.writeLine(" = 0;")),e.onTrue.acceptStatement(this),this.closeBlock()}else super.visitIf(e)}visitLock(e){this.writeCall("synchronized ",e.lock),this.writeChild(e.body)}visitReturn(e){null!=e.value&&this.currentMethod.id==FuId.MAIN?(e.value.isLiteralZero()||(this.ensureChildBlock(),this.write("System.exit("),e.value.accept(this,FuPriority.ARGUMENT),this.writeLine(");")),this.writeLine("return;")):super.visitReturn(e)}writeSwitchValue(e){if(GenJava.#Bn(e)){let t=e;this.#Yn(t)}else super.writeSwitchValue(e)}writeSwitchCaseValue(e,t){let i;if((i=t)instanceof FuSymbolReference){let e,t;if((e=i.symbol.parent)instanceof FuEnum&&GenJava.#xn(e))return void this.writeUppercaseWithUnderscores(i.name);if((t=i.symbol)instanceof FuClass)return this.write(t.name),void this.write(" _")}super.writeSwitchCaseValue(e,t)}visitSwitch(e){!e.isTypeMatching()&&e.hasWhen()?e.cases.some((e=>FuSwitch.hasEarlyBreakAndContinue(e.body)))||FuSwitch.hasEarlyBreakAndContinue(e.defaultBody)?(this.write("fuswitch"),this.visitLiteralLong(BigInt(this.switchesWithGoto.length)),this.write(": "),this.switchesWithGoto.push(e),this.writeSwitchAsIfs(e,!1)):this.writeSwitchAsIfs(e,!0):super.visitSwitch(e)}#Jn(e){this.createFile(this.#On,e+".java"),0!=this.#Mn.length&&(this.write("package "),this.write(this.#Mn),this.writeCharLine(59))}visitEnumValue(e,t){let i;this.writeDoc(e.documentation),this.write("int "),this.writeUppercaseWithUnderscores(e.name),this.write(" = "),(i=e.value)instanceof FuImplicitEnumValue?this.visitLiteralLong(BigInt(i.value)):e.value.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59)}writeEnum(e){this.#Jn(e.name),this.writeNewLine(),this.writeDoc(e.documentation),this.writePublic(e);let t=GenJava.#xn(e);if(this.write(t?"enum ":"interface "),this.writeLine(e.name),this.openBlock(),t){for(let t=e.getFirstValue();this.writeDoc(t.documentation),this.writeUppercaseWithUnderscores(t.name),t=t.next,null!=t;)this.writeCharLine(44);this.writeNewLine()}else e.acceptValues(this);this.closeBlock(),this.closeFile()}#ha(e,t){switch(this.writeNewLine(),this.writeMethodDoc(e),this.#ln(e.visibility),e.callType){case FuCallType.STATIC:this.write("static ");break;case FuCallType.VIRTUAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.OVERRIDE:this.write("@Override ");break;case FuCallType.NORMAL:e.visibility!=FuVisibility.PRIVATE&&this.write("final ");break;case FuCallType.SEALED:this.write("final @Override ");break;default:throw new Error}if(e.id==FuId.MAIN?this.write("void main"):this.writeTypeAndName(e),this.writeChar(40),e.id==FuId.MAIN&&0==t)this.write("String[] args");else{let i=e.firstParameter();for(let e=0;e<t;e++)e>0&&this.write(", "),this.writeTypeAndName(i),i=i.nextVar()}this.writeChar(41);let i=" throws ";for(const t of e.throws)this.write(i),this.writeExceptionClass(t.symbol),i=", "}#qn(e,t){t+1<e.getParametersCount()&&this.#qn(e,t+1),this.#ha(e,t),this.writeNewLine(),this.openBlock(),e.type.id!=FuId.VOID_TYPE&&this.write("return "),this.writeName(e),this.writeChar(40);let i=e.firstParameter();for(let e=0;e<t;e++)this.writeName(i),this.write(", "),i=i.nextVar();i.value.accept(this,FuPriority.ARGUMENT),this.writeLine(");"),this.closeBlock()}writeConst(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),this.write("static final "),this.writeTypeAndName(e),this.write(" = "),this.writeCoercedExpr(e.type,e.value),this.writeCharLine(59)}writeField(e){this.writeDoc(e.documentation),this.#ln(e.visibility),this.writeVar(e),this.writeCharLine(59)}writeMethod(e){this.#ha(e,e.getParametersCount()),this.writeBody(e);let t=0;for(let i=e.firstParameter();null!=i;i=i.nextVar()){if(null!=i.value){this.#qn(e,t);break}t++}}writeClass(e,t){switch(this.openStringWriter(),this.writeDoc(e.documentation),this.writePublic(e),e.callType){case FuCallType.NORMAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.STATIC:case FuCallType.SEALED:this.write("final ");break;default:throw new Error}this.openClass(e,""," extends "),e.callType==FuCallType.STATIC?(this.write("private "),this.write(e.name),this.writeLine("()"),this.openBlock(),this.closeBlock()):this.needsConstructor(e)?(null!=e.constructor_&&(this.writeDoc(e.constructor_.documentation),this.#ln(e.constructor_.visibility)),this.write(e.name),this.writeLine("()"),this.openBlock(),this.writeConstructorBody(e),this.closeBlock()):e.id==FuId.EXCEPTION_CLASS&&(this.writeExceptionConstructor(e,"() { }"),this.writeExceptionConstructor(e,"(String message) { super(message); }"),this.writeExceptionConstructor(e,"(String message, Throwable cause) { super(message, cause); }"),this.writeExceptionConstructor(e,"(Throwable cause) { super(cause); }")),this.writeMembers(e,!0),this.closeBlock(),this.#Jn(e.name),this.writeTopLevelNatives(t),this.writeIncludes("import ",";"),this.writeNewLine(),this.closeStringWriter(),this.closeFile()}#zn(){this.#Jn("FuPriorityQueueEntry"),this.writeLine("class FuPriorityQueueEntry<TElement, TPriority extends Comparable<TPriority>>"),this.writeLine("\timplements Comparable<FuPriorityQueueEntry<TElement, TPriority>>"),this.openBlock(),this.writeLine("private final TElement element;"),this.writeLine("private final TPriority priority;"),this.writeNewLine(),this.writeLine("public FuPriorityQueueEntry(TElement element, TPriority priority)"),this.openBlock(),this.writeLine("this.element = element;"),this.writeLine("this.priority = priority;"),this.closeBlock(),this.writeNewLine(),this.writeLine("public TElement get()"),this.openBlock(),this.writeLine("return element;"),this.closeBlock(),this.writeNewLine(),this.writeLine("public int compareTo(FuPriorityQueueEntry<TElement, TPriority> o)"),this.openBlock(),this.writeLine("return priority.compareTo(o.priority);"),this.closeBlock(),this.closeBlock(),this.closeFile()}#cn(){this.#Jn("FuResource"),this.writeLine("import java.io.DataInputStream;"),this.writeLine("import java.io.IOException;"),this.writeNewLine(),this.writeLine("class FuResource"),this.openBlock(),this.writeLine("static byte[] getByteArray(String name, int length)"),this.openBlock(),this.write("DataInputStream dis = new DataInputStream("),this.writeLine("FuResource.class.getResourceAsStream(name));"),this.writeLine("byte[] result = new byte[length];"),this.write("try "),this.openBlock(),this.write("try "),this.openBlock(),this.writeLine("dis.readFully(result);"),this.closeBlock(),this.write("finally "),this.openBlock(),this.writeLine("dis.close();"),this.closeBlock(),this.closeBlock(),this.write("catch (IOException e) "),this.openBlock(),this.writeLine("throw new RuntimeException();"),this.closeBlock(),this.writeLine("return result;"),this.closeBlock(),this.closeBlock(),this.closeFile()}writeProgram(e,t,i){this.#On=t,this.#Mn=i,this.#Ra=!1,this.writeTypes(e),this.#Ra&&this.#zn(),Object.keys(e.resources).length>0&&this.#cn()}}export class GenJsNoModule extends GenBase{#qi=!1;getTargetName(){return"JavaScript"}#ba(e){switch(this.writeCamelCase(e),e){case"Arguments":case"Constructor":case"arguments":case"await":case"catch":case"debugger":case"delete":case"export":case"extends":case"finally":case"function":case"implements":case"import":case"instanceof":case"interface":case"let":case"package":case"private":case"super":case"try":case"typeof":case"var":case"with":case"yield":this.writeChar(95)}}writeName(e){if(e instanceof FuContainerType)this.write(e.name);else if(e instanceof FuConst){const t=e;t.visibility==FuVisibility.PRIVATE&&this.writeChar(35),this.writeUppercaseConstName(t)}else if(e instanceof FuVar)this.#ba(e.name);else{if(!(e instanceof FuMember))throw new Error;e.visibility==FuVisibility.PRIVATE?(this.writeChar(35),this.writeCamelCase(e.name),"Constructor"==e.name&&this.writeChar(95)):this.#ba(e.name)}}writeTypeAndName(e){this.writeName(e)}writeArrayElementType(e){switch(e.id){case FuId.S_BYTE_RANGE:this.write("Int8");break;case FuId.BYTE_RANGE:this.write("Uint8");break;case FuId.SHORT_RANGE:this.write("Int16");break;case FuId.U_SHORT_RANGE:this.write("Uint16");break;case FuId.INT_TYPE:case FuId.N_INT_TYPE:this.write("Int32");break;case FuId.LONG_TYPE:this.write("BigInt64");break;case FuId.FLOAT_TYPE:this.write("Float32");break;case FuId.DOUBLE_TYPE:this.write("Float64");break;default:throw new Error}}visitAggregateInitializer(e){let t,i=!1;(t=e.type.getElementType())instanceof FuNumericType&&(this.write("new "),this.writeArrayElementType(t),this.write("Array("),i=!0),this.write("[ "),this.writeCoercedLiterals(null,e.items),this.write(" ]"),i&&this.writeChar(41)}writeNew(e,t){switch(e.class.id){case FuId.LIST_CLASS:case FuId.QUEUE_CLASS:case FuId.STACK_CLASS:this.write("[]");break;case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.write("new Set()");break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.write("{}");break;case FuId.ORDERED_DICTIONARY_CLASS:this.write("new Map()");break;case FuId.LOCK_CLASS:this.notSupported(e,"Lock");break;default:this.write("new "),e.class.id==FuId.STRING_WRITER_CLASS&&(this.#qi=!0),this.write(e.class.name),this.write("()")}}writeNewWithFields(e,t){this.write("Object.assign("),this.writeNew(e,FuPriority.ARGUMENT),this.writeChar(44),this.writeObjectLiteral(t,": "),this.writeChar(41)}writeVar(e){this.write(e.type.isFinal()&&!e.isAssignableStorage()?"const ":"let "),super.writeVar(e)}#$n(e){let t=0;for(const i of e)t++,(96==i.codePointAt(0)||36==i.codePointAt(0)&&t<e.length&&123==e.charCodeAt(t))&&this.writeChar(92),this.writeChar(i.codePointAt(0))}visitInterpolatedString(e,t){this.writeChar(96);for(const t of e.parts){if(this.#$n(t.prefix),this.write("${"),0!=t.width||32!=t.format){if(t.argument instanceof FuLiteralLong||t.argument instanceof FuPrefixExpr?(this.writeChar(40),t.argument.accept(this,FuPriority.PRIMARY),this.writeChar(41)):t.argument.accept(this,FuPriority.PRIMARY),t.argument.type instanceof FuNumericType){switch(t.format){case 69:this.write(".toExponential("),t.precision>=0&&this.visitLiteralLong(BigInt(t.precision)),this.write(").toUpperCase()");break;case 101:this.write(".toExponential("),t.precision>=0&&this.visitLiteralLong(BigInt(t.precision)),this.writeChar(41);break;case 70:case 102:this.write(".toFixed("),t.precision>=0&&this.visitLiteralLong(BigInt(t.precision)),this.writeChar(41);break;case 88:this.write(".toString(16).toUpperCase()");break;case 120:this.write(".toString(16)");break;default:this.write(".toString()")}if(t.precision>=0)switch(t.format){case 68:case 100:case 88:case 120:this.write(".padStart("),this.visitLiteralLong(BigInt(t.precision)),this.write(', "0")')}}t.width>0?(this.write(".padStart("),this.visitLiteralLong(BigInt(t.width)),this.writeChar(41)):t.width<0&&(this.write(".padEnd("),this.visitLiteralLong(BigInt(-t.width)),this.writeChar(41))}else t.argument.accept(this,FuPriority.ARGUMENT);this.writeChar(125)}this.#$n(e.suffix),this.writeChar(96)}writeLocalName(e,t){let i,r;if((i=e)instanceof FuMember){if(i.isStatic()){if(null==this.currentMethod){let i;if((i=e)instanceof FuConst)return void i.value.accept(this,t);throw new Error}this.write(this.currentMethod.parent.name)}else this.write("this");this.writeChar(46)}this.writeName(e),(r=e.parent)instanceof FuForeach&&r.collection.type instanceof FuStringType&&this.write(".codePointAt(0)")}writeCoercedInternal(e,t,i){if(e instanceof FuNumericType)if(e.id==FuId.LONG_TYPE){if(t instanceof FuLiteralLong)return t.accept(this,FuPriority.PRIMARY),void this.writeChar(110);if(t.type.id!=FuId.LONG_TYPE)return void this.writeCall("BigInt",t)}else if(t.type.id==FuId.LONG_TYPE)return void this.writeCall("Number",t);t.accept(this,i)}writeNewArray(e,t,i){this.write("new "),e instanceof FuNumericType&&this.writeArrayElementType(e),this.writeCall("Array",t)}hasInitCode(e){let t;return(t=e.type)instanceof FuArrayStorageType&&t.getElementType()instanceof FuStorageType}writeInitCode(e){if(!this.hasInitCode(e))return;let t,i,r=e.type,s=0;for(;(t=r.getElementType())instanceof FuArrayStorageType;)this.openLoop("let",s++,r.length),this.writeArrayElement(e,s),this.write(" = "),this.writeNewArray(t.getElementType(),t.lengthExpr,FuPriority.ARGUMENT),this.writeCharLine(59),r=t;for((i=r.getElementType())instanceof FuStorageType&&(this.openLoop("let",s++,r.length),this.writeArrayElement(e,s),this.write(" = "),this.writeNew(i,FuPriority.ARGUMENT),this.writeCharLine(59));--s>=0;)this.closeBlock()}writeResource(e,t){this.write("Fu."),this.writeResourceName(e)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.write("process.stderr");break;case FuId.LIST_COUNT:case FuId.QUEUE_COUNT:case FuId.STACK_COUNT:this.writePostfix(e.left,".length");break;case FuId.HASH_SET_COUNT:case FuId.SORTED_SET_COUNT:case FuId.ORDERED_DICTIONARY_COUNT:this.writePostfix(e.left,".size");break;case FuId.DICTIONARY_COUNT:case FuId.SORTED_DICTIONARY_COUNT:this.writeCall("Object.keys",e.left),this.write(".length");break;case FuId.MATCH_START:this.writePostfix(e.left,".index");break;case FuId.MATCH_END:t>FuPriority.ADD&&this.writeChar(40),this.writePostfix(e.left,".index + "),this.writePostfix(e.left,"[0].length"),t>FuPriority.ADD&&this.writeChar(41);break;case FuId.MATCH_LENGTH:this.writePostfix(e.left,"[0].length");break;case FuId.MATCH_VALUE:this.writePostfix(e.left,"[0]");break;case FuId.MATH_NA_N:this.write("NaN");break;case FuId.MATH_NEGATIVE_INFINITY:this.write("-Infinity");break;case FuId.MATH_POSITIVE_INFINITY:this.write("Infinity");break;default:super.visitSymbolReference(e,t)}}writeStringLength(e){this.writePostfix(e,".length")}writeCharAt(e){this.writeMethodCall(e.left,"charCodeAt",e.right)}writeBinaryOperand(e,t,i){this.writeCoerced(i.isRel()?e.type:i.type,e,t)}#gn(e,t,i,r,s){this.isWholeArray(e,t,i)?e.accept(this,r):(e.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.write(s),this.writeChar(40),this.writeStartEnd(t,i),this.writeChar(41))}static#Zn(e){if(0==e.length||e.charCodeAt(0)<65)return!1;for(const t of e)if(!FuLexer.isLetterOrDigit(t.codePointAt(0)))return!1;return!0}#eh(e,t){let i,r=e[t];if((i=r)instanceof FuLiteralString){this.writeChar(47);let t=!1;for(const e of i.value){switch(e.codePointAt(0)){case 92:if(!t){t=!0;continue}t=!1;break;case 34:case 39:t=!1;break;case 47:t=!0}t&&(this.writeChar(92),t=!1),this.writeChar(e.codePointAt(0))}this.writeChar(47),this.writeRegexOptions(e,"","","","i","m","s")}else this.write("new RegExp("),r.accept(this,FuPriority.ARGUMENT),this.writeRegexOptions(e,', "',"",'"',"i","m","s"),this.writeChar(41)}#th(e,t,i){i>FuPriority.EQUALITY&&this.writeChar(40),this.write("typeof("),e.accept(this,FuPriority.ARGUMENT),this.write(') == "'),this.write(t),this.writeChar(34),i>FuPriority.EQUALITY&&this.writeChar(41)}static#ih(e){return e.some((e=>e.type.id==FuId.LONG_TYPE))}#rh(e,t,i,r){GenJsNoModule.#ih(r)?(this.write("((x, y) => x "),this.writeChar(i),this.write(" y ? x : y)"),this.writeInParentheses(r)):this.writeCall(t,r[0],r[1])}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.CLASS_TO_STRING:case FuId.STRING_ENDS_WITH:case FuId.STRING_INDEX_OF:case FuId.STRING_LAST_INDEX_OF:case FuId.STRING_STARTS_WITH:case FuId.ARRAY_SORT_ALL:case FuId.LIST_INDEX_OF:case FuId.STACK_PUSH:case FuId.STACK_POP:case FuId.HASH_SET_ADD:case FuId.HASH_SET_CLEAR:case FuId.SORTED_SET_ADD:case FuId.SORTED_SET_CLEAR:case FuId.ORDERED_DICTIONARY_CLEAR:case FuId.STRING_WRITER_CLEAR:case FuId.STRING_WRITER_TO_STRING:case FuId.MATH_METHOD:case FuId.MATH_LOG2:case FuId.MATH_ROUND:null==t?this.writeLocalName(i,FuPriority.PRIMARY):(GenJsNoModule.isReferenceTo(t,FuId.BASE_PTR)?this.write("super"):t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.writeName(i)),this.writeCoercedArgsInParentheses(i,r);break;case FuId.ENUM_FROM_INT:r[0].accept(this,s);break;case FuId.ENUM_HAS_FLAG:this.writeEnumHasFlag(t,r,s);break;case FuId.ENUM_TO_INT:t.accept(this,s);break;case FuId.INT_TRY_PARSE:case FuId.N_INT_TRY_PARSE:this.write("!isNaN("),t.accept(this,FuPriority.ASSIGN),this.write(" = parseInt("),r[0].accept(this,FuPriority.ARGUMENT),this.writeTryParseRadix(r),this.write("))");break;case FuId.LONG_TRY_PARSE:1!=r.length&&this.notSupported(r[1],"Radix"),this.write("(() => { try { "),t.accept(this,FuPriority.ASSIGN),this.write(" = BigInt("),r[0].accept(this,FuPriority.ARGUMENT),this.write("); return true; } catch { return false; }})()");break;case FuId.DOUBLE_TRY_PARSE:this.write("!isNaN("),t.accept(this,FuPriority.ASSIGN),this.write(" = parseFloat("),r[0].accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.STRING_CONTAINS:case FuId.ARRAY_CONTAINS:case FuId.LIST_CONTAINS:this.writeMethodCall(t,"includes",r[0]);break;case FuId.STRING_REPLACE:this.writeMethodCall(t,"replaceAll",r[0],r[1]);break;case FuId.STRING_SUBSTRING:this.writePostfix(t,".substring("),r[0].accept(this,FuPriority.ARGUMENT),2==r.length&&(this.write(", "),this.writeAdd(r[0],r[1])),this.writeChar(41);break;case FuId.STRING_TO_LOWER:this.writePostfix(t,".toLowerCase()");break;case FuId.STRING_TO_UPPER:this.writePostfix(t,".toUpperCase()");break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:this.writePostfix(t,".fill("),r[0].accept(this,FuPriority.ARGUMENT),3==r.length&&(this.write(", "),this.writeStartEnd(r[1],r[2])),this.writeChar(41);break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:r[1].accept(this,FuPriority.PRIMARY),t.type.asClassType().getElementType()instanceof FuNumericType?(this.write(".set("),this.#gn(t,r[0],r[3],FuPriority.ARGUMENT,i.id==FuId.ARRAY_COPY_TO?"subarray":"slice"),r[2].isLiteralZero()||(this.write(", "),r[2].accept(this,FuPriority.ARGUMENT))):(this.write(".splice("),r[2].accept(this,FuPriority.ARGUMENT),this.write(", "),r[3].accept(this,FuPriority.ARGUMENT),this.write(", ..."),this.#gn(t,r[0],r[3],FuPriority.PRIMARY,"slice")),this.writeChar(41);break;case FuId.ARRAY_SORT_PART:this.writePostfix(t,".subarray("),this.writeStartEnd(r[0],r[1]),this.write(").sort()");break;case FuId.LIST_ADD:this.writeListAdd(t,"push",r);break;case FuId.LIST_ADD_RANGE:this.writePostfix(t,".push(..."),r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.LIST_ALL:this.writeMethodCall(t,"every",r[0]);break;case FuId.LIST_ANY:this.writeMethodCall(t,"some",r[0]);break;case FuId.LIST_CLEAR:case FuId.QUEUE_CLEAR:case FuId.STACK_CLEAR:this.writePostfix(t,".length = 0");break;case FuId.LIST_INSERT:this.writeListInsert(t,"splice",r,", 0, ");break;case FuId.LIST_LAST:case FuId.STACK_PEEK:this.writePostfix(t,".at(-1)");break;case FuId.LIST_REMOVE_AT:this.writePostfix(t,".splice("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", 1)");break;case FuId.LIST_REMOVE_RANGE:this.writeMethodCall(t,"splice",r[0],r[1]);break;case FuId.LIST_SORT_ALL:this.writePostfix(t,".sort((a, b) => a - b)");break;case FuId.LIST_SORT_PART:this.writePostfix(t,".splice("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.write(", ..."),this.#gn(t,r[0],r[1],FuPriority.PRIMARY,"slice"),this.write(".sort((a, b) => a - b))");break;case FuId.QUEUE_DEQUEUE:this.writePostfix(t,".shift()");break;case FuId.QUEUE_ENQUEUE:this.writeMethodCall(t,"push",r[0]);break;case FuId.QUEUE_PEEK:this.writePostfix(t,"[0]");break;case FuId.HASH_SET_CONTAINS:case FuId.SORTED_SET_CONTAINS:case FuId.ORDERED_DICTIONARY_CONTAINS_KEY:this.writeMethodCall(t,"has",r[0]);break;case FuId.HASH_SET_REMOVE:case FuId.SORTED_SET_REMOVE:case FuId.ORDERED_DICTIONARY_REMOVE:this.writeMethodCall(t,"delete",r[0]);break;case FuId.DICTIONARY_ADD:this.writeDictionaryAdd(t,r);break;case FuId.DICTIONARY_CLEAR:case FuId.SORTED_DICTIONARY_CLEAR:this.write("for (const key in "),t.accept(this,FuPriority.ARGUMENT),this.writeCharLine(41),this.write("\tdelete "),this.writePostfix(t,"[key];");break;case FuId.DICTIONARY_CONTAINS_KEY:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:this.writeMethodCall(t,"hasOwnProperty",r[0]);break;case FuId.DICTIONARY_REMOVE:case FuId.SORTED_DICTIONARY_REMOVE:this.write("delete "),this.writeIndexing(t,r[0]);break;case FuId.TEXT_WRITER_WRITE:this.writePostfix(t,".write("),r[0].type instanceof FuStringType?r[0].accept(this,FuPriority.ARGUMENT):this.writeCall("String",r[0]),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_CHAR:this.writeMethodCall(t,"write(String.fromCharCode",r[0]),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_CODE_POINT:this.writeMethodCall(t,"write(String.fromCodePoint",r[0]),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_LINE:GenJsNoModule.isReferenceTo(t,FuId.CONSOLE_ERROR)?(this.write("console.error("),0==r.length?this.write('""'):r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41)):(this.writePostfix(t,".write("),0!=r.length&&(r[0].accept(this,FuPriority.ADD),this.write(" + ")),this.write('"\\n")'));break;case FuId.CONSOLE_WRITE:this.write("process.stdout.write("),r[0].type instanceof FuStringType?r[0].accept(this,FuPriority.ARGUMENT):this.writeCall("String",r[0]),this.writeChar(41);break;case FuId.CONSOLE_WRITE_LINE:this.write("console.log("),0==r.length?this.write('""'):r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.CONVERT_TO_BASE64_STRING:this.write("btoa(String.fromCodePoint(..."),this.#gn(r[0],r[1],r[2],FuPriority.PRIMARY,"subarray"),this.write("))");break;case FuId.U_T_F8_GET_BYTE_COUNT:this.write("new TextEncoder().encode("),r[0].accept(this,FuPriority.ARGUMENT),this.write(").length");break;case FuId.U_T_F8_GET_BYTES:this.write("new TextEncoder().encodeInto("),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].isLiteralZero()?r[1].accept(this,FuPriority.ARGUMENT):this.writeMethodCall(r[1],"subarray",r[2]),this.writeChar(41);break;case FuId.U_T_F8_GET_STRING:this.write("new TextDecoder().decode("),this.#gn(r[0],r[1],r[2],FuPriority.ARGUMENT,"subarray"),this.writeChar(41);break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:let e;(e=r[0])instanceof FuLiteralString&&GenJsNoModule.#Zn(e.value)?(this.write("process.env."),this.write(e.value)):(this.write("process.env["),r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(93));break;case FuId.REGEX_COMPILE:this.#eh(r,0);break;case FuId.REGEX_ESCAPE:this.writePostfix(r[0],".replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&')");break;case FuId.REGEX_IS_MATCH_STR:this.#eh(r,1),this.writeCall(".test",r[0]);break;case FuId.REGEX_IS_MATCH_REGEX:this.writeMethodCall(t,"test",r[0]);break;case FuId.MATCH_FIND_STR:case FuId.MATCH_FIND_REGEX:s>FuPriority.EQUALITY&&this.writeChar(40),this.writeChar(40),t.accept(this,FuPriority.ASSIGN),this.write(" = "),i.id==FuId.MATCH_FIND_STR?this.#eh(r,1):r[1].accept(this,FuPriority.PRIMARY),this.writeCall(".exec",r[0]),this.write(") != null"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.MATCH_GET_CAPTURE:this.writeIndexing(t,r[0]);break;case FuId.JSON_ELEMENT_PARSE:this.writeCall("JSON.parse",r[0]);break;case FuId.JSON_ELEMENT_IS_OBJECT:s>FuPriority.EQUALITY&&this.writeChar(40),this.writePostfix(t,"?.constructor == Object"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.JSON_ELEMENT_IS_ARRAY:this.writeCall("Array.isArray",t);break;case FuId.JSON_ELEMENT_IS_STRING:this.#th(t,"string",s);break;case FuId.JSON_ELEMENT_IS_NUMBER:this.#th(t,"number",s);break;case FuId.JSON_ELEMENT_IS_BOOLEAN:this.#th(t,"boolean",s);break;case FuId.JSON_ELEMENT_IS_NULL:s>FuPriority.EQUALITY&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" === null"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.JSON_ELEMENT_GET_OBJECT:case FuId.JSON_ELEMENT_GET_ARRAY:case FuId.JSON_ELEMENT_GET_STRING:case FuId.JSON_ELEMENT_GET_DOUBLE:case FuId.JSON_ELEMENT_GET_BOOLEAN:t.accept(this,s);break;case FuId.MATH_ABS:this.writeCall(r[0].type.id==FuId.LONG_TYPE?"(x => x < 0n ? -x : x)":"Math.abs",r[0]);break;case FuId.MATH_CEILING:this.writeCall("Math.ceil",r[0]);break;case FuId.MATH_CLAMP:GenJsNoModule.#ih(r)?(this.write("((x, min, max) => x < min ? min : x > max ? max : x)"),this.writeInParentheses(r)):(this.write("Math.min(Math.max("),this.writeClampAsMinMax(r));break;case FuId.MATH_FUSED_MULTIPLY_ADD:s>FuPriority.ADD&&this.writeChar(40),r[0].accept(this,FuPriority.MUL),this.write(" * "),r[1].accept(this,FuPriority.MUL),this.write(" + "),r[2].accept(this,FuPriority.ADD),s>FuPriority.ADD&&this.writeChar(41);break;case FuId.MATH_IS_FINITE:case FuId.MATH_IS_NA_N:this.writeCamelCase(i.name),this.writeInParentheses(r);break;case FuId.MATH_IS_INFINITY:s>FuPriority.EQUALITY&&this.writeChar(40),this.writeCall("Math.abs",r[0]),this.write(" == Infinity"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.MATH_MAX:this.#rh(i,"Math.max",62,r);break;case FuId.MATH_MIN:this.#rh(i,"Math.min",60,r);break;case FuId.MATH_TRUNCATE:this.writeCall("Math.trunc",r[0]);break;default:this.notSupported(t,i.name)}}writeAssign(e,t){let i,r;(i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&r.class.id==FuId.ORDERED_DICTIONARY_CLASS?this.writeMethodCall(i.left,"set",i.right,e.right):super.writeAssign(e,t)}writeOpAssignRight(e){this.writeCoerced(e.left.type,e.right,FuPriority.ARGUMENT)}writeIndexingExpr(e,t){let i;(i=e.left.type)instanceof FuClassType&&i.class.id==FuId.ORDERED_DICTIONARY_CLASS?this.writeMethodCall(e.left,"get",e.right):super.writeIndexingExpr(e,t)}getIsOperator(){return" instanceof "}writeBoolAndOr(e){this.write("!!"),super.visitBinaryExpr(e,FuPriority.PRIMARY)}#sh(e,t){e.right.accept(this,t),this.writeCharLine(41),this.writeChar(9),e.left.accept(this,FuPriority.ASSIGN)}#Za(e,t,i,r){r>FuPriority.REL&&this.writeChar(40),null!=t?(this.writeChar(40),this.#ba(t),this.write(" = "),e.accept(this,FuPriority.ARGUMENT),this.writeChar(41)):e.accept(this,FuPriority.REL),this.write(" instanceof "),this.write(i.name),r>FuPriority.REL&&this.writeChar(41)}visitBinaryExpr(e,t){let i;e.op==FuToken.SLASH&&e.type instanceof FuIntegerType&&e.type.id!=FuId.LONG_TYPE?(t>FuPriority.OR&&this.writeChar(40),e.left.accept(this,FuPriority.MUL),this.write(" / "),e.right.accept(this,FuPriority.PRIMARY),this.write(" | 0"),t>FuPriority.OR&&this.writeChar(41)):e.op==FuToken.DIV_ASSIGN&&e.type instanceof FuIntegerType&&e.type.id!=FuId.LONG_TYPE?(t>FuPriority.ASSIGN&&this.writeChar(40),e.left.accept(this,FuPriority.ASSIGN),this.write(" = "),e.left.accept(this,FuPriority.MUL),this.write(" / "),e.right.accept(this,FuPriority.PRIMARY),this.write(" | 0"),t>FuPriority.ASSIGN&&this.writeChar(41)):e.op==FuToken.AND&&e.type.id==FuId.BOOL_TYPE||e.op==FuToken.OR&&e.type.id==FuId.BOOL_TYPE?this.writeBoolAndOr(e):e.op==FuToken.XOR&&e.type.id==FuId.BOOL_TYPE?this.writeEqual(e.left,e.right,t,!0):e.op==FuToken.AND_ASSIGN&&e.type.id==FuId.BOOL_TYPE?(this.write("if (!"),this.#sh(e,FuPriority.PRIMARY),this.write(" = false")):e.op==FuToken.OR_ASSIGN&&e.type.id==FuId.BOOL_TYPE?(this.write("if ("),this.#sh(e,FuPriority.ARGUMENT),this.write(" = true")):e.op==FuToken.XOR_ASSIGN&&e.type.id==FuId.BOOL_TYPE?(e.left.accept(this,FuPriority.ASSIGN),this.write(" = "),this.writeEqual(e.left,e.right,FuPriority.ARGUMENT,!0)):e.op==FuToken.IS&&(i=e.right)instanceof FuVar?this.#Za(e.left,i.name,i.type,t):super.visitBinaryExpr(e,t)}visitLambdaExpr(e){this.writeName(e.first),this.write(" => "),GenJsNoModule.hasTemporaries(e.body)?(this.openBlock(),this.writeTemporaries(e.body),this.write("return "),e.body.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59),this.closeBlock()):e.body.accept(this,FuPriority.STATEMENT)}startTemporaryVar(e){throw new Error}defineObjectLiteralTemporary(e){}writeAsType(e){}#ah(e,t){this.write(e.isAssigned?"let ":"const "),this.#ba(e.name),this.write(" = "),t.accept(this,FuPriority.ARGUMENT),this.writeAsType(e),this.writeCharLine(59)}writeAssertCast(e){let t=e.right;this.#ah(t,e.left)}writeAssert(e){e.completesNormally()?(this.writeTemporaries(e.cond),this.write("console.assert("),e.cond.accept(this,FuPriority.ARGUMENT),null!=e.message&&(this.write(", "),e.message.accept(this,FuPriority.ARGUMENT))):(this.write("throw new Error("),null!=e.message&&e.message.accept(this,FuPriority.ARGUMENT)),this.writeLine(");")}startBreakGoto(){this.write("break fuswitch")}visitForeach(e){this.write("for (const ");let t=e.collection.type;switch(t.class.id){case FuId.STRING_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:case FuId.HASH_SET_CLASS:this.writeName(e.getVar()),this.write(" of "),e.collection.accept(this,FuPriority.ARGUMENT);break;case FuId.SORTED_SET_CLASS:if(this.writeName(e.getVar()),this.write(" of "),t.getElementType()instanceof FuNumericType){const e=t.getElementType();this.write("new "),this.writeArrayElementType(e),this.write("Array(")}else t.getElementType()instanceof FuEnum?this.write("new Int32Array("):this.write("Array.from(");e.collection.accept(this,FuPriority.ARGUMENT),this.write(").sort()");break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:case FuId.ORDERED_DICTIONARY_CLASS:if(this.writeChar(91),this.writeName(e.getVar()),this.write(", "),this.writeName(e.getValueVar()),this.write("] of "),t.class.id==FuId.ORDERED_DICTIONARY_CLASS)e.collection.accept(this,FuPriority.ARGUMENT);else if(this.writeCall("Object.entries",e.collection),e.getVar().type instanceof FuStringType)t.class.id==FuId.SORTED_DICTIONARY_CLASS&&this.write(".sort((a, b) => a[0].localeCompare(b[0]))");else{if(!(e.getVar().type instanceof FuNumericType||e.getVar().type instanceof FuEnum))throw new Error;this.write(".map(e => [+e[0], e[1]])"),t.class.id==FuId.SORTED_DICTIONARY_CLASS&&this.write(".sort((a, b) => a[0] - b[0])")}break;default:throw new Error}this.writeChar(41),this.writeChild(e.body)}visitLock(e){this.notSupported(e,"'lock'")}writeSwitchCaseCond(e,t,i){let r;if((r=t)instanceof FuSymbolReference&&r.symbol instanceof FuClass)this.#Za(e.value,null,r.symbol,i);else if(t instanceof FuVar){const r=t;this.#Za(e.value,i==FuPriority.COND_AND?r.name:null,r.type,i)}else super.writeSwitchCaseCond(e,t,i)}writeIfCaseBody(e,t,i,r){let s;null!=r&&(s=r.values[0])instanceof FuVar?(this.writeChar(32),this.openBlock(),this.#ah(s,i.value),this.writeFirstStatements(r.body,FuSwitch.lengthWithoutTrailingBreak(r.body)),this.closeBlock()):super.writeIfCaseBody(e,t,i,r)}visitSwitch(e){e.isTypeMatching()||e.hasWhen()?e.cases.some((e=>FuSwitch.hasEarlyBreak(e.body)))||FuSwitch.hasEarlyBreak(e.defaultBody)?(this.write("fuswitch"),this.visitLiteralLong(BigInt(this.switchesWithGoto.length)),this.switchesWithGoto.push(e),this.write(": "),this.openBlock(),this.writeSwitchAsIfs(e,!1),this.closeBlock()):this.writeSwitchAsIfs(e,!1):super.visitSwitch(e)}writeException(){this.write("Error")}startContainerType(e){this.writeNewLine(),this.writeDoc(e.documentation)}visitEnumValue(e,t){null!=t&&this.writeCharLine(44),this.writeDoc(e.documentation),this.writeUppercaseWithUnderscores(e.name),this.write(" : "),this.visitLiteralLong(BigInt(e.value.intValue()))}writeEnum(e){this.startContainerType(e),this.write("const "),this.write(e.name),this.write(" = "),this.openBlock(),e.acceptValues(this),this.writeNewLine(),this.closeBlock()}writeConst(e){(e.visibility!=FuVisibility.PRIVATE||e.type instanceof FuArrayStorageType)&&(this.writeNewLine(),this.writeDoc(e.documentation),this.write("static "),this.writeName(e),this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT),this.writeCharLine(59))}writeField(e){this.writeDoc(e.documentation),super.writeVar(e),this.writeCharLine(59)}writeMethod(e){e.callType!=FuCallType.ABSTRACT&&(this.writeNewLine(),this.writeMethodDoc(e),e.callType==FuCallType.STATIC&&this.write("static "),this.writeName(e),this.writeParameters(e,!0),this.writeBody(e))}openJsClass(e){this.openClass(e,""," extends "),e.id==FuId.EXCEPTION_CLASS&&(this.write('name = "'),this.write(e.name),this.writeLine('";'))}writeConstructor(e){this.writeLine("constructor()"),this.openBlock(),e.parent instanceof FuClass&&this.writeLine("super();"),this.writeConstructorBody(e),this.closeBlock()}writeClass(e,t){this.writeBaseClass(e,t)&&(this.startContainerType(e),this.openJsClass(e),this.needsConstructor(e)&&(null!=e.constructor_&&this.writeDoc(e.constructor_.documentation),this.writeConstructor(e)),this.writeMembers(e,!0),this.closeBlock())}#bn(e){this.writeNewLine(),e.type.id==FuId.INT_TYPE&&this.write("process.exit("),this.write(e.parent.name),this.write(".main("),1==e.parameters.count()&&this.write("process.argv.slice(2)"),e.type.id==FuId.INT_TYPE&&this.writeChar(41),this.writeCharLine(41)}writeLib(e){if(this.#qi&&(this.writeNewLine(),this.writeLine("class StringWriter"),this.openBlock(),this.writeLine('#buf = "";'),this.writeNewLine(),this.writeLine("write(s)"),this.openBlock(),this.writeLine("this.#buf += s;"),this.closeBlock(),this.writeNewLine(),this.writeLine("clear()"),this.openBlock(),this.writeLine('this.#buf = "";'),this.closeBlock(),this.writeNewLine(),this.writeLine("toString()"),this.openBlock(),this.writeLine("return this.#buf;"),this.closeBlock(),this.closeBlock()),Object.keys(e.resources).length>0){this.writeNewLine(),this.writeLine("class Fu"),this.openBlock();for(const[t,i]of Object.entries(e.resources).sort(((e,t)=>e[0].localeCompare(t[0]))))this.write("static "),this.writeResourceName(t),this.writeLine(" = new Uint8Array(["),this.writeChar(9),this.writeBytes(i),this.writeLine(" ]);");this.writeNewLine(),this.closeBlock()}null!=e.main&&this.#bn(e.main)}writeUseStrict(){this.writeNewLine(),this.writeLine('"use strict";')}writeProgram(e,t,i){this.createFile(null,t),this.writeUseStrict(),this.writeTopLevelNatives(e),this.writeTypes(e),this.writeLib(e),this.closeFile()}}export class GenJs extends GenJsNoModule{startContainerType(e){super.startContainerType(e),e.isPublic&&this.write("export ")}writeUseStrict(){}}export class GenTs extends GenJs{#nh;#hh=!1;getTargetName(){return"TypeScript"}withGenFullCode(){return this.#hh=!0,this}visitEnumValue(e,t){this.writeEnumValue(e),this.writeCharLine(44)}writeEnum(e){this.startContainerType(e),this.write("enum "),this.write(e.name),this.writeChar(32),this.openBlock(),e.acceptValues(this),this.closeBlock()}writeTypeAndName(e){this.writeName(e),this.write(": "),this.#oh(e.type)}#oh(e,t=!1){if(e instanceof FuNumericType)this.write(e.id==FuId.LONG_TYPE?"bigint":"number");else if(e instanceof FuEnum){const t=e;this.write(t.id==FuId.BOOL_TYPE?"boolean":t.name)}else if(e instanceof FuClassType){const i=e;if(i instanceof FuReadWriteClassType||(t=!0),i.class.id==FuId.STRING_CLASS)this.write("string");else if((i.class.id!=FuId.ARRAY_PTR_CLASS||i.getElementType()instanceof FuNumericType)&&(i.class.id!=FuId.ARRAY_STORAGE_CLASS||i.getElementType()instanceof FuNumericType)&&i.class.id!=FuId.LIST_CLASS&&i.class.id!=FuId.QUEUE_CLASS&&i.class.id!=FuId.STACK_CLASS){switch(t&&i.class.typeParameterCount>0&&this.write("Readonly<"),i.class.id){case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:this.writeArrayElementType(i.getElementType()),this.write("Array");break;case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.write("Set<"),this.#oh(i.getElementType(),!1),this.writeChar(62);break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:i.getKeyType()instanceof FuEnum&&this.write("Partial<"),this.write("Record<"),this.#oh(i.getKeyType()),this.write(", "),this.#oh(i.getValueType()),this.writeChar(62),i.getKeyType()instanceof FuEnum&&this.writeChar(62);break;case FuId.ORDERED_DICTIONARY_CLASS:this.write("Map<"),this.#oh(i.getKeyType()),this.write(", "),this.#oh(i.getValueType()),this.writeChar(62);break;case FuId.REGEX_CLASS:this.write("RegExp");break;case FuId.MATCH_CLASS:this.write("RegExpMatchArray");break;case FuId.JSON_ELEMENT_CLASS:this.write("any");break;default:this.write(i.class.name)}t&&i.class.typeParameterCount>0&&this.writeChar(62)}else t&&this.write("readonly "),i.getElementType().nullable&&this.writeChar(40),this.#oh(i.getElementType()),i.getElementType().nullable&&this.writeChar(41),this.write("[]");e.nullable&&this.write(" | null")}else this.write(e.name)}writeAsType(e){this.write(" as "),this.write(e.type.name)}writeBinaryOperand(e,t,i){let r=i.type;e.type instanceof FuNumericType&&i.isRel()&&(r=this.#nh.promoteNumericTypes(i.left.type,i.right.type)),this.writeCoerced(r,e,t)}writeEqualOperand(e,t){e.type instanceof FuNumericType?this.writeCoerced(this.#nh.promoteNumericTypes(e.type,t.type),e,FuPriority.EQUALITY):e.accept(this,FuPriority.EQUALITY)}writeBoolAndOr(e){this.write("[ "),e.left.accept(this,FuPriority.ARGUMENT),this.write(", "),e.right.accept(this,FuPriority.ARGUMENT),this.write(" ]."),this.write(e.op==FuToken.AND?"every":"some"),this.write("(Boolean)")}defineIsVar(e){let t;(t=e.right)instanceof FuVar&&(this.ensureChildBlock(),this.write("let "),this.writeName(t),this.write(": "),this.#oh(e.left.type),this.endStatement())}#ln(e){switch(e){case FuVisibility.PRIVATE:case FuVisibility.INTERNAL:break;case FuVisibility.PROTECTED:this.write("protected ");break;case FuVisibility.PUBLIC:this.write("public ");break;default:throw new Error}}writeConst(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),this.write("static readonly "),this.writeName(e),this.write(": "),this.#oh(e.type,!0),this.#hh&&(this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT)),this.writeCharLine(59)}writeField(e){this.writeDoc(e.documentation),this.#ln(e.visibility),e.type.isFinal()&&!e.isAssignableStorage()&&this.write("readonly "),this.writeTypeAndName(e),this.#hh&&this.writeVarInit(e),this.writeCharLine(59)}writeMethod(e){switch(this.writeNewLine(),this.writeMethodDoc(e),this.#ln(e.visibility),e.callType){case FuCallType.STATIC:this.write("static ");break;case FuCallType.VIRTUAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.OVERRIDE:case FuCallType.NORMAL:case FuCallType.SEALED:break;default:throw new Error}this.writeName(e),this.writeChar(40);let t=0;for(let i=e.firstParameter();null!=i;i=i.nextVar())t>0&&this.write(", "),this.writeName(i),null==i.value||this.#hh||this.writeChar(63),this.write(": "),this.#oh(i.type),null!=i.value&&this.#hh&&this.writeVarInit(i),t++;this.write("): "),this.#oh(e.type),this.#hh?this.writeBody(e):this.writeCharLine(59)}writeClass(e,t){if(this.writeBaseClass(e,t)){switch(this.startContainerType(e),e.callType){case FuCallType.NORMAL:break;case FuCallType.ABSTRACT:this.write("abstract ");break;case FuCallType.STATIC:case FuCallType.SEALED:break;default:throw new Error}this.openJsClass(e),(this.needsConstructor(e)||e.callType==FuCallType.STATIC)&&(null!=e.constructor_?(this.writeDoc(e.constructor_.documentation),this.#ln(e.constructor_.visibility)):e.callType==FuCallType.STATIC&&this.write("private "),this.#hh?this.writeConstructor(e):this.writeLine("constructor();")),this.writeMembers(e,this.#hh),this.closeBlock()}}writeProgram(e,t,i){this.#nh=e.system,this.createFile(null,t),this.#hh&&this.writeTopLevelNatives(e),this.writeTypes(e),this.#hh&&this.writeLib(e),this.closeFile()}}export class GenPySwift extends GenBase{writeDocPara(e,t){t&&(this.writeNewLine(),this.startDocLine(),this.writeNewLine(),this.startDocLine());for(const t of e.children)if(t instanceof FuDocText){const e=t;this.write(e.text)}else if(t instanceof FuDocCode){const e=t;this.writeChar(96),this.writeDocCode(e.text),this.writeChar(96)}else{if(!(t instanceof FuDocLine))throw new Error;this.writeNewLine(),this.startDocLine()}}writeDocList(e){this.writeNewLine();for(const t of e.items)this.write(this.getDocBullet()),this.writeDocPara(t,!1),this.writeNewLine();this.startDocLine()}writeLocalName(e,t){let i;(i=e)instanceof FuMember&&(i.isStatic()?this.writeName(this.currentMethod.parent):this.write("self"),this.writeChar(46)),this.writeName(e)}visitAggregateInitializer(e){this.write("[ "),this.writeCoercedLiterals(e.type.asClassType().getElementType(),e.items),this.write(" ]")}visitPrefixExpr(e,t){switch(e.op){case FuToken.INCREMENT:case FuToken.DECREMENT:e.inner.accept(this,t);break;default:super.visitPrefixExpr(e,t)}}visitPostfixExpr(e,t){switch(e.op){case FuToken.INCREMENT:case FuToken.DECREMENT:e.inner.accept(this,t);break;default:super.visitPostfixExpr(e,t)}}static#uh(e){let t;return(t=e.type)instanceof FuClassType&&t.class.id!=FuId.STRING_CLASS&&!(t instanceof FuStorageType)}writeEqual(e,t,i,r){GenPySwift.#uh(e)||GenPySwift.#uh(t)?this.writeEqualExpr(e,t,i,this.getReferenceEqOp(r)):super.writeEqual(e,t,i,r)}writeExpr(e,t){e.accept(this,t)}writeElementCoerced(e,t){this.writeCoerced(e,t,FuPriority.ARGUMENT)}writeListAppend(e,t){this.writePostfix(e,".append(");let i=e.type.asClassType().getElementType();0==t.length?this.writeNewStorage(i):this.writeElementCoerced(i,t[0]),this.writeChar(41)}visitPreCall(e){return!1}visitXcrement(e,t,i){let r;if(e instanceof FuVar){const r=e;return null!=r.value&&this.visitXcrement(r.value,t,i)}if(e instanceof FuAggregateInitializer||e instanceof FuLiteral||e instanceof FuLambdaExpr)return!1;if(e instanceof FuInterpolatedString){const s=e;r=!1;for(const e of s.parts)this.visitXcrement(e.argument,t,i)&&(r=!0);return r}if(e instanceof FuSymbolReference){const r=e;return null!=r.left&&this.visitXcrement(r.left,t,i)}if(e instanceof FuUnaryExpr){const s=e;return null!=s.inner&&(r=this.visitXcrement(s.inner,t,i),s.op!=FuToken.INCREMENT&&s.op!=FuToken.DECREMENT||t!=s instanceof FuPostfixExpr||(i&&(this.writeExpr(s.inner,FuPriority.ASSIGN),this.writeLine(s.op==FuToken.INCREMENT?" += 1":" -= 1")),r=!0),r)}if(e instanceof FuBinaryExpr){const s=e;return r=this.visitXcrement(s.left,t,i),s.op==FuToken.IS?r:(s.op==FuToken.COND_AND||s.op==FuToken.COND_OR?console.assert(!this.visitXcrement(s.right,t,!1)):this.visitXcrement(s.right,t,i)&&(r=!0),r)}if(e instanceof FuSelectExpr){const s=e;return r=this.visitXcrement(s.cond,t,i),console.assert(!this.visitXcrement(s.onTrue,t,!1)),console.assert(!this.visitXcrement(s.onFalse,t,!1)),r}if(e instanceof FuCallExpr){const s=e;r=this.visitXcrement(s.method,t,i);for(const e of s.arguments_)this.visitXcrement(e,t,i)&&(r=!0);return t||this.visitPreCall(s)&&(r=!0),r}throw new Error}visitExpr(e){let t;if(this.visitXcrement(e,!1,!0),!((t=e)instanceof FuUnaryExpr)||t.op!=FuToken.INCREMENT&&t.op!=FuToken.DECREMENT){let t;this.writeExpr(e,FuPriority.STATEMENT),this.writeNewLine(),(t=e)instanceof FuVar&&this.writeInitCode(t)}this.visitXcrement(e,!0,!0),this.cleanupTemporaries()}endStatement(){this.writeNewLine()}writeChild(e){this.openChild(),e.acceptStatement(this),this.closeChild()}visitBlock(e){this.writeStatements(e.statements)}#ch(e,t,i){return this.visitXcrement(t,!1,!0),this.write(e),this.writeExpr(t,i),this.openChild(),this.visitXcrement(t,!0,!0)}writeContinueDoWhile(e){this.#ch("if ",e,FuPriority.ARGUMENT),this.writeLine("continue"),this.closeChild(),this.visitXcrement(e,!0,!0),this.writeLine("break")}needCondXcrement(e){return null!=e.cond}#lh(e){let t;if((t=e)instanceof FuFor){if(t.isRange)return;this.visitOptionalStatement(t.advance)}this.needCondXcrement(e)&&this.visitXcrement(e.cond,!1,!0)}visitContinue(e){let t;(t=e.loop)instanceof FuDoWhile?this.writeContinueDoWhile(t.cond):(this.#lh(e.loop),this.writeLine("continue"))}#wh(){this.write("while "),this.visitLiteralTrue(),this.openChild()}visitDoWhile(e){this.#wh(),e.body.acceptStatement(this),e.body.completesNormally()&&(this.#ch(this.getIfNot(),e.cond,FuPriority.PRIMARY),this.writeLine("break"),this.closeChild(),this.visitXcrement(e.cond,!0,!0)),this.closeChild()}openWhile(e){this.#ch("while ",e.cond,FuPriority.ARGUMENT)}#Th(e){e.body.acceptStatement(this),e.body.completesNormally()&&this.#lh(e),this.closeChild(),this.needCondXcrement(e)&&(e.hasBreak&&this.visitXcrement(e.cond,!0,!1)?(this.write("else"),this.openChild(),this.visitXcrement(e.cond,!0,!0),this.closeChild()):this.visitXcrement(e.cond,!0,!0))}visitFor(e){if(e.isRange){let t=e.init;this.write("for "),e.isIndVarUsed?this.writeName(t):this.writeChar(95),this.write(" in ");let i=e.cond;this.writeForRange(t,i,e.rangeStep),this.writeChild(e.body)}else this.visitOptionalStatement(e.init),null!=e.cond?this.openWhile(e):this.#wh(),this.#Th(e)}visitIf(e){let t=this.#ch("if ",e.cond,FuPriority.ARGUMENT);if(e.onTrue.acceptStatement(this),this.closeChild(),null==e.onFalse&&t&&!e.onTrue.completesNormally())this.visitXcrement(e.cond,!0,!0);else if(null!=e.onFalse||t){let i;!t&&(i=e.onFalse)instanceof FuIf&&!this.visitXcrement(i.cond,!1,!1)?(this.writeElseIf(),this.visitIf(i)):(this.write("else"),this.openChild(),this.visitXcrement(e.cond,!0,!0),this.visitOptionalStatement(e.onFalse),this.closeChild())}}visitReturn(e){null==e.value?this.writeLine("return"):(this.visitXcrement(e.value,!1,!0),this.writeTemporaries(e.value),this.visitXcrement(e.value,!0,!1)?(this.writeResultVar(),this.write(" = "),this.writeCoercedExpr(this.currentMethod.type,e.value),this.writeNewLine(),this.visitXcrement(e.value,!0,!0),this.writeLine("return result")):(this.write("return "),this.writeCoercedExpr(this.currentMethod.type,e.value),this.writeNewLine()),this.cleanupTemporaries())}visitWhile(e){this.openWhile(e),this.#Th(e)}}export class GenSwift extends GenPySwift{#nh;#dh;#ph;#Fh;#Ir;#Er;#Eh=[];#yh=[];getTargetName(){return"Swift"}startDocLine(){this.write("/// ")}writeDocCode(e){this.write("null"==e?"nil":e)}getDocBullet(){return"/// * "}writeDoc(e){null!=e&&this.writeContent(e)}#ba(e){switch(e){case"this":this.write("self");break;case"As":case"Associatedtype":case"Await":case"Break":case"Case":case"Catch":case"Class":case"Continue":case"Default":case"Defer":case"Deinit":case"Do":case"Else":case"Enum":case"Extension":case"Fallthrough":case"False":case"Fileprivate":case"For":case"Foreach":case"Func":case"Guard":case"If":case"Import":case"In":case"Init":case"Inout":case"Int":case"Internal":case"Is":case"Let":case"Nil":case"Operator":case"Private":case"Protocol":case"Public":case"Repeat":case"Rethrows":case"Return":case"Self":case"Static":case"Struct":case"Switch":case"Subscript":case"Super":case"Throw":case"Throws":case"True":case"Try":case"Typealias":case"Var":case"Void":case"Where":case"While":case"as":case"associatedtype":case"await":case"catch":case"defer":case"deinit":case"extension":case"fallthrough":case"fileprivate":case"func":case"guard":case"import":case"init":case"inout":case"is":case"let":case"nil":case"operator":case"private":case"protocol":case"repeat":case"rethrows":case"self":case"struct":case"subscript":case"super":case"try":case"typealias":case"var":case"where":this.writeCamelCase(e),this.writeChar(95);break;default:this.writeCamelCase(e)}}writeName(e){let t;if(e instanceof FuContainerType)this.write(e.name);else if((t=e)instanceof FuConst&&null!=t.inMethod)this.writeCamelCase(t.inMethod.name),this.writePascalCase(e.name),t.inMethodIndex>0&&this.visitLiteralLong(BigInt(t.inMethodIndex));else{if(!(e instanceof FuVar||e instanceof FuMember))throw new Error;this.#ba(e.name)}}writeLocalName(e,t){let i;if((i=e.parent)instanceof FuForeach){let t=i.collection.type;if(t.class.id==FuId.STRING_CLASS)return this.write("Int("),this.#ba(e.name),void this.write(".value)");if((e==i.first?t.getElementType():t.getValueType()).id==FuId.INT_TYPE)return this.write("Int("),this.#ba(e.name),void this.writeChar(41)}super.writeLocalName(e,t)}writeMemberOp(e,t){null!=e.type&&e.type.nullable&&this.writeChar(33),this.writeChar(46)}#Ih(e){e.accept(this,FuPriority.PRIMARY),e.type.nullable&&this.writeChar(33),this.writeChar(91)}getTypeId(e,t){return e.id==FuId.INT_TYPE||t&&e instanceof FuRangeType?FuId.N_INT_TYPE:e.id}static#Sh(e){return e.ptrTaken||e.getElementType()instanceof FuStorageType}#Ch(e){this.#ph=!0,this.write("ArrayRef<"),this.#oh(e),this.writeChar(62)}#Ah(e){switch(e.class.id){case FuId.STRING_CLASS:this.write("String");break;case FuId.ARRAY_PTR_CLASS:this.#Ch(e.getElementType());break;case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:case FuId.QUEUE_CLASS:case FuId.STACK_CLASS:this.writeChar(91),this.#oh(e.getElementType()),this.writeChar(93);break;case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.write("Set<"),this.#oh(e.getElementType()),this.writeChar(62);break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.writeChar(91),this.#oh(e.getKeyType()),this.write(": "),this.#oh(e.getValueType()),this.writeChar(93);break;case FuId.ORDERED_DICTIONARY_CLASS:this.notSupported(e,"OrderedDictionary");break;case FuId.JSON_ELEMENT_CLASS:this.write("Any");break;case FuId.LOCK_CLASS:this.include("Foundation"),this.write("NSRecursiveLock");break;default:this.write(e.class.name)}}#oh(e){if(e instanceof FuNumericType)switch(e.id){case FuId.S_BYTE_RANGE:this.write("Int8");break;case FuId.BYTE_RANGE:this.write("UInt8");break;case FuId.SHORT_RANGE:this.write("Int16");break;case FuId.U_SHORT_RANGE:this.write("UInt16");break;case FuId.INT_TYPE:this.write("Int32");break;case FuId.N_INT_TYPE:this.write("Int");break;case FuId.LONG_TYPE:this.write("Int64");break;case FuId.FLOAT_TYPE:this.write("Float");break;case FuId.DOUBLE_TYPE:this.write("Double");break;default:throw new Error}else if(e instanceof FuEnum)this.write(e.id==FuId.BOOL_TYPE?"Bool":e.name);else if(e instanceof FuArrayStorageType){const t=e;GenSwift.#Sh(t)?this.#Ch(t.getElementType()):(this.writeChar(91),this.#oh(t.getElementType()),this.writeChar(93))}else{if(!(e instanceof FuClassType))throw new Error;{const t=e;this.#Ah(t),t.nullable&&this.writeChar(63)}}}#_h(e){e.id==FuId.INT_TYPE?this.write("Int"):this.#oh(e)}writeTypeAndName(e){this.writeName(e),e.type.isFinal()&&!e.isAssignableStorage()||(this.write(": "),this.#_h(e.type))}visitLiteralNull(){this.write("nil")}#fh(e,t,i){if(e.type.nullable)e.accept(this,FuPriority.PRIMARY),this.writeChar(33);else{let r;!i&&(r=e)instanceof FuCallExpr&&r.method.symbol.id==FuId.STRING_SUBSTRING?this.writeCall("String",e):e.accept(this,t)}}visitInterpolatedString(e,t){if(e.parts.some((e=>null!=e.widthExpr||32!=e.format||e.precision>=0)))this.include("Foundation"),this.write("String(format: "),this.writePrintf(e,!1);else{this.writeChar(34);for(const t of e.parts)this.write(t.prefix),this.write("\\("),this.#fh(t.argument,FuPriority.ARGUMENT,!0),this.writeChar(41);this.write(e.suffix),this.writeChar(34)}}static#Rh(e){if(e.type.id!=FuId.INT_TYPE)return!1;let t;return(t=e)instanceof FuUnaryExpr&&(t.op==FuToken.INCREMENT||t.op==FuToken.DECREMENT)&&(e=t.inner),e.isIndexing()}writeCoercedInternal(e,t,i){if(e instanceof FuNumericType&&!(t instanceof FuLiteral)&&this.getTypeId(e,!1)!=this.getTypeId(t.type,t instanceof FuBinaryExpr&&!t.isIndexing())||GenSwift.#Rh(t)){let i;this.#_h(e),this.writeChar(40),e instanceof FuIntegerType&&(i=t)instanceof FuCallExpr&&i.method.symbol.id==FuId.MATH_TRUNCATE?i.arguments_[0].accept(this,FuPriority.ARGUMENT):t.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}else e.nullable?t.accept(this,i):this.#fh(t,i,!1)}writeStringLength(e){this.#fh(e,FuPriority.PRIMARY,!0),this.write(".count")}writeArrayLength(e,t){this.writePostfix(e,".count")}writeCharAt(e){this.#Fh=!0,this.write("fuStringCharAt("),this.#fh(e.left,FuPriority.ARGUMENT,!1),this.write(", "),e.right.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.MATH_NA_N:this.write("Float.nan");break;case FuId.MATH_NEGATIVE_INFINITY:this.write("-Float.infinity");break;case FuId.MATH_POSITIVE_INFINITY:this.write("Float.infinity");break;default:super.visitSymbolReference(e,t)}}getReferenceEqOp(e){return e?" !== ":" === "}#Lh(e,t,i){this.#fh(e,FuPriority.PRIMARY,!0),this.writeChar(46),this.write(t),this.writeChar(40),this.#fh(i[0],FuPriority.ARGUMENT,!0),this.writeChar(41)}#Nh(e,t){this.writeCoerced(this.#nh.intType,e,FuPriority.SHIFT),this.write("..<"),this.writeAdd(e,t)}writeElementCoerced(e,t){e.id!=FuId.INT_TYPE||GenSwift.#Rh(t)?this.writeCoerced(e,t,FuPriority.ARGUMENT):(this.write("Int32("),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41))}#gh(e){let t=this.#Eh[this.indent];return!t.has(e)&&(t.add(e),!0)}#dn(e,t,i){i>FuPriority.EQUALITY&&this.writeChar(40),e.accept(this,FuPriority.EQUALITY),this.write(" is "),this.write(t),i>FuPriority.EQUALITY&&this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.NONE:case FuId.ARRAY_CONTAINS:case FuId.LIST_CONTAINS:case FuId.LIST_SORT_ALL:case FuId.HASH_SET_CONTAINS:case FuId.HASH_SET_REMOVE:case FuId.SORTED_SET_CONTAINS:case FuId.SORTED_SET_REMOVE:null==t?i.isStatic()&&(this.writeName(this.currentMethod.parent),this.writeChar(46)):GenSwift.isReferenceTo(t,FuId.BASE_PTR)?this.write("super."):(t.accept(this,FuPriority.PRIMARY),this.writeMemberOp(t,null)),this.writeName(i),this.writeCoercedArgsInParentheses(i,r);break;case FuId.CLASS_TO_STRING:t.accept(this,FuPriority.PRIMARY),this.writeMemberOp(t,null),this.write("description");break;case FuId.ENUM_FROM_INT:this.write(e.name),this.write("(rawValue: "),r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ENUM_TO_INT:this.writePostfix(t,".rawValue");break;case FuId.ENUM_HAS_FLAG:this.writeMethodCall(t,"contains",r[0]);break;case FuId.STRING_CONTAINS:this.#Lh(t,"contains",r);break;case FuId.STRING_ENDS_WITH:this.#Lh(t,"hasSuffix",r);break;case FuId.STRING_INDEX_OF:this.include("Foundation"),this.#Ir=!0,this.write("fuStringIndexOf("),this.#fh(t,FuPriority.ARGUMENT,!0),this.write(", "),this.#fh(r[0],FuPriority.ARGUMENT,!0),this.writeChar(41);break;case FuId.STRING_LAST_INDEX_OF:this.include("Foundation"),this.#Ir=!0,this.write("fuStringIndexOf("),this.#fh(t,FuPriority.ARGUMENT,!0),this.write(", "),this.#fh(r[0],FuPriority.ARGUMENT,!0),this.write(", .backwards)");break;case FuId.STRING_REPLACE:this.#fh(t,FuPriority.PRIMARY,!0),this.write(".replacingOccurrences(of: "),this.#fh(r[0],FuPriority.ARGUMENT,!0),this.write(", with: "),this.#fh(r[1],FuPriority.ARGUMENT,!0),this.writeChar(41);break;case FuId.STRING_STARTS_WITH:this.#Lh(t,"hasPrefix",r);break;case FuId.STRING_SUBSTRING:r[0].isLiteralZero()?this.#fh(t,FuPriority.PRIMARY,!0):(this.#Er=!0,this.write("fuStringSubstring("),this.#fh(t,FuPriority.ARGUMENT,!1),this.write(", "),this.writeCoerced(this.#nh.intType,r[0],FuPriority.ARGUMENT),this.writeChar(41)),2==r.length&&(this.write(".prefix("),this.writeCoerced(this.#nh.intType,r[1],FuPriority.ARGUMENT),this.writeChar(41));break;case FuId.STRING_TO_LOWER:this.writePostfix(t,".lowercased()");break;case FuId.STRING_TO_UPPER:this.writePostfix(t,".uppercased()");break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:this.#Ih(r[1]),this.#Nh(r[2],r[3]),this.write("] = "),this.#Ih(t),this.#Nh(r[0],r[3]),this.writeChar(93);break;case FuId.ARRAY_FILL_ALL:let a;t.accept(this,FuPriority.ASSIGN),(a=t.type)instanceof FuArrayStorageType&&!GenSwift.#Sh(a)?(this.write(" = ["),this.#oh(a.getElementType()),this.write("](repeating: "),this.writeCoerced(a.getElementType(),r[0],FuPriority.ARGUMENT),this.write(", count: "),this.visitLiteralLong(BigInt(a.length)),this.writeChar(41)):(this.write(".fill("),this.writeElementCoerced(t.type.asClassType().getElementType(),r[0]),this.writeChar(41));break;case FuId.ARRAY_FILL_PART:let n;(n=t.type)instanceof FuArrayStorageType&&!GenSwift.#Sh(n)?(this.#Ih(t),this.#Nh(r[1],r[2]),this.write("] = ArraySlice(repeating: "),this.writeCoerced(n.getElementType(),r[0],FuPriority.ARGUMENT),this.write(", count: "),this.writeCoerced(this.#nh.intType,r[2],FuPriority.ARGUMENT),this.writeChar(41)):(t.accept(this,FuPriority.PRIMARY),this.writeMemberOp(t,null),this.write("fill("),this.writeElementCoerced(t.type.asClassType().getElementType(),r[0]),this.write(", "),this.writeCoerced(this.#nh.intType,r[1],FuPriority.ARGUMENT),this.write(", "),this.writeCoerced(this.#nh.intType,r[2],FuPriority.ARGUMENT),this.writeChar(41));break;case FuId.ARRAY_SORT_ALL:this.writePostfix(t,"[0..<");let h=t.type;this.visitLiteralLong(BigInt(h.length)),this.write("].sort()");break;case FuId.ARRAY_SORT_PART:case FuId.LIST_SORT_PART:this.#Ih(t),this.#Nh(r[0],r[1]),this.write("].sort()");break;case FuId.LIST_ADD:case FuId.QUEUE_ENQUEUE:case FuId.STACK_PUSH:this.writeListAppend(t,r);break;case FuId.LIST_ADD_RANGE:t.accept(this,FuPriority.ASSIGN),this.write(" += "),r[0].accept(this,FuPriority.ARGUMENT);break;case FuId.LIST_ALL:this.writePostfix(t,".allSatisfy "),r[0].accept(this,FuPriority.ARGUMENT);break;case FuId.LIST_ANY:this.writePostfix(t,".contains "),r[0].accept(this,FuPriority.ARGUMENT);break;case FuId.LIST_CLEAR:case FuId.QUEUE_CLEAR:case FuId.STACK_CLEAR:case FuId.HASH_SET_CLEAR:case FuId.SORTED_SET_CLEAR:case FuId.DICTIONARY_CLEAR:case FuId.SORTED_DICTIONARY_CLEAR:this.writePostfix(t,".removeAll()");break;case FuId.LIST_INDEX_OF:s>FuPriority.REL&&this.writeChar(40),this.writePostfix(t,".firstIndex(of: "),r[0].accept(this,FuPriority.ARGUMENT),this.write(") ?? -1"),s>FuPriority.REL&&this.writeChar(41);break;case FuId.LIST_INSERT:this.writePostfix(t,".insert(");let o=t.type.asClassType().getElementType();1==r.length?this.writeNewStorage(o):this.writeCoerced(o,r[1],FuPriority.ARGUMENT),this.write(", at: "),this.writeCoerced(this.#nh.intType,r[0],FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.LIST_LAST:case FuId.STACK_PEEK:this.writePostfix(t,".last");break;case FuId.LIST_REMOVE_AT:this.writePostfix(t,".remove(at: "),this.writeCoerced(this.#nh.intType,r[0],FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.LIST_REMOVE_RANGE:this.writePostfix(t,".removeSubrange("),this.#Nh(r[0],r[1]),this.writeChar(41);break;case FuId.QUEUE_DEQUEUE:this.writePostfix(t,".removeFirst()");break;case FuId.QUEUE_PEEK:this.writePostfix(t,".first");break;case FuId.STACK_POP:this.writePostfix(t,".removeLast()");break;case FuId.HASH_SET_ADD:case FuId.SORTED_SET_ADD:this.writePostfix(t,".insert("),this.writeCoerced(t.type.asClassType().getElementType(),r[0],FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.DICTIONARY_ADD:this.writeDictionaryAdd(t,r);break;case FuId.DICTIONARY_CONTAINS_KEY:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:s>FuPriority.EQUALITY&&this.writeChar(40),this.writeIndexing(t,r[0]),this.write(" != nil"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.DICTIONARY_REMOVE:case FuId.SORTED_DICTIONARY_REMOVE:this.writePostfix(t,".removeValue(forKey: "),r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.CONSOLE_WRITE:this.write("print("),this.#fh(r[0],FuPriority.ARGUMENT,!0),this.write(', terminator: "")');break;case FuId.CONSOLE_WRITE_LINE:this.write("print("),1==r.length&&this.#fh(r[0],FuPriority.ARGUMENT,!0),this.writeChar(41);break;case FuId.CONVERT_TO_BASE64_STRING:this.write("Data("),this.#Ih(r[0]),this.#Nh(r[1],r[2]),this.write("]).base64EncodedString()");break;case FuId.U_T_F8_GET_BYTE_COUNT:this.#fh(r[0],FuPriority.PRIMARY,!0),this.write(".utf8.count");break;case FuId.U_T_F8_GET_BYTES:this.#gh("fubytes")&&this.write(this.#yh[this.indent]?"var ":"let "),this.write("fubytes = [UInt8]("),this.#fh(r[0],FuPriority.PRIMARY,!0),this.writeLine(".utf8)"),this.#Ih(r[1]),this.writeCoerced(this.#nh.intType,r[2],FuPriority.SHIFT),r[2].isLiteralZero()?this.write("..<"):(this.write(" ..< "),this.writeCoerced(this.#nh.intType,r[2],FuPriority.ADD),this.write(" + ")),this.writeLine("fubytes.count] = fubytes[...]");break;case FuId.U_T_F8_GET_STRING:this.write("String(decoding: "),this.#Ih(r[0]),this.#Nh(r[1],r[2]),this.write("], as: UTF8.self)");break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.include("Foundation"),this.write("ProcessInfo.processInfo.environment["),this.#fh(r[0],FuPriority.ARGUMENT,!1),this.writeChar(93);break;case FuId.JSON_ELEMENT_PARSE:this.include("Foundation"),this.write("try! JSONSerialization.jsonObject(with: "),this.writePostfix(r[0],".data(using: .utf8)!, options: .fragmentsAllowed)");break;case FuId.JSON_ELEMENT_IS_OBJECT:this.#dn(t,"[String: Any]",s);break;case FuId.JSON_ELEMENT_IS_ARRAY:this.#dn(t,"[Any]",s);break;case FuId.JSON_ELEMENT_IS_STRING:this.#dn(t,"String",s);break;case FuId.JSON_ELEMENT_IS_NUMBER:this.#dn(t,"Double",s);break;case FuId.JSON_ELEMENT_IS_BOOLEAN:this.#dn(t,"Bool",s);break;case FuId.JSON_ELEMENT_IS_NULL:this.#dn(t,"NSNull",s);break;case FuId.JSON_ELEMENT_GET_OBJECT:case FuId.JSON_ELEMENT_GET_ARRAY:case FuId.JSON_ELEMENT_GET_STRING:case FuId.JSON_ELEMENT_GET_DOUBLE:case FuId.JSON_ELEMENT_GET_BOOLEAN:s>FuPriority.EQUALITY&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" as! "),this.#oh(e),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.MATH_METHOD:case FuId.MATH_LOG2:this.include("Foundation"),this.writeCamelCase(i.name),this.writeInParentheses(r);break;case FuId.MATH_ABS:case FuId.MATH_MAX:case FuId.MATH_MIN:this.writeCamelCase(i.name),this.writeInParentheses(r);break;case FuId.MATH_CEILING:this.include("Foundation"),this.writeCall("ceil",r[0]);break;case FuId.MATH_CLAMP:this.write("min(max("),this.writeClampAsMinMax(r);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.include("Foundation"),this.writeCall("fma",r[0],r[1],r[2]);break;case FuId.MATH_IS_FINITE:this.writePostfix(r[0],".isFinite");break;case FuId.MATH_IS_INFINITY:this.writePostfix(r[0],".isInfinite");break;case FuId.MATH_IS_NA_N:this.writePostfix(r[0],".isNaN");break;case FuId.MATH_ROUND:this.writePostfix(r[0],".rounded()");break;case FuId.MATH_TRUNCATE:this.include("Foundation"),this.writeCall("trunc",r[0]);break;default:this.notSupported(t,i.name)}}writeNewArrayStorage(e){GenSwift.#Sh(e)?super.writeNewArrayStorage(e):(this.writeChar(91),this.#oh(e.getElementType()),this.write("](repeating: "),this.#mh(e.getElementType()),this.write(", count: "),this.visitLiteralLong(BigInt(e.length)),this.writeChar(41))}writeNew(e,t){this.#Ah(e),this.write("()")}#mh(e){if(e instanceof FuNumericType)this.writeChar(48);else if(e instanceof FuEnum){const t=e;t.id==FuId.BOOL_TYPE?this.write("false"):(this.writeName(t),this.writeChar(46),this.writeName(t.getFirstValue()))}else if(e instanceof FuStringType&&!e.nullable)this.write('""');else if(e instanceof FuArrayStorageType){const t=e;this.writeNewArrayStorage(t)}else this.write("nil")}writeNewArray(e,t,i){if(this.#Ch(e),this.writeChar(40),e instanceof FuArrayStorageType)this.write("factory: { "),this.writeNewStorage(e),this.write(" }");else if(e instanceof FuStorageType){const t=e;this.write("factory: "),this.writeName(t.class),this.write(".init")}else this.write("repeating: "),this.#mh(e);this.write(", count: "),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}visitPrefixExpr(e,t){e.op==FuToken.TILDE&&e.type instanceof FuEnumFlags?(this.write(e.type.name),this.write("(rawValue: ~"),this.writePostfix(e.inner,".rawValue)")):super.visitPrefixExpr(e,t)}writeIndexingExpr(e,t){this.#Ih(e.left);let i,r,s=e.left.type;switch(s.class.id){case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:i=this.#nh.intType;break;default:i=s.getKeyType()}this.writeCoerced(i,e.right,FuPriority.ARGUMENT),this.writeChar(93),t!=FuPriority.ASSIGN&&(r=e.left.type)instanceof FuClassType&&2==r.class.typeParameterCount&&this.writeChar(33)}writeBinaryOperand(e,t,i){if(e.type.id!=FuId.BOOL_TYPE){if(i.op==FuToken.PLUS&&i.type.id==FuId.STRING_STORAGE_TYPE)return void this.#fh(e,t,!0);if(i.op==FuToken.PLUS||i.op==FuToken.MINUS||i.op==FuToken.ASTERISK||i.op==FuToken.SLASH||i.op==FuToken.MOD||i.op==FuToken.AND||i.op==FuToken.OR||i.op==FuToken.XOR||i.op==FuToken.SHIFT_LEFT&&e==i.left||i.op==FuToken.SHIFT_RIGHT&&e==i.left){if(!(e instanceof FuLiteral)){let r=this.#nh.promoteNumericTypes(i.left.type,i.right.type);if(r!=e.type||GenSwift.#Rh(e))return void this.writeCoerced(r,e,t)}}else if(i.op==FuToken.EQUAL||i.op==FuToken.NOT_EQUAL||i.op==FuToken.LESS||i.op==FuToken.LESS_OR_EQUAL||i.op==FuToken.GREATER||i.op==FuToken.GREATER_OR_EQUAL){let r=this.#nh.promoteFloatingTypes(i.left.type,i.right.type);if(null!=r&&r!=e.type)return void this.writeCoerced(r,e,t)}}e.accept(this,t)}#Ph(e,t,i,r){let s;(s=r)instanceof FuPrefixExpr&&s.op==FuToken.TILDE?this.writeMethodCall(e,i,s.inner):this.writeMethodCall(e,t,r)}#kh(e){let t;return(t=e.right)instanceof FuBinaryExpr&&t.isAssign()?(this.visitBinaryExpr(t,FuPriority.STATEMENT),this.writeNewLine(),t.left):e.right}#bh(e,t){if(e.left.accept(this,FuPriority.ASSIGN),this.writeChar(32),this.write(e.getOpString()),this.writeChar(32),GenSwift.#Rh(e.left))GenSwift.#Rh(t)?t.accept(this,FuPriority.ARGUMENT):(this.write("Int32("),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41));else{let i,r;t instanceof FuLiteralNull&&(i=e.left)instanceof FuBinaryExpr&&i.op==FuToken.LEFT_BRACKET&&(r=i.left.type)instanceof FuClassType&&2==r.class.typeParameterCount?(this.#oh(r.getValueType()),this.write(".none")):this.writeCoerced(e.type,t,FuPriority.ARGUMENT)}}visitBinaryExpr(e,t){let i;switch(e.op){case FuToken.SHIFT_LEFT:this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.PRIMARY," << ",FuPriority.PRIMARY);break;case FuToken.SHIFT_RIGHT:this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.PRIMARY," >> ",FuPriority.PRIMARY);break;case FuToken.AND:e.type.id==FuId.BOOL_TYPE?this.writeCall("{ a, b in a && b }",e.left,e.right):e.type instanceof FuEnumFlags?this.#Ph(e.left,"intersection","subtracting",e.right):this.writeBinaryExpr(e,t>FuPriority.MUL,FuPriority.MUL," & ",FuPriority.PRIMARY);break;case FuToken.OR:e.type.id==FuId.BOOL_TYPE?this.writeCall("{ a, b in a || b }",e.left,e.right):e.type instanceof FuEnumFlags?this.writeMethodCall(e.left,"union",e.right):this.writeBinaryExpr(e,t>FuPriority.ADD,FuPriority.ADD," | ",FuPriority.MUL);break;case FuToken.XOR:e.type.id==FuId.BOOL_TYPE?this.writeEqual(e.left,e.right,t,!0):e.type instanceof FuEnumFlags?this.writeMethodCall(e.left,"symmetricDifference",e.right):this.writeBinaryExpr(e,t>FuPriority.ADD,FuPriority.ADD," ^ ",FuPriority.MUL);break;case FuToken.ASSIGN:case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:this.#bh(e,this.#kh(e));break;case FuToken.AND_ASSIGN:if(i=this.#kh(e),e.type.id==FuId.BOOL_TYPE){let t;this.write("if "),(t=i)instanceof FuPrefixExpr&&t.op==FuToken.EXCLAMATION_MARK?t.inner.accept(this,FuPriority.ARGUMENT):(this.writeChar(33),i.accept(this,FuPriority.PRIMARY)),this.openChild(),e.left.accept(this,FuPriority.ASSIGN),this.writeLine(" = false"),this.indent--,this.writeChar(125)}else e.type instanceof FuEnumFlags?this.#Ph(e.left,"formIntersection","subtract",i):this.#bh(e,i);break;case FuToken.OR_ASSIGN:i=this.#kh(e),e.type.id==FuId.BOOL_TYPE?(this.write("if "),i.accept(this,FuPriority.ARGUMENT),this.openChild(),e.left.accept(this,FuPriority.ASSIGN),this.writeLine(" = true"),this.indent--,this.writeChar(125)):e.type instanceof FuEnumFlags?this.writeMethodCall(e.left,"formUnion",i):this.#bh(e,i);break;case FuToken.XOR_ASSIGN:i=this.#kh(e),e.type.id==FuId.BOOL_TYPE?(e.left.accept(this,FuPriority.ASSIGN),this.write(" = "),e.left.accept(this,FuPriority.EQUALITY),this.write(" != "),e.right.accept(this,FuPriority.EQUALITY)):e.type instanceof FuEnumFlags?this.writeMethodCall(e.left,"formSymmetricDifference",i):this.#bh(e,i);break;default:super.visitBinaryExpr(e,t)}}writeResource(e,t){this.write("FuResource."),this.writeResourceName(e)}static#Oh(e){if(e instanceof FuVar||e instanceof FuLiteral||e instanceof FuLambdaExpr)return!1;if(e instanceof FuAggregateInitializer){return e.items.some((e=>GenSwift.#Oh(e)))}if(e instanceof FuInterpolatedString){return e.parts.some((e=>GenSwift.#Oh(e.argument)))}if(e instanceof FuSymbolReference){const t=e;return null!=t.left&&GenSwift.#Oh(t.left)}if(e instanceof FuUnaryExpr){const t=e;return null!=t.inner&&GenSwift.#Oh(t.inner)}if(e instanceof FuBinaryExpr){const t=e;return GenSwift.#Oh(t.left)||GenSwift.#Oh(t.right)}if(e instanceof FuSelectExpr){const t=e;return GenSwift.#Oh(t.cond)||GenSwift.#Oh(t.onTrue)||GenSwift.#Oh(t.onFalse)}if(e instanceof FuCallExpr){const t=e;return t.method.symbol.throws.length>0||null!=t.method.left&&GenSwift.#Oh(t.method.left)||t.arguments_.some((e=>GenSwift.#Oh(e)))}throw new Error}writeExpr(e,t){GenSwift.#Oh(e)&&this.write("try "),super.writeExpr(e,t)}writeCoercedExpr(e,t){GenSwift.#Oh(t)&&this.write("try "),super.writeCoercedExpr(e,t)}startTemporaryVar(e){this.write("var ")}visitExpr(e){let t;this.writeTemporaries(e),(t=e)instanceof FuCallExpr&&e.type.id!=FuId.VOID_TYPE&&this.write("_ = "),super.visitExpr(e)}#Mh(){for(;this.#Eh.length<=this.indent;)this.#Eh.push(new Set),this.#yh.push(!1);this.#Eh[this.indent].clear(),this.#yh[this.indent]=!1}openChild(){this.writeChar(32),this.openBlock(),this.#Mh()}closeChild(){this.closeBlock()}writeVar(e){if(e instanceof FuField||this.#gh(e.name)){let t,i,r;this.write(((t=e.type)instanceof FuArrayStorageType?GenSwift.#Sh(t):(i=e.type)instanceof FuStorageType?0==i.class.typeParameterCount&&!e.isAssignableStorage():(r=e)instanceof FuVar&&!r.isAssigned)?"let ":"var "),super.writeVar(e)}else this.writeName(e),this.writeVarInit(e)}static#Dh(e){let t=0;for(const i of e){let e;if((e=i)instanceof FuCallExpr&&e.method.symbol.id==FuId.U_T_F8_GET_BYTES&&2==++t)return!0}return!1}writeStatements(e){this.#yh[this.indent]=GenSwift.#Dh(e),super.writeStatements(e)}visitLambdaExpr(e){this.write("{ "),this.writeName(e.first),this.write(" in "),e.body.accept(this,FuPriority.STATEMENT),this.write(" }")}writeAssertCast(e){this.write("let ");let t=e.right;this.#ba(t.name),this.write(" = "),e.left.accept(this,FuPriority.EQUALITY),this.write(" as! "),this.writeLine(t.type.name)}writeAssert(e){this.write("assert("),this.writeExpr(e.cond,FuPriority.ARGUMENT),null!=e.message&&(this.write(", "),this.writeExpr(e.message,FuPriority.ARGUMENT)),this.writeCharLine(41)}visitBreak(e){this.writeLine("break")}needCondXcrement(e){return!(null==e.cond||e.hasBreak&&this.visitXcrement(e.cond,!0,!1))}getIfNot(){return"if !"}writeContinueDoWhile(e){this.visitXcrement(e,!1,!0),this.writeLine("continue")}visitDoWhile(e){this.visitXcrement(e.cond,!0,!1)?super.visitDoWhile(e):(this.write("repeat"),this.openChild(),e.body.acceptStatement(this),e.body.completesNormally()&&this.visitXcrement(e.cond,!1,!0),this.closeChild(),this.write("while "),this.writeExpr(e.cond,FuPriority.ARGUMENT),this.writeNewLine())}writeElseIf(){this.write("else ")}openWhile(e){this.needCondXcrement(e)?super.openWhile(e):(this.write("while true"),this.openChild(),this.visitXcrement(e.cond,!1,!0),this.write("let fuDoLoop = "),e.cond.accept(this,FuPriority.ARGUMENT),this.writeNewLine(),this.visitXcrement(e.cond,!0,!0),this.write("if !fuDoLoop"),this.openChild(),this.writeLine("break"),this.closeChild())}writeForRange(e,t,i){if(1==i)switch(this.writeExpr(e.value,FuPriority.SHIFT),t.op){case FuToken.LESS:this.write("..<"),t.right.accept(this,FuPriority.SHIFT);break;case FuToken.LESS_OR_EQUAL:this.write("..."),t.right.accept(this,FuPriority.SHIFT);break;default:throw new Error}else{switch(this.write("stride(from: "),this.writeExpr(e.value,FuPriority.ARGUMENT),t.op){case FuToken.LESS:case FuToken.GREATER:this.write(", to: "),this.writeExpr(t.right,FuPriority.ARGUMENT);break;case FuToken.LESS_OR_EQUAL:case FuToken.GREATER_OR_EQUAL:this.write(", through: "),this.writeExpr(t.right,FuPriority.ARGUMENT);break;default:throw new Error}this.write(", by: "),this.visitLiteralLong(i),this.writeChar(41)}}visitForeach(e){this.write("for "),2==e.count()?(this.writeChar(40),this.writeName(e.getVar()),this.write(", "),this.writeName(e.getValueVar()),this.writeChar(41)):this.writeName(e.getVar()),this.write(" in ");let t=e.collection.type;switch(t.class.id){case FuId.STRING_CLASS:this.writePostfix(e.collection,".unicodeScalars");break;case FuId.SORTED_SET_CLASS:this.writePostfix(e.collection,".sorted()");break;case FuId.SORTED_DICTIONARY_CLASS:this.writePostfix(e.collection,t.getKeyType().nullable?".sorted(by: { $0.key! < $1.key! })":".sorted(by: { $0.key < $1.key })");break;default:this.writeExpr(e.collection,FuPriority.ARGUMENT)}this.writeChild(e.body)}visitLock(e){e.lock.accept(this,FuPriority.PRIMARY),this.writeLine(".lock()"),this.write("do"),this.openChild(),this.write("defer { "),e.lock.accept(this,FuPriority.PRIMARY),this.writeLine(".unlock() }"),e.body.acceptStatement(this),this.closeChild()}writeResultVar(){this.write("let result: "),this.#_h(this.currentMethod.type)}#xh(e,t){let i,r,s;if((i=t)instanceof FuSymbolReference&&(r=i.symbol)instanceof FuClass)this.write("is "),this.write(r.name);else if(t instanceof FuVar){const e=t;this.write("let "),this.#ba(e.name),this.write(" as "),this.#_h(e.type)}else(s=t)instanceof FuBinaryExpr&&s.op==FuToken.WHEN?(this.#xh(e,s.left),this.write(" where "),this.writeExpr(s.right,FuPriority.ARGUMENT)):this.writeCoerced(e.value.type,t,FuPriority.ARGUMENT)}#Gh(e,t){this.indent++,this.visitXcrement(e.value,!0,!0),this.#Mh(),this.writeSwitchCaseBody(t),this.indent--}visitSwitch(e){this.visitXcrement(e.value,!1,!0),this.write("switch "),this.writeExpr(e.value,FuPriority.ARGUMENT),this.writeLine(" {");for(const t of e.cases){this.write("case ");for(let i=0;i<t.values.length;i++)this.writeComma(i),this.#xh(e,t.values[i]);this.writeCharLine(58),this.#Gh(e,t.body)}e.defaultBody.length>0&&(this.writeLine("default:"),this.#Gh(e,e.defaultBody)),this.writeCharLine(125)}writeException(){this.write("Error")}visitThrow(e){null!=e.message&&this.visitXcrement(e.message,!1,!0),this.write("throw "),"Exception"==e.class.name?(this.#dh=!0,this.write("FuError.error("),null!=e.message?this.writeExpr(e.message,FuPriority.ARGUMENT):this.write('""')):(this.write(e.class.name),this.writeChar(40)),this.writeCharLine(41)}#Uh(e){this.write("fuParam"),this.writePascalCase(e.name)}writeParameter(e){this.write("_ "),e.isAssigned?this.#Uh(e):this.writeName(e),this.write(": "),this.#_h(e.type)}visitEnumValue(e,t){this.writeDoc(e.documentation),this.write("static let "),this.writeName(e),this.write(" = "),this.write(e.parent.name),this.writeChar(40);let i=e.value.intValue();0==i?this.write("[]"):(this.write("rawValue: "),this.visitLiteralLong(BigInt(i))),this.writeCharLine(41)}writeEnum(e){if(this.writeNewLine(),this.writeDoc(e.documentation),this.writePublic(e),e instanceof FuEnumFlags)this.write("struct "),this.write(e.name),this.writeLine(": OptionSet"),this.openBlock(),this.writeLine("let rawValue: Int"),e.acceptValues(this);else{this.write("enum "),this.write(e.name),e.hasExplicitValue&&this.write(": Int"),this.writeNewLine(),this.openBlock();const t={};for(let i=e.first;null!=i;i=i.next){let e;if((e=i)instanceof FuConst){this.writeDoc(e.documentation);let i=e.value.intValue();t.hasOwnProperty(i)?(this.write("static let "),this.writeName(e),this.write(" = "),this.writeName(t[i])):(this.write("case "),this.writeName(e),e.value instanceof FuImplicitEnumValue||(this.write(" = "),this.visitLiteralLong(BigInt(i))),t[i]=e),this.writeNewLine()}}}this.closeBlock()}#ln(e){switch(e){case FuVisibility.PRIVATE:this.write("private ");break;case FuVisibility.INTERNAL:this.write("fileprivate ");break;case FuVisibility.PROTECTED:case FuVisibility.PUBLIC:this.write("public ");break;default:throw new Error}}writeConst(e){this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),this.write("static let "),this.writeName(e),this.write(" = "),e.type.id==FuId.INT_TYPE||e.type instanceof FuEnum||e.type.id==FuId.STRING_PTR_TYPE?e.value.accept(this,FuPriority.ARGUMENT):(this.#oh(e.type),this.writeChar(40),e.value.accept(this,FuPriority.ARGUMENT),this.writeChar(41)),this.writeNewLine()}writeField(e){let t;this.writeNewLine(),this.writeDoc(e.documentation),this.#ln(e.visibility),(t=e.type)instanceof FuClassType&&t.class.id!=FuId.STRING_CLASS&&!(t instanceof FuOwningType)&&this.write("unowned "),this.writeVar(e),null==e.value&&(e.type instanceof FuNumericType||e.type instanceof FuEnum||e.type.id==FuId.STRING_STORAGE_TYPE)?(this.write(" = "),this.#mh(e.type)):e.isAssignableStorage()&&(this.write(" = "),this.writeName(e.type.asClassType().class),this.write("()")),this.writeNewLine()}writeParameterDoc(e,t){this.write("/// - Parameter "),this.writeName(e),this.write(": "),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeThrowsDoc(e){this.write("/// - Throws: `"),this.writeExceptionClass(e.symbol),this.write("` "),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeMethod(e){switch(this.writeNewLine(),this.writeDoc(e.documentation),this.writeParametersAndThrowsDoc(e),e.callType){case FuCallType.STATIC:this.#ln(e.visibility),this.write("static ");break;case FuCallType.NORMAL:this.#ln(e.visibility);break;case FuCallType.ABSTRACT:case FuCallType.VIRTUAL:this.write(e.visibility==FuVisibility.INTERNAL?"fileprivate ":"open ");break;case FuCallType.OVERRIDE:this.write(e.visibility==FuVisibility.INTERNAL?"fileprivate ":"open "),this.write("override ");break;case FuCallType.SEALED:this.#ln(e.visibility),this.write("final override ")}if(e.id==FuId.CLASS_TO_STRING?this.write("var description: String"):(this.write("func "),this.writeName(e),this.writeParameters(e,!0),e.throws.length>0&&this.write(" throws"),e.type.id!=FuId.VOID_TYPE&&(this.write(" -> "),this.#_h(e.type))),this.writeNewLine(),this.openBlock(),e.callType==FuCallType.ABSTRACT)this.writeLine('preconditionFailure("Abstract method called")');else{for(let t=e.firstParameter();null!=t;t=t.nextVar())t.isAssigned&&(this.write("var "),this.writeTypeAndName(t),this.write(" = "),this.#Uh(t),this.writeNewLine());this.#Mh(),this.currentMethod=e,e.body.acceptStatement(this),this.currentMethod=null}this.closeBlock()}writeClass(e,t){this.writeNewLine(),this.writeDoc(e.documentation),this.writePublic(e),e.callType==FuCallType.SEALED&&this.write("final "),this.startClass(e,"",": "),e.addsToString()&&(this.writeChar(e.hasBaseClass()?44:58),this.write(" CustomStringConvertible")),this.writeNewLine(),this.openBlock(),this.needsConstructor(e)&&(null!=e.constructor_?(this.writeDoc(e.constructor_.documentation),this.#ln(e.constructor_.visibility)):this.write("fileprivate "),e.hasBaseClass()&&this.write("override "),this.writeLine("init()"),this.openBlock(),this.#Mh(),this.writeConstructorBody(e),this.closeBlock()),this.writeMembers(e,!0),this.closeBlock()}#Sa(){this.#dh&&(this.writeNewLine(),this.writeLine("public enum FuError: Error"),this.openBlock(),this.writeLine("case error(String)"),this.closeBlock()),this.#ph&&(this.writeNewLine(),this.writeLine("public class ArrayRef<T>: Sequence"),this.openBlock(),this.writeLine("var array: [T]"),this.writeNewLine(),this.writeLine("init(_ array: [T])"),this.openBlock(),this.writeLine("self.array = array"),this.closeBlock(),this.writeNewLine(),this.writeLine("init(repeating: T, count: Int)"),this.openBlock(),this.writeLine("self.array = [T](repeating: repeating, count: count)"),this.closeBlock(),this.writeNewLine(),this.writeLine("init(factory: () -> T, count: Int)"),this.openBlock(),this.writeLine("self.array = (1...count).map({_ in factory() })"),this.closeBlock(),this.writeNewLine(),this.writeLine("subscript(index: Int) -> T"),this.openBlock(),this.writeLine("get"),this.openBlock(),this.writeLine("return array[index]"),this.closeBlock(),this.writeLine("set(value)"),this.openBlock(),this.writeLine("array[index] = value"),this.closeBlock(),this.closeBlock(),this.writeLine("subscript(bounds: Range<Int>) -> ArraySlice<T>"),this.openBlock(),this.writeLine("get"),this.openBlock(),this.writeLine("return array[bounds]"),this.closeBlock(),this.writeLine("set(value)"),this.openBlock(),this.writeLine("array[bounds] = value"),this.closeBlock(),this.closeBlock(),this.writeNewLine(),this.writeLine("func fill(_ value: T)"),this.openBlock(),this.writeLine("array = [T](repeating: value, count: array.count)"),this.closeBlock(),this.writeNewLine(),this.writeLine("func fill(_ value: T, _ startIndex: Int, _ count: Int)"),this.openBlock(),this.writeLine("array[startIndex ..< startIndex + count] = ArraySlice(repeating: value, count: count)"),this.closeBlock(),this.writeNewLine(),this.writeLine("public func makeIterator() -> IndexingIterator<Array<T>>"),this.openBlock(),this.writeLine("return array.makeIterator()"),this.closeBlock(),this.closeBlock()),this.#Fh&&(this.writeNewLine(),this.writeLine("fileprivate func fuStringCharAt(_ s: String, _ offset: Int) -> Int"),this.openBlock(),this.writeLine("return Int(s.unicodeScalars[s.index(s.startIndex, offsetBy: offset)].value)"),this.closeBlock()),this.#Ir&&(this.writeNewLine(),this.writeLine("fileprivate func fuStringIndexOf<S1: StringProtocol, S2: StringProtocol>(_ haystack: S1, _ needle: S2, _ options: String.CompareOptions = .literal) -> Int"),this.openBlock(),this.writeLine("guard let index = haystack.range(of: needle, options: options) else { return -1 }"),this.writeLine("return haystack.distance(from: haystack.startIndex, to: index.lowerBound)"),this.closeBlock()),this.#Er&&(this.writeNewLine(),this.writeLine("fileprivate func fuStringSubstring(_ s: String, _ offset: Int) -> Substring"),this.openBlock(),this.writeLine("return s[s.index(s.startIndex, offsetBy: offset)...]"),this.closeBlock())}#cn(e){if(0!=Object.keys(e).length){this.#ph=!0,this.writeNewLine(),this.writeLine("fileprivate final class FuResource"),this.openBlock();for(const[t,i]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0]))))this.write("static let "),this.writeResourceName(t),this.writeLine(" = ArrayRef<UInt8>(["),this.writeChar(9),this.writeBytes(i),this.writeLine(" ])");this.closeBlock()}}#bn(e){this.writeNewLine(),e.type.id==FuId.INT_TYPE&&this.write("exit(Int32("),this.write(e.parent.name),this.write(".main("),1==e.parameters.count()&&this.write("Array(CommandLine.arguments[1...])"),e.type.id==FuId.INT_TYPE&&this.write("))"),this.writeCharLine(41)}writeProgram(e,t,i){this.#nh=e.system,this.#dh=!1,this.#ph=!1,this.#Fh=!1,this.#Ir=!1,this.#Er=!1,this.openStringWriter(),this.writeTypes(e),this.createFile(null,t),this.writeTopLevelNatives(e),null!=e.main&&e.main.type.id==FuId.INT_TYPE&&this.include("Foundation"),this.writeIncludes("import ",""),this.closeStringWriter(),this.#Sa(),this.#cn(e.resources),null!=e.main&&this.#bn(e.main),this.closeFile()}}export class GenPy extends GenPySwift{#vh;#Bh;getTargetName(){return"Python"}writeBanner(){this.writeLine('# Generated automatically with "fut". Do not edit.')}startDocLine(){}writeDocCode(e){switch(e){case"true":this.write("True");break;case"false":this.write("False");break;case"null":this.write("None");break;default:this.write(e)}}getDocBullet(){return" * "}#Yh(e){if(this.write('"""'),this.writeDocPara(e.summary,!1),e.details.length>0){this.writeNewLine();for(const t of e.details)this.writeNewLine(),this.writeDocBlock(t,!1)}}writeDoc(e){null!=e&&(this.#Yh(e),this.writeLine('"""'))}writeParameterDoc(e,t){t&&(this.writeNewLine(),this.writeNewLine()),this.write(":param "),this.writeName(e),this.write(": "),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}writeThrowsDoc(e){this.write(":raises "),this.writeExceptionClass(e.symbol),this.write(": "),this.writeDocPara(e.documentation.summary,!1),this.writeNewLine()}#Vh(e){null!=e.documentation&&(this.#Yh(e.documentation),this.writeParametersAndThrowsDoc(e),this.writeLine('"""'))}visitLiteralNull(){this.write("None")}visitLiteralFalse(){this.write("False")}visitLiteralTrue(){this.write("True")}#Hh(e){switch(e){case"this":this.write("self");break;case"And":case"Array":case"As":case"Assert":case"Async":case"Await":case"Bool":case"Break":case"Class":case"Continue":case"Def":case"Del":case"Dict":case"Elif":case"Else":case"Enum":case"Except":case"Finally":case"For":case"From":case"Global":case"If":case"Import":case"In":case"Is":case"Lambda":case"Len":case"List":case"Math":case"Nonlocal":case"Not":case"Or":case"Pass":case"Raise":case"Re":case"Return":case"Str":case"Sys":case"Try":case"While":case"With":case"Yield":case"and":case"array":case"as":case"async":case"await":case"def":case"del":case"dict":case"elif":case"enum":case"except":case"finally":case"from":case"global":case"import":case"is":case"json":case"lambda":case"len":case"list":case"math":case"nonlocal":case"not":case"or":case"pass":case"raise":case"re":case"str":case"sys":case"try":case"with":case"yield":this.writeCamelCase(e),this.writeChar(95);break;default:this.writeLowercaseWithUnderscores(e)}}writeName(e){if(e instanceof FuContainerType){e.isPublic||this.writeChar(95),this.write(e.name)}else if(e instanceof FuConst){const t=e;t.visibility!=FuVisibility.PUBLIC&&this.writeChar(95),this.writeUppercaseConstName(t)}else if(e instanceof FuVar)this.#Hh(e.name);else{if(!(e instanceof FuMember))throw new Error;{const t=e;t.id==FuId.CLASS_TO_STRING?this.write("__str__"):t.visibility==FuVisibility.PUBLIC?this.#Hh(e.name):(this.writeChar(95),this.writeLowercaseWithUnderscores(e.name))}}}#Wh(e){this.writtenTypes.has(e)?this.writeName(e):(this.writeChar(34),this.writeName(e),this.writeChar(34))}#Qh(e,t){this.write(e),this.writeChar(91),this.#Xh(t.getElementType(),t.class.id==FuId.ARRAY_STORAGE_CLASS),2==t.class.typeParameterCount&&(this.write(", "),this.#Xh(t.getValueType())),this.writeChar(93)}#Xh(e,t=!1){if(e instanceof FuIntegerType)this.write("int");else if(e instanceof FuFloatingType)this.write("float");else if(e instanceof FuEnum){const t=e;t.id==FuId.BOOL_TYPE?this.write("bool"):this.#Wh(t)}else{if(!(e instanceof FuClassType))throw new Error;{const i=e;switch(t=t?!(i instanceof FuStorageType):i.nullable,i.class.id){case FuId.NONE:if(t&&!this.writtenTypes.has(i.class))return this.writeChar(34),this.writeName(i.class),void this.write(' | None"');this.#Wh(i.class);break;case FuId.STRING_CLASS:this.write("str"),t=i.nullable;break;case FuId.ARRAY_PTR_CLASS:case FuId.ARRAY_STORAGE_CLASS:case FuId.LIST_CLASS:case FuId.STACK_CLASS:let e;(e=i.getElementType())instanceof FuNumericType?e.id==FuId.BYTE_RANGE?(this.write("bytearray"),i.class.id!=FuId.ARRAY_PTR_CLASS||i instanceof FuReadWriteClassType||this.write(" | bytes")):(this.include("array"),this.write("array.array")):this.#Qh("list",i);break;case FuId.QUEUE_CLASS:this.include("collections"),this.#Qh("collections.deque",i);break;case FuId.PRIORITY_QUEUE_CLASS:this.write("list[tuple["),this.#Xh(i.typeArg1),this.write(", "),this.#Xh(i.typeArg0),this.write("]]");break;case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.#Qh("set",i);break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.#Qh("dict",i);break;case FuId.ORDERED_DICTIONARY_CLASS:this.include("collections"),this.#Qh("collections.OrderedDict",i);break;case FuId.TEXT_WRITER_CLASS:this.include("io"),this.write("io.TextIOBase");break;case FuId.STRING_WRITER_CLASS:this.include("io"),this.write("io.StringIO");break;case FuId.REGEX_CLASS:this.include("re"),this.write("re.Pattern");break;case FuId.MATCH_CLASS:this.include("re"),this.write("re.Match");break;case FuId.JSON_ELEMENT_CLASS:this.write("dict | list | str | float | bool | None");break;case FuId.LOCK_CLASS:this.include("threading"),this.write("threading.RLock");break;default:throw new Error}t&&this.write(" | None")}}}writeTypeAndName(e){this.writeName(e),this.write(": "),this.#Xh(e.type)}writeLocalName(e,t){let i;(i=e.parent)instanceof FuForeach&&i.collection.type instanceof FuStringType?(this.write("ord("),this.#Hh(e.name),this.writeChar(41)):super.writeLocalName(e,t)}static#Kh(e){switch(e.id){case FuId.S_BYTE_RANGE:return 98;case FuId.BYTE_RANGE:return 66;case FuId.SHORT_RANGE:return 104;case FuId.U_SHORT_RANGE:return 72;case FuId.INT_TYPE:return 105;case FuId.N_INT_TYPE:case FuId.LONG_TYPE:return 113;case FuId.FLOAT_TYPE:return 102;case FuId.DOUBLE_TYPE:return 100;default:throw new Error}}visitAggregateInitializer(e){let t;if((t=e.type.getElementType())instanceof FuNumericType){let i=GenPy.#Kh(t);66==i?this.write("bytes("):(this.include("array"),this.write('array.array("'),this.writeChar(i),this.write('", ')),super.visitAggregateInitializer(e),this.writeChar(41)}else super.visitAggregateInitializer(e)}visitInterpolatedString(e,t){this.write('f"');for(const t of e.parts)this.writeDoubling(t.prefix,123),this.writeChar(123),t.argument.accept(this,FuPriority.ARGUMENT),this.writePyFormat(t);this.writeDoubling(e.suffix,123),this.writeChar(34)}visitPrefixExpr(e,t){e.op==FuToken.EXCLAMATION_MARK?(t>FuPriority.COND_AND&&this.writeChar(40),this.write("not "),e.inner.accept(this,FuPriority.OR),t>FuPriority.COND_AND&&this.writeChar(41)):super.visitPrefixExpr(e,t)}getReferenceEqOp(e){return e?" is not ":" is "}writeCharAt(e){this.write("ord("),this.writeIndexingExpr(e,FuPriority.ARGUMENT),this.writeChar(41)}writeStringLength(e){this.writeCall("len",e)}writeArrayLength(e,t){this.writeCall("len",e)}visitSymbolReference(e,t){switch(e.symbol.id){case FuId.CONSOLE_ERROR:this.include("sys"),this.write("sys.stderr");break;case FuId.LIST_COUNT:case FuId.QUEUE_COUNT:case FuId.STACK_COUNT:case FuId.PRIORITY_QUEUE_COUNT:case FuId.HASH_SET_COUNT:case FuId.SORTED_SET_COUNT:case FuId.DICTIONARY_COUNT:case FuId.SORTED_DICTIONARY_COUNT:case FuId.ORDERED_DICTIONARY_COUNT:this.writeStringLength(e.left);break;case FuId.MATH_NA_N:this.include("math"),this.write("math.nan");break;case FuId.MATH_NEGATIVE_INFINITY:this.include("math"),this.write("-math.inf");break;case FuId.MATH_POSITIVE_INFINITY:this.include("math"),this.write("math.inf");break;default:this.writeJavaMatchProperty(e,t)||super.visitSymbolReference(e,t)}}visitBinaryExpr(e,t){switch(e.op){case FuToken.SLASH:if(e.type instanceof FuIntegerType){let i,r,s;(r=e.left)instanceof FuRangeType&&r.min>=0&&(s=e.right)instanceof FuRangeType&&s.min>=0?(t>FuPriority.OR&&this.writeChar(40),i=!0):(this.write("int("),i=!1),e.left.accept(this,FuPriority.MUL),this.write(i?" // ":" / "),e.right.accept(this,FuPriority.PRIMARY),(!i||t>FuPriority.OR)&&this.writeChar(41)}else super.visitBinaryExpr(e,t);break;case FuToken.COND_AND:this.writeBinaryExpr(e,t>FuPriority.COND_AND||t==FuPriority.COND_OR,FuPriority.COND_AND," and ",FuPriority.COND_AND);break;case FuToken.COND_OR:this.writeBinaryExpr2(e,t,FuPriority.COND_OR," or ");break;case FuToken.ASSIGN:if(this.atLineStart){let t;for(let i=e.right;(t=i)instanceof FuBinaryExpr&&t.isAssign();i=t.right)if(t.op!=FuToken.ASSIGN){this.visitBinaryExpr(t,FuPriority.STATEMENT),this.writeNewLine();break}}e.left.accept(this,FuPriority.ASSIGN),this.write(" = ");{let t;((t=e.right)instanceof FuBinaryExpr&&t.isAssign()&&t.op!=FuToken.ASSIGN?t.left:e.right).accept(this,FuPriority.ASSIGN)}break;case FuToken.ADD_ASSIGN:case FuToken.SUB_ASSIGN:case FuToken.MUL_ASSIGN:case FuToken.DIV_ASSIGN:case FuToken.MOD_ASSIGN:case FuToken.SHIFT_LEFT_ASSIGN:case FuToken.SHIFT_RIGHT_ASSIGN:case FuToken.AND_ASSIGN:case FuToken.OR_ASSIGN:case FuToken.XOR_ASSIGN:{let t,i=e.right;(t=i)instanceof FuBinaryExpr&&t.isAssign()&&(this.visitBinaryExpr(t,FuPriority.STATEMENT),this.writeNewLine(),i=t.left),e.left.accept(this,FuPriority.ASSIGN),this.writeChar(32),e.op==FuToken.DIV_ASSIGN&&e.type instanceof FuIntegerType&&this.writeChar(47),this.write(e.getOpString()),this.writeChar(32),i.accept(this,FuPriority.ARGUMENT)}break;case FuToken.IS:let i;(i=e.right)instanceof FuSymbolReference?(this.write("isinstance("),e.left.accept(this,FuPriority.ARGUMENT),this.write(", "),this.writeName(i.symbol),this.writeChar(41)):this.notSupported(e,"'is' with a variable");break;default:super.visitBinaryExpr(e,t)}}writeCoercedSelect(e,t,i){i>FuPriority.SELECT&&this.writeChar(40),this.writeCoerced(e,t.onTrue,FuPriority.SELECT),this.write(" if "),t.cond.accept(this,FuPriority.SELECT_COND),this.write(" else "),this.writeCoerced(e,t.onFalse,FuPriority.SELECT),i>FuPriority.SELECT&&this.writeChar(41)}#mh(e){if(e instanceof FuNumericType)this.writeChar(48);else{let t;(t=e)instanceof FuEnum?e.id==FuId.BOOL_TYPE?this.visitLiteralFalse():(this.writeName(t),this.writeChar(46),this.writeUppercaseWithUnderscores(t.getFirstValue().name)):e.id==FuId.STRING_PTR_TYPE&&!e.nullable||e.id==FuId.STRING_STORAGE_TYPE?this.write('""'):this.write("None")}}#jh(e,t,i){if(e instanceof FuStorageType)this.write("[ "),this.writeNewStorage(e),this.write(" for _ in range("),i.accept(this,FuPriority.ARGUMENT),this.write(") ]");else if(e instanceof FuNumericType){let r=GenPy.#Kh(e);66!=r||null!=t&&!t.isLiteralZero()?(this.include("array"),this.write('array.array("'),this.writeChar(r),this.write('", [ '),null==t?this.writeChar(48):t.accept(this,FuPriority.ARGUMENT),this.write(" ]) * "),i.accept(this,FuPriority.MUL)):this.writeCall("bytearray",i)}else this.write("[ "),null==t?this.#mh(e):t.accept(this,FuPriority.ARGUMENT),this.write(" ] * "),i.accept(this,FuPriority.MUL)}writeNewArray(e,t,i){this.#jh(e,null,t)}writeArrayStorageInit(e,t){this.write(" = "),this.#jh(e.getElementType(),null,e.lengthExpr)}writeNew(e,t){switch(e.class.id){case FuId.LIST_CLASS:case FuId.STACK_CLASS:let t;if((t=e.getElementType())instanceof FuNumericType){let e=GenPy.#Kh(t);66==e?this.write("bytearray()"):(this.include("array"),this.write('array.array("'),this.writeChar(e),this.write('")'))}else this.write("[]");break;case FuId.QUEUE_CLASS:this.include("collections"),this.write("collections.deque()");break;case FuId.PRIORITY_QUEUE_CLASS:this.write("[]");break;case FuId.HASH_SET_CLASS:case FuId.SORTED_SET_CLASS:this.write("set()");break;case FuId.DICTIONARY_CLASS:case FuId.SORTED_DICTIONARY_CLASS:this.write("{}");break;case FuId.ORDERED_DICTIONARY_CLASS:this.include("collections"),this.write("collections.OrderedDict()");break;case FuId.STRING_WRITER_CLASS:this.include("io"),this.write("io.StringIO()");break;case FuId.LOCK_CLASS:this.include("threading"),this.write("threading.RLock()");break;default:this.writeName(e.class),this.write("()")}}#Jh(e,t){t.accept(this,FuPriority.REL),this.write(" in "),e.accept(this,FuPriority.REL)}#gn(e,t){this.writeChar(91),e.accept(this,FuPriority.ARGUMENT),this.writeChar(58),null!=t&&this.writeAdd(e,t),this.writeChar(93)}#qh(e,t){this.write(" = ");let i=GenPy.#Kh(e.type.asClassType().getElementType());66==i?(this.write(t),this.writeChar(40)):(this.include("array"),this.write('array.array("'),this.writeChar(i),this.write('", ')),this.write("sorted(")}#zh(e,t,i){this.write(e),this.writeChar(40);let r=i[0];r.body.accept(this,FuPriority.ARGUMENT),this.write(" for "),this.writeName(r.first),this.write(" in "),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41)}#$h(e){this.include("re"),this.writeRegexOptions(e,", "," | ","","re.I","re.M","re.S")}#Zh(e){this.write("re.search("),e[1].accept(this,FuPriority.ARGUMENT),this.write(", "),e[0].accept(this,FuPriority.ARGUMENT),this.#$h(e),this.writeChar(41)}#dn(e,t){this.write("isinstance("),e.accept(this,FuPriority.ARGUMENT),this.write(", "),this.write(t),this.writeChar(41)}writeCallExpr(e,t,i,r,s){switch(i.id){case FuId.ENUM_FROM_INT:this.writeName(e),this.writeInParentheses(r);break;case FuId.ENUM_TO_INT:this.writePostfix(t,".value");break;case FuId.ENUM_HAS_FLAG:case FuId.STRING_CONTAINS:case FuId.ARRAY_CONTAINS:case FuId.LIST_CONTAINS:case FuId.HASH_SET_CONTAINS:case FuId.SORTED_SET_CONTAINS:case FuId.DICTIONARY_CONTAINS_KEY:case FuId.SORTED_DICTIONARY_CONTAINS_KEY:case FuId.ORDERED_DICTIONARY_CONTAINS_KEY:this.#Jh(t,r[0]);break;case FuId.STRING_ENDS_WITH:this.writeMethodCall(t,"endswith",r[0]);break;case FuId.STRING_INDEX_OF:this.writeMethodCall(t,"find",r[0]);break;case FuId.STRING_LAST_INDEX_OF:this.writeMethodCall(t,"rfind",r[0]);break;case FuId.STRING_STARTS_WITH:this.writeMethodCall(t,"startswith",r[0]);break;case FuId.STRING_SUBSTRING:t.accept(this,FuPriority.PRIMARY),this.#gn(r[0],2==r.length?r[1]:null);break;case FuId.STRING_TO_LOWER:this.writePostfix(t,".lower()");break;case FuId.STRING_TO_UPPER:this.writePostfix(t,".upper()");break;case FuId.ARRAY_BINARY_SEARCH_ALL:this.include("bisect"),this.writeCall("bisect.bisect_left",t,r[0]);break;case FuId.ARRAY_BINARY_SEARCH_PART:this.include("bisect"),this.write("bisect.bisect_left("),t.accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write(", "),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.ARRAY_COPY_TO:case FuId.LIST_COPY_TO:r[1].accept(this,FuPriority.PRIMARY),this.#gn(r[2],r[3]),this.write(" = "),t.accept(this,FuPriority.PRIMARY),this.#gn(r[0],r[3]);break;case FuId.ARRAY_FILL_ALL:case FuId.ARRAY_FILL_PART:if(t.accept(this,FuPriority.PRIMARY),1==r.length){this.write("[:] = ");let e=t.type;this.#jh(e.getElementType(),r[0],e.lengthExpr)}else this.#gn(r[1],r[2]),this.write(" = "),this.#jh(t.type.asClassType().getElementType(),r[0],r[2]);break;case FuId.ARRAY_SORT_ALL:case FuId.LIST_SORT_ALL:t.accept(this,FuPriority.ASSIGN),this.#qh(t,"bytearray"),t.accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.ARRAY_SORT_PART:case FuId.LIST_SORT_PART:t.accept(this,FuPriority.PRIMARY),this.#gn(r[0],r[1]),this.#qh(t,"bytes"),t.accept(this,FuPriority.PRIMARY),this.#gn(r[0],r[1]),this.write("))");break;case FuId.LIST_ADD:this.writeListAdd(t,"append",r);break;case FuId.LIST_ADD_RANGE:t instanceof FuSymbolReference?(t.accept(this,FuPriority.ASSIGN),this.write(" += "),r[0].accept(this,FuPriority.ARGUMENT)):this.writeMethodCall(t,"extend",r[0]);break;case FuId.LIST_ALL:this.#zh("all",t,r);break;case FuId.LIST_ANY:this.#zh("any",t,r);break;case FuId.LIST_CLEAR:case FuId.STACK_CLEAR:let a;(a=t.type.asClassType().getElementType())instanceof FuNumericType&&66!=GenPy.#Kh(a)?(this.write("del "),this.writePostfix(t,"[:]")):this.writePostfix(t,".clear()");break;case FuId.LIST_INDEX_OF:s>FuPriority.SELECT&&this.writeChar(40),this.writeMethodCall(t,"index",r[0]),this.write(" if "),this.#Jh(t,r[0]),this.write(" else -1"),s>FuPriority.SELECT&&this.writeChar(41);break;case FuId.LIST_INSERT:this.writeListInsert(t,"insert",r);break;case FuId.LIST_LAST:case FuId.STACK_PEEK:this.writePostfix(t,"[-1]");break;case FuId.LIST_REMOVE_AT:case FuId.DICTIONARY_REMOVE:case FuId.SORTED_DICTIONARY_REMOVE:case FuId.ORDERED_DICTIONARY_REMOVE:this.write("del "),this.writeIndexing(t,r[0]);break;case FuId.LIST_REMOVE_RANGE:this.write("del "),t.accept(this,FuPriority.PRIMARY),this.#gn(r[0],r[1]);break;case FuId.QUEUE_DEQUEUE:this.writePostfix(t,".popleft()");break;case FuId.QUEUE_ENQUEUE:case FuId.STACK_PUSH:this.writeListAppend(t,r);break;case FuId.QUEUE_PEEK:this.writePostfix(t,"[0]");break;case FuId.PRIORITY_QUEUE_CLEAR:this.writePostfix(t,".clear()");break;case FuId.PRIORITY_QUEUE_DEQUEUE:this.include("heapq"),this.write("heapq.heappop("),t.accept(this,FuPriority.ARGUMENT),this.write(")[1]");break;case FuId.PRIORITY_QUEUE_ENQUEUE:this.include("heapq"),this.write("heapq.heappush("),t.accept(this,FuPriority.ARGUMENT),this.write(", ("),r[1].accept(this,FuPriority.ARGUMENT),this.write(", "),r[0].accept(this,FuPriority.ARGUMENT),this.write("))");break;case FuId.PRIORITY_QUEUE_PEEK:this.writePostfix(t,"[0][1]");break;case FuId.DICTIONARY_ADD:this.writeDictionaryAdd(t,r);break;case FuId.TEXT_WRITER_WRITE:this.write("print("),r[0].accept(this,FuPriority.ARGUMENT),this.write(', end="", file='),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_CHAR:case FuId.TEXT_WRITER_WRITE_CODE_POINT:this.writeMethodCall(t,"write(chr",r[0]),this.writeChar(41);break;case FuId.TEXT_WRITER_WRITE_LINE:this.write("print("),1==r.length&&(r[0].accept(this,FuPriority.ARGUMENT),this.write(", ")),this.write("file="),t.accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.CONSOLE_WRITE:this.write("print("),r[0].accept(this,FuPriority.ARGUMENT),this.write(', end="")');break;case FuId.CONSOLE_WRITE_LINE:this.write("print("),1==r.length&&r[0].accept(this,FuPriority.ARGUMENT),this.writeChar(41);break;case FuId.STRING_WRITER_CLEAR:this.writePostfix(t,".seek(0)"),this.writeNewLine(),this.writePostfix(t,".truncate(0)");break;case FuId.STRING_WRITER_TO_STRING:this.writePostfix(t,".getvalue()");break;case FuId.CONVERT_TO_BASE64_STRING:this.include("base64"),this.write("base64.b64encode("),r[0].accept(this,FuPriority.PRIMARY),this.#gn(r[1],r[2]),this.write(').decode("utf8")');break;case FuId.U_T_F8_GET_BYTE_COUNT:this.write("len("),this.writePostfix(r[0],'.encode("utf8"))');break;case FuId.U_T_F8_GET_BYTES:this.write("fubytes = "),r[0].accept(this,FuPriority.PRIMARY),this.writeLine('.encode("utf8")'),r[1].accept(this,FuPriority.PRIMARY),this.writeChar(91),r[2].accept(this,FuPriority.ARGUMENT),this.writeChar(58),this.startAdd(r[2]),this.writeLine("len(fubytes)] = fubytes");break;case FuId.U_T_F8_GET_STRING:r[0].accept(this,FuPriority.PRIMARY),this.#gn(r[1],r[2]),this.write('.decode("utf8")');break;case FuId.ENVIRONMENT_GET_ENVIRONMENT_VARIABLE:this.include("os"),this.writeCall("os.getenv",r[0]);break;case FuId.REGEX_COMPILE:this.write("re.compile("),r[0].accept(this,FuPriority.ARGUMENT),this.#$h(r),this.writeChar(41);break;case FuId.REGEX_ESCAPE:this.include("re"),this.writeCall("re.escape",r[0]);break;case FuId.REGEX_IS_MATCH_STR:s>FuPriority.EQUALITY&&this.writeChar(40),this.#Zh(r),this.write(" is not None"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.REGEX_IS_MATCH_REGEX:s>FuPriority.EQUALITY&&this.writeChar(40),this.writeMethodCall(t,"search",r[0]),this.write(" is not None"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.MATCH_FIND_STR:case FuId.MATCH_FIND_REGEX:s>FuPriority.EQUALITY&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" is not None"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.MATCH_GET_CAPTURE:this.writeMethodCall(t,"group",r[0]);break;case FuId.JSON_ELEMENT_PARSE:this.include("json"),this.writeCall("json.loads",r[0]);break;case FuId.JSON_ELEMENT_IS_OBJECT:this.#dn(t,"dict");break;case FuId.JSON_ELEMENT_IS_ARRAY:this.#dn(t,"list");break;case FuId.JSON_ELEMENT_IS_STRING:this.#dn(t,"str");break;case FuId.JSON_ELEMENT_IS_NUMBER:this.#dn(t,"float");break;case FuId.JSON_ELEMENT_IS_BOOLEAN:this.#dn(t,"bool");break;case FuId.JSON_ELEMENT_IS_NULL:s>FuPriority.EQUALITY&&this.writeChar(40),t.accept(this,FuPriority.EQUALITY),this.write(" is None"),s>FuPriority.EQUALITY&&this.writeChar(41);break;case FuId.JSON_ELEMENT_GET_OBJECT:case FuId.JSON_ELEMENT_GET_ARRAY:case FuId.JSON_ELEMENT_GET_STRING:case FuId.JSON_ELEMENT_GET_DOUBLE:case FuId.JSON_ELEMENT_GET_BOOLEAN:t.accept(this,s);break;case FuId.MATH_METHOD:case FuId.MATH_IS_FINITE:case FuId.MATH_IS_NA_N:case FuId.MATH_LOG2:this.include("math"),this.write("math."),this.writeLowercase(i.name),this.writeInParentheses(r);break;case FuId.MATH_ABS:this.writeCall("abs",r[0]);break;case FuId.MATH_CEILING:this.include("math"),this.writeCall("math.ceil",r[0]);break;case FuId.MATH_CLAMP:this.write("min(max("),this.writeClampAsMinMax(r);break;case FuId.MATH_FUSED_MULTIPLY_ADD:this.include("math"),this.writeCall("math.fma",r[0],r[1],r[2]);break;case FuId.MATH_IS_INFINITY:this.include("math"),this.writeCall("math.isinf",r[0]);break;case FuId.MATH_MAX:this.writeCall("max",r[0],r[1]);break;case FuId.MATH_MIN:this.writeCall("min",r[0],r[1]);break;case FuId.MATH_ROUND:this.writeCall("round",r[0]);break;case FuId.MATH_TRUNCATE:this.include("math"),this.writeCall("math.trunc",r[0]);break;default:if(null==t)this.writeLocalName(i,FuPriority.PRIMARY);else{if(GenPy.isReferenceTo(t,FuId.BASE_PTR)){this.writeName(i.parent),this.writeChar(46),this.writeName(i),this.write("(self"),r.length>0&&(this.write(", "),this.writeCoercedArgs(i,r)),this.writeChar(41);break}t.accept(this,FuPriority.PRIMARY),this.writeChar(46),this.writeName(i)}this.writeCoercedArgsInParentheses(i,r)}}writeResource(e,t){this.write("_FuResource."),this.writeResourceName(e)}visitPreCall(e){switch(e.method.symbol.id){case FuId.MATCH_FIND_STR:return e.method.left.accept(this,FuPriority.ASSIGN),this.write(" = "),this.#Zh(e.arguments_),this.writeNewLine(),!0;case FuId.MATCH_FIND_REGEX:return e.method.left.accept(this,FuPriority.ASSIGN),this.write(" = "),this.writeMethodCall(e.arguments_[1],"search",e.arguments_[0]),this.writeNewLine(),!0;default:return!1}}startTemporaryVar(e){}hasInitCode(e){return e.type instanceof FuArrayStorageType||(e.type.isFinal()?!(e.value instanceof FuLiteralNull):null!=e.value)}visitExpr(e){let t;(t=e)instanceof FuVar&&!this.hasInitCode(t)||(this.writeTemporaries(e),super.visitExpr(e))}startLine(){super.startLine(),this.#vh=!1}openChild(){this.writeCharLine(58),this.indent++,this.#vh=!0}closeChild(){this.#vh&&this.writeLine("pass"),this.indent--}visitLambdaExpr(e){throw new Error}writeAssertCast(e){let t=e.right;this.writeTypeAndName(t),this.write(" = "),e.left.accept(this,FuPriority.ARGUMENT),this.writeNewLine()}writeAssert(e){this.write("assert "),e.cond.accept(this,FuPriority.ARGUMENT),null!=e.message&&(this.write(", "),e.message.accept(this,FuPriority.ARGUMENT)),this.writeNewLine()}visitBreak(e){this.writeLine(e.loopOrSwitch instanceof FuSwitch?"raise _CiBreak()":"break")}getIfNot(){return"if not "}#eo(e,t,i){let r;(r=e)instanceof FuLiteralLong?this.visitLiteralLong(r.value+BigInt(t)):(e.accept(this,FuPriority.ADD),this.write(i))}writeForRange(e,t,i){switch(this.write("range("),1==i&&e.value.isLiteralZero()||(e.value.accept(this,FuPriority.ARGUMENT),this.write(", ")),t.op){case FuToken.LESS:case FuToken.GREATER:t.right.accept(this,FuPriority.ARGUMENT);break;case FuToken.LESS_OR_EQUAL:this.#eo(t.right,1," + 1");break;case FuToken.GREATER_OR_EQUAL:this.#eo(t.right,-1," - 1");break;default:throw new Error}1!=i&&(this.write(", "),this.visitLiteralLong(i)),this.writeChar(41)}visitForeach(e){this.write("for "),this.writeName(e.getVar());let t=e.collection.type;2==t.class.typeParameterCount?(this.write(", "),this.writeName(e.getValueVar()),this.write(" in "),t.class.id==FuId.SORTED_DICTIONARY_CLASS?(this.write("sorted("),this.writePostfix(e.collection,".items())")):this.writePostfix(e.collection,".items()")):(this.write(" in "),t.class.id==FuId.SORTED_SET_CLASS?this.writeCall("sorted",e.collection):e.collection.accept(this,FuPriority.ARGUMENT)),this.writeChild(e.body)}writeElseIf(){this.write("el")}visitLock(e){this.visitXcrement(e.lock,!1,!0),this.write("with "),e.lock.accept(this,FuPriority.ARGUMENT),this.openChild(),this.visitXcrement(e.lock,!0,!0),e.body.acceptStatement(this),this.closeChild()}writeResultVar(){this.write("result")}#to(e){let t,i,r;if((t=e)instanceof FuSymbolReference&&(i=t.symbol)instanceof FuClass)this.writeName(i),this.write("()");else if(e instanceof FuVar){const t=e;this.writeName(t.type.asClassType().class),this.write("() as "),this.#Hh(t.name)}else(r=e)instanceof FuBinaryExpr&&r.op==FuToken.WHEN?(this.#to(r.left),this.write(" if "),r.right.accept(this,FuPriority.ARGUMENT)):e.accept(this,FuPriority.OR)}#io(e,t){this.openChild(),this.visitXcrement(e.value,!0,!0),this.writeFirstStatements(t,FuSwitch.lengthWithoutTrailingBreak(t)),this.closeChild()}visitSwitch(e){let t=e.cases.some((e=>FuSwitch.hasEarlyBreak(e.body)))||FuSwitch.hasEarlyBreak(e.defaultBody);t&&(this.#Bh=!0,this.write("try"),this.openChild()),this.visitXcrement(e.value,!1,!0),this.write("match "),e.value.accept(this,FuPriority.ARGUMENT),this.openChild();for(const t of e.cases){let i="case ";for(const e of t.values)this.write(i),this.#to(e),i=" | ";this.#io(e,t.body)}e.hasDefault()&&(this.write("case _"),this.#io(e,e.defaultBody)),this.closeChild(),t&&(this.closeChild(),this.write("except _CiBreak"),this.openChild(),this.closeChild())}visitThrow(e){null!=e.message&&this.visitXcrement(e.message,!1,!0),this.write("raise "),this.writeThrowArgument(e),this.writeNewLine()}#ro(e){this.writeNewLine(),this.write("class "),this.writeName(e)}visitEnumValue(e,t){this.writeUppercaseWithUnderscores(e.name),this.write(" = "),this.visitLiteralLong(BigInt(e.value.intValue())),this.writeNewLine(),this.writeDoc(e.documentation)}writeEnum(e){this.#ro(e),this.include("enum"),this.write(e instanceof FuEnumFlags?"(enum.Flag)":"(enum.Enum)"),this.openChild(),this.writeDoc(e.documentation),e.acceptValues(this),this.closeChild(),this.writtenTypes.add(e)}writeConst(e){(e.visibility!=FuVisibility.PRIVATE||e.type instanceof FuArrayStorageType)&&(this.writeNewLine(),this.writeName(e),this.write(" = "),e.value.accept(this,FuPriority.ARGUMENT),this.writeNewLine(),this.writeDoc(e.documentation))}writeField(e){this.writeTypeAndName(e),this.writeNewLine()}writeMethod(e){switch(this.writeNewLine(),e.callType){case FuCallType.STATIC:this.writeLine("@staticmethod");break;case FuCallType.ABSTRACT:this.include("abc"),this.writeLine("@abc.abstractmethod")}this.write("def "),this.writeName(e),e.callType==FuCallType.STATIC?this.writeParameters(e,!0):(this.write("(self"),this.writeRemainingParameters(e,!1,!0)),this.write(" -> "),e.type.id==FuId.VOID_TYPE?this.write("None"):this.#Xh(e.type),this.currentMethod=e,this.openChild(),this.#Vh(e),null!=e.body&&e.body.acceptStatement(this),this.closeChild(),this.currentMethod=null}#so(e){let t;for(;(t=e.parent)instanceof FuClass;){if(this.needsConstructor(t))return!0;e=t}return!1}writeInitField(e){this.hasInitCode(e)&&(this.write("self."),this.writeName(e),this.writeVarInit(e),this.writeNewLine(),this.writeInitCode(e))}writeClass(e,t){if(!this.writeBaseClass(e,t))return;let i;this.writtenTypes.delete(e),this.#ro(e),(i=e.parent)instanceof FuClass?(this.writeChar(40),this.writeName(i),this.writeChar(41)):e.callType==FuCallType.ABSTRACT&&(this.include("abc"),this.write("(abc.ABC)")),this.openChild(),this.writeDoc(e.documentation),this.needsConstructor(e)&&(this.writeNewLine(),this.write("def __init__(self)"),this.openChild(),null!=e.constructor_&&this.writeDoc(e.constructor_.documentation),this.#so(e)&&(this.writeName(e.parent),this.writeLine(".__init__(self)")),this.writeConstructorBody(e),this.closeChild()),this.writeMembers(e,!0),this.closeChild(),this.writtenTypes.add(e)}#ao(e){this.write(`\\x${e.toString(16).padStart(2,"0")}`)}#cn(e){if(0!=Object.keys(e).length){this.writeNewLine(),this.write("class _FuResource"),this.openChild();for(const[t,i]of Object.entries(e).sort(((e,t)=>e[0].localeCompare(t[0])))){this.writeResourceName(t),this.writeLine(" = ("),this.indent++,this.write('b"');let e=0;for(const t of i)e>0&&0==(15&e)&&(this.writeCharLine(34),this.write('b"')),this.#ao(t),e++;this.writeLine('" )'),this.indent--}this.closeChild()}}#bn(e){this.writeNewLine(),this.writeLine("if __name__ == '__main__':"),this.writeChar(9),e.type.id==FuId.INT_TYPE&&this.write("sys.exit("),this.writeName(e.parent),this.write(".main("),1==e.parameters.count()&&this.write("sys.argv[1:]"),e.type.id==FuId.INT_TYPE&&this.writeChar(41),this.writeCharLine(41)}writeProgram(e,t,i){this.writtenTypes.clear(),this.#Bh=!1,this.openStringWriter(),this.writeTypes(e),this.createFile(null,t),this.writeTopLevelNatives(e),null==e.main||e.main.type.id!=FuId.INT_TYPE&&1!=e.main.parameters.count()||this.include("sys"),this.writeIncludes("import ",""),this.#Bh&&(this.writeNewLine(),this.writeLine("class _CiBreak(Exception): pass")),this.closeStringWriter(),this.#cn(e.resources),null!=e.main&&this.#bn(e.main),this.closeFile()}}class StringWriter{#no="";write(e){this.#no+=e}clear(){this.#no=""}toString(){return this.#no}}